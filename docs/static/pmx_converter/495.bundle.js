"use strict";(self.webpackChunkbabylon_mmd=self.webpackChunkbabylon_mmd||[]).push([[495],{7495:(e,t,s)=>{s.r(t),s.d(t,{Engine:()=>o});var a=s(854),_=s(6315),r=s(7008),i=s(4085),E=s(4329),n=s(1137),h=s(7716);r.w.prototype.setAlphaMode=function(e,t=!1){if(this._alphaMode!==e){switch(e){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}t||(this.depthCullingState.depthMask=0===e),this._alphaMode=e}else if(!t){const t=0===e;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}},s(2212),r.w.prototype.updateDynamicIndexBuffer=function(e,t,s=0){let a;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(e),a=e.is32Bits?t instanceof Uint32Array?t:new Uint32Array(t):t instanceof Uint16Array?t:new Uint16Array(t),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,a,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},r.w.prototype.updateDynamicVertexBuffer=function(e,t,s,a){this.bindArrayBuffer(e),void 0===s&&(s=0);const _=t.byteLength||t.length;void 0===a||a>=_&&0===s?t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,s,new Float32Array(t)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,s,t):t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(t).subarray(s,s+a)):(t=t instanceof ArrayBuffer?new Uint8Array(t,s,a):new Uint8Array(t.buffer,t.byteOffset+s,a),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)),this._resetVertexBufferBinding()},s(9967),s(8019),s(6125),s(7298),s(9696);var l=s(9931),T=s(9161),R=s(4296);s(7841);class o extends r.w{static get NpmPackage(){return l.$.NpmPackage}static get Version(){return l.$.Version}static get Instances(){return _.q.Instances}static get LastCreatedEngine(){return _.q.LastCreatedEngine}static get LastCreatedScene(){return _.q.LastCreatedScene}static DefaultLoadingScreenFactory(e){return l.$.DefaultLoadingScreenFactory(e)}get _supportsHardwareTextureRescaling(){return!!o._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(e,t,s,a=!1){if(super(e,t,s,a),this.customAnimationFrameRequester=null,this._performanceMonitor=new i.r,this._drawCalls=new R.A,e&&(this._features.supportRenderPasses=!0,s=this._creationOptions,e.getContext)){const t=e;this._sharedInit(t)}}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e){super._sharedInit(e),(0,T.BG)(this,e,this._creationOptions)}resizeImageBitmap(e,t,s){return(0,T.jf)(this,e,t,s)}_createImageBitmapFromSource(e,t){return(0,T.kF)(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&(0,T.tl)(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&(0,T.g7)()}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(e,t,s,a){const _=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,s,a),_}scissorClear(e,t,s,a,_){this.enableScissor(e,t,s,a),this.clear(_,!0,!0,!0),this.disableScissor()}enableScissor(e,t,s,a){const _=this._gl;_.enable(_.SCISSOR_TEST),_.scissor(e,t,s,a)}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST)}_loadFileAsync(e,t,s){return new Promise(((a,_)=>{this._loadFile(e,(e=>{a(e)}),void 0,t,s,((e,t)=>{_(t)}))}))}getVertexShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries();super._rebuildBuffers()}getFontOffset(e){return(0,T.PR)(e)}_cancelFrame(){if(this.customAnimationFrameRequester){if(0!==this._frameHandler){this._frameHandler=0;const{cancelAnimationFrame:e}=this.customAnimationFrameRequester;e&&e(this.customAnimationFrameRequester.requestID)}}else super._cancelFrame()}_renderLoop(){if(this._frameHandler=0,!this._contextWasLost){let e=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0&&0===this._frameHandler&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&(0,T.eG)(this._renderingCanvas)}exitPointerlock(){(0,T.rT)()}beginFrame(){this._measureFps(),super.beginFrame()}_deletePipelineContext(e){const t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,s,a,_,r=null){_=_||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const i=super.createShaderProgram(e,t,s,a,_,r);return this.onAfterShaderCompilationObservable.notifyObservers(this),i}_createShaderProgram(e,t,s,a,_=null){const r=a.createProgram();if(e.program=r,!r)throw new Error("Unable to create program");if(a.attachShader(r,t),a.attachShader(r,s),this.webGLVersion>1&&_){const t=this.createTransformFeedback();this.bindTransformFeedback(t),this.setTranformFeedbackVaryings(r,_),e.transformFeedback=t}return a.linkProgram(r),this.webGLVersion>1&&_&&this.bindTransformFeedback(null),e.context=a,e.vertexShader=t,e.fragmentShader=s,e.isParallelCompiled||this._finalizePipelineContext(e),r}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e),this.scenes.forEach((t=>{t.postProcesses.forEach((t=>{t._outputTexture===e&&(t._outputTexture=null)})),t.cameras.forEach((t=>{t._postProcesses.forEach((t=>{t&&t._outputTexture===e&&(t._outputTexture=null)}))}))}))}_rescaleTexture(e,t,s,a,_){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const r=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&o._RescalePostProcessFactory&&(this._rescalePostProcess=o._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;const i=()=>{this._rescalePostProcess.onApply=function(t){t._bindTexture("textureSampler",e)};let i=s;i||(i=this.scenes[this.scenes.length-1]),i.postProcessManager.directRender([this._rescalePostProcess],r,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,a,0,0,t.width,t.height,0),this.unBindFramebuffer(r),r.dispose(),_&&_()},E=this._rescalePostProcess.getEffect();E?E.executeWhenCompiled(i):this._rescalePostProcess.onEffectCreatedObservable.addOnce((e=>{e.executeWhenCompiled(i)}))}}wrapWebGLTexture(e,t=!1,s=3,_=0,r=0){const i=new h.d(e,this._gl),E=new a.h(this,0,!0);return E._hardwareTexture=i,E.baseWidth=_,E.baseHeight=r,E.width=_,E.height=r,E.isReady=!0,E.useMipMaps=t,this.updateTextureSamplingMode(s,E),E}_uploadImageToTexture(e,t,s=0,a=0){const _=this._gl,r=this._getWebGLTextureType(e.type),i=this._getInternalFormat(e.format),E=this._getRGBABufferInternalSizedFormat(e.type,i),n=e.isCube?_.TEXTURE_CUBE_MAP:_.TEXTURE_2D;this._bindTextureDirectly(n,e,!0),this._unpackFlipY(e.invertY);let h=_.TEXTURE_2D;e.isCube&&(h=_.TEXTURE_CUBE_MAP_POSITIVE_X+s),_.texImage2D(h,a,E,i,r,t),this._bindTextureDirectly(n,null,!0)}updateTextureComparisonFunction(e,t){if(1===this.webGLVersion)return void n.V.Error("WebGL 1 does not support texture comparison.");const s=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),0===t?(s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_COMPARE_FUNC,515),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_COMPARE_MODE,s.NONE)):(s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_COMPARE_FUNC,t),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_COMPARE_MODE,s.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),0===t?(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_FUNC,515),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_MODE,s.NONE)):(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_FUNC,t),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_MODE,s.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");const s=new E.A(t);return s.capacity=e,this.bindArrayBuffer(s),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),s.references=1,s}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}_clientWaitAsync(e,t=0,s=10){const a=this._gl;return new Promise(((_,r)=>{const i=()=>{const E=a.clientWaitSync(e,t,0);E!=a.WAIT_FAILED?E!=a.TIMEOUT_EXPIRED?_():setTimeout(i,s):r()};i()}))}_readPixelsAsync(e,t,s,a,_,r,i){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const E=this._gl,n=E.createBuffer();E.bindBuffer(E.PIXEL_PACK_BUFFER,n),E.bufferData(E.PIXEL_PACK_BUFFER,i.byteLength,E.STREAM_READ),E.readPixels(e,t,s,a,_,r,0),E.bindBuffer(E.PIXEL_PACK_BUFFER,null);const h=E.fenceSync(E.SYNC_GPU_COMMANDS_COMPLETE,0);return h?(E.flush(),this._clientWaitAsync(h,0,10).then((()=>(E.deleteSync(h),E.bindBuffer(E.PIXEL_PACK_BUFFER,n),E.getBufferSubData(E.PIXEL_PACK_BUFFER,0,i),E.bindBuffer(E.PIXEL_PACK_BUFFER,null),E.deleteBuffer(n),i)))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),(0,T.kX)(this,this._renderingCanvas),super.dispose()}}o.ALPHA_DISABLE=0,o.ALPHA_ADD=1,o.ALPHA_COMBINE=2,o.ALPHA_SUBTRACT=3,o.ALPHA_MULTIPLY=4,o.ALPHA_MAXIMIZED=5,o.ALPHA_ONEONE=6,o.ALPHA_PREMULTIPLIED=7,o.ALPHA_PREMULTIPLIED_PORTERDUFF=8,o.ALPHA_INTERPOLATE=9,o.ALPHA_SCREENMODE=10,o.DELAYLOADSTATE_NONE=0,o.DELAYLOADSTATE_LOADED=1,o.DELAYLOADSTATE_LOADING=2,o.DELAYLOADSTATE_NOTLOADED=4,o.NEVER=512,o.ALWAYS=519,o.LESS=513,o.EQUAL=514,o.LEQUAL=515,o.GREATER=516,o.GEQUAL=518,o.NOTEQUAL=517,o.KEEP=7680,o.REPLACE=7681,o.INCR=7682,o.DECR=7683,o.INVERT=5386,o.INCR_WRAP=34055,o.DECR_WRAP=34056,o.TEXTURE_CLAMP_ADDRESSMODE=0,o.TEXTURE_WRAP_ADDRESSMODE=1,o.TEXTURE_MIRROR_ADDRESSMODE=2,o.TEXTUREFORMAT_ALPHA=0,o.TEXTUREFORMAT_LUMINANCE=1,o.TEXTUREFORMAT_LUMINANCE_ALPHA=2,o.TEXTUREFORMAT_RGB=4,o.TEXTUREFORMAT_RGBA=5,o.TEXTUREFORMAT_RED=6,o.TEXTUREFORMAT_R=6,o.TEXTUREFORMAT_RG=7,o.TEXTUREFORMAT_RED_INTEGER=8,o.TEXTUREFORMAT_R_INTEGER=8,o.TEXTUREFORMAT_RG_INTEGER=9,o.TEXTUREFORMAT_RGB_INTEGER=10,o.TEXTUREFORMAT_RGBA_INTEGER=11,o.TEXTURETYPE_UNSIGNED_BYTE=0,o.TEXTURETYPE_UNSIGNED_INT=0,o.TEXTURETYPE_FLOAT=1,o.TEXTURETYPE_HALF_FLOAT=2,o.TEXTURETYPE_BYTE=3,o.TEXTURETYPE_SHORT=4,o.TEXTURETYPE_UNSIGNED_SHORT=5,o.TEXTURETYPE_INT=6,o.TEXTURETYPE_UNSIGNED_INTEGER=7,o.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,o.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,o.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,o.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,o.TEXTURETYPE_UNSIGNED_INT_24_8=12,o.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,o.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,o.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,o.TEXTURE_NEAREST_SAMPLINGMODE=1,o.TEXTURE_BILINEAR_SAMPLINGMODE=2,o.TEXTURE_TRILINEAR_SAMPLINGMODE=3,o.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,o.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,o.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,o.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,o.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,o.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,o.TEXTURE_NEAREST_LINEAR=7,o.TEXTURE_NEAREST_NEAREST=1,o.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,o.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,o.TEXTURE_LINEAR_LINEAR=2,o.TEXTURE_LINEAR_NEAREST=12,o.TEXTURE_EXPLICIT_MODE=0,o.TEXTURE_SPHERICAL_MODE=1,o.TEXTURE_PLANAR_MODE=2,o.TEXTURE_CUBIC_MODE=3,o.TEXTURE_PROJECTION_MODE=4,o.TEXTURE_SKYBOX_MODE=5,o.TEXTURE_INVCUBIC_MODE=6,o.TEXTURE_EQUIRECTANGULAR_MODE=7,o.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,o.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,o.SCALEMODE_FLOOR=1,o.SCALEMODE_NEAREST=2,o.SCALEMODE_CEILING=3}}]);