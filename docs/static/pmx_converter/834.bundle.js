"use strict";(self.webpackChunkbabylon_mmd=self.webpackChunkbabylon_mmd||[]).push([[834],{5834:(e,t,r)=>{r.r(t),r.d(t,{_ENVTextureLoader:()=>w});var o=r(998),n=r(9923),a=r(4867),i=r(7517),l=r(854),s=r(2667),u=(r(7457),r(7891)),c=r(1137);r(4176),r(1947);r(9779),r(2212);var d=r(6755);s.t.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)},Object.defineProperty(s.t.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=d.d.ConvertCubeMapTextureToSphericalPolynomial(this),null===this._texture._sphericalPolynomialPromise?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then((e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0}))),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0}),r(5999);const p="image/png",h=2,m=[134,22,135,150,246,214,150,54];function f(e){if(e.version>h)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${h}".`);return 2===e.version?e:e={...e,version:2,imageType:p}}function x(e,t,n){const i=(n=f(n)).specular;return i?(e._lodGenerationScale=i.lodGenerationScale,async function(e,t,n=p){if(!o.S0.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const i=(0,a.C0)(e.width)+1,c=e.getEngine();let d=!1,h=!1,m=null,f=null,x=null;const w=c.getCaps();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,c.updateTextureSamplingMode(3,e),w.textureLOD?c._features.supportRenderAndCopyToLodForFloatTextures?w.textureHalfFloatRender&&w.textureHalfFloatLinearFiltering?(d=!0,e.type=2):w.textureFloatRender&&w.textureFloatLinearFiltering&&(d=!0,e.type=1):d=!1:(d=!1,h=!0,x={});let y=0;if(d)c.isWebGPU?(y=1,await r.e(126).then(r.bind(r,371))):await r.e(71).then(r.bind(r,9682)),m=new u.w("rgbdDecode","rgbdDecode",null,null,1,null,3,c,!1,void 0,e.type,void 0,null,!1,void 0,y),e._isRGBD=!1,e.invertY=!1,f=c.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,h){const t=3,r=e._lodGenerationScale,o=e._lodGenerationOffset;for(let n=0;n<t;n++){const a=(i-1)*r+o,u=o+(a-o)*(1-n/(t-1)),d=Math.round(Math.min(Math.max(u,0),a)),p=new l.h(c,2);p.isCube=!0,p.invertY=!0,p.generateMipMaps=!1,c.updateTextureSamplingMode(2,p);const h=new s.t(null);switch(h._isCube=!0,h._texture=p,x[d]=h,n){case 0:e._lodTextureLow=h;break;case 1:e._lodTextureMid=h;break;case 2:e._lodTextureHigh=h}}}const P=[];for(let r=0;r<t.length;r++)for(let o=0;o<6;o++){const a=t[r][o],i=new Blob([a],{type:n}),l=URL.createObjectURL(i);let s;if(c._features.forceBitmapOverHTMLImageElement)s=c.createImageBitmap(i,{premultiplyAlpha:"none"}).then((t=>_(t,c,d,m,l,o,r,h,x,f,e)));else{const t=new Image;t.src=l,s=new Promise(((n,a)=>{t.onload=()=>{_(t,c,d,m,l,o,r,h,x,f,e).then((()=>n())).catch((e=>{a(e)}))},t.onerror=e=>{a(e)}}))}P.push(s)}if(t.length<i){let r;const o=Math.pow(2,i-1-t.length),n=o*o*4;switch(e.type){case 0:r=new Uint8Array(n);break;case 2:r=new Uint16Array(n);break;case 1:r=new Float32Array(n)}for(let o=t.length;o<i;o++)for(let t=0;t<6;t++)c._uploadArrayBufferViewToTexture(e,r,t,o)}return Promise.all(P).then((()=>{f&&(c._releaseTexture(e),f._swapAndDie(e)),m&&m.dispose(),h&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}))}(e,function(e,t){const r=(t=f(t)).specular;let o=Math.log2(t.width);if(o=Math.round(o)+1,r.mipmaps.length!==6*o)throw new Error(`Unsupported specular mipmaps number "${r.mipmaps.length}"`);const n=new Array(o);for(let t=0;t<o;t++){n[t]=new Array(6);for(let o=0;o<6;o++){const a=r.mipmaps[6*t+o];n[t][o]=new Uint8Array(e.buffer,e.byteOffset+r.specularDataPosition+a.position,a.length)}}return n}(t,n),n.imageType)):Promise.resolve()}function _(e,t,r,o,n,a,i,l,s,u,c){return new Promise(((d,p)=>{if(r){const r=t.createTexture(null,!0,!0,null,1,null,(e=>{p(e)}),e);o?.onEffectCreatedObservable.addOnce((l=>{l.executeWhenCompiled((()=>{o.externalTextureSamplerBinding=!0,o.onApply=o=>{o._bindTexture("textureSampler",r),o.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([o],u,!0,a,i),t.restoreDefaultFramebuffer(),r.dispose(),URL.revokeObjectURL(n),d())}))}))}else{if(t._uploadImageToTexture(c,e,a,i),l){const r=s[i];r&&t._uploadImageToTexture(r._texture,e,a,0)}d()}}))}class w{constructor(){this.supportCascades=!1}loadCubeData(e,t,r,o,a){if(Array.isArray(e))return;const l=function(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let r=0;for(let e=0;e<m.length;e++)if(t.getUint8(r++)!==m[e])return c.V.Error("Not a babylon environment map"),null;let o="",n=0;for(;n=t.getUint8(r++);)o+=String.fromCharCode(n);let a=JSON.parse(o);return a=f(a),a.specular&&(a.specular.specularDataPosition=r,a.specular.lodGenerationScale=a.specular.lodGenerationScale||.8),a}(e);if(l){t.width=l.width,t.height=l.width;try{(function(e,t){const r=(t=f(t)).irradiance;if(!r)return;const o=new i.Q;n.Pq.FromArrayToRef(r.x,0,o.x),n.Pq.FromArrayToRef(r.y,0,o.y),n.Pq.FromArrayToRef(r.z,0,o.z),n.Pq.FromArrayToRef(r.xx,0,o.xx),n.Pq.FromArrayToRef(r.yy,0,o.yy),n.Pq.FromArrayToRef(r.zz,0,o.zz),n.Pq.FromArrayToRef(r.yz,0,o.yz),n.Pq.FromArrayToRef(r.zx,0,o.zx),n.Pq.FromArrayToRef(r.xy,0,o.xy),e._sphericalPolynomial=o})(t,l),x(t,e,l).then((()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),o&&o()}),(e=>{a?.("Can not upload environment levels",e)}))}catch(e){a?.("Can not upload environment file",e)}}else a&&a("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}},6755:(e,t,r)=>{r.d(t,{d:()=>u});var o=r(9923),n=r(4867),a=r(7517),i=r(5559),l=r(6041);class s{constructor(e,t,r,o){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=r,this.worldAxisForFileY=o}}class u{static ConvertCubeMapTextureToSphericalPolynomial(e){if(!e.isCube)return null;e.getScene()?.getEngine().flushFramebuffer();const t=e.getSize().width,r=e.readPixels(0,void 0,void 0,!1),o=e.readPixels(1,void 0,void 0,!1);let n,a;e.isRenderTarget?(n=e.readPixels(3,void 0,void 0,!1),a=e.readPixels(2,void 0,void 0,!1)):(n=e.readPixels(2,void 0,void 0,!1),a=e.readPixels(3,void 0,void 0,!1));const i=e.readPixels(4,void 0,void 0,!1),l=e.readPixels(5,void 0,void 0,!1),s=e.gammaSpace;let u=0;return 1!=e.textureType&&2!=e.textureType||(u=1),new Promise((e=>{Promise.all([o,r,n,a,i,l]).then((([r,o,n,a,i,l])=>{const c={size:t,right:o,left:r,up:n,down:a,front:i,back:l,format:5,type:u,gammaSpace:s};e(this.ConvertCubeMapToSphericalPolynomial(c))}))}))}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){const t=new a.O;let r=0;const o=2/e.size,s=o,u=.5*o,c=u-1;for(let a=0;a<6;a++){const d=this._FileFaces[a],p=e[d.name];let h=c;const m=5===e.format?4:3;for(let a=0;a<e.size;a++){let f=c;for(let s=0;s<e.size;s++){const c=d.worldAxisForFileX.scale(f).add(d.worldAxisForFileY.scale(h)).add(d.worldAxisForNormal);c.normalize();const x=this._AreaElement(f-u,h-u)-this._AreaElement(f-u,h+u)-this._AreaElement(f+u,h-u)+this._AreaElement(f+u,h+u);let _=p[a*e.size*m+s*m+0],w=p[a*e.size*m+s*m+1],y=p[a*e.size*m+s*m+2];isNaN(_)&&(_=0),isNaN(w)&&(w=0),isNaN(y)&&(y=0),0===e.type&&(_/=255,w/=255,y/=255),e.gammaSpace&&(_=Math.pow((0,n.OQ)(_),i.tk),w=Math.pow((0,n.OQ)(w),i.tk),y=Math.pow((0,n.OQ)(y),i.tk));const P=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){const e=Math.max(_,w,y);if(e>P){const t=P/e;_*=t,w*=t,y*=t}}else _=(0,n.OQ)(_,0,P),w=(0,n.OQ)(w,0,P),y=(0,n.OQ)(y,0,P);const g=new l.v9(_,w,y);t.addLight(c,g,x),r+=x,f+=o}h+=s}}const d=4*Math.PI*6/6/r;return t.scaleInPlace(d),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),a.Q.FromHarmonics(t)}}u._FileFaces=[new s("right",new o.Pq(1,0,0),new o.Pq(0,0,-1),new o.Pq(0,-1,0)),new s("left",new o.Pq(-1,0,0),new o.Pq(0,0,1),new o.Pq(0,-1,0)),new s("up",new o.Pq(0,1,0),new o.Pq(1,0,0),new o.Pq(0,0,1)),new s("down",new o.Pq(0,-1,0),new o.Pq(1,0,0),new o.Pq(0,0,-1)),new s("front",new o.Pq(0,0,1),new o.Pq(1,0,0),new o.Pq(0,-1,0)),new s("back",new o.Pq(0,0,-1),new o.Pq(-1,0,0),new o.Pq(0,-1,0))],u.MAX_HDRI_VALUE=4096,u.PRESERVE_CLAMPED_COLORS=!1}}]);