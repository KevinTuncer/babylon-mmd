(()=>{var e,t={110:()=>{},896:(e,t,r)=>{"use strict";var s=r(718);class n{_canvas;_engine;_scene;_onTick;constructor(e){this._canvas=e.canvas,this._engine=e.engine,this._scene=null,this._onTick=null}static async Create(e){const t=new n(e);return t._scene=await t._initialize(e.sceneBuilder),t._onTick=t._makeOnTick(),t}run(){const e=this._engine;window.addEventListener("resize",this._onResize),e.runRenderLoop(this._onTick)}dispose(){window.removeEventListener("resize",this._onResize),this._engine.dispose()}_onResize=()=>{this._engine.resize()};async _initialize(e){return await e.build(this._canvas,this._engine)}_makeOnTick(){const e=this._scene;return()=>e.render()}}var a=r(110),o=r.n(a);class i{name;boneTracks;moveableBoneTracks;morphTracks;propertyTrack;cameraTrack;startFrame;endFrame;constructor(e,t,r,s,n,a){this.name=e,this.boneTracks=t,this.moveableBoneTracks=r,this.morphTracks=s,this.propertyTrack=n,this.cameraTrack=a;let o=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER;for(let e=0;e<t.length;++e){const r=t[e];o=Math.min(o,r.startFrame),i=Math.max(i,r.endFrame)}for(let e=0;e<r.length;++e){const t=r[e];o=Math.min(o,t.startFrame),i=Math.max(i,t.endFrame)}for(let e=0;e<s.length;++e){const t=s[e];o=Math.min(o,t.startFrame),i=Math.max(i,t.endFrame)}o=Math.min(o,n.startFrame),i=Math.max(i,n.endFrame),o=Math.min(o,a.startFrame),i=Math.max(i,a.endFrame),this.startFrame=o,this.endFrame=i}validate(){const e=this.boneTracks;for(let t=0;t<e.length;++t)if(!e[t].validate())return!1;const t=this.moveableBoneTracks;for(let e=0;e<t.length;++e)if(!t[e].validate())return!1;const r=this.morphTracks;for(let e=0;e<r.length;++e)if(!r[e].validate())return!1;return this.propertyTrack.validate()&&this.cameraTrack.validate()}}class l{trackType;name;frameNumbers;constructor(e,t,r){this.trackType=e,this.name=t,this.frameNumbers=new Uint32Array(r)}validate(){for(let e=1;e<this.frameNumbers.length;++e)if(this.frameNumbers[e-1]>=this.frameNumbers[e])return!1;return!0}get startFrame(){return 0===this.frameNumbers.length?0:this.frameNumbers[0]}get endFrame(){return 0===this.frameNumbers.length?0:this.frameNumbers[this.frameNumbers.length-1]}}class h extends l{rotations;rotationInterpolations;constructor(e,t){super("bone",e,t),this.rotations=new Float32Array(4*t),this.rotationInterpolations=new Uint8Array(4*t)}}class m extends l{positions;positionInterpolations;rotations;rotationInterpolations;constructor(e,t){super("moveableBone",e,t),this.positions=new Float32Array(3*t),this.positionInterpolations=new Uint8Array(12*t),this.rotations=new Float32Array(4*t),this.rotationInterpolations=new Uint8Array(4*t)}}class c extends l{weights;constructor(e,t){super("morph",e,t),this.weights=new Float32Array(t)}}class f extends l{positions;positionInterpolations;rotations;rotationInterpolations;distances;distanceInterpolations;fovs;fovInterpolations;constructor(e){super("camera","cameraTrack",e),this.positions=new Float32Array(3*e),this.positionInterpolations=new Uint8Array(12*e),this.rotations=new Float32Array(3*e),this.rotationInterpolations=new Uint8Array(4*e),this.distances=new Float32Array(e),this.distanceInterpolations=new Uint8Array(4*e),this.fovs=new Float32Array(e),this.fovInterpolations=new Uint8Array(4*e)}}class y extends l{visibles;ikBoneNames;ikStates;constructor(e,t){super("property","propertyTrack",e),this.visibles=new Uint8Array(e),this.ikBoneNames=new Array(t),this.ikStates=new Array(t);for(let r=0;r<t;++r)this.ikStates[r]=new Uint8Array(e)}}class u{log(e){console.log(e)}warn(e){console.warn(e)}error(e){console.error(e)}}class d{static _LittleEndian=!0;_dataView;_decoder;_offset;constructor(e){this._dataView=new DataView(e),this._decoder=null,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}getUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}getInt8(){const e=this._dataView.getInt8(this._offset);return this._offset+=1,e}getUint8Array(e,t){for(let r=0;r<t;++r)e[r]=this._dataView.getUint8(this._offset),this._offset+=1}getUint16(){const e=this._dataView.getUint16(this._offset,d._LittleEndian);return this._offset+=2,e}getUint16Array(e,t){for(let r=0;r<t;++r)e[r]=this._dataView.getUint16(this._offset,d._LittleEndian),this._offset+=2}getInt16(){const e=this._dataView.getInt16(this._offset,d._LittleEndian);return this._offset+=2,e}getUint32(){const e=this._dataView.getUint32(this._offset,d._LittleEndian);return this._offset+=4,e}getUint32Array(e,t){for(let r=0;r<t;++r)e[r]=this._dataView.getUint32(this._offset,d._LittleEndian),this._offset+=4}getInt32(){const e=this._dataView.getInt32(this._offset,d._LittleEndian);return this._offset+=4,e}getInt32Array(e,t){for(let r=0;r<t;++r)e[r]=this._dataView.getInt32(this._offset,d._LittleEndian),this._offset+=4}getFloat32(){const e=this._dataView.getFloat32(this._offset,d._LittleEndian);return this._offset+=4,e}getFloat32Array(e,t){for(let r=0;r<t;++r)e[r]=this._dataView.getFloat32(this._offset,d._LittleEndian),this._offset+=4}getFloat32Tuple(e){const t=new Array(e);for(let r=0;r<e;++r)t[r]=this._dataView.getFloat32(this._offset,d._LittleEndian),this._offset+=4;return t}initializeTextDecoder(e){this._decoder=new TextDecoder(e)}getDecoderString(e,t){if(null===this._decoder)throw new Error("TextDecoder is not initialized.");let r=new Uint8Array(this._dataView.buffer,this._offset,e);if(this._offset+=e,t)for(let e=0;e<r.length;++e)if(0===r[e]){r=r.subarray(0,e);break}return this._decoder.decode(r)}getSignatureString(e){const t=new TextDecoder("utf-8"),r=new Uint8Array(this._dataView.buffer,this._offset,e);return this._offset+=e,t.decode(r)}get bytesAvailable(){return this._dataView.byteLength-this._offset}}class g{static _Signature="Vocaloid Motion Data 0002";static SignatureBytes=30;static ModelNameBytes=20;static BoneKeyFrameBytes=111;static MorphKeyFrameBytes=23;static CameraKeyFrameBytes=61;static LightKeyFrameBytes=28;static SelfShadowKeyFrameBytes=9;static PropertyKeyFrameBytes=5;static PropertyKeyFrameIkStateBytes=21;dataDeserializer;boneKeyFrameCount;morphKeyFrameCount;cameraKeyFrameCount;lightKeyFrameCount;selfShadowKeyFrameCount;propertyKeyFrameCount;constructor(e,t,r,s,n,a,o){this.dataDeserializer=e,this.boneKeyFrameCount=t,this.morphKeyFrameCount=r,this.cameraKeyFrameCount=s,this.lightKeyFrameCount=n,this.selfShadowKeyFrameCount=a,this.propertyKeyFrameCount=o}static CheckedCreate(e,t=new u){const r=new d(e);if(r.initializeTextDecoder("shift-jis"),r.bytesAvailable<g.SignatureBytes+g.ModelNameBytes)return null;if(r.getSignatureString(this.SignatureBytes).substring(0,this._Signature.length)!==this._Signature)return null;if(r.offset+=g.ModelNameBytes,r.bytesAvailable<4)return null;const s=r.getUint32();if(r.bytesAvailable<s*g.BoneKeyFrameBytes)return null;if(r.offset+=s*g.BoneKeyFrameBytes,r.bytesAvailable<4)return null;const n=r.getUint32();if(r.bytesAvailable<n*g.MorphKeyFrameBytes)return null;if(r.offset+=n*g.MorphKeyFrameBytes,r.bytesAvailable<4)return null;const a=r.getUint32();if(r.bytesAvailable<a*g.CameraKeyFrameBytes)return null;if(r.offset+=a*g.CameraKeyFrameBytes,r.bytesAvailable<4)return null;const o=r.getUint32();if(r.bytesAvailable<o*g.LightKeyFrameBytes)return null;if(r.offset+=o*g.LightKeyFrameBytes,r.bytesAvailable<4)return null;const i=r.getUint32();if(r.bytesAvailable<i*g.SelfShadowKeyFrameBytes)return null;if(r.offset+=i*g.SelfShadowKeyFrameBytes,0===r.bytesAvailable)return new g(r,s,n,a,o,i,0);if(r.bytesAvailable<4)return null;const l=r.getUint32();for(let e=0;e<l;++e){if(r.bytesAvailable<g.PropertyKeyFrameBytes)return null;if(r.offset+=g.PropertyKeyFrameBytes,r.bytesAvailable<4)return null;const e=r.getUint32();if(r.bytesAvailable<e*g.PropertyKeyFrameIkStateBytes)return null;r.offset+=e*g.PropertyKeyFrameIkStateBytes}return r.bytesAvailable>0&&t.warn(`There are ${r.bytesAvailable} bytes left after parsing`),r.offset=0,new g(r,s,n,a,o,i,l)}}class p{propertyKeyFrames;_vmdData;constructor(e,t){this._vmdData=e,this.propertyKeyFrames=t}static Parse(e){const t=e.dataDeserializer,r=[];t.offset=g.SignatureBytes+g.ModelNameBytes+4+e.boneKeyFrameCount*g.BoneKeyFrameBytes+4+e.morphKeyFrameCount*g.MorphKeyFrameBytes+4+e.cameraKeyFrameCount*g.CameraKeyFrameBytes+4+e.lightKeyFrameCount*g.LightKeyFrameBytes+4+e.selfShadowKeyFrameCount*g.SelfShadowKeyFrameBytes+4;const s=e.propertyKeyFrameCount;for(let e=0;e<s;++e){const e=t.getUint32(),s=0!==t.getUint8(),n=t.getUint32(),a=[];for(let e=0;e<n;e++){const e=t.getDecoderString(20,!0),r=0!==t.getUint8();a.push([e,r])}const o={frameNumber:e,visible:s,ikStates:a};r.push(o)}return new p(e,r)}static ParseFromBuffer(e){const t=g.CheckedCreate(e);if(null===t)throw new Error("Invalid VMD data");return p.Parse(t)}get boneKeyFrames(){const e=g.SignatureBytes+g.ModelNameBytes+4;return new p.BoneKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.boneKeyFrameCount)}get morphKeyFrames(){const e=g.SignatureBytes+g.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*g.BoneKeyFrameBytes+4;return new p.MorphKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.morphKeyFrameCount)}get cameraKeyFrames(){const e=g.SignatureBytes+g.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*g.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*g.MorphKeyFrameBytes+4;return new p.CameraKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.cameraKeyFrameCount)}get lightKeyFrames(){const e=g.SignatureBytes+g.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*g.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*g.MorphKeyFrameBytes+4+this._vmdData.cameraKeyFrameCount*g.CameraKeyFrameBytes+4;return new p.LightKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.lightKeyFrameCount)}get selfShadowKeyFrames(){const e=g.SignatureBytes+g.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*g.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*g.MorphKeyFrameBytes+4+this._vmdData.cameraKeyFrameCount*g.CameraKeyFrameBytes+4+this._vmdData.lightKeyFrameCount*g.LightKeyFrameBytes+4;return new p.SelfShadowKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.selfShadowKeyFrameCount)}}!function(e){class t{_dataDeserializer;_startOffset;_length;constructor(e,t,r){this._dataDeserializer=e,this._startOffset=t,this._length=r}get length(){return this._length}}e.BufferArrayReader=t,e.BoneKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*g.BoneKeyFrameBytes;return new r(this._dataDeserializer,t)}};class r{boneName;frameNumber;position;rotation;interpolation;constructor(e,t){e.offset=t,this.boneName=e.getDecoderString(15,!0),this.frameNumber=e.getUint32(),this.position=e.getFloat32Tuple(3),this.rotation=e.getFloat32Tuple(4),this.interpolation=new Uint8Array(64);for(let t=0;t<64;++t)this.interpolation[t]=e.getUint8()}}e.BoneKeyFrame=r,e.MorphKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*g.MorphKeyFrameBytes;return new s(this._dataDeserializer,t)}};class s{morphName;frameNumber;weight;constructor(e,t){e.offset=t,this.morphName=e.getDecoderString(15,!0),this.frameNumber=e.getUint32(),this.weight=e.getFloat32()}}e.MorphKeyFrame=s,e.CameraKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*g.CameraKeyFrameBytes;return new n(this._dataDeserializer,t)}};class n{frameNumber;distance;position;rotation;interpolation;fov;perspective;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.distance=e.getFloat32(),this.position=e.getFloat32Tuple(3),this.rotation=e.getFloat32Tuple(3),this.interpolation=new Uint8Array(24);for(let t=0;t<24;++t)this.interpolation[t]=e.getUint8();this.fov=e.getUint32(),this.perspective=0!==e.getUint8()}}e.CameraKeyFrame=n,e.LightKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*g.LightKeyFrameBytes;return new a(this._dataDeserializer,t)}};class a{frameNumber;color;direction;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.color=e.getFloat32Tuple(3),this.direction=e.getFloat32Tuple(3)}}e.LightKeyFrame=a,e.SelfShadowKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*g.SelfShadowKeyFrameBytes;return new o(this._dataDeserializer,t)}};class o{frameNumber;mode;distance;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.mode=e.getUint8(),this.distance=e.getFloat32()}}e.SelfShadowKeyFrame=o}(p||(p={}));class b{_scene;_loggingEnabled;log;warn;error;constructor(e){this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._scene=e}loadFromVmdObject(e,t,r,s){this.loadFromVmdObjectAsync(e,t,s).then(r)}async loadFromVmdObjectAsync(e,t,r){Array.isArray(t)||(t=[t]);let n=0,a=0,o=0,l=0;for(let e=0;e<t.length;++e){const r=t[e];n+=r.boneKeyFrames.length,a+=r.morphKeyFrames.length,o+=r.propertyKeyFrames.length,l+=r.cameraKeyFrames.length}const u={lengthComputable:!0,loaded:0,total:n+a+o+l};let d=0,g=performance.now();const p=[];{const e=new Map,n=[],a=[],o=[];for(let e=0;e<t.length;++e){const r=t[e].boneKeyFrames,s=r.length;for(let e=0;e<s;++e)o.push(r.get(e))}100<performance.now()-g&&(await s.w1W.DelayAsync(0),g=performance.now());const i=o.length;for(let t=0;t<i;++t){const r=o[t].boneName;let s=e.get(r);void 0===s&&(s=e.size,e.set(r,s),n.push(0),a.push(r)),n[s]+=1}o.sort(((e,t)=>e.frameNumber-t.frameNumber));for(let t=0;t<e.size;++t)p.push(new m(a[t],n[t]));100<performance.now()-g&&(await s.w1W.DelayAsync(0),g=performance.now());const l=new Uint32Array(e.size);for(let t=0;t<i;++t){const n=o[t],a=e.get(n.boneName),i=p[a],h=l[a],m=n.interpolation;i.frameNumbers[h]=n.frameNumber;const c=i.positions,f=n.position;c[3*h+0]=f[0],c[3*h+1]=f[1],c[3*h+2]=f[2];const y=i.positionInterpolations;y[12*h+0]=m[0],y[12*h+1]=m[8],y[12*h+2]=m[4],y[12*h+3]=m[12],y[12*h+4]=m[16],y[12*h+5]=m[24],y[12*h+6]=m[20],y[12*h+7]=m[28],y[12*h+8]=m[32],y[12*h+9]=m[40],y[12*h+10]=m[36],y[12*h+11]=m[44];const b=i.rotations,_=n.rotation;b[4*h+0]=_[0],b[4*h+1]=_[1],b[4*h+2]=_[2],b[4*h+3]=_[3];const w=i.rotationInterpolations;w[4*h+0]=m[48],w[4*h+1]=m[56],w[4*h+2]=m[52],w[4*h+3]=m[60],l[a]+=1,t%1e3==0&&100<performance.now()-g&&(u.loaded=d+t,r?.({...u}),await s.w1W.DelayAsync(0),g=performance.now())}}const b=[],_=[];for(let e=0;e<p.length;++e){const t=p[e];let r=!0;for(let e=0;e<t.frameNumbers.length;++e){const s=t.positions;if(0!==s[3*e+0]||0!==s[3*e+1]||0!==s[3*e+2]){r=!1;break}const n=t.rotations;if(0!==n[4*e+0]||0!==n[4*e+1]||0!==n[4*e+2]||1!==n[4*e+3]){r=!1;break}}if(r)continue;let s=!1;for(let e=0;e<t.positions.length;++e)if(0!==t.positions[e]){s=!0;break}if(s)_.push(t);else{const e=new h(t.name,t.frameNumbers.length);e.frameNumbers.set(t.frameNumbers),e.rotations.set(t.rotations),e.rotationInterpolations.set(t.rotationInterpolations),b.push(e)}}if(p.length=0,1<t.length){const e=new Int32Array(b.length).fill(-1);for(let t=0;t<b.length;++t){const r=b[t].frameNumbers;let s=0,n=r[0];for(let e=1;e<=r.length;++e){const t=r[e];n!==t&&(s+=1,n=t)}r.length!==s&&(e[t]=s)}for(let t=0;t<b.length;++t){const r=e[t];if(-1===r)continue;const s=b[t],n=s.frameNumbers,a=s.rotations,o=s.rotationInterpolations,i=new h(s.name,r);let l=0,m=n[0];for(let e=1;e<=n.length;++e){const t=n[e];if(m!==t){const r=e-1;i.frameNumbers[l]=m;const s=i.rotations;s[4*l+0]=a[4*r+0],s[4*l+1]=a[4*r+1],s[4*l+2]=a[4*r+2],s[4*l+3]=a[4*r+3];const n=i.rotationInterpolations;n[4*l+0]=o[4*r+0],n[4*l+1]=o[4*r+1],n[4*l+2]=o[4*r+2],n[4*l+3]=o[4*r+3],l+=1,m=t}}b[t]=i}const t=new Int32Array(_.length).fill(-1);for(let e=0;e<_.length;++e){const r=_[e].frameNumbers;let s=0,n=r[0];for(let e=1;e<=r.length;++e){const t=r[e];n!==t&&(s+=1,n=t)}r.length!==s&&(t[e]=s)}for(let e=0;e<_.length;++e){const r=t[e];if(-1===r)continue;const s=_[e],n=s.frameNumbers,a=s.positions,o=s.positionInterpolations,i=s.rotations,l=s.rotationInterpolations,h=new m(s.name,r);let c=0,f=n[0];for(let e=1;e<=n.length;++e){const t=n[e];if(f!==t){const r=e-1;h.frameNumbers[c]=f;const s=h.positions;s[3*c+0]=a[3*r+0],s[3*c+1]=a[3*r+1],s[3*c+2]=a[3*r+2];const n=h.positionInterpolations;n[12*c+0]=o[12*r+0],n[12*c+1]=o[12*r+1],n[12*c+2]=o[12*r+2],n[12*c+3]=o[12*r+3],n[12*c+4]=o[12*r+4],n[12*c+5]=o[12*r+5],n[12*c+6]=o[12*r+6],n[12*c+7]=o[12*r+7],n[12*c+8]=o[12*r+8],n[12*c+9]=o[12*r+9],n[12*c+10]=o[12*r+10],n[12*c+11]=o[12*r+11];const m=h.rotations;m[4*c+0]=i[4*r+0],m[4*c+1]=i[4*r+1],m[4*c+2]=i[4*r+2],m[4*c+3]=i[4*r+3];const y=h.rotationInterpolations;y[4*c+0]=l[4*r+0],y[4*c+1]=l[4*r+1],y[4*c+2]=l[4*r+2],y[4*c+3]=l[4*r+3],c+=1,f=t}}_[e]=h}}u.loaded=d+n,r?.({...u}),d+=n;const w=[];{const e=new Map,n=[],a=[],o=[];for(let e=0;e<t.length;++e){const r=t[e].morphKeyFrames,s=r.length;for(let e=0;e<s;++e)o.push(r.get(e))}100<performance.now()-g&&(await s.w1W.DelayAsync(0),g=performance.now());const i=o.length;for(let t=0;t<i;++t){const r=o[t].morphName;let s=e.get(r);void 0===s&&(s=e.size,e.set(r,s),n.push(0),a.push(r)),n[s]+=1}o.sort(((e,t)=>e.frameNumber-t.frameNumber));for(let t=0;t<e.size;++t)w.push(new c(a[t],n[t]));100<performance.now()-g&&(await s.w1W.DelayAsync(0),g=performance.now());const l=new Uint32Array(e.size);for(let t=0;t<i;++t){const n=o[t],a=e.get(n.morphName),i=w[a],h=l[a];i.frameNumbers[h]=n.frameNumber,i.weights[h]=n.weight,l[a]+=1,t%1e3==0&&100<performance.now()-g&&(u.loaded=d+t,r?.({...u}),await s.w1W.DelayAsync(0),g=performance.now())}}const F=[];for(let e=0;e<w.length;++e){const t=w[e];let r=!0;for(let e=0;e<t.weights.length;++e)if(0!==t.weights[e]){r=!1;break}r||F.push(t)}if(w.length=0,1<t.length){const e=new Int32Array(F.length).fill(-1);for(let t=0;t<F.length;++t){const r=F[t].frameNumbers;let s=0,n=r[0];for(let e=1;e<=r.length;++e){const t=r[e];n!==t&&(s+=1,n=t)}r.length!==s&&(e[t]=s)}for(let t=0;t<F.length;++t){const r=e[t];if(-1===r)continue;const s=F[t],n=s.frameNumbers,a=s.weights,o=new c(s.name,r);let i=0,l=n[0];for(let e=1;e<=n.length;++e){const t=n[e];l!==t&&(o.frameNumbers[i]=l,o.weights[i]=a[e-1],i+=1,l=t)}F[t]=o}}u.loaded=d+a,r?.({...u}),d+=a;const v=[];for(let e=0;e<t.length;++e){const r=t[e].propertyKeyFrames;for(let e=0;e<r.length;++e)v.push(r[e])}let N;if(v.sort(((e,t)=>e.frameNumber-t.frameNumber)),1<t.length)N=v;else{N=[];let e=v[0]?.frameNumber;for(let t=1;t<=v.length;++t){const r=v[t]?.frameNumber;e!==r&&(N.push(v[t-1]),e=r)}}const A=new Set;for(let e=0;e<t.length;++e){const r=t[e].propertyKeyFrames;for(let e=0;e<r.length;++e){const t=r[e];for(let e=0;e<t.ikStates.length;++e)A.add(t.ikStates[e][0])}}const k=new y(N.length,A.size);{const e=new Array(A.size),t=new Map;let r=0;for(const s of A)e[r]=s,t.set(s,r),k.ikBoneNames[r]=s,r+=1;const s=new Uint8Array(A.size);for(let e=0;e<N.length;++e){const r=N[e];k.frameNumbers[e]=r.frameNumber,k.visibles[e]=r.visible?1:0;const n=k.ikStates,a=r.ikStates;s.fill(0);for(let r=0;r<a.length;++r){const o=a[r],i=t.get(o[0]);n[i][e]=o[1]?1:0,s[i]=1}for(let t=0;t<s.length;++t)if(0===s[t]){const r=n[t][e-1];n[t][e]=void 0===r?0:r}}}u.loaded=d+o,r?.({...u}),d+=o;const K=[];for(let e=0;e<t.length;++e){const r=t[e].cameraKeyFrames;for(let e=0;e<r.length;++e)K.push(r.get(e))}let B;if(K.sort(((e,t)=>e.frameNumber-t.frameNumber)),1<t.length)B=K;else{B=[];let e=K[0]?.frameNumber;for(let t=1;t<=K.length;++t){const r=K[t]?.frameNumber;e!==r&&(B.push(K[t-1]),e=r)}}const U=new f(B.length);for(let e=0;e<B.length;++e){const t=B[e],n=t.interpolation;U.frameNumbers[e]=t.frameNumber;const a=U.positions,o=t.position;a[3*e+0]=o[0],a[3*e+1]=o[1],a[3*e+2]=o[2];const i=U.positionInterpolations;i[12*e+0]=n[0],i[12*e+1]=n[1],i[12*e+2]=n[2],i[12*e+3]=n[3],i[12*e+4]=n[4],i[12*e+5]=n[5],i[12*e+6]=n[6],i[12*e+7]=n[7],i[12*e+8]=n[8],i[12*e+9]=n[9],i[12*e+10]=n[10],i[12*e+11]=n[11];const l=U.rotations,h=t.rotation;l[3*e+0]=h[0],l[3*e+1]=h[1],l[3*e+2]=h[2];const m=U.rotationInterpolations;m[4*e+0]=n[12],m[4*e+1]=n[13],m[4*e+2]=n[14],m[4*e+3]=n[15],U.distances[e]=t.distance;const c=U.distanceInterpolations;c[4*e+0]=n[16],c[4*e+1]=n[17],c[4*e+2]=n[18],c[4*e+3]=n[19],U.fovs[e]=t.fov;const f=U.fovInterpolations;f[4*e+0]=n[20],f[4*e+1]=n[21],f[4*e+2]=n[22],f[4*e+3]=n[23],e%1e3==0&&100<performance.now()-g&&(u.loaded=d+e,r?.({...u}),await s.w1W.DelayAsync(0),g=performance.now())}return u.loaded=d+l,r?.({...u}),d+=l,new i(e,b,_,F,k,U)}loadFromVmdData(e,t,r,s){Array.isArray(t)||(t=[t]);const n=[];for(let e=0;e<t.length;++e)n.push(p.Parse(t[e]));this.loadFromVmdObject(e,n,r,s)}loadFromVmdDataAsync(e,t,r){return new Promise((s=>{this.loadFromVmdData(e,t,s,r)}))}loadFromBuffer(e,t,r,s,n){Array.isArray(t)||(t=[t]);const a=[];for(let e=0;e<t.length;++e){const r=g.CheckedCreate(t[e]);if(null===r)return void n?.(new Error("VMD data validation failed."));a.push(r)}this.loadFromVmdData(e,a,r,s)}loadFromBufferAsync(e,t,r){return new Promise(((s,n)=>{this.loadFromBuffer(e,t,s,r,n)}))}load(e,t,r,n,a){Array.isArray(t)||(t=[t]);const o=this._scene,i=[],l=[];for(let h=0;h<t.length;++h){const m=t[h];l.push(o._loadFile(m,((o,l)=>{"string"==typeof o?a?.(void 0,new s.ehT("VMD data must be binary.")):(i.push(o),i.length===t.length&&this.loadFromBuffer(e,i,r,n,(e=>{a?.(void 0,e)})))}),n,!0,!0,a))}return 1===t.length?l[0]:l}loadAsync(e,t,r){return new Promise(((s,n)=>{this.load(e,t,s,r,((e,t)=>n({request:e,exception:t})))}))}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){s.YdH.Log(e)}_logDisabled(){}_warnEnabled(e){s.YdH.Warn(e)}_warnDisabled(){}_errorEnabled(e){s.YdH.Error(e)}_errorDisabled(){}}class _{static _LittleEndian=!0;_dataView;_encoder;_offset;constructor(e){this._dataView=new DataView(e),this._encoder=new TextEncoder,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}setUint8(e){this._dataView.setUint8(this._offset,e),this._offset+=1}setUint8Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setUint8(this._offset,e[r]),this._offset+=1}setInt8(e){this._dataView.setInt8(this._offset,e),this._offset+=1}setInt8Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setInt8(this._offset,e[r]),this._offset+=1}setUint16(e){this._dataView.setUint16(this._offset,e,_._LittleEndian),this._offset+=2}setUint16Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setUint16(this._offset,e[r],_._LittleEndian),this._offset+=2}setUint32(e){this._dataView.setUint32(this._offset,e,_._LittleEndian),this._offset+=4}setUint32Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setUint32(this._offset,e[r],_._LittleEndian),this._offset+=4}setInt32(e){this._dataView.setInt32(this._offset,e,_._LittleEndian),this._offset+=4}setInt32Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setInt32(this._offset,e[r],_._LittleEndian),this._offset+=4}setFloat32(e){this._dataView.setFloat32(this._offset,e,_._LittleEndian),this._offset+=4}setFloat32Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setFloat32(this._offset,e[r],_._LittleEndian),this._offset+=4}setString(e){const t=this._dataView,r=this._encoder.encode(e);t.setUint32(this._offset,r.length,_._LittleEndian),this._offset+=4;for(let e=0;e<r.length;++e)t.setUint8(this._offset,r[e]),this._offset+=1}get bytesAvailable(){return this._dataView.byteLength-this._offset}}class w{constructor(){}static Convert(e){const t=new TextEncoder;let r=7;{r+=4;const s=e.boneTracks.length;for(let n=0;n<s;n++){const s=e.boneTracks[n];r+=4+t.encode(s.name).length,r+=4,r+=4*s.frameNumbers.length,r+=16*s.frameNumbers.length,r+=16*s.frameNumbers.length}r+=4;const n=e.moveableBoneTracks.length;for(let s=0;s<n;s++){const n=e.moveableBoneTracks[s];r+=4+t.encode(n.name).length,r+=4,r+=4*n.frameNumbers.length,r+=12*n.frameNumbers.length,r+=48*n.frameNumbers.length,r+=16*n.frameNumbers.length,r+=16*n.frameNumbers.length}r+=4;const a=e.morphTracks.length;for(let s=0;s<a;s++){const n=e.morphTracks[s];r+=4+t.encode(n.name).length,r+=4,r+=4*n.frameNumbers.length,r+=4*n.frameNumbers.length}r+=4,r+=4*e.propertyTrack.frameNumbers.length,r+=1*e.propertyTrack.frameNumbers.length,r+=4;const o=e.propertyTrack.ikBoneNames.length;for(let s=0;s<o;s++){const n=e.propertyTrack.ikBoneNames[s];r+=4+t.encode(n).length}r+=1*o*e.propertyTrack.frameNumbers.length,r+=4,r+=4*e.cameraTrack.frameNumbers.length,r+=12*e.cameraTrack.frameNumbers.length,r+=48*e.cameraTrack.frameNumbers.length,r+=12*e.cameraTrack.frameNumbers.length,r+=16*e.cameraTrack.frameNumbers.length,r+=4*e.cameraTrack.frameNumbers.length,r+=16*e.cameraTrack.frameNumbers.length,r+=4*e.cameraTrack.frameNumbers.length,r+=16*e.cameraTrack.frameNumbers.length}const s=new ArrayBuffer(r),n=new _(s);n.setUint8Array(t.encode("BVMD")),n.setInt8Array([1,0,0]);const a=e.boneTracks;n.setUint32(a.length);for(let e=0;e<a.length;e++){const t=a[e];n.setString(t.name),n.setUint32(t.frameNumbers.length),n.setUint32Array(t.frameNumbers),n.setFloat32Array(t.rotations),n.setUint8Array(t.rotationInterpolations)}const o=e.moveableBoneTracks;n.setUint32(o.length);for(let e=0;e<o.length;e++){const t=o[e];n.setString(t.name),n.setUint32(t.frameNumbers.length),n.setUint32Array(t.frameNumbers),n.setFloat32Array(t.positions),n.setUint8Array(t.positionInterpolations),n.setFloat32Array(t.rotations),n.setUint8Array(t.rotationInterpolations)}const i=e.morphTracks;n.setUint32(i.length);for(let e=0;e<i.length;e++){const t=i[e];n.setString(t.name),n.setUint32(t.frameNumbers.length),n.setUint32Array(t.frameNumbers),n.setFloat32Array(t.weights)}n.setUint32(e.propertyTrack.frameNumbers.length),n.setUint32(e.propertyTrack.ikBoneNames.length),n.setUint32Array(e.propertyTrack.frameNumbers),n.setUint8Array(e.propertyTrack.visibles);const l=e.propertyTrack.ikBoneNames;for(let t=0;t<l.length;t++){const r=l[t];n.setString(r),n.setUint8Array(e.propertyTrack.ikStates[t])}return n.setUint32(e.cameraTrack.frameNumbers.length),n.setUint32Array(e.cameraTrack.frameNumbers),n.setFloat32Array(e.cameraTrack.positions),n.setUint8Array(e.cameraTrack.positionInterpolations),n.setFloat32Array(e.cameraTrack.rotations),n.setUint8Array(e.cameraTrack.rotationInterpolations),n.setFloat32Array(e.cameraTrack.distances),n.setUint8Array(e.cameraTrack.distanceInterpolations),n.setFloat32Array(e.cameraTrack.fovs),n.setUint8Array(e.cameraTrack.fovInterpolations),s}}o();const F=document.getElementById("render-canvas");if(!(F instanceof HTMLCanvasElement))throw new Error("Invalid canvas element");const v=new s.D4V(F,!0,{preserveDrawingBuffer:!0,stencil:!0,antialias:!0,powerPreference:"high-performance",doNotHandleContextLost:!0},!0);n.Create({canvas:F,engine:v,sceneBuilder:new class{async build(e,t){t.setHardwareScalingLevel(1e3);const r=new s.xsS(t);new s.cEJ("camera1",new s.Pa4(0,5,-10),r);const n=document.createElement("div");n.style.position="absolute",n.style.top="0",n.style.left="0",n.style.backgroundColor="white",n.style.width="100%",n.style.height="100%",n.style.display="flex",n.style.flexDirection="column",n.style.justifyContent="center",n.style.alignItems="center",n.style.fontFamily="sans-serif",e.parentElement.appendChild(n);const a=document.createElement("div");a.style.width="auto",a.style.height="100%",a.style.display="flex",a.style.flexDirection="column",a.style.justifyContent="center",a.style.alignItems="start",n.appendChild(a);const o=new b(r);o.loggingEnabled=!0;const i=[],l=document.createElement("h1");l.textContent="VMD to BVMD Converter",l.style.width="500px",l.style.textAlign="center",a.appendChild(l);const h=document.createElement("ul");a.appendChild(h),h.style.width="100%",h.style.height="auto",h.style.fontSize="20px";const m=()=>{h.innerHTML="";for(const e of i){const t=document.createElement("li");t.textContent=e.name,h.appendChild(t)}};m();const c=document.createElement("input");c.style.width="100%",c.style.height="80px",c.style.display="block",c.style.backgroundColor="black",c.style.color="white",c.style.marginBottom="10px",c.style.fontSize="20px",c.type="file",c.accept=".vmd",c.multiple=!0,c.onchange=()=>{if(null!==c.files){for(const e of c.files)e.name.endsWith(".vmd")&&i.push(e);m()}},a.appendChild(c);const f=document.createElement("button");return f.textContent="Convert",f.style.width="100%",f.style.height="60px",f.style.border="none",f.style.fontSize="20px",f.onclick=async()=>{if(0===i.length)return void alert("Please select a VMD file");f.textContent="Converting...";const e=await o.loadAsync(i[0].name,i),t=w.Convert(e),r=new Blob([t],{type:"application/octet-stream"}),s=URL.createObjectURL(r),n=document.createElement("a");n.href=s,n.download=`${i[0].name.substring(0,i[0].name.lastIndexOf("."))}.bvmd`,n.click(),URL.revokeObjectURL(s),n.remove(),i.length=0,m(),f.textContent="Convert"},a.appendChild(f),r}}}).then((e=>e.run()))}},r={};function s(e){var n=r[e];if(void 0!==n)return n.exports;var a=r[e]={exports:{}};return t[e](a,a.exports,s),a.exports}s.m=t,e=[],s.O=(t,r,n,a)=>{if(!r){var o=1/0;for(m=0;m<e.length;m++){for(var[r,n,a]=e[m],i=!0,l=0;l<r.length;l++)(!1&a||o>=a)&&Object.keys(s.O).every((e=>s.O[e](r[l])))?r.splice(l--,1):(i=!1,a<o&&(o=a));if(i){e.splice(m--,1);var h=n();void 0!==h&&(t=h)}}return t}a=a||0;for(var m=e.length;m>0&&e[m-1][2]>a;m--)e[m]=e[m-1];e[m]=[r,n,a]},s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={179:0};s.O.j=t=>0===e[t];var t=(t,r)=>{var n,a,[o,i,l]=r,h=0;if(o.some((t=>0!==e[t]))){for(n in i)s.o(i,n)&&(s.m[n]=i[n]);if(l)var m=l(s)}for(t&&t(r);h<o.length;h++)a=o[h],s.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return s.O(m)},r=self.webpackChunkbabylon_mmd=self.webpackChunkbabylon_mmd||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})();var n=s.O(void 0,[216],(()=>s(896)));n=s.O(n)})();