(()=>{var e,t={110:()=>{},737:(e,t,r)=>{"use strict";var s=r(352);class n{_canvas;_engine;_scene;_onTick;constructor(e){this._canvas=e.canvas,this._engine=e.engine,this._scene=null,this._onTick=null}static async Create(e){const t=new n(e);return t._scene=await t._initialize(e.sceneBuilder),t._onTick=t._makeOnTick(),t}run(){const e=this._engine;window.addEventListener("resize",this._onResize),e.runRenderLoop(this._onTick)}dispose(){window.removeEventListener("resize",this._onResize),this._engine.dispose()}_onResize=()=>{this._engine.resize()};async _initialize(e){return await e.build(this._canvas,this._engine)}_makeOnTick(){const e=this._scene;return()=>e.render()}}var a=r(110),o=r.n(a),i=r(576),l=r(412),h=r(405);class m{static _LittleEndian=!0;_dataView;_encoder;_offset;constructor(e){this._dataView=new DataView(e),this._encoder=new TextEncoder,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}setUint8(e){this._dataView.setUint8(this._offset,e),this._offset+=1}setUint8Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setUint8(this._offset,e[r]),this._offset+=1}setInt8(e){this._dataView.setInt8(this._offset,e),this._offset+=1}setInt8Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setInt8(this._offset,e[r]),this._offset+=1}setUint16(e){this._dataView.setUint16(this._offset,e,m._LittleEndian),this._offset+=2}setUint16Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setUint16(this._offset,e[r],m._LittleEndian),this._offset+=2}setUint32(e){this._dataView.setUint32(this._offset,e,m._LittleEndian),this._offset+=4}setUint32Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setUint32(this._offset,e[r],m._LittleEndian),this._offset+=4}setInt32(e){this._dataView.setInt32(this._offset,e,m._LittleEndian),this._offset+=4}setInt32Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setInt32(this._offset,e[r],m._LittleEndian),this._offset+=4}setFloat32(e){this._dataView.setFloat32(this._offset,e,m._LittleEndian),this._offset+=4}setFloat32Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setFloat32(this._offset,e[r],m._LittleEndian),this._offset+=4}setString(e){const t=this._dataView,r=this._encoder.encode(e);t.setUint32(this._offset,r.length,m._LittleEndian),this._offset+=4;for(let e=0;e<r.length;++e)t.setUint8(this._offset,r[e]),this._offset+=1}get bytesAvailable(){return this._dataView.byteLength-this._offset}}class c{constructor(){}static Convert(e){const t=new TextEncoder;let r=7;{r+=4;const s=e.boneTracks.length;for(let n=0;n<s;n++){const s=e.boneTracks[n];r+=4+t.encode(s.name).length,r+=4,r+=4*s.frameNumbers.length,r+=16*s.frameNumbers.length,r+=4*s.frameNumbers.length}r+=4;const n=e.moveableBoneTracks.length;for(let s=0;s<n;s++){const n=e.moveableBoneTracks[s];r+=4+t.encode(n.name).length,r+=4,r+=4*n.frameNumbers.length,r+=12*n.frameNumbers.length,r+=12*n.frameNumbers.length,r+=16*n.frameNumbers.length,r+=4*n.frameNumbers.length}r+=4;const a=e.morphTracks.length;for(let s=0;s<a;s++){const n=e.morphTracks[s];r+=4+t.encode(n.name).length,r+=4,r+=4*n.frameNumbers.length,r+=4*n.frameNumbers.length}r+=4,r+=4*e.propertyTrack.frameNumbers.length,r+=1*e.propertyTrack.frameNumbers.length,r+=4;const o=e.propertyTrack.ikBoneNames.length;for(let s=0;s<o;s++){const n=e.propertyTrack.ikBoneNames[s];r+=4+t.encode(n).length}r+=1*o*e.propertyTrack.frameNumbers.length,r+=4,r+=4*e.cameraTrack.frameNumbers.length,r+=12*e.cameraTrack.frameNumbers.length,r+=12*e.cameraTrack.frameNumbers.length,r+=12*e.cameraTrack.frameNumbers.length,r+=4*e.cameraTrack.frameNumbers.length,r+=4*e.cameraTrack.frameNumbers.length,r+=4*e.cameraTrack.frameNumbers.length,r+=4*e.cameraTrack.frameNumbers.length,r+=4*e.cameraTrack.frameNumbers.length}const s=new ArrayBuffer(r),n=new m(s);n.setUint8Array(t.encode("BVMD")),n.setInt8Array([1,0,0]);const a=e.boneTracks;n.setUint32(a.length);for(let e=0;e<a.length;e++){const t=a[e];n.setString(t.name),n.setUint32(t.frameNumbers.length),n.setUint32Array(t.frameNumbers),n.setFloat32Array(t.rotations),n.setUint8Array(t.rotationInterpolations)}const o=e.moveableBoneTracks;n.setUint32(o.length);for(let e=0;e<o.length;e++){const t=o[e];n.setString(t.name),n.setUint32(t.frameNumbers.length),n.setUint32Array(t.frameNumbers),n.setFloat32Array(t.positions),n.setUint8Array(t.positionInterpolations),n.setFloat32Array(t.rotations),n.setUint8Array(t.rotationInterpolations)}const i=e.morphTracks;n.setUint32(i.length);for(let e=0;e<i.length;e++){const t=i[e];n.setString(t.name),n.setUint32(t.frameNumbers.length),n.setUint32Array(t.frameNumbers),n.setFloat32Array(t.weights)}n.setUint32(e.propertyTrack.frameNumbers.length),n.setUint32(e.propertyTrack.ikBoneNames.length),n.setUint32Array(e.propertyTrack.frameNumbers),n.setUint8Array(e.propertyTrack.visibles);const l=e.propertyTrack.ikBoneNames;for(let t=0;t<l.length;t++){const r=l[t];n.setString(r),n.setUint8Array(e.propertyTrack.ikStates[t])}return n.setUint32(e.cameraTrack.frameNumbers.length),n.setUint32Array(e.cameraTrack.frameNumbers),n.setFloat32Array(e.cameraTrack.positions),n.setUint8Array(e.cameraTrack.positionInterpolations),n.setFloat32Array(e.cameraTrack.rotations),n.setUint8Array(e.cameraTrack.rotationInterpolations),n.setFloat32Array(e.cameraTrack.distances),n.setUint8Array(e.cameraTrack.distanceInterpolations),n.setFloat32Array(e.cameraTrack.fovs),n.setUint8Array(e.cameraTrack.fovInterpolations),s}}var f=r(882),y=r(658),u=r(114);class d{name;boneTracks;moveableBoneTracks;morphTracks;propertyTrack;cameraTrack;startFrame;endFrame;constructor(e,t,r,s,n,a){this.name=e,this.boneTracks=t,this.moveableBoneTracks=r,this.morphTracks=s,this.propertyTrack=n,this.cameraTrack=a;let o=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER;for(let e=0;e<t.length;++e){const r=t[e];o=Math.min(o,r.startFrame),i=Math.max(i,r.endFrame)}for(let e=0;e<r.length;++e){const t=r[e];o=Math.min(o,t.startFrame),i=Math.max(i,t.endFrame)}for(let e=0;e<s.length;++e){const t=s[e];o=Math.min(o,t.startFrame),i=Math.max(i,t.endFrame)}o=Math.min(o,n.startFrame),i=Math.max(i,n.endFrame),o=Math.min(o,a.startFrame),i=Math.max(i,a.endFrame),this.startFrame=o,this.endFrame=i}validate(){const e=this.boneTracks;for(let t=0;t<e.length;++t)if(!e[t].validate())return!1;const t=this.moveableBoneTracks;for(let e=0;e<t.length;++e)if(!t[e].validate())return!1;const r=this.morphTracks;for(let e=0;e<r.length;++e)if(!r[e].validate())return!1;return this.propertyTrack.validate()&&this.cameraTrack.validate()}}class g{trackType;name;frameNumbers;constructor(e,t,r){this.trackType=e,this.name=t,this.frameNumbers=new Uint32Array(r)}validate(){for(let e=1;e<this.frameNumbers.length;++e)if(this.frameNumbers[e-1]>=this.frameNumbers[e])return!1;return!0}get startFrame(){return 0===this.frameNumbers.length?0:this.frameNumbers[0]}get endFrame(){return 0===this.frameNumbers.length?0:this.frameNumbers[this.frameNumbers.length-1]}}class p extends g{rotations;rotationInterpolations;constructor(e,t){super("bone",e,t),this.rotations=new Float32Array(4*t),this.rotationInterpolations=new Uint8Array(4*t)}}class b extends g{positions;positionInterpolations;rotations;rotationInterpolations;constructor(e,t){super("moveableBone",e,t),this.positions=new Float32Array(3*t),this.positionInterpolations=new Uint8Array(12*t),this.rotations=new Float32Array(4*t),this.rotationInterpolations=new Uint8Array(4*t)}}class _ extends g{weights;constructor(e,t){super("morph",e,t),this.weights=new Float32Array(t)}}class w extends g{positions;positionInterpolations;rotations;rotationInterpolations;distances;distanceInterpolations;fovs;fovInterpolations;constructor(e){super("camera","cameraTrack",e),this.positions=new Float32Array(3*e),this.positionInterpolations=new Uint8Array(12*e),this.rotations=new Float32Array(3*e),this.rotationInterpolations=new Uint8Array(4*e),this.distances=new Float32Array(e),this.distanceInterpolations=new Uint8Array(4*e),this.fovs=new Float32Array(e),this.fovInterpolations=new Uint8Array(4*e)}}class F extends g{visibles;ikBoneNames;ikStates;constructor(e,t){super("property","propertyTrack",e),this.visibles=new Uint8Array(e),this.ikBoneNames=new Array(t),this.ikStates=new Array(t);for(let r=0;r<t;++r)this.ikStates[r]=new Uint8Array(e)}}class v{log(e){console.log(e)}warn(e){console.warn(e)}error(e){console.error(e)}}class N{static _LittleEndian=!0;_dataView;_decoder;_offset;constructor(e){this._dataView=new DataView(e),this._decoder=null,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}getUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}getInt8(){const e=this._dataView.getInt8(this._offset);return this._offset+=1,e}getUint8Array(e,t){for(let r=0;r<t;++r)e[r]=this._dataView.getUint8(this._offset),this._offset+=1}getUint16(){const e=this._dataView.getUint16(this._offset,N._LittleEndian);return this._offset+=2,e}getUint16Array(e,t){for(let r=0;r<t;++r)e[r]=this._dataView.getUint16(this._offset,N._LittleEndian),this._offset+=2}getInt16(){const e=this._dataView.getInt16(this._offset,N._LittleEndian);return this._offset+=2,e}getUint32(){const e=this._dataView.getUint32(this._offset,N._LittleEndian);return this._offset+=4,e}getUint32Array(e,t){for(let r=0;r<t;++r)e[r]=this._dataView.getUint32(this._offset,N._LittleEndian),this._offset+=4}getInt32(){const e=this._dataView.getInt32(this._offset,N._LittleEndian);return this._offset+=4,e}getInt32Array(e,t){for(let r=0;r<t;++r)e[r]=this._dataView.getInt32(this._offset,N._LittleEndian),this._offset+=4}getFloat32(){const e=this._dataView.getFloat32(this._offset,N._LittleEndian);return this._offset+=4,e}getFloat32Array(e,t){for(let r=0;r<t;++r)e[r]=this._dataView.getFloat32(this._offset,N._LittleEndian),this._offset+=4}getFloat32Tuple(e){const t=new Array(e);for(let r=0;r<e;++r)t[r]=this._dataView.getFloat32(this._offset,N._LittleEndian),this._offset+=4;return t}initializeTextDecoder(e){this._decoder=new TextDecoder(e)}getDecoderString(e,t){if(null===this._decoder)throw new Error("TextDecoder is not initialized.");let r=new Uint8Array(this._dataView.buffer,this._offset,e);if(this._offset+=e,t)for(let e=0;e<r.length;++e)if(0===r[e]){r=r.subarray(0,e);break}return this._decoder.decode(r)}getSignatureString(e){const t=new TextDecoder("utf-8"),r=new Uint8Array(this._dataView.buffer,this._offset,e);return this._offset+=e,t.decode(r)}get bytesAvailable(){return this._dataView.byteLength-this._offset}}class A{static _Signature="Vocaloid Motion Data 0002";static SignatureBytes=30;static ModelNameBytes=20;static BoneKeyFrameBytes=111;static MorphKeyFrameBytes=23;static CameraKeyFrameBytes=61;static LightKeyFrameBytes=28;static SelfShadowKeyFrameBytes=9;static PropertyKeyFrameBytes=5;static PropertyKeyFrameIkStateBytes=21;dataDeserializer;boneKeyFrameCount;morphKeyFrameCount;cameraKeyFrameCount;lightKeyFrameCount;selfShadowKeyFrameCount;propertyKeyFrameCount;constructor(e,t,r,s,n,a,o){this.dataDeserializer=e,this.boneKeyFrameCount=t,this.morphKeyFrameCount=r,this.cameraKeyFrameCount=s,this.lightKeyFrameCount=n,this.selfShadowKeyFrameCount=a,this.propertyKeyFrameCount=o}static CheckedCreate(e,t=new v){const r=new N(e);if(r.initializeTextDecoder("shift-jis"),r.bytesAvailable<A.SignatureBytes+A.ModelNameBytes)return null;if(r.getSignatureString(this.SignatureBytes).substring(0,this._Signature.length)!==this._Signature)return null;if(r.offset+=A.ModelNameBytes,r.bytesAvailable<4)return null;const s=r.getUint32();if(r.bytesAvailable<s*A.BoneKeyFrameBytes)return null;if(r.offset+=s*A.BoneKeyFrameBytes,r.bytesAvailable<4)return null;const n=r.getUint32();if(r.bytesAvailable<n*A.MorphKeyFrameBytes)return null;if(r.offset+=n*A.MorphKeyFrameBytes,r.bytesAvailable<4)return null;const a=r.getUint32();if(r.bytesAvailable<a*A.CameraKeyFrameBytes)return null;if(r.offset+=a*A.CameraKeyFrameBytes,r.bytesAvailable<4)return null;const o=r.getUint32();if(r.bytesAvailable<o*A.LightKeyFrameBytes)return null;if(r.offset+=o*A.LightKeyFrameBytes,r.bytesAvailable<4)return null;const i=r.getUint32();if(r.bytesAvailable<i*A.SelfShadowKeyFrameBytes)return null;if(r.offset+=i*A.SelfShadowKeyFrameBytes,0===r.bytesAvailable)return new A(r,s,n,a,o,i,0);if(r.bytesAvailable<4)return null;const l=r.getUint32();for(let e=0;e<l;++e){if(r.bytesAvailable<A.PropertyKeyFrameBytes)return null;if(r.offset+=A.PropertyKeyFrameBytes,r.bytesAvailable<4)return null;const e=r.getUint32();if(r.bytesAvailable<e*A.PropertyKeyFrameIkStateBytes)return null;r.offset+=e*A.PropertyKeyFrameIkStateBytes}return r.bytesAvailable>0&&t.warn(`There are ${r.bytesAvailable} bytes left after parsing`),r.offset=0,new A(r,s,n,a,o,i,l)}}class k{propertyKeyFrames;_vmdData;constructor(e,t){this._vmdData=e,this.propertyKeyFrames=t}static Parse(e){const t=e.dataDeserializer,r=[];t.offset=A.SignatureBytes+A.ModelNameBytes+4+e.boneKeyFrameCount*A.BoneKeyFrameBytes+4+e.morphKeyFrameCount*A.MorphKeyFrameBytes+4+e.cameraKeyFrameCount*A.CameraKeyFrameBytes+4+e.lightKeyFrameCount*A.LightKeyFrameBytes+4+e.selfShadowKeyFrameCount*A.SelfShadowKeyFrameBytes+4;const s=e.propertyKeyFrameCount;for(let e=0;e<s;++e){const e=t.getUint32(),s=0!==t.getUint8(),n=t.getUint32(),a=[];for(let e=0;e<n;e++){const e=t.getDecoderString(20,!0),r=0!==t.getUint8();a.push([e,r])}const o={frameNumber:e,visible:s,ikStates:a};r.push(o)}return new k(e,r)}static ParseFromBuffer(e){const t=A.CheckedCreate(e);if(null===t)throw new Error("Invalid VMD data");return k.Parse(t)}get boneKeyFrames(){const e=A.SignatureBytes+A.ModelNameBytes+4;return new k.BoneKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.boneKeyFrameCount)}get morphKeyFrames(){const e=A.SignatureBytes+A.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*A.BoneKeyFrameBytes+4;return new k.MorphKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.morphKeyFrameCount)}get cameraKeyFrames(){const e=A.SignatureBytes+A.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*A.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*A.MorphKeyFrameBytes+4;return new k.CameraKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.cameraKeyFrameCount)}get lightKeyFrames(){const e=A.SignatureBytes+A.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*A.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*A.MorphKeyFrameBytes+4+this._vmdData.cameraKeyFrameCount*A.CameraKeyFrameBytes+4;return new k.LightKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.lightKeyFrameCount)}get selfShadowKeyFrames(){const e=A.SignatureBytes+A.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*A.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*A.MorphKeyFrameBytes+4+this._vmdData.cameraKeyFrameCount*A.CameraKeyFrameBytes+4+this._vmdData.lightKeyFrameCount*A.LightKeyFrameBytes+4;return new k.SelfShadowKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.selfShadowKeyFrameCount)}}!function(e){class t{_dataDeserializer;_startOffset;_length;constructor(e,t,r){this._dataDeserializer=e,this._startOffset=t,this._length=r}get length(){return this._length}}e.BufferArrayReader=t,e.BoneKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*A.BoneKeyFrameBytes;return new r(this._dataDeserializer,t)}};class r{boneName;frameNumber;position;rotation;interpolation;constructor(e,t){e.offset=t,this.boneName=e.getDecoderString(15,!0),this.frameNumber=e.getUint32(),this.position=e.getFloat32Tuple(3),this.rotation=e.getFloat32Tuple(4),this.interpolation=new Uint8Array(64);for(let t=0;t<64;++t)this.interpolation[t]=e.getUint8()}}e.BoneKeyFrame=r,e.MorphKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*A.MorphKeyFrameBytes;return new s(this._dataDeserializer,t)}};class s{morphName;frameNumber;weight;constructor(e,t){e.offset=t,this.morphName=e.getDecoderString(15,!0),this.frameNumber=e.getUint32(),this.weight=e.getFloat32()}}e.MorphKeyFrame=s,e.CameraKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*A.CameraKeyFrameBytes;return new n(this._dataDeserializer,t)}};class n{frameNumber;distance;position;rotation;interpolation;fov;perspective;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.distance=e.getFloat32(),this.position=e.getFloat32Tuple(3),this.rotation=e.getFloat32Tuple(3),this.interpolation=new Uint8Array(24);for(let t=0;t<24;++t)this.interpolation[t]=e.getUint8();this.fov=e.getUint32(),this.perspective=0!==e.getUint8()}}e.CameraKeyFrame=n,e.LightKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*A.LightKeyFrameBytes;return new a(this._dataDeserializer,t)}};class a{frameNumber;color;direction;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.color=e.getFloat32Tuple(3),this.direction=e.getFloat32Tuple(3)}}e.LightKeyFrame=a,e.SelfShadowKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*A.SelfShadowKeyFrameBytes;return new o(this._dataDeserializer,t)}};class o{frameNumber;mode;distance;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.mode=e.getUint8(),this.distance=e.getFloat32()}}e.SelfShadowKeyFrame=o}(k||(k={}));class K{_scene;_loggingEnabled;log;warn;error;constructor(e){this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._scene=e}loadFromVmdObject(e,t,r,s){this.loadFromVmdObjectAsync(e,t,s).then(r)}async loadFromVmdObjectAsync(e,t,r){Array.isArray(t)||(t=[t]);let s=0,n=0,a=0,o=0;for(let e=0;e<t.length;++e){const r=t[e];s+=r.boneKeyFrames.length,n+=r.morphKeyFrames.length,a+=r.propertyKeyFrames.length,o+=r.cameraKeyFrames.length}const i={lengthComputable:!0,loaded:0,total:s+n+a+o};let l=0,h=performance.now();const m=[];{const e=new Map,s=[],n=[],a=[];for(let e=0;e<t.length;++e){const r=t[e].boneKeyFrames,s=r.length;for(let e=0;e<s;++e)a.push(r.get(e))}100<performance.now()-h&&(await u.w1.DelayAsync(0),h=performance.now());const o=a.length;for(let t=0;t<o;++t){const r=a[t].boneName;let o=e.get(r);void 0===o&&(o=e.size,e.set(r,o),s.push(0),n.push(r)),s[o]+=1}a.sort(((e,t)=>e.frameNumber-t.frameNumber));for(let t=0;t<e.size;++t)m.push(new b(n[t],s[t]));100<performance.now()-h&&(await u.w1.DelayAsync(0),h=performance.now());const c=new Uint32Array(e.size);for(let t=0;t<o;++t){const s=a[t],n=e.get(s.boneName),o=m[n],f=c[n],y=s.interpolation;o.frameNumbers[f]=s.frameNumber;const d=o.positions,g=s.position;d[3*f+0]=g[0],d[3*f+1]=g[1],d[3*f+2]=g[2];const p=o.positionInterpolations;p[12*f+0]=y[0],p[12*f+1]=y[8],p[12*f+2]=y[4],p[12*f+3]=y[12],p[12*f+4]=y[16],p[12*f+5]=y[24],p[12*f+6]=y[20],p[12*f+7]=y[28],p[12*f+8]=y[32],p[12*f+9]=y[40],p[12*f+10]=y[36],p[12*f+11]=y[44];const b=o.rotations,_=s.rotation;b[4*f+0]=_[0],b[4*f+1]=_[1],b[4*f+2]=_[2],b[4*f+3]=_[3];const w=o.rotationInterpolations;w[4*f+0]=y[48],w[4*f+1]=y[56],w[4*f+2]=y[52],w[4*f+3]=y[60],c[n]+=1,t%1e3==0&&100<performance.now()-h&&(i.loaded=l+t,r?.({...i}),await u.w1.DelayAsync(0),h=performance.now())}}const c=[],f=[];for(let e=0;e<m.length;++e){const t=m[e];let r=!0;for(let e=0;e<t.frameNumbers.length;++e){const s=t.positions;if(0!==s[3*e+0]||0!==s[3*e+1]||0!==s[3*e+2]){r=!1;break}const n=t.rotations;if(0!==n[4*e+0]||0!==n[4*e+1]||0!==n[4*e+2]||1!==n[4*e+3]){r=!1;break}}if(r)continue;let s=!1;for(let e=0;e<t.positions.length;++e)if(0!==t.positions[e]){s=!0;break}if(s)f.push(t);else{const e=new p(t.name,t.frameNumbers.length);e.frameNumbers.set(t.frameNumbers),e.rotations.set(t.rotations),e.rotationInterpolations.set(t.rotationInterpolations),c.push(e)}}if(m.length=0,1<t.length){const e=new Int32Array(c.length).fill(-1);for(let t=0;t<c.length;++t){const r=c[t].frameNumbers;let s=0,n=r[0];for(let e=1;e<=r.length;++e){const t=r[e];n!==t&&(s+=1,n=t)}r.length!==s&&(e[t]=s)}for(let t=0;t<c.length;++t){const r=e[t];if(-1===r)continue;const s=c[t],n=s.frameNumbers,a=s.rotations,o=s.rotationInterpolations,i=new p(s.name,r);let l=0,h=n[0];for(let e=1;e<=n.length;++e){const t=n[e];if(h!==t){const r=e-1;i.frameNumbers[l]=h;const s=i.rotations;s[4*l+0]=a[4*r+0],s[4*l+1]=a[4*r+1],s[4*l+2]=a[4*r+2],s[4*l+3]=a[4*r+3];const n=i.rotationInterpolations;n[4*l+0]=o[4*r+0],n[4*l+1]=o[4*r+1],n[4*l+2]=o[4*r+2],n[4*l+3]=o[4*r+3],l+=1,h=t}}c[t]=i}const t=new Int32Array(f.length).fill(-1);for(let e=0;e<f.length;++e){const r=f[e].frameNumbers;let s=0,n=r[0];for(let e=1;e<=r.length;++e){const t=r[e];n!==t&&(s+=1,n=t)}r.length!==s&&(t[e]=s)}for(let e=0;e<f.length;++e){const r=t[e];if(-1===r)continue;const s=f[e],n=s.frameNumbers,a=s.positions,o=s.positionInterpolations,i=s.rotations,l=s.rotationInterpolations,h=new b(s.name,r);let m=0,c=n[0];for(let e=1;e<=n.length;++e){const t=n[e];if(c!==t){const r=e-1;h.frameNumbers[m]=c;const s=h.positions;s[3*m+0]=a[3*r+0],s[3*m+1]=a[3*r+1],s[3*m+2]=a[3*r+2];const n=h.positionInterpolations;n[12*m+0]=o[12*r+0],n[12*m+1]=o[12*r+1],n[12*m+2]=o[12*r+2],n[12*m+3]=o[12*r+3],n[12*m+4]=o[12*r+4],n[12*m+5]=o[12*r+5],n[12*m+6]=o[12*r+6],n[12*m+7]=o[12*r+7],n[12*m+8]=o[12*r+8],n[12*m+9]=o[12*r+9],n[12*m+10]=o[12*r+10],n[12*m+11]=o[12*r+11];const f=h.rotations;f[4*m+0]=i[4*r+0],f[4*m+1]=i[4*r+1],f[4*m+2]=i[4*r+2],f[4*m+3]=i[4*r+3];const y=h.rotationInterpolations;y[4*m+0]=l[4*r+0],y[4*m+1]=l[4*r+1],y[4*m+2]=l[4*r+2],y[4*m+3]=l[4*r+3],m+=1,c=t}}f[e]=h}}i.loaded=l+s,r?.({...i}),l+=s;const y=[];{const e=new Map,s=[],n=[],a=[];for(let e=0;e<t.length;++e){const r=t[e].morphKeyFrames,s=r.length;for(let e=0;e<s;++e)a.push(r.get(e))}100<performance.now()-h&&(await u.w1.DelayAsync(0),h=performance.now());const o=a.length;for(let t=0;t<o;++t){const r=a[t].morphName;let o=e.get(r);void 0===o&&(o=e.size,e.set(r,o),s.push(0),n.push(r)),s[o]+=1}a.sort(((e,t)=>e.frameNumber-t.frameNumber));for(let t=0;t<e.size;++t)y.push(new _(n[t],s[t]));100<performance.now()-h&&(await u.w1.DelayAsync(0),h=performance.now());const m=new Uint32Array(e.size);for(let t=0;t<o;++t){const s=a[t],n=e.get(s.morphName),o=y[n],c=m[n];o.frameNumbers[c]=s.frameNumber,o.weights[c]=s.weight,m[n]+=1,t%1e3==0&&100<performance.now()-h&&(i.loaded=l+t,r?.({...i}),await u.w1.DelayAsync(0),h=performance.now())}}const g=[];for(let e=0;e<y.length;++e){const t=y[e];let r=!0;for(let e=0;e<t.weights.length;++e)if(0!==t.weights[e]){r=!1;break}r||g.push(t)}if(y.length=0,1<t.length){const e=new Int32Array(g.length).fill(-1);for(let t=0;t<g.length;++t){const r=g[t].frameNumbers;let s=0,n=r[0];for(let e=1;e<=r.length;++e){const t=r[e];n!==t&&(s+=1,n=t)}r.length!==s&&(e[t]=s)}for(let t=0;t<g.length;++t){const r=e[t];if(-1===r)continue;const s=g[t],n=s.frameNumbers,a=s.weights,o=new _(s.name,r);let i=0,l=n[0];for(let e=1;e<=n.length;++e){const t=n[e];l!==t&&(o.frameNumbers[i]=l,o.weights[i]=a[e-1],i+=1,l=t)}g[t]=o}}i.loaded=l+n,r?.({...i}),l+=n;const v=[];for(let e=0;e<t.length;++e){const r=t[e].propertyKeyFrames;for(let e=0;e<r.length;++e)v.push(r[e])}let N;if(v.sort(((e,t)=>e.frameNumber-t.frameNumber)),1<t.length)N=v;else{N=[];let e=v[0]?.frameNumber;for(let t=1;t<=v.length;++t){const r=v[t]?.frameNumber;e!==r&&(N.push(v[t-1]),e=r)}}const A=new Set;for(let e=0;e<t.length;++e){const r=t[e].propertyKeyFrames;for(let e=0;e<r.length;++e){const t=r[e];for(let e=0;e<t.ikStates.length;++e)A.add(t.ikStates[e][0])}}const k=new F(N.length,A.size);{const e=new Array(A.size),t=new Map;let r=0;for(const s of A)e[r]=s,t.set(s,r),k.ikBoneNames[r]=s,r+=1;const s=new Uint8Array(A.size);for(let e=0;e<N.length;++e){const r=N[e];k.frameNumbers[e]=r.frameNumber,k.visibles[e]=r.visible?1:0;const n=k.ikStates,a=r.ikStates;s.fill(0);for(let r=0;r<a.length;++r){const o=a[r],i=t.get(o[0]);n[i][e]=o[1]?1:0,s[i]=1}for(let t=0;t<s.length;++t)if(0===s[t]){const r=n[t][e-1];n[t][e]=void 0===r?0:r}}}i.loaded=l+a,r?.({...i}),l+=a;const K=[];for(let e=0;e<t.length;++e){const r=t[e].cameraKeyFrames;for(let e=0;e<r.length;++e)K.push(r.get(e))}let B;if(K.sort(((e,t)=>e.frameNumber-t.frameNumber)),1<t.length)B=K;else{B=[];let e=K[0]?.frameNumber;for(let t=1;t<=K.length;++t){const r=K[t]?.frameNumber;e!==r&&(B.push(K[t-1]),e=r)}}const U=new w(B.length);for(let e=0;e<B.length;++e){const t=B[e],s=t.interpolation;U.frameNumbers[e]=t.frameNumber;const n=U.positions,a=t.position;n[3*e+0]=a[0],n[3*e+1]=a[1],n[3*e+2]=a[2];const o=U.positionInterpolations;o[12*e+0]=s[0],o[12*e+1]=s[1],o[12*e+2]=s[2],o[12*e+3]=s[3],o[12*e+4]=s[4],o[12*e+5]=s[5],o[12*e+6]=s[6],o[12*e+7]=s[7],o[12*e+8]=s[8],o[12*e+9]=s[9],o[12*e+10]=s[10],o[12*e+11]=s[11];const m=U.rotations,c=t.rotation;m[3*e+0]=c[0],m[3*e+1]=c[1],m[3*e+2]=c[2];const f=U.rotationInterpolations;f[4*e+0]=s[12],f[4*e+1]=s[13],f[4*e+2]=s[14],f[4*e+3]=s[15],U.distances[e]=t.distance;const y=U.distanceInterpolations;y[4*e+0]=s[16],y[4*e+1]=s[17],y[4*e+2]=s[18],y[4*e+3]=s[19],U.fovs[e]=t.fov;const d=U.fovInterpolations;d[4*e+0]=s[20],d[4*e+1]=s[21],d[4*e+2]=s[22],d[4*e+3]=s[23],e%1e3==0&&100<performance.now()-h&&(i.loaded=l+e,r?.({...i}),await u.w1.DelayAsync(0),h=performance.now())}return i.loaded=l+o,r?.({...i}),l+=o,new d(e,c,f,g,k,U)}loadFromVmdData(e,t,r,s){Array.isArray(t)||(t=[t]);const n=[];for(let e=0;e<t.length;++e)n.push(k.Parse(t[e]));this.loadFromVmdObject(e,n,r,s)}loadFromVmdDataAsync(e,t,r){return new Promise((s=>{this.loadFromVmdData(e,t,s,r)}))}loadFromBuffer(e,t,r,s,n){Array.isArray(t)||(t=[t]);const a=[];for(let e=0;e<t.length;++e){const r=A.CheckedCreate(t[e]);if(null===r)return void n?.(new Error("VMD data validation failed."));a.push(r)}this.loadFromVmdData(e,a,r,s)}loadFromBufferAsync(e,t,r){return new Promise(((s,n)=>{this.loadFromBuffer(e,t,s,r,n)}))}load(e,t,r,s,n){Array.isArray(t)||(t=[t]);const a=this._scene,o=[],i=[];for(let l=0;l<t.length;++l){const h=t[l];i.push(a._loadFile(h,((a,i)=>{"string"==typeof a?n?.(void 0,new f.eh("VMD data must be binary.")):(o.push(a),o.length===t.length&&this.loadFromBuffer(e,o,r,s,(e=>{n?.(void 0,e)})))}),s,!0,!0,n))}return 1===t.length?i[0]:i}loadAsync(e,t,r){return new Promise(((s,n)=>{this.load(e,t,s,r,((e,t)=>n({request:e,exception:t})))}))}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){y.Y.Log(e)}_logDisabled(){}_warnEnabled(e){y.Y.Warn(e)}_warnDisabled(){}_errorEnabled(e){y.Y.Error(e)}_errorDisabled(){}}o();const B=document.getElementById("render-canvas");if(!(B instanceof HTMLCanvasElement))throw new Error("Invalid canvas element");const U=new s.D(B,!1,{preserveDrawingBuffer:!0,stencil:!0,antialias:!0,powerPreference:"high-performance",doNotHandleContextLost:!0},!0);n.Create({canvas:B,engine:U,sceneBuilder:new class{async build(e,t){t.setHardwareScalingLevel(1e3);const r=new h.x(t);new i.c("camera1",new l.P(0,5,-10),r);const s=document.createElement("div");s.style.position="absolute",s.style.top="0",s.style.left="0",s.style.backgroundColor="white",s.style.width="100%",s.style.height="100%",s.style.display="flex",s.style.flexDirection="column",s.style.justifyContent="center",s.style.alignItems="center",s.style.fontFamily="sans-serif",e.parentElement.appendChild(s);const n=document.createElement("div");n.style.width="auto",n.style.height="100%",n.style.display="flex",n.style.flexDirection="column",n.style.justifyContent="center",n.style.alignItems="start",s.appendChild(n);const a=new K(r);a.loggingEnabled=!0;const o=[],m=document.createElement("h1");m.textContent="VMD to BVMD Converter",m.style.width="500px",m.style.textAlign="center",n.appendChild(m);const f=document.createElement("ul");n.appendChild(f),f.style.width="100%",f.style.height="auto",f.style.fontSize="20px";const y=()=>{f.innerHTML="";for(const e of o){const t=document.createElement("li");t.textContent=e.name,f.appendChild(t)}};y();const u=document.createElement("input");u.style.width="100%",u.style.height="80px",u.style.display="block",u.style.backgroundColor="black",u.style.color="white",u.style.marginBottom="10px",u.style.fontSize="20px",u.type="file",u.accept=".vmd",u.multiple=!0,u.onchange=()=>{if(null!==u.files){for(const e of u.files)e.name.endsWith(".vmd")&&o.push(e);y()}},n.appendChild(u);const d=document.createElement("button");return d.textContent="Convert",d.style.width="100%",d.style.height="60px",d.style.border="none",d.style.fontSize="20px",d.onclick=async()=>{if(0===o.length)return void alert("Please select a VMD file");d.textContent="Converting...";const e=await a.loadAsync(o[0].name,o),t=c.Convert(e),r=new Blob([t],{type:"application/octet-stream"}),s=URL.createObjectURL(r),n=document.createElement("a");n.href=s,n.download=`${o[0].name.substring(0,o[0].name.lastIndexOf("."))}.bvmd`,n.click(),URL.revokeObjectURL(s),n.remove(),o.length=0,y(),d.textContent="Convert"},n.appendChild(d),r}}}).then((e=>e.run()))}},r={};function s(e){var n=r[e];if(void 0!==n)return n.exports;var a=r[e]={exports:{}};return t[e](a,a.exports,s),a.exports}s.m=t,e=[],s.O=(t,r,n,a)=>{if(!r){var o=1/0;for(m=0;m<e.length;m++){for(var[r,n,a]=e[m],i=!0,l=0;l<r.length;l++)(!1&a||o>=a)&&Object.keys(s.O).every((e=>s.O[e](r[l])))?r.splice(l--,1):(i=!1,a<o&&(o=a));if(i){e.splice(m--,1);var h=n();void 0!==h&&(t=h)}}return t}a=a||0;for(var m=e.length;m>0&&e[m-1][2]>a;m--)e[m]=e[m-1];e[m]=[r,n,a]},s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={179:0};s.O.j=t=>0===e[t];var t=(t,r)=>{var n,a,[o,i,l]=r,h=0;if(o.some((t=>0!==e[t]))){for(n in i)s.o(i,n)&&(s.m[n]=i[n]);if(l)var m=l(s)}for(t&&t(r);h<o.length;h++)a=o[h],s.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return s.O(m)},r=self.webpackChunkbabylon_mmd=self.webpackChunkbabylon_mmd||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})();var n=s.O(void 0,[216],(()=>s(737)));n=s.O(n)})();