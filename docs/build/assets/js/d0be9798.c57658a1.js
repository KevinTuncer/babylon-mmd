"use strict";(self.webpackChunkbabylon_mmd_docs=self.webpackChunkbabylon_mmd_docs||[]).push([[6],{3905:(e,t,n)=>{n.d(t,{Zo:()=>m,kt:()=>g});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var d=a.createContext({}),s=function(e){var t=a.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},m=function(e){var t=s(e.components);return a.createElement(d.Provider,{value:t},e.children)},p="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,d=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),p=s(n),c=o,g=p["".concat(d,".").concat(c)]||p[c]||u[c]||i;return n?a.createElement(g,r(r({ref:t},m),{},{components:n})):a.createElement(g,r({ref:t},m))}));function g(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=c;var l={};for(var d in t)hasOwnProperty.call(t,d)&&(l[d]=t[d]);l.originalType=e,l[p]="string"==typeof e?e:o,r[1]=l;for(var s=2;s<i;s++)r[s]=n[s];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},4646:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>r,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>s});var a=n(7462),o=(n(7294),n(3905));const i={},r="Load BPMX Model",l={unversionedId:"deep-usage/load-bpmx-model/index",id:"deep-usage/load-bpmx-model/index",title:"Load BPMX Model",description:"Learn how to load models in BPMX format.",source:"@site/docs/1-deep-usage/2-load-bpmx-model/index.md",sourceDirName:"1-deep-usage/2-load-bpmx-model",slug:"/deep-usage/load-bpmx-model/",permalink:"/babylon-mmd/docs/deep-usage/load-bpmx-model/",draft:!1,editUrl:"https://github.com/noname0310/babylon-mmd/tree/main/docs/babylon-mmd-docs/docs/1-deep-usage/2-load-bpmx-model/index.md",tags:[],version:"current",frontMatter:{},sidebar:"docsSidebar",previous:{title:"Convert PMX model into BPMX",permalink:"/babylon-mmd/docs/deep-usage/convert-pmx-model-into-bpmx/"},next:{title:"Bake Physics Animation (External)",permalink:"/babylon-mmd/docs/deep-usage/bake-physics-animation/"}},d={},s=[{value:"Load BPMX Model as Skinned Mesh",id:"load-bpmx-model-as-skinned-mesh",level:2},{value:"Load BPMX Model as Static Mesh",id:"load-bpmx-model-as-static-mesh",level:2},{value:"Load multiple assets simultaneously",id:"load-multiple-assets-simultaneously",level:2},{value:"Add Shadow to Model",id:"add-shadow-to-model",level:2}],m={toc:s},p="wrapper";function u(e){let{components:t,...i}=e;return(0,o.kt)(p,(0,a.Z)({},m,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"load-bpmx-model"},"Load BPMX Model"),(0,o.kt)("p",null,"Learn how to load models in BPMX format."),(0,o.kt)("h2",{id:"load-bpmx-model-as-skinned-mesh"},"Load BPMX Model as Skinned Mesh"),(0,o.kt)("p",null,"BPMX specs may have more than 0 Bone or MorphTarget, so basically everything loaded by ",(0,o.kt)("inlineCode",{parentName:"p"},"BpmxLoader")," is Skinned Mesh even if it has no Bone or MorphTarget. (The same applies to the ",(0,o.kt)("inlineCode",{parentName:"p"},"PmxLoader"),".)"),(0,o.kt)("p",null,"For load bpmx model, we need to import side effects."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/sceneBuilder.ts"',title:'"src/sceneBuilder.ts"'},'import "babylon-mmd/esm/Loader/Optimized/bpmxLoader";\n')),(0,o.kt)("p",null,"Then, load the model using the ",(0,o.kt)("inlineCode",{parentName:"p"},"SceneLoader"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/sceneBuilder.ts"',title:'"src/sceneBuilder.ts"'},'const bpmxLoader = SceneLoader.GetPluginForExtension(".bpmx") as BpmxLoader;\nbpmxLoader.loggingEnabled = true;\nconst materialBuilder = bpmxLoader.materialBuilder as MmdStandardMaterialBuilder;\nmaterialBuilder.loadOutlineRenderingProperties = (): void => { /* do nothing */ };\n\nengine.displayLoadingUI();\n\nbpmxLoader.boundingBoxMargin = 60;\nconst modelMesh = await SceneLoader.ImportMeshAsync(\n    undefined,\n    "res/YYB Piano dress Miku.bpmx",\n    undefined,\n    scene,\n    (event) => engine.loadingUIText = `Loading model... ${event.loaded}/${event.total} (${Math.floor(event.loaded * 100 / event.total)}%)`\n).then((result) => result.meshes[0] as Mesh);\n\nmodelMesh;\n\nscene.onAfterRenderObservable.addOnce(() => engine.hideLoadingUI());\n')),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},'SceneLoader.GetPluginForExtension(".bpmx")')," - Get the ",(0,o.kt)("inlineCode",{parentName:"p"},"BpmxLoader")," from the ",(0,o.kt)("inlineCode",{parentName:"p"},"SceneLoader"),".")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"bpmxLoader.loggingEnabled = true;")," - Enable logging for better debugging.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"bpmxLoader.materialBuilder")," - In this case we get the ",(0,o.kt)("inlineCode",{parentName:"p"},"MmdStandardMaterialBuilder")," from the ",(0,o.kt)("inlineCode",{parentName:"p"},"BpmxLoader"),". If you implement your own material builder, you can pass it to the loader.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"materialBuilder.loadOutlineRenderingProperties = (): void => { /* do nothing */ };")," - Override the method to disable outline rendering. (This is just a setting for the goal in this example.)")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"bpmxLoader.boundingBoxMargin = 60;")," - Set the bounding box margin. (The default value is 10.)"))),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Basically, dance motion can cause curring problem because it moves mesh a lot from rest pose."),(0,o.kt)("p",{parentName:"admonition"},"And the motion that we're going to use in this next example is especially problematic, so we need to make the bounding box bigger.")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"If you change the settings of the ",(0,o.kt)("inlineCode",{parentName:"p"},"BpmxLoader")," before calling ",(0,o.kt)("inlineCode",{parentName:"p"},"ImportMeshAsync"),", the settings will be applied to the loaded model."),(0,o.kt)("p",{parentName:"admonition"},"The reason for using this method is that ",(0,o.kt)("inlineCode",{parentName:"p"},"ImportMeshAsync")," does not have a parameter to pass the load options to the loader.")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"result1",src:n(211).Z,width:"1922",height:"1081"})),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},"BJS - [19:42:52]: Failed to load sphere texture: file:res/YYB Piano dress Miku.bpmx_")),(0,o.kt)("p",{parentName:"admonition"},"You'll see this error message. These errors are often displayed when the 3D model data itself is incorrect, and to resolve this, the asset must be modified by using a editor such as ",(0,o.kt)("a",{parentName:"p",href:"https://www.deviantart.com/johnwithlenon/art/PmxEditor-v0273-English-Version-unofficial-trans-925125044"},"Pmx Editor"),".")),(0,o.kt)("h2",{id:"load-bpmx-model-as-static-mesh"},"Load BPMX Model as Static Mesh"),(0,o.kt)("p",null,"For models such as Stage, it is usually static. Importing these models into a static mesh can save performance."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/sceneBuilder.ts"',title:'"src/sceneBuilder.ts"'},'bpmxLoader.boundingBoxMargin = 0;\nbpmxLoader.buildSkeleton = false;\nbpmxLoader.buildMorph = false;\n// promises.push(\nawait SceneLoader.ImportMeshAsync(\n    undefined,\n    "res/\u30ac\u30e9\u30b9\u7247\u30c9\u30fc\u30e0B.bpmx",\n    undefined,\n    scene,\n    (event) => engine.loadingUIText = `Loading stage... ${event.loaded}/${event.total} (${Math.floor(event.loaded * 100 / event.total)}%)`\n);\n')),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"bpmxLoader.boundingBoxMargin = 0;")," - Set the bounding box margin to 0. (because static mesh doesn't move)"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"bpmxLoader.buildSkeleton = false;")," - Disable building skeleton."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"bpmxLoader.buildMorph = false;")," - Disable building morph.")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Naturally, mmd models loaded with static mesh cannot be controlled by MMD Runtime.")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"result2",src:n(436).Z,width:"1922",height:"1081"})),(0,o.kt)("h2",{id:"load-multiple-assets-simultaneously"},"Load multiple assets simultaneously"),(0,o.kt)("p",null,"Now, we are awaiting the model and stage to load one by one, but we can load them simultaneously by using ",(0,o.kt)("inlineCode",{parentName:"p"},"Promise.all"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/sceneBuilder.ts"',title:'"src/sceneBuilder.ts"'},'const bpmxLoader = SceneLoader.GetPluginForExtension(".bpmx") as BpmxLoader;\nbpmxLoader.loggingEnabled = true;\n\nengine.displayLoadingUI();\n\nlet loadingTexts: string[] = [];\nconst updateLoadingText = (updateIndex: number, text: string): void => {\n    loadingTexts[updateIndex] = text;\n    engine.loadingUIText = "<br/><br/><br/><br/>" + loadingTexts.join("<br/><br/>");\n};\n\nconst promises: Promise<any>[] = [];\n\nbpmxLoader.boundingBoxMargin = 60;\npromises.push(SceneLoader.ImportMeshAsync(\n    undefined,\n    "res/YYB Piano dress Miku.bpmx",\n    undefined,\n    scene,\n    (event) => updateLoadingText(0, `Loading model... ${event.loaded}/${event.total} (${Math.floor(event.loaded * 100 / event.total)}%)`)\n).then((result) => result.meshes[0] as Mesh));\n\nbpmxLoader.boundingBoxMargin = 0;\nbpmxLoader.buildSkeleton = false;\nbpmxLoader.buildMorph = false;\npromises.push(SceneLoader.ImportMeshAsync(\n    undefined,\n    "res/\u30ac\u30e9\u30b9\u7247\u30c9\u30fc\u30e0B.bpmx",\n    undefined,\n    scene,\n    (event) => updateLoadingText(1, `Loading stage... ${event.loaded}/${event.total} (${Math.floor(event.loaded * 100 / event.total)}%)`)\n));\n\nloadingTexts = new Array(promises.length).fill("");\n\nconst loadResults = await Promise.all(promises);\nscene.onAfterRenderObservable.addOnce(() => engine.hideLoadingUI());\n\nloadResults;\n')),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Simply added ",(0,o.kt)("inlineCode",{parentName:"li"},"Promise.all")," and the loading screen.")),(0,o.kt)("h2",{id:"add-shadow-to-model"},"Add Shadow to Model"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/sceneBuilder.ts"',title:'"src/sceneBuilder.ts"'},"const modelMesh = loadResults[0] as Mesh;\nmodelMesh.receiveShadows = true;\nshadowGenerator.addShadowCaster(modelMesh);\n")),(0,o.kt)("p",null,"Pretty easy, right?"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"result3",src:n(9399).Z,width:"1922",height:"1081"})))}u.isMDXComponent=!0},436:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/image-1-233f7c41bea2cd7148549a3f66f88696.png"},9399:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/image-2-4dca4009ebf5333b660d657fd901a1ba.png"},211:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/image-c30b5f26e820bec37dc6be19e3cc4d46.png"}}]);