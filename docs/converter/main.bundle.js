(()=>{var e,t={110:()=>{},113:(e,t,r)=>{"use strict";var n=r(718);class s{_canvas;_engine;_scene;_onTick;constructor(e){this._canvas=e.canvas,this._engine=e.engine,this._scene=null,this._onTick=null}static async Create(e){const t=new s(e);return t._scene=await t._initialize(e.sceneBuilder),t._onTick=t._makeOnTick(),t}run(){const e=this._engine;window.addEventListener("resize",this._onResize),e.runRenderLoop(this._onTick)}dispose(){window.removeEventListener("resize",this._onResize),this._engine.dispose()}_onResize=()=>{this._engine.resize()};async _initialize(e){return await e.build(this._canvas,this._engine)}_makeOnTick(){const e=this._scene;return()=>e.render()}}var a=r(110),o=r.n(a);class i{name;boneTracks;moveableBoneTracks;morphTracks;propertyTrack;cameraTrack;startFrame;endFrame;constructor(e,t,r,n,s,a){this.name=e,this.boneTracks=t,this.moveableBoneTracks=r,this.morphTracks=n,this.propertyTrack=s,this.cameraTrack=a;let o=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER;for(let e=0;e<t.length;++e){const r=t[e];o=Math.min(o,r.startFrame),i=Math.max(i,r.endFrame)}for(let e=0;e<r.length;++e){const t=r[e];o=Math.min(o,t.startFrame),i=Math.max(i,t.endFrame)}for(let e=0;e<n.length;++e){const t=n[e];o=Math.min(o,t.startFrame),i=Math.max(i,t.endFrame)}o=Math.min(o,s.startFrame),i=Math.max(i,s.endFrame),o=Math.min(o,a.startFrame),i=Math.max(i,a.endFrame),this.startFrame=o,this.endFrame=i}validate(){const e=this.boneTracks;for(let t=0;t<e.length;++t)if(!e[t].validate())return!1;const t=this.moveableBoneTracks;for(let e=0;e<t.length;++e)if(!t[e].validate())return!1;const r=this.morphTracks;for(let e=0;e<r.length;++e)if(!r[e].validate())return!1;return this.propertyTrack.validate()&&this.cameraTrack.validate()}}class l{trackType;name;frameNumbers;constructor(e,t,r){this.trackType=e,this.name=t,this.frameNumbers=new Uint32Array(r)}validate(){for(let e=1;e<this.frameNumbers.length;++e)if(this.frameNumbers[e-1]>=this.frameNumbers[e])return!1;return!0}get startFrame(){return 0===this.frameNumbers.length?0:this.frameNumbers[0]}get endFrame(){return 0===this.frameNumbers.length?0:this.frameNumbers[this.frameNumbers.length-1]}}class m extends l{rotations;rotationInterpolations;constructor(e,t){super("bone",e,t),this.rotations=new Float32Array(4*t),this.rotationInterpolations=new Uint8Array(4*t)}}class c extends l{positions;positionInterpolations;rotations;rotationInterpolations;constructor(e,t){super("moveableBone",e,t),this.positions=new Float32Array(3*t),this.positionInterpolations=new Uint8Array(12*t),this.rotations=new Float32Array(4*t),this.rotationInterpolations=new Uint8Array(4*t)}}class h extends l{weights;constructor(e,t){super("morph",e,t),this.weights=new Float32Array(t)}}class f extends l{positions;positionInterpolations;rotations;rotationInterpolations;distances;distanceInterpolations;fovs;fovInterpolations;constructor(e){super("camera","cameraTrack",e),this.positions=new Float32Array(3*e),this.positionInterpolations=new Uint8Array(12*e),this.rotations=new Float32Array(3*e),this.rotationInterpolations=new Uint8Array(4*e),this.distances=new Float32Array(e),this.distanceInterpolations=new Uint8Array(4*e),this.fovs=new Float32Array(e),this.fovInterpolations=new Uint8Array(4*e)}}class y extends l{visibles;ikBoneNames;ikStates;constructor(e,t){super("property","propertyTrack",e),this.visibles=new Uint8Array(e),this.ikBoneNames=new Array(t),this.ikStates=new Array(t);for(let r=0;r<t;++r)this.ikStates[r]=new Uint8Array(e)}}class u{log(e){console.log(e)}warn(e){console.warn(e)}error(e){console.error(e)}}class d{static _LittleEndian=!0;_dataView;_decoder;_offset;constructor(e){this._dataView=new DataView(e),this._decoder=null,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}getUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}getInt8(){const e=this._dataView.getInt8(this._offset);return this._offset+=1,e}getUint8Array(e,t){for(let r=0;r<t;++r)e[r]=this._dataView.getUint8(this._offset),this._offset+=1}getUint16(){const e=this._dataView.getUint16(this._offset,d._LittleEndian);return this._offset+=2,e}getInt16(){const e=this._dataView.getInt16(this._offset,d._LittleEndian);return this._offset+=2,e}getUint32(){const e=this._dataView.getUint32(this._offset,d._LittleEndian);return this._offset+=4,e}getUint32Array(e,t){for(let r=0;r<t;++r)e[r]=this._dataView.getUint32(this._offset,d._LittleEndian),this._offset+=4}getInt32(){const e=this._dataView.getInt32(this._offset,d._LittleEndian);return this._offset+=4,e}getFloat32(){const e=this._dataView.getFloat32(this._offset,d._LittleEndian);return this._offset+=4,e}getFloat32Array(e,t){for(let r=0;r<t;++r)e[r]=this._dataView.getFloat32(this._offset,d._LittleEndian),this._offset+=4}getFloat32Tuple(e){const t=new Array(e);for(let r=0;r<e;++r)t[r]=this._dataView.getFloat32(this._offset,d._LittleEndian),this._offset+=4;return t}initializeTextDecoder(e){this._decoder=new TextDecoder(e)}getDecoderString(e,t){if(null===this._decoder)throw new Error("TextDecoder is not initialized.");let r=new Uint8Array(this._dataView.buffer,this._offset,e);if(this._offset+=e,t)for(let e=0;e<r.length;++e)if(0===r[e]){r=r.subarray(0,e);break}return this._decoder.decode(r)}getSignatureString(e){const t=new TextDecoder("utf-8"),r=new Uint8Array(this._dataView.buffer,this._offset,e);return this._offset+=e,t.decode(r)}get bytesAvailable(){return this._dataView.byteLength-this._offset}}class g{static _Signature="Vocaloid Motion Data 0002";static SignatureBytes=30;static ModelNameBytes=20;static BoneKeyFrameBytes=111;static MorphKeyFrameBytes=23;static CameraKeyFrameBytes=61;static LightKeyFrameBytes=28;static SelfShadowKeyFrameBytes=9;static PropertyKeyFrameBytes=5;static PropertyKeyFrameIkStateBytes=21;dataDeserializer;boneKeyFrameCount;morphKeyFrameCount;cameraKeyFrameCount;lightKeyFrameCount;selfShadowKeyFrameCount;propertyKeyFrameCount;constructor(e,t,r,n,s,a,o){this.dataDeserializer=e,this.boneKeyFrameCount=t,this.morphKeyFrameCount=r,this.cameraKeyFrameCount=n,this.lightKeyFrameCount=s,this.selfShadowKeyFrameCount=a,this.propertyKeyFrameCount=o}static CheckedCreate(e,t=new u){const r=new d(e);if(r.initializeTextDecoder("shift-jis"),r.bytesAvailable<g.SignatureBytes+g.ModelNameBytes)return null;if(r.getSignatureString(this.SignatureBytes).substring(0,this._Signature.length)!==this._Signature)return null;if(r.offset+=g.ModelNameBytes,r.bytesAvailable<4)return null;const n=r.getUint32();if(r.bytesAvailable<n*g.BoneKeyFrameBytes)return null;if(r.offset+=n*g.BoneKeyFrameBytes,r.bytesAvailable<4)return null;const s=r.getUint32();if(r.bytesAvailable<s*g.MorphKeyFrameBytes)return null;if(r.offset+=s*g.MorphKeyFrameBytes,r.bytesAvailable<4)return null;const a=r.getUint32();if(r.bytesAvailable<a*g.CameraKeyFrameBytes)return null;if(r.offset+=a*g.CameraKeyFrameBytes,r.bytesAvailable<4)return null;const o=r.getUint32();if(r.bytesAvailable<o*g.LightKeyFrameBytes)return null;if(r.offset+=o*g.LightKeyFrameBytes,r.bytesAvailable<4)return null;const i=r.getUint32();if(r.bytesAvailable<i*g.SelfShadowKeyFrameBytes)return null;if(r.offset+=i*g.SelfShadowKeyFrameBytes,0===r.bytesAvailable)return new g(r,n,s,a,o,i,0);if(r.bytesAvailable<4)return null;const l=r.getUint32();for(let e=0;e<l;++e){if(r.bytesAvailable<g.PropertyKeyFrameBytes)return null;if(r.offset+=g.PropertyKeyFrameBytes,r.bytesAvailable<4)return null;const e=r.getUint32();if(r.bytesAvailable<e*g.PropertyKeyFrameIkStateBytes)return null;r.offset+=e*g.PropertyKeyFrameIkStateBytes}return r.bytesAvailable>0&&t.warn(`There are ${r.bytesAvailable} bytes left after parsing`),r.offset=0,new g(r,n,s,a,o,i,l)}}class p{propertyKeyFrames;_vmdData;constructor(e,t){this._vmdData=e,this.propertyKeyFrames=t}static Parse(e){const t=e.dataDeserializer,r=[];t.offset=g.SignatureBytes+g.ModelNameBytes+4+e.boneKeyFrameCount*g.BoneKeyFrameBytes+4+e.morphKeyFrameCount*g.MorphKeyFrameBytes+4+e.cameraKeyFrameCount*g.CameraKeyFrameBytes+4+e.lightKeyFrameCount*g.LightKeyFrameBytes+4+e.selfShadowKeyFrameCount*g.SelfShadowKeyFrameBytes+4;const n=e.propertyKeyFrameCount;for(let e=0;e<n;++e){const e=t.getUint32(),n=0!==t.getUint8(),s=t.getUint32(),a=[];for(let e=0;e<s;e++){const e=t.getDecoderString(20,!0),r=0!==t.getUint8();a.push([e,r])}const o={frameNumber:e,visible:n,ikStates:a};r.push(o)}return new p(e,r)}static ParseFromBuffer(e){const t=g.CheckedCreate(e);if(null===t)throw new Error("Invalid VMD data");return p.Parse(t)}get boneKeyFrames(){const e=g.SignatureBytes+g.ModelNameBytes+4;return new p.BoneKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.boneKeyFrameCount)}get morphKeyFrames(){const e=g.SignatureBytes+g.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*g.BoneKeyFrameBytes+4;return new p.MorphKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.morphKeyFrameCount)}get cameraKeyFrames(){const e=g.SignatureBytes+g.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*g.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*g.MorphKeyFrameBytes+4;return new p.CameraKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.cameraKeyFrameCount)}get lightKeyFrames(){const e=g.SignatureBytes+g.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*g.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*g.MorphKeyFrameBytes+4+this._vmdData.cameraKeyFrameCount*g.CameraKeyFrameBytes+4;return new p.LightKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.lightKeyFrameCount)}get selfShadowKeyFrames(){const e=g.SignatureBytes+g.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*g.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*g.MorphKeyFrameBytes+4+this._vmdData.cameraKeyFrameCount*g.CameraKeyFrameBytes+4+this._vmdData.lightKeyFrameCount*g.LightKeyFrameBytes+4;return new p.SelfShadowKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.selfShadowKeyFrameCount)}}!function(e){class t{_dataDeserializer;_startOffset;_length;constructor(e,t,r){this._dataDeserializer=e,this._startOffset=t,this._length=r}get length(){return this._length}}e.BufferArrayReader=t,e.BoneKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*g.BoneKeyFrameBytes;return new r(this._dataDeserializer,t)}};class r{boneName;frameNumber;position;rotation;interpolation;constructor(e,t){e.offset=t,this.boneName=e.getDecoderString(15,!0),this.frameNumber=e.getUint32(),this.position=e.getFloat32Tuple(3),this.rotation=e.getFloat32Tuple(4),this.interpolation=new Uint8Array(64);for(let t=0;t<64;++t)this.interpolation[t]=e.getUint8()}}e.BoneKeyFrame=r,e.MorphKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*g.MorphKeyFrameBytes;return new n(this._dataDeserializer,t)}};class n{morphName;frameNumber;weight;constructor(e,t){e.offset=t,this.morphName=e.getDecoderString(15,!0),this.frameNumber=e.getUint32(),this.weight=e.getFloat32()}}e.MorphKeyFrame=n,e.CameraKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*g.CameraKeyFrameBytes;return new s(this._dataDeserializer,t)}};class s{frameNumber;distance;position;rotation;interpolation;fov;perspective;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.distance=e.getFloat32(),this.position=e.getFloat32Tuple(3),this.rotation=e.getFloat32Tuple(3),this.interpolation=new Uint8Array(24);for(let t=0;t<24;++t)this.interpolation[t]=e.getUint8();this.fov=e.getUint32(),this.perspective=0!==e.getUint8()}}e.CameraKeyFrame=s,e.LightKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*g.LightKeyFrameBytes;return new a(this._dataDeserializer,t)}};class a{frameNumber;color;direction;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.color=e.getFloat32Tuple(3),this.direction=e.getFloat32Tuple(3)}}e.LightKeyFrame=a,e.SelfShadowKeyFrames=class extends t{constructor(e,t,r){super(e,t,r)}get(e){const t=this._startOffset+e*g.SelfShadowKeyFrameBytes;return new o(this._dataDeserializer,t)}};class o{frameNumber;mode;distance;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.mode=e.getUint8(),this.distance=e.getFloat32()}}e.SelfShadowKeyFrame=o}(p||(p={}));class b{_scene;_loggingEnabled;log;warn;error;constructor(e){this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._scene=e}loadFromVmdObject(e,t,r,n){this.loadFromVmdObjectAsync(e,t,n).then(r)}async loadFromVmdObjectAsync(e,t,r){Array.isArray(t)||(t=[t]);let s=0,a=0,o=0,l=0;for(let e=0;e<t.length;++e){const r=t[e];s+=r.boneKeyFrames.length,a+=r.morphKeyFrames.length,o+=r.propertyKeyFrames.length,l+=r.cameraKeyFrames.length}const u={lengthComputable:!0,loaded:0,total:s+a+o+l};let d=0,g=performance.now();const p=[];{const e=new Map,s=[],a=[],o=[];for(let e=0;e<t.length;++e){const r=t[e].boneKeyFrames,n=r.length;for(let e=0;e<n;++e)o.push(r.get(e))}100<performance.now()-g&&(await n.w1W.DelayAsync(0),g=performance.now());const i=o.length;for(let t=0;t<i;++t){const r=o[t].boneName;let n=e.get(r);void 0===n&&(n=e.size,e.set(r,n),s.push(0),a.push(r)),s[n]+=1}o.sort(((e,t)=>e.frameNumber-t.frameNumber));for(let t=0;t<e.size;++t)p.push(new c(a[t],s[t]));100<performance.now()-g&&(await n.w1W.DelayAsync(0),g=performance.now());const l=new Uint32Array(e.size);for(let t=0;t<i;++t){const s=o[t],a=e.get(s.boneName),i=p[a],m=l[a],c=s.interpolation;i.frameNumbers[m]=s.frameNumber;const h=i.positions,f=s.position;h[3*m+0]=f[0],h[3*m+1]=f[1],h[3*m+2]=f[2];const y=i.positionInterpolations;y[12*m+0]=c[0],y[12*m+1]=c[8],y[12*m+2]=c[4],y[12*m+3]=c[12],y[12*m+4]=c[16],y[12*m+5]=c[24],y[12*m+6]=c[20],y[12*m+7]=c[28],y[12*m+8]=c[32],y[12*m+9]=c[40],y[12*m+10]=c[36],y[12*m+11]=c[44];const b=i.rotations,w=s.rotation;b[4*m+0]=w[0],b[4*m+1]=w[1],b[4*m+2]=w[2],b[4*m+3]=w[3];const _=i.rotationInterpolations;_[4*m+0]=c[48],_[4*m+1]=c[56],_[4*m+2]=c[52],_[4*m+3]=c[60],l[a]+=1,t%1e3==0&&100<performance.now()-g&&(u.loaded=d+t,r?.({...u}),await n.w1W.DelayAsync(0),g=performance.now())}}const b=[],w=[];for(let e=0;e<p.length;++e){const t=p[e];let r=!0;for(let e=0;e<t.frameNumbers.length;++e){const n=t.positions;if(0!==n[3*e+0]||0!==n[3*e+1]||0!==n[3*e+2]){r=!1;break}const s=t.rotations;if(0!==s[4*e+0]||0!==s[4*e+1]||0!==s[4*e+2]||1!==s[4*e+3]){r=!1;break}}if(r)continue;let n=!1;for(let e=0;e<t.positions.length;++e)if(0!==t.positions[e]){n=!0;break}if(n)w.push(t);else{const e=new m(t.name,t.frameNumbers.length);e.frameNumbers.set(t.frameNumbers),e.rotations.set(t.rotations),e.rotationInterpolations.set(t.rotationInterpolations),b.push(e)}}if(p.length=0,1<t.length){const e=new Int32Array(b.length).fill(-1);for(let t=0;t<b.length;++t){const r=b[t].frameNumbers;let n=0,s=r[0];for(let e=1;e<=r.length;++e){const t=r[e];s!==t&&(n+=1,s=t)}r.length!==n&&(e[t]=n)}for(let t=0;t<b.length;++t){const r=e[t];if(-1===r)continue;const n=b[t],s=n.frameNumbers,a=n.rotations,o=n.rotationInterpolations,i=new m(n.name,r);let l=0,c=s[0];for(let e=1;e<=s.length;++e){const t=s[e];if(c!==t){const r=e-1;i.frameNumbers[l]=c;const n=i.rotations;n[4*l+0]=a[4*r+0],n[4*l+1]=a[4*r+1],n[4*l+2]=a[4*r+2],n[4*l+3]=a[4*r+3];const s=i.rotationInterpolations;s[4*l+0]=o[4*r+0],s[4*l+1]=o[4*r+1],s[4*l+2]=o[4*r+2],s[4*l+3]=o[4*r+3],l+=1,c=t}}b[t]=i}const t=new Int32Array(w.length).fill(-1);for(let e=0;e<w.length;++e){const r=w[e].frameNumbers;let n=0,s=r[0];for(let e=1;e<=r.length;++e){const t=r[e];s!==t&&(n+=1,s=t)}r.length!==n&&(t[e]=n)}for(let e=0;e<w.length;++e){const r=t[e];if(-1===r)continue;const n=w[e],s=n.frameNumbers,a=n.positions,o=n.positionInterpolations,i=n.rotations,l=n.rotationInterpolations,m=new c(n.name,r);let h=0,f=s[0];for(let e=1;e<=s.length;++e){const t=s[e];if(f!==t){const r=e-1;m.frameNumbers[h]=f;const n=m.positions;n[3*h+0]=a[3*r+0],n[3*h+1]=a[3*r+1],n[3*h+2]=a[3*r+2];const s=m.positionInterpolations;s[12*h+0]=o[12*r+0],s[12*h+1]=o[12*r+1],s[12*h+2]=o[12*r+2],s[12*h+3]=o[12*r+3],s[12*h+4]=o[12*r+4],s[12*h+5]=o[12*r+5],s[12*h+6]=o[12*r+6],s[12*h+7]=o[12*r+7],s[12*h+8]=o[12*r+8],s[12*h+9]=o[12*r+9],s[12*h+10]=o[12*r+10],s[12*h+11]=o[12*r+11];const c=m.rotations;c[4*h+0]=i[4*r+0],c[4*h+1]=i[4*r+1],c[4*h+2]=i[4*r+2],c[4*h+3]=i[4*r+3];const y=m.rotationInterpolations;y[4*h+0]=l[4*r+0],y[4*h+1]=l[4*r+1],y[4*h+2]=l[4*r+2],y[4*h+3]=l[4*r+3],h+=1,f=t}}w[e]=m}}u.loaded=d+s,r?.({...u}),d+=s;const _=[];{const e=new Map,s=[],a=[],o=[];for(let e=0;e<t.length;++e){const r=t[e].morphKeyFrames,n=r.length;for(let e=0;e<n;++e)o.push(r.get(e))}100<performance.now()-g&&(await n.w1W.DelayAsync(0),g=performance.now());const i=o.length;for(let t=0;t<i;++t){const r=o[t].morphName;let n=e.get(r);void 0===n&&(n=e.size,e.set(r,n),s.push(0),a.push(r)),s[n]+=1}o.sort(((e,t)=>e.frameNumber-t.frameNumber));for(let t=0;t<e.size;++t)_.push(new h(a[t],s[t]));100<performance.now()-g&&(await n.w1W.DelayAsync(0),g=performance.now());const l=new Uint32Array(e.size);for(let t=0;t<i;++t){const s=o[t],a=e.get(s.morphName),i=_[a],m=l[a];i.frameNumbers[m]=s.frameNumber,i.weights[m]=s.weight,l[a]+=1,t%1e3==0&&100<performance.now()-g&&(u.loaded=d+t,r?.({...u}),await n.w1W.DelayAsync(0),g=performance.now())}}const F=[];for(let e=0;e<_.length;++e){const t=_[e];let r=!0;for(let e=0;e<t.weights.length;++e)if(0!==t.weights[e]){r=!1;break}r||F.push(t)}if(_.length=0,1<t.length){const e=new Int32Array(F.length).fill(-1);for(let t=0;t<F.length;++t){const r=F[t].frameNumbers;let n=0,s=r[0];for(let e=1;e<=r.length;++e){const t=r[e];s!==t&&(n+=1,s=t)}r.length!==n&&(e[t]=n)}for(let t=0;t<F.length;++t){const r=e[t];if(-1===r)continue;const n=F[t],s=n.frameNumbers,a=n.weights,o=new h(n.name,r);let i=0,l=s[0];for(let e=1;e<=s.length;++e){const t=s[e];l!==t&&(o.frameNumbers[i]=l,o.weights[i]=a[e-1],i+=1,l=t)}F[t]=o}}u.loaded=d+a,r?.({...u}),d+=a;const v=[];for(let e=0;e<t.length;++e){const r=t[e].propertyKeyFrames;for(let e=0;e<r.length;++e)v.push(r[e])}let N;if(v.sort(((e,t)=>e.frameNumber-t.frameNumber)),1<t.length)N=v;else{N=[];let e=v[0]?.frameNumber;for(let t=1;t<=v.length;++t){const r=v[t]?.frameNumber;e!==r&&(N.push(v[t-1]),e=r)}}const A=new Set;for(let e=0;e<t.length;++e){const r=t[e].propertyKeyFrames;for(let e=0;e<r.length;++e){const t=r[e];for(let e=0;e<t.ikStates.length;++e)A.add(t.ikStates[e][0])}}const k=new y(N.length,A.size);{const e=new Array(A.size),t=new Map;let r=0;for(const n of A)e[r]=n,t.set(n,r),k.ikBoneNames[r]=n,r+=1;const n=new Uint8Array(A.size);for(let e=0;e<N.length;++e){const r=N[e];k.frameNumbers[e]=r.frameNumber,k.visibles[e]=r.visible?1:0;const s=k.ikStates,a=r.ikStates;n.fill(0);for(let r=0;r<a.length;++r){const o=a[r],i=t.get(o[0]);s[i][e]=o[1]?1:0,n[i]=1}for(let t=0;t<n.length;++t)if(0===n[t]){const r=s[t][e-1];s[t][e]=void 0===r?0:r}}}u.loaded=d+o,r?.({...u}),d+=o;const K=[];for(let e=0;e<t.length;++e){const r=t[e].cameraKeyFrames;for(let e=0;e<r.length;++e)K.push(r.get(e))}let B;if(K.sort(((e,t)=>e.frameNumber-t.frameNumber)),1<t.length)B=K;else{B=[];let e=K[0]?.frameNumber;for(let t=1;t<=K.length;++t){const r=K[t]?.frameNumber;e!==r&&(B.push(K[t-1]),e=r)}}const T=new f(B.length);for(let e=0;e<B.length;++e){const t=B[e],s=t.interpolation;T.frameNumbers[e]=t.frameNumber;const a=T.positions,o=t.position;a[3*e+0]=o[0],a[3*e+1]=o[1],a[3*e+2]=o[2];const i=T.positionInterpolations;i[12*e+0]=s[0],i[12*e+1]=s[1],i[12*e+2]=s[2],i[12*e+3]=s[3],i[12*e+4]=s[4],i[12*e+5]=s[5],i[12*e+6]=s[6],i[12*e+7]=s[7],i[12*e+8]=s[8],i[12*e+9]=s[9],i[12*e+10]=s[10],i[12*e+11]=s[11];const l=T.rotations,m=t.rotation;l[3*e+0]=m[0],l[3*e+1]=m[1],l[3*e+2]=m[2];const c=T.rotationInterpolations;c[4*e+0]=s[12],c[4*e+1]=s[13],c[4*e+2]=s[14],c[4*e+3]=s[15],T.distances[e]=t.distance;const h=T.distanceInterpolations;h[4*e+0]=s[16],h[4*e+1]=s[17],h[4*e+2]=s[18],h[4*e+3]=s[19],T.fovs[e]=t.fov;const f=T.fovInterpolations;f[4*e+0]=s[20],f[4*e+1]=s[21],f[4*e+2]=s[22],f[4*e+3]=s[23],e%1e3==0&&100<performance.now()-g&&(u.loaded=d+e,r?.({...u}),await n.w1W.DelayAsync(0),g=performance.now())}return u.loaded=d+l,r?.({...u}),d+=l,new i(e,b,w,F,k,T)}loadFromVmdData(e,t,r,n){Array.isArray(t)||(t=[t]);const s=[];for(let e=0;e<t.length;++e)s.push(p.Parse(t[e]));this.loadFromVmdObject(e,s,r,n)}loadFromVmdDataAsync(e,t,r){return new Promise((n=>{this.loadFromVmdData(e,t,n,r)}))}loadFromBuffer(e,t,r,n,s){Array.isArray(t)||(t=[t]);const a=[];for(let e=0;e<t.length;++e){const r=g.CheckedCreate(t[e]);if(null===r)return void s?.(new Error("VMD data validation failed."));a.push(r)}this.loadFromVmdData(e,a,r,n)}loadFromBufferAsync(e,t,r){return new Promise(((n,s)=>{this.loadFromBuffer(e,t,n,r,s)}))}load(e,t,r,s,a){Array.isArray(t)||(t=[t]);const o=this._scene,i=[],l=[];for(let m=0;m<t.length;++m){const c=t[m];l.push(o._loadFile(c,((o,l)=>{"string"==typeof o?a?.(void 0,new n.ehT("VMD data must be binary.")):(i.push(o),i.length===t.length&&this.loadFromBuffer(e,i,r,s,(e=>{a?.(void 0,e)})))}),s,!0,!0,a))}return 1===t.length?l[0]:l}loadAsync(e,t,r){return new Promise(((n,s)=>{this.load(e,t,n,r,((e,t)=>s({request:e,exception:t})))}))}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){n.YdH.Log(e)}_logDisabled(){}_warnEnabled(e){n.YdH.Warn(e)}_warnDisabled(){}_errorEnabled(e){n.YdH.Error(e)}_errorDisabled(){}}class w{static _LittleEndian=!0;_dataView;_encoder;_offset;constructor(e){this._dataView=new DataView(e),this._encoder=new TextEncoder,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}setUint8Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setUint8(this._offset,e[r]),this._offset+=1}setInt8Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setInt8(this._offset,e[r]),this._offset+=1}setUint32(e){this._dataView.setUint32(this._offset,e,w._LittleEndian),this._offset+=4}setUint32Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setUint32(this._offset,e[r],w._LittleEndian),this._offset+=4}setFloat32Array(e){const t=this._dataView;for(let r=0;r<e.length;++r)t.setFloat32(this._offset,e[r],w._LittleEndian),this._offset+=4}setString(e){const t=this._dataView,r=this._encoder.encode(e);t.setUint32(this._offset,r.length,w._LittleEndian),this._offset+=4;for(let e=0;e<r.length;++e)t.setUint8(this._offset,r[e]),this._offset+=1}get bytesAvailable(){return this._dataView.byteLength-this._offset}}class _{constructor(){}static Convert(e){const t=new TextEncoder;let r=7;{r+=4;const n=e.boneTracks.length;for(let s=0;s<n;s++){const n=e.boneTracks[s];r+=4+t.encode(n.name).length,r+=4,r+=4*n.frameNumbers.length,r+=16*n.frameNumbers.length,r+=16*n.frameNumbers.length}r+=4;const s=e.moveableBoneTracks.length;for(let n=0;n<s;n++){const s=e.moveableBoneTracks[n];r+=4+t.encode(s.name).length,r+=4,r+=4*s.frameNumbers.length,r+=12*s.frameNumbers.length,r+=48*s.frameNumbers.length,r+=16*s.frameNumbers.length,r+=16*s.frameNumbers.length}r+=4;const a=e.morphTracks.length;for(let n=0;n<a;n++){const s=e.morphTracks[n];r+=4+t.encode(s.name).length,r+=4,r+=4*s.frameNumbers.length,r+=4*s.frameNumbers.length}r+=4,r+=4*e.propertyTrack.frameNumbers.length,r+=1*e.propertyTrack.frameNumbers.length,r+=4;const o=e.propertyTrack.ikBoneNames.length;for(let n=0;n<o;n++){const s=e.propertyTrack.ikBoneNames[n];r+=4+t.encode(s).length}r+=1*o*e.propertyTrack.frameNumbers.length,r+=4,r+=4*e.cameraTrack.frameNumbers.length,r+=12*e.cameraTrack.frameNumbers.length,r+=48*e.cameraTrack.frameNumbers.length,r+=12*e.cameraTrack.frameNumbers.length,r+=16*e.cameraTrack.frameNumbers.length,r+=4*e.cameraTrack.frameNumbers.length,r+=16*e.cameraTrack.frameNumbers.length,r+=4*e.cameraTrack.frameNumbers.length,r+=16*e.cameraTrack.frameNumbers.length}const n=new ArrayBuffer(r),s=new w(n);s.setUint8Array(t.encode("BVMD")),s.setInt8Array([1,0,0]);const a=e.boneTracks;s.setUint32(a.length);for(let e=0;e<a.length;e++){const t=a[e];s.setString(t.name),s.setUint32(t.frameNumbers.length),s.setUint32Array(t.frameNumbers),s.setFloat32Array(t.rotations),s.setUint8Array(t.rotationInterpolations)}const o=e.moveableBoneTracks;s.setUint32(o.length);for(let e=0;e<o.length;e++){const t=o[e];s.setString(t.name),s.setUint32(t.frameNumbers.length),s.setUint32Array(t.frameNumbers),s.setFloat32Array(t.positions),s.setUint8Array(t.positionInterpolations),s.setFloat32Array(t.rotations),s.setUint8Array(t.rotationInterpolations)}const i=e.morphTracks;s.setUint32(i.length);for(let e=0;e<i.length;e++){const t=i[e];s.setString(t.name),s.setUint32(t.frameNumbers.length),s.setUint32Array(t.frameNumbers),s.setFloat32Array(t.weights)}s.setUint32(e.propertyTrack.frameNumbers.length),s.setUint32(e.propertyTrack.ikBoneNames.length),s.setUint32Array(e.propertyTrack.frameNumbers),s.setUint8Array(e.propertyTrack.visibles);const l=e.propertyTrack.ikBoneNames;for(let t=0;t<l.length;t++){const r=l[t];s.setString(r),s.setUint8Array(e.propertyTrack.ikStates[t])}return s.setUint32(e.cameraTrack.frameNumbers.length),s.setUint32Array(e.cameraTrack.frameNumbers),s.setFloat32Array(e.cameraTrack.positions),s.setUint8Array(e.cameraTrack.positionInterpolations),s.setFloat32Array(e.cameraTrack.rotations),s.setUint8Array(e.cameraTrack.rotationInterpolations),s.setFloat32Array(e.cameraTrack.distances),s.setUint8Array(e.cameraTrack.distanceInterpolations),s.setFloat32Array(e.cameraTrack.fovs),s.setUint8Array(e.cameraTrack.fovInterpolations),n}}o();const F=document.getElementById("render-canvas");if(!(F instanceof HTMLCanvasElement))throw new Error("Invalid canvas element");const v=new n.D4V(F,!0,{preserveDrawingBuffer:!0,stencil:!0,antialias:!0},!0);s.Create({canvas:F,engine:v,sceneBuilder:new class{async build(e,t){t.setHardwareScalingLevel(1e3);const r=new n.xsS(t);new n.cEJ("camera1",new n.Pa4(0,5,-10),r);const s=new b(r);s.loggingEnabled=!0;const a=[],o=document.createElement("div");o.style.position="absolute",o.style.top="0",o.style.left="0",o.style.backgroundColor="white",o.style.width="100%",o.style.height="100%",o.style.display="flex",o.style.flexDirection="column",o.style.justifyContent="center",o.style.alignItems="center",o.style.fontFamily="sans-serif",e.parentElement.appendChild(o);const i=document.createElement("div");i.style.width="auto",i.style.height="100%",i.style.display="flex",i.style.flexDirection="column",i.style.justifyContent="center",i.style.alignItems="start",o.appendChild(i);const l=document.createElement("h1");l.textContent="VMD to BVMD Converter",l.style.width="500px",l.style.textAlign="center",i.appendChild(l);const m=document.createElement("ul");i.appendChild(m),m.style.width="100%",m.style.height="auto",m.style.fontSize="20px";const c=()=>{m.innerHTML="";for(const e of a){const t=document.createElement("li");t.textContent=e.name,m.appendChild(t)}};c();const h=document.createElement("input");h.style.width="100%",h.style.height="80px",h.style.display="block",h.style.backgroundColor="black",h.style.color="white",h.style.marginBottom="10px",h.style.fontSize="20px",h.type="file",h.accept=".vmd",h.multiple=!0,h.onchange=()=>{if(null!==h.files){for(const e of h.files)e.name.endsWith(".vmd")&&a.push(e);c()}},i.appendChild(h);const f=document.createElement("button");return f.textContent="Convert",f.style.width="100%",f.style.height="60px",f.style.border="none",f.style.fontSize="20px",f.onclick=async()=>{if(0===a.length)return void alert("Please select a VMD file");f.textContent="Converting...";const e=await s.loadAsync(a[0].name,a),t=_.Convert(e),r=new Blob([t],{type:"application/octet-stream"}),n=URL.createObjectURL(r),o=document.createElement("a");o.href=n,o.download=`${a[0].name}.bvmd`,o.click(),URL.revokeObjectURL(n),o.remove(),a.length=0,c(),f.textContent="Convert"},i.appendChild(f),r}}}).then((e=>e.run()))}},r={};function n(e){var s=r[e];if(void 0!==s)return s.exports;var a=r[e]={exports:{}};return t[e](a,a.exports,n),a.exports}n.m=t,e=[],n.O=(t,r,s,a)=>{if(!r){var o=1/0;for(c=0;c<e.length;c++){for(var[r,s,a]=e[c],i=!0,l=0;l<r.length;l++)(!1&a||o>=a)&&Object.keys(n.O).every((e=>n.O[e](r[l])))?r.splice(l--,1):(i=!1,a<o&&(o=a));if(i){e.splice(c--,1);var m=s();void 0!==m&&(t=m)}}return t}a=a||0;for(var c=e.length;c>0&&e[c-1][2]>a;c--)e[c]=e[c-1];e[c]=[r,s,a]},n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={179:0};n.O.j=t=>0===e[t];var t=(t,r)=>{var s,a,[o,i,l]=r,m=0;if(o.some((t=>0!==e[t]))){for(s in i)n.o(i,s)&&(n.m[s]=i[s]);if(l)var c=l(n)}for(t&&t(r);m<o.length;m++)a=o[m],n.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return n.O(c)},r=self.webpackChunkbabylon_mmd=self.webpackChunkbabylon_mmd||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})();var s=n.O(void 0,[216],(()=>n(113)));s=n.O(s)})();