(()=>{var e,t={8110:()=>{},3975:(e,t,n)=>{"use strict";var r=n(2352);class o{_canvas;_engine;_scene;_onTick;constructor(e){this._canvas=e.canvas,this._engine=e.engine,this._scene=null,this._onTick=null}static async Create(e){const t=new o(e);return t._scene=await t._initialize(e.sceneBuilder),t._onTick=t._makeOnTick(),t}run(){const e=this._engine;window.addEventListener("resize",this._onResize),e.runRenderLoop(this._onTick)}dispose(){window.removeEventListener("resize",this._onResize),this._engine.dispose()}_onResize=()=>{this._engine.resize()};async _initialize(e){return await e.build(this._canvas,this._engine)}_makeOnTick(){const e=this._scene;return()=>e.render()}}var i,s=n(8110),a=n.n(s),l=(n(7714),n(3374),n(1999)),d=n(8963),h=n(2587),c=n(5804),u=n(6388),f=n(2922),g=n(5412),p=n(678),x=n(4073),m=n(658),A=n(5356),T=n(8139);class _{static Data=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="]}class y{uniqueId;leftLoadCount;isRequesting;errorTextureDatas;constructor(e){this.uniqueId=e,this.leftLoadCount=0,this.isRequesting=!0,this.errorTextureDatas=[]}}class E{observable;hasLoadError;constructor(){this.observable=new T.y$,this.hasLoadError=!1}}class I{cacheKey;_scene;_assetContainer;_onLoad;_onError;_arrayBuffer;_texture;constructor(e,t,n,r,o,i,s){this.cacheKey=e,this._scene=t,this._assetContainer=n,this._onLoad=i,this._onError=s,this._arrayBuffer=null,this._texture=null,o||t._loadFile(r,(r=>{const o=this._arrayBuffer=r;this._createTexture(t,n,e,o,i,((e,t)=>{this._arrayBuffer=null,s?.(e,t)}))}),void 0,!0,!0,((e,t)=>{s?.(e?e.status+" "+e.statusText:"",t)}))}loadFromArrayBuffer(e){this._arrayBuffer=e,this._createTexture(this._scene,this._assetContainer,this.cacheKey,this._arrayBuffer,this._onLoad,((e,t)=>{this._arrayBuffer=null,this._onError?.(e,t)}))}_createTexture(e,t,n,r,o,i){e._blockEntityCollection=!!t;const s=this._texture=new A.x("data:"+n,e,void 0,void 0,void 0,o,i,r,!0);s._parentContainer=t,e._blockEntityCollection=!1,t?.textures.push(s),s.name=n}get arrayBuffer(){return this._arrayBuffer}get texture(){return this._texture}}class M{onModelTextureLoadedObservable=new Map;textureCache=new Map;_textureLoadInfoMap=new Map;_loadingModels=new Map;_errorTexturesReferenceCount=new Map;static _EmptyResult={texture:null,arrayBuffer:null};_incrementLeftLoadCount(e){let t=this._loadingModels.get(e);void 0===t&&(t=new y(e),this._loadingModels.set(e,t)),t.leftLoadCount+=1;let n=this.onModelTextureLoadedObservable.get(e);return void 0===n&&(n=new T.y$,this.onModelTextureLoadedObservable.set(e,n)),t}_decrementLeftLoadCount(e){if(e.leftLoadCount-=1,!e.isRequesting&&0===e.leftLoadCount){this._removeErrorTexturesReferenceCount(e.uniqueId),this._loadingModels.delete(e.uniqueId);const t=this.onModelTextureLoadedObservable.get(e.uniqueId);t?.notifyObservers(),t?.clear(),this.onModelTextureLoadedObservable.delete(e.uniqueId)}}loadModelTexturesEnd(e){const t=this._loadingModels.get(e);if(void 0!==t&&(t.isRequesting=!1,0===t.leftLoadCount)){this._removeErrorTexturesReferenceCount(e),this._loadingModels.delete(e);const t=this.onModelTextureLoadedObservable.get(e);t?.notifyObservers(),t?.clear(),this.onModelTextureLoadedObservable.delete(e)}}_addErrorTextureReferenceCount(e,t){this._loadingModels.get(e).errorTextureDatas.push(t),this._errorTexturesReferenceCount.set(t,(this._errorTexturesReferenceCount.get(t)??0)+1)}_removeErrorTexturesReferenceCount(e){const t=this._loadingModels.get(e);for(let e=0;e<t.errorTextureDatas.length;++e){const n=t.errorTextureDatas[e],r=this._errorTexturesReferenceCount.get(n)-1;0===r?null!==n.texture?n.texture.dispose():(this._textureLoadInfoMap.delete(n.cacheKey),this.textureCache.delete(n.cacheKey),this._errorTexturesReferenceCount.delete(n)):this._errorTexturesReferenceCount.set(n,r)}}_handleTextureOnDispose(e){e.texture.onDisposeObservable.addOnce((()=>{this._textureLoadInfoMap.delete(e.cacheKey),this.textureCache.delete(e.cacheKey),this._errorTexturesReferenceCount.delete(e)}))}async _loadTextureAsyncInternal(e,t,n,r,o,i){const s=this._incrementLeftLoadCount(e);let a=this._textureLoadInfoMap.get(t);void 0===a&&(a=new E,this._textureLoadInfoMap.set(t,a));let l=this.textureCache.get(t);if(void 0===l&&!a.hasLoadError){const s=null!==r?_.Data[r]:t;l=new I(t,o,i,s,null!==n,(()=>{this._handleTextureOnDispose(l),a.hasLoadError=!1,a.observable.notifyObservers(!1),a.observable.clear()}),((t,n)=>{null!==l.texture&&this._handleTextureOnDispose(l),this._addErrorTextureReferenceCount(e,l),a.hasLoadError=!0,a.observable.notifyObservers(!0),a.observable.clear()})),this.textureCache.set(t,l);const d=n instanceof Blob?await n.arrayBuffer():n;null!==d&&l.loadFromArrayBuffer(d)}return null!==l.texture&&l.texture.isReady()?(this._decrementLeftLoadCount(s),a.hasLoadError?M._EmptyResult:l):new Promise((e=>{a.observable.addOnce((t=>{this._decrementLeftLoadCount(s),e(t?M._EmptyResult:l)}))}))}async loadTextureAsync(e,t,n,r,o){const i="number"==typeof n,s=i?i?"file:shared_toon_texture_"+n:n:this.pathNormalize(t+n);return await this._loadTextureAsyncInternal(e,s,null,i?n:null,r,o)}async loadTextureFromBufferAsync(e,t,n,r,o,i=!0){return i&&(t=this.pathNormalize(t)),await this._loadTextureAsyncInternal(e,t,n,null,r,o)}pathNormalize(e){const t=(e=e.replace(/\\/g,"/")).split("/"),n=[];for(let e=0;e<t.length;++e){const r=t[e];"."!==r&&(".."===r?n.pop():n.push(r))}return n.join("/")}}!function(e){let t,n,r,o,i,s,a,l,d;!function(e){let t;!function(e){e[e.Utf16le=0]="Utf16le",e[e.Utf8=1]="Utf8"}(t=e.Encoding||(e.Encoding={}))}(t=e.Header||(e.Header={})),function(e){let t;!function(e){e[e.Bdef1=0]="Bdef1",e[e.Bdef2=1]="Bdef2",e[e.Bdef4=2]="Bdef4",e[e.Sdef=3]="Sdef",e[e.Qdef=4]="Qdef"}(t=e.BoneWeightType||(e.BoneWeightType={}))}(n=e.Vertex||(e.Vertex={})),function(e){let t,n;!function(e){e[e.IsDoubleSided=1]="IsDoubleSided",e[e.EnabledGroundShadow=2]="EnabledGroundShadow",e[e.EnabledDrawShadow=4]="EnabledDrawShadow",e[e.EnabledReceiveShadow=8]="EnabledReceiveShadow",e[e.EnabledToonEdge=16]="EnabledToonEdge",e[e.EnabledVertexColor=32]="EnabledVertexColor",e[e.EnabledPointDraw=64]="EnabledPointDraw",e[e.EnabledLineDraw=128]="EnabledLineDraw"}(t=e.Flag||(e.Flag={})),function(e){e[e.Off=0]="Off",e[e.Multiply=1]="Multiply",e[e.Add=2]="Add",e[e.SubTexture=3]="SubTexture"}(n=e.SphereTextureMode||(e.SphereTextureMode={}))}(r=e.Material||(e.Material={})),function(e){let t;!function(e){e[e.UseBoneIndexAsTailPosition=1]="UseBoneIndexAsTailPosition",e[e.IsRotatable=2]="IsRotatable",e[e.IsMovable=4]="IsMovable",e[e.IsVisible=8]="IsVisible",e[e.IsControllable=16]="IsControllable",e[e.IsIkEnabled=32]="IsIkEnabled",e[e.LocalAppendTransform=128]="LocalAppendTransform",e[e.HasAppendRotate=256]="HasAppendRotate",e[e.HasAppendMove=512]="HasAppendMove",e[e.HasAxisLimit=1024]="HasAxisLimit",e[e.HasLocalVector=2048]="HasLocalVector",e[e.TransformAfterPhysics=4096]="TransformAfterPhysics",e[e.IsExternalParentTransformed=8192]="IsExternalParentTransformed"}(t=e.Flag||(e.Flag={}))}(o=e.Bone||(e.Bone={})),function(e){let t,n,r;!function(e){e[e.System=0]="System",e[e.Eyebrow=1]="Eyebrow",e[e.Eye=2]="Eye",e[e.Lip=3]="Lip",e[e.Other=4]="Other"}(t=e.Category||(e.Category={})),function(e){e[e.GroupMorph=0]="GroupMorph",e[e.VertexMorph=1]="VertexMorph",e[e.BoneMorph=2]="BoneMorph",e[e.UvMorph=3]="UvMorph",e[e.AdditionalUvMorph1=4]="AdditionalUvMorph1",e[e.AdditionalUvMorph2=5]="AdditionalUvMorph2",e[e.AdditionalUvMorph3=6]="AdditionalUvMorph3",e[e.AdditionalUvMorph4=7]="AdditionalUvMorph4",e[e.MaterialMorph=8]="MaterialMorph",e[e.FlipMorph=9]="FlipMorph",e[e.ImpulseMorph=10]="ImpulseMorph"}(n=e.Type||(e.Type={})),function(e){let t;!function(e){e[e.Multiply=0]="Multiply",e[e.Add=1]="Add"}(t=e.Type||(e.Type={}))}(r=e.MaterialMorph||(e.MaterialMorph={}))}(i=e.Morph||(e.Morph={})),function(e){let t;!function(e){let t;!function(e){e[e.Bone=0]="Bone",e[e.Morph=1]="Morph"}(t=e.FrameType||(e.FrameType={}))}(t=e.FrameData||(e.FrameData={}))}(s=e.DisplayFrame||(e.DisplayFrame={})),function(e){let t,n;!function(e){e[e.Sphere=0]="Sphere",e[e.Box=1]="Box",e[e.Capsule=2]="Capsule"}(t=e.ShapeType||(e.ShapeType={})),function(e){e[e.FollowBone=0]="FollowBone",e[e.Physics=1]="Physics",e[e.PhysicsWithBone=2]="PhysicsWithBone"}(n=e.PhysicsMode||(e.PhysicsMode={}))}(a=e.RigidBody||(e.RigidBody={})),function(e){let t;!function(e){e[e.Spring6dof=0]="Spring6dof",e[e.Sixdof=1]="Sixdof",e[e.P2p=2]="P2p",e[e.ConeTwist=3]="ConeTwist",e[e.Slider=4]="Slider",e[e.Hinge=5]="Hinge"}(t=e.Type||(e.Type={}))}(l=e.Joint||(e.Joint={})),function(e){let t,n,r;!function(e){e[e.TriMesh=0]="TriMesh",e[e.Rope=1]="Rope"}(t=e.Type||(e.Type={})),function(e){e[e.Blink=1]="Blink",e[e.ClusterCreation=2]="ClusterCreation",e[e.LinkCrossing=4]="LinkCrossing"}(n=e.Flag||(e.Flag={})),function(e){e[e.VertexPoint=0]="VertexPoint",e[e.VertexTwoSided=1]="VertexTwoSided",e[e.VertexOneSided=2]="VertexOneSided",e[e.FaceTwoSided=3]="FaceTwoSided",e[e.FaceOneSided=4]="FaceOneSided"}(r=e.AeroDynamicModel||(e.AeroDynamicModel={}))}(d=e.SoftBody||(e.SoftBody={}))}(i||(i={}));class b{log(e){console.log(e)}warn(e){console.warn(e)}error(e){console.error(e)}}class w{static _LittleEndian=!0;_dataView;_decoder;_offset;constructor(e){this._dataView=new DataView(e),this._decoder=null,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}getUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}getInt8(){const e=this._dataView.getInt8(this._offset);return this._offset+=1,e}getUint8Array(e,t){for(let n=0;n<t;++n)e[n]=this._dataView.getUint8(this._offset),this._offset+=1}getUint16(){const e=this._dataView.getUint16(this._offset,w._LittleEndian);return this._offset+=2,e}getUint16Array(e,t){for(let n=0;n<t;++n)e[n]=this._dataView.getUint16(this._offset,w._LittleEndian),this._offset+=2}getInt16(){const e=this._dataView.getInt16(this._offset,w._LittleEndian);return this._offset+=2,e}getUint32(){const e=this._dataView.getUint32(this._offset,w._LittleEndian);return this._offset+=4,e}getUint32Array(e,t){for(let n=0;n<t;++n)e[n]=this._dataView.getUint32(this._offset,w._LittleEndian),this._offset+=4}getInt32(){const e=this._dataView.getInt32(this._offset,w._LittleEndian);return this._offset+=4,e}getInt32Array(e,t){for(let n=0;n<t;++n)e[n]=this._dataView.getInt32(this._offset,w._LittleEndian),this._offset+=4}getFloat32(){const e=this._dataView.getFloat32(this._offset,w._LittleEndian);return this._offset+=4,e}getFloat32Array(e,t){for(let n=0;n<t;++n)e[n]=this._dataView.getFloat32(this._offset,w._LittleEndian),this._offset+=4}getFloat32Tuple(e){const t=new Array(e);for(let n=0;n<e;++n)t[n]=this._dataView.getFloat32(this._offset,w._LittleEndian),this._offset+=4;return t}initializeTextDecoder(e){this._decoder=new TextDecoder(e)}getDecoderString(e,t){if(null===this._decoder)throw new Error("TextDecoder is not initialized.");let n=new Uint8Array(this._dataView.buffer,this._offset,e);if(this._offset+=e,t)for(let e=0;e<n.length;++e)if(0===n[e]){n=n.subarray(0,e);break}return this._decoder.decode(n)}getSignatureString(e){const t=new TextDecoder("utf-8"),n=new Uint8Array(this._dataView.buffer,this._offset,e);return this._offset+=e,t.decode(n)}get bytesAvailable(){return this._dataView.byteLength-this._offset}}class S{_vertexIndexSize;_textureIndexSize;_materialIndexSize;_boneIndexSize;_morphIndexSize;_rigidBodyIndexSize;constructor(e,t,n,r,o,i){this._vertexIndexSize=e,this._textureIndexSize=t,this._materialIndexSize=n,this._boneIndexSize=r,this._morphIndexSize=o,this._rigidBodyIndexSize=i}getVertexIndex(e){switch(this._vertexIndexSize){case 1:return e.getUint8();case 2:return e.getUint16();case 4:return e.getInt32();default:throw new Error(`Invalid vertexIndexSize: ${this._vertexIndexSize}`)}}_getNonVertexIndex(e,t){switch(t){case 1:return e.getInt8();case 2:return e.getInt16();case 4:return e.getInt32();default:throw new Error(`Invalid indexSize: ${t}`)}}getTextureIndex(e){return this._getNonVertexIndex(e,this._textureIndexSize)}getMaterialIndex(e){return this._getNonVertexIndex(e,this._materialIndexSize)}getBoneIndex(e){return this._getNonVertexIndex(e,this._boneIndexSize)}getMorphIndex(e){return this._getNonVertexIndex(e,this._morphIndexSize)}getRigidBodyIndex(e){return this._getNonVertexIndex(e,this._rigidBodyIndexSize)}}class R{constructor(){}static async ParseAsync(e,t=new b){const n=new w(e),r=this._ParseHeader(n,t),o=new S(r.vertexIndexSize,r.textureIndexSize,r.materialIndexSize,r.boneIndexSize,r.morphIndexSize,r.rigidBodyIndexSize),i=await this._ParseVerticesAsync(n,o,r),s=this._ParseFaces(n,o,r),a=this._ParseTextures(n),l=this._ParseMaterials(n,o),d=this._ParseBones(n,o),h=this._ParseMorphs(n,o),c=this._ParseDisplayFrames(n,o),u=this._ParseRigidBodies(n,o),f=this._ParseJoints(n,o),g=r.version<=2?[]:this._ParseSoftBodies(n,o,r);return n.bytesAvailable>0&&t.warn(`There are ${n.bytesAvailable} bytes left after parsing`),{header:r,vertices:i,faces:s,textures:a,materials:l,bones:d,morphs:h,displayFrames:c,rigidBodies:u,joints:f,softBodies:g}}static _ParseHeader(e,t){if(e.bytesAvailable<17)throw new RangeError("is not pmx file");const n=e.getSignatureString(4);if("PMX "!==n)throw new RangeError("is not pmx file");const r=e.getFloat32(),o=e.getUint8(),s=e.getUint8();e.initializeTextDecoder(s===i.Header.Encoding.Utf8?"utf-8":"utf-16le");const a=e.getUint8(),l=e.getUint8(),d=e.getUint8(),h=e.getUint8(),c=e.getUint8(),u=e.getUint8(),f=e.getUint8();if(o<8)throw new Error(`Invalid globalsCount: ${o}`);if(8<o){t.warn(`globalsCount is greater than 8: ${o} files may be corrupted or higher version`);for(let t=8;t<o;++t)e.getUint8()}return{signature:n,version:r,encoding:s,additionalVec4Count:a,vertexIndexSize:l,textureIndexSize:d,materialIndexSize:h,boneIndexSize:c,morphIndexSize:u,rigidBodyIndexSize:f,modelName:e.getDecoderString(e.getInt32(),!1),englishModelName:e.getDecoderString(e.getInt32(),!1),comment:e.getDecoderString(e.getInt32(),!1),englishComment:e.getDecoderString(e.getInt32(),!1)}}static async _ParseVerticesAsync(e,t,n){const r=e.getInt32(),o=[];let s=performance.now();for(let a=0;a<r;++a){const r=e.getFloat32Tuple(3),l=e.getFloat32Tuple(3),d=e.getFloat32Tuple(2),h=[];for(let t=0;t<n.additionalVec4Count;t++)h.push(e.getFloat32Tuple(4));const c=e.getUint8();let u;switch(c){case i.Vertex.BoneWeightType.Bdef1:u={boneIndices:t.getBoneIndex(e),boneWeights:null};break;case i.Vertex.BoneWeightType.Bdef2:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:e.getFloat32()};break;case i.Vertex.BoneWeightType.Bdef4:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:[e.getFloat32(),e.getFloat32(),e.getFloat32(),e.getFloat32()]};break;case i.Vertex.BoneWeightType.Sdef:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:{boneWeight0:e.getFloat32(),c:e.getFloat32Tuple(3),r0:e.getFloat32Tuple(3),r1:e.getFloat32Tuple(3)}};break;case i.Vertex.BoneWeightType.Qdef:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:[e.getFloat32(),e.getFloat32(),e.getFloat32(),e.getFloat32()]};break;default:throw new Error(`Invalid weightType: ${c}`)}const f=e.getFloat32();o.push({position:r,normal:l,uv:d,additionalVec4:h,weightType:c,boneWeight:u,edgeRatio:f}),a%1e4==0&&100<performance.now()-s&&(await new Promise((e=>setTimeout(e,0))),s=performance.now())}return o}static _ParseFaces(e,t,n){const r=e.getInt32(),o=new ArrayBuffer(r*n.vertexIndexSize);let i;switch(n.vertexIndexSize){case 1:i=new Uint8Array(o);break;case 2:i=new Uint16Array(o);break;case 4:i=new Int32Array(o);break;default:throw new Error(`Invalid vertexIndexSize: ${n.vertexIndexSize}`)}for(let n=0;n<r;++n)i[n]=t.getVertexIndex(e);return i}static _ParseTextures(e){const t=e.getInt32(),n=[];for(let r=0;r<t;++r){const t=e.getDecoderString(e.getInt32(),!1);n.push(t)}return n}static _ParseMaterials(e,t){const n=e.getInt32(),r=[];for(let o=0;o<n;++o){const n=e.getDecoderString(e.getInt32(),!1),o=e.getDecoderString(e.getInt32(),!1),i=e.getFloat32Tuple(4),s=e.getFloat32Tuple(3),a=e.getFloat32(),l=e.getFloat32Tuple(3),d=e.getUint8(),h=e.getFloat32Tuple(4),c=e.getFloat32(),u=t.getTextureIndex(e),f=t.getTextureIndex(e),g=e.getUint8(),p=1===e.getUint8(),x={name:n,englishName:o,diffuse:i,specular:s,shininess:a,ambient:l,flag:d,edgeColor:h,edgeSize:c,textureIndex:u,sphereTextureIndex:f,sphereTextureMode:g,isSharedToonTexture:p,toonTextureIndex:p?e.getUint8():t.getTextureIndex(e),comment:e.getDecoderString(e.getInt32(),!1),surfaceCount:e.getInt32()};r.push(x)}return r}static _ParseBones(e,t){const n=e.getInt32(),r=[];for(let o=0;o<n;++o){const n=e.getDecoderString(e.getInt32(),!1),o=e.getDecoderString(e.getInt32(),!1),s=e.getFloat32Tuple(3),a=t.getBoneIndex(e),l=e.getInt32(),d=e.getUint16();let h,c,u,f;h=d&i.Bone.Flag.UseBoneIndexAsTailPosition?t.getBoneIndex(e):e.getFloat32Tuple(3),(d&i.Bone.Flag.HasAppendMove||d&i.Bone.Flag.HasAppendRotate)&&(c={isLocal:0!=(d&i.Bone.Flag.LocalAppendTransform),affectRotation:0!=(d&i.Bone.Flag.HasAppendRotate),affectPosition:0!=(d&i.Bone.Flag.HasAppendMove),parentIndex:t.getBoneIndex(e),ratio:e.getFloat32()}),d&i.Bone.Flag.HasAxisLimit&&(u=e.getFloat32Tuple(3)),d&i.Bone.Flag.HasLocalVector&&(f={x:e.getFloat32Tuple(3),z:e.getFloat32Tuple(3)});const g=0!=(d&i.Bone.Flag.TransformAfterPhysics);let p,x;if(d&i.Bone.Flag.IsExternalParentTransformed&&(p=e.getInt32()),d&i.Bone.Flag.IsIkEnabled){const n=t.getBoneIndex(e),r=e.getInt32(),o=e.getFloat32(),i=[],s=e.getInt32();for(let n=0;n<s;++n){const n={target:t.getBoneIndex(e),limitation:1===e.getUint8()?{minimumAngle:e.getFloat32Tuple(3),maximumAngle:e.getFloat32Tuple(3)}:void 0};i.push(n)}x={target:n,iteration:r,rotationConstraint:o,links:i}}const m={name:n,englishName:o,position:s,parentBoneIndex:a,transformOrder:l,flag:d,tailPosition:h,appendTransform:c,axisLimit:u,localVector:f,transformAfterPhysics:g,externalParentTransform:p,ik:x};r.push(m)}return r}static _ParseMorphs(e,t){const n=e.getInt32(),r=[];for(let o=0;o<n;++o){const n=e.getDecoderString(e.getInt32(),!1),o=e.getDecoderString(e.getInt32(),!1),s=e.getInt8(),a=e.getInt8();let l={name:n,englishName:o,category:s,type:a};const d=e.getInt32();switch(a){case i.Morph.Type.GroupMorph:{const n=new Int32Array(d),r=new Float32Array(d);for(let o=0;o<d;++o)n[o]=t.getMorphIndex(e),r[o]=e.getFloat32();l={...l,indices:n,ratios:r}}break;case i.Morph.Type.VertexMorph:{const n=new Int32Array(d),r=new Float32Array(3*d);for(let o=0;o<d;++o)n[o]=t.getVertexIndex(e),r[3*o+0]=e.getFloat32(),r[3*o+1]=e.getFloat32(),r[3*o+2]=e.getFloat32();l={...l,indices:n,positions:r}}break;case i.Morph.Type.BoneMorph:{const n=new Int32Array(d),r=new Float32Array(3*d),o=new Float32Array(4*d);for(let i=0;i<d;++i)n[i]=t.getBoneIndex(e),r[3*i+0]=e.getFloat32(),r[3*i+1]=e.getFloat32(),r[3*i+2]=e.getFloat32(),o[4*i+0]=e.getFloat32(),o[4*i+1]=e.getFloat32(),o[4*i+2]=e.getFloat32(),o[4*i+3]=e.getFloat32();l={...l,indices:n,positions:r,rotations:o}}break;case i.Morph.Type.UvMorph:case i.Morph.Type.AdditionalUvMorph1:case i.Morph.Type.AdditionalUvMorph2:case i.Morph.Type.AdditionalUvMorph3:case i.Morph.Type.AdditionalUvMorph4:{const n=new Int32Array(d),r=new Float32Array(4*d);for(let o=0;o<d;++o)n[o]=t.getVertexIndex(e),r[4*o+0]=e.getFloat32(),r[4*o+1]=e.getFloat32(),r[4*o+2]=e.getFloat32(),r[4*o+3]=e.getFloat32();l={...l,indices:n,offsets:r}}break;case i.Morph.Type.MaterialMorph:{const n=[];for(let r=0;r<d;++r){const r={index:t.getMaterialIndex(e),type:e.getUint8(),diffuse:e.getFloat32Tuple(4),specular:e.getFloat32Tuple(3),shininess:e.getFloat32(),ambient:e.getFloat32Tuple(3),edgeColor:e.getFloat32Tuple(4),edgeSize:e.getFloat32(),textureColor:e.getFloat32Tuple(4),sphereTextureColor:e.getFloat32Tuple(4),toonTextureColor:e.getFloat32Tuple(4)};n.push(r)}l={...l,elements:n}}break;case i.Morph.Type.FlipMorph:{const n=new Int32Array(d),r=new Float32Array(d);for(let o=0;o<d;++o)n[o]=t.getMorphIndex(e),r[o]=e.getFloat32();l={...l,indices:n,ratios:r}}break;case i.Morph.Type.ImpulseMorph:{const n=new Int32Array(d),r=new Array(d),o=new Float32Array(3*d),i=new Float32Array(3*d);for(let s=0;s<d;++s)n[s]=t.getRigidBodyIndex(e),r[s]=1===e.getUint8(),o[3*s+0]=e.getFloat32(),o[3*s+1]=e.getFloat32(),o[3*s+2]=e.getFloat32(),i[3*s+0]=e.getFloat32(),i[3*s+1]=e.getFloat32(),i[3*s+2]=e.getFloat32();l={...l,indices:n,isLocals:r,velocities:o,torques:i}}break;default:throw new Error(`Unknown morph type: ${a}`)}r.push(l)}return r}static _ParseDisplayFrames(e,t){const n=e.getInt32(),r=[];for(let o=0;o<n;++o){const n=e.getDecoderString(e.getInt32(),!1),o=e.getDecoderString(e.getInt32(),!1),s=1===e.getUint8(),a=e.getInt32(),l=[];for(let n=0;n<a;++n){const n=e.getUint8(),r={type:n,index:n===i.DisplayFrame.FrameData.FrameType.Bone?t.getBoneIndex(e):t.getMorphIndex(e)};l.push(r)}const d={name:n,englishName:o,isSpecialFrame:s,frames:l};r.push(d)}return r}static _ParseRigidBodies(e,t){const n=e.getInt32(),r=[];for(let o=0;o<n;++o){const n={name:e.getDecoderString(e.getInt32(),!1),englishName:e.getDecoderString(e.getInt32(),!1),boneIndex:t.getBoneIndex(e),collisionGroup:e.getUint8(),collisionMask:e.getUint16(),shapeType:e.getUint8(),shapeSize:e.getFloat32Tuple(3),shapePosition:e.getFloat32Tuple(3),shapeRotation:e.getFloat32Tuple(3),mass:e.getFloat32(),linearDamping:e.getFloat32(),angularDamping:e.getFloat32(),repulsion:e.getFloat32(),friction:e.getFloat32(),physicsMode:e.getUint8()};r.push(n)}return r}static _ParseJoints(e,t){const n=e.getInt32(),r=[];for(let o=0;o<n;++o){const n={name:e.getDecoderString(e.getInt32(),!1),englishName:e.getDecoderString(e.getInt32(),!1),type:e.getUint8(),rigidbodyIndexA:t.getRigidBodyIndex(e),rigidbodyIndexB:t.getRigidBodyIndex(e),position:e.getFloat32Tuple(3),rotation:e.getFloat32Tuple(3),positionMin:e.getFloat32Tuple(3),positionMax:e.getFloat32Tuple(3),rotationMin:e.getFloat32Tuple(3),rotationMax:e.getFloat32Tuple(3),springPosition:e.getFloat32Tuple(3),springRotation:e.getFloat32Tuple(3)};r.push(n)}return r}static _ParseSoftBodies(e,t,n){const r=e.getInt32(),o=[];for(let i=0;i<r;++i){const r=e.getDecoderString(e.getInt32(),!1),i=e.getDecoderString(e.getInt32(),!1),s=e.getUint8(),a=t.getMaterialIndex(e),l=e.getUint8(),d=e.getUint16(),h=e.getUint8(),c=e.getInt32(),u=e.getInt32(),f=e.getFloat32(),g=e.getFloat32(),p=e.getInt32(),x={vcf:e.getFloat32(),dp:e.getFloat32(),dg:e.getFloat32(),lf:e.getFloat32(),pr:e.getFloat32(),vc:e.getFloat32(),df:e.getFloat32(),mt:e.getFloat32(),chr:e.getFloat32(),khr:e.getFloat32(),shr:e.getFloat32(),ahr:e.getFloat32()},m={srhrCl:e.getFloat32(),skhrCl:e.getFloat32(),sshrCl:e.getFloat32(),srSpltCl:e.getFloat32(),skSpltCl:e.getFloat32(),ssSpltCl:e.getFloat32()},A={vIt:e.getInt32(),pIt:e.getInt32(),dIt:e.getInt32(),cIt:e.getInt32()},T={lst:e.getInt32(),ast:e.getInt32(),vst:e.getInt32()},_=e.getInt32(),y=[];for(let n=0;n<_;++n){const n={rigidbodyIndex:t.getRigidBodyIndex(e),vertexIndex:t.getVertexIndex(e),isNearMode:0!==e.getUint8()};y.push(n)}const E=e.getInt32(),I=new ArrayBuffer(E*n.vertexIndexSize);let M;switch(n.vertexIndexSize){case 1:M=new Uint8Array(I);break;case 2:M=new Uint16Array(I);break;case 4:M=new Int32Array(I);break;default:throw new Error(`Invalid vertexIndexSize: ${n.vertexIndexSize}`)}for(let n=0;n<E;++n)M[n]=t.getVertexIndex(e);const b={name:r,englishName:i,type:s,materialIndex:a,collisionGroup:l,collisionMask:d,flags:h,bLinkDistance:c,clusterCount:u,totalMass:f,collisionMargin:g,aeroModel:p,config:x,cluster:m,interation:A,material:T,anchors:y,vertexPins:M};o.push(b)}return o}}class C{files;_fileMap=new Map;constructor(e,t,n){if(t=this._pathNormalize(t),this.files=e,0!==e.length)if(e[0]instanceof File)for(const r of e){const e=n+this._pathNormalize(r.webkitRelativePath).slice(t.length);this._fileMap.set(this._pathNormalize(e),r)}else for(const t of e){const e=n+t.relativePath;this._fileMap.set(this._pathNormalize(e),t)}}resolve(e){const t=this._pathNormalize(e);return this._fileMap.get(t)}_pathNormalize(e){return e.replace(/\\/g,"/").toUpperCase()}}var v,F=n(2067);!function(e){e[e.Opaque=F.F.MATERIAL_OPAQUE]="Opaque",e[e.AlphaTest=F.F.MATERIAL_ALPHATEST]="AlphaTest",e[e.AlphaBlend=F.F.MATERIAL_ALPHABLEND]="AlphaBlend"}(v||(v={}));class B{texture;onLoadObservable;constructor(){this.texture=null,this.onLoadObservable=new T.y$}awaitLoad(){return new Promise((e=>{null!==this.texture?e(this):this.onLoadObservable.addOnce((()=>e(this)))}))}}class U{_resolution;_textureCache;_context;_vertexShader;_fragmentShader;_program;_uvBuffer;_indexBuffer;_indicesBytePerElement;constructor(e,t,n=512){this._resolution=n,this._textureCache=new Map,this._context=this._createRenderingContext(),this._vertexShader=null,this._fragmentShader=null,this._program=null,this._uvBuffer=null,this._indexBuffer=null,this._indicesBytePerElement=t.BYTES_PER_ELEMENT,!1!==this._prepareContext()&&!1!==this._bindUvAndIndexBuffer(e,t)||this.dispose()}_createRenderingContext(){const e=document.createElement("canvas");return e.width=this._resolution,e.height=this._resolution,e.getContext("webgl2",{alpha:!1,antialias:!1,depth:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1})}_prepareContext(){if(null===this._context)return!1;const e=this._context;e.clearColor(0,0,0,0);const t=this._vertexShader=e.createShader(e.VERTEX_SHADER);if(null===t)return!1;if(e.shaderSource(t,"\n            precision highp float;\n            attribute vec2 uv;\n            varying vec2 vUv;\n\n            void main() {\n                vUv = uv;\n                gl_Position = vec4(uv * 2.0 - 1.0, 0.0, 1.0);\n            }\n        "),e.compileShader(t),!e.getShaderParameter(t,e.COMPILE_STATUS))return console.error(e.getShaderInfoLog(t)),!1;const n=this._fragmentShader=e.createShader(e.FRAGMENT_SHADER);if(null===n)return!1;const r=`\n            precision highp float;\n            uniform sampler2D texture;\n            varying vec2 vUv;\n\n            void main() {\n                vec2 onePixel = vec2(1.0 / ${this._resolution.toFixed(1)});\n\n                float minAlpha = 1.0;\n                for (int i = 0; i < 2; ++i) {\n                    for (int j = 0; j < 2; ++j) {\n                        float alpha = texture2D(texture, vUv + vec2(onePixel.x * float(i), onePixel.y * float(j))).a;\n                        minAlpha = min(minAlpha, alpha);\n                    }\n                }\n                gl_FragColor = vec4(vec3(1.0) - minAlpha, 1.0);\n            }\n        `;if(e.shaderSource(n,r),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))return console.error(e.getShaderInfoLog(n)),!1;const o=this._program=e.createProgram();return null!==o&&(e.attachShader(o,t),e.attachShader(o,n),e.linkProgram(o),e.getProgramParameter(o,e.LINK_STATUS)?(e.useProgram(o),!0):(console.error(e.getProgramInfoLog(o)),!1))}async _getWebGlTexture(e){const t=this._context;if(null===t)return null;const n=this._textureCache.get(e);if(void 0!==n)return await n.awaitLoad(),n.texture;const r=new B;this._textureCache.set(e,r);const o=await new Promise(((t,n)=>{const r=new Image;r.onload=()=>t(r),r.onerror=()=>n(),r.src=URL.createObjectURL(new Blob([e]))})),i=t.createTexture();return null===i?null:(t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,o.width,o.height,0,t.RGBA,t.UNSIGNED_BYTE,o),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,1),URL.revokeObjectURL(o.src),r.texture=i,r.onLoadObservable.notifyObservers(),i)}_bindUvAndIndexBuffer(e,t){const n=this._context;if(null===n)return!1;const r=this._program;if(null===r)return!1;const o=this._uvBuffer=n.createBuffer();if(null===o)return!1;n.bindBuffer(n.ARRAY_BUFFER,o),n.bufferData(n.ARRAY_BUFFER,e,n.STATIC_DRAW);const i=n.getAttribLocation(r,"uv");n.enableVertexAttribArray(i),n.vertexAttribPointer(i,2,n.FLOAT,!1,0,0);const s=this._indexBuffer=n.createBuffer();return null!==s&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,s),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t,n.STATIC_DRAW),!0)}async textureHasAlphaOnGeometry(e,t,n,r,o){const i=this._context;if(null===i)return v.Opaque;const s=this._program;if(null===s)return v.Opaque;const a=await this._getWebGlTexture(e);if(null===a)return v.Opaque;i.clear(i.COLOR_BUFFER_BIT);const l=i.getUniformLocation(s,"texture");i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,a),i.uniform1i(l,0),i.drawElements(i.TRIANGLES,n,2===this._indicesBytePerElement?i.UNSIGNED_SHORT:i.UNSIGNED_INT,t*this._indicesBytePerElement);const d=this._resolution,h=new Uint8Array(d*d*4);i.readPixels(0,0,d,d,i.RGBA,i.UNSIGNED_BYTE,h);let c=0,u=0,f=0;for(let e=0;e<d;e+=2)for(let t=0;t<d;t+=2){const n=h[4*(e*d+t)];c=Math.max(c,n),0<n&&n<255&&(u+=n,f+=1)}return 0!==f&&(u/=f),c<r?v.Opaque:u+o<c?v.AlphaTest:v.AlphaBlend}dispose(){const e=this._context;if(null!==e){e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),e.bindTexture(e.TEXTURE_2D,null),e.useProgram(null),e.deleteBuffer(this._uvBuffer),e.deleteBuffer(this._indexBuffer);for(const t of this._textureCache.values())e.deleteTexture(t.texture);e.deleteProgram(this._program),e.deleteShader(this._vertexShader),e.deleteShader(this._fragmentShader),this._context=null,this._vertexShader=null,this._fragmentShader=null,this._program=null,this._uvBuffer=null,this._indexBuffer=null}}}class D{static _LittleEndian=!0;_dataView;_encoder;_offset;constructor(e){this._dataView=new DataView(e),this._encoder=new TextEncoder,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}setUint8(e){this._dataView.setUint8(this._offset,e),this._offset+=1}setUint8Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setUint8(this._offset,e[n]),this._offset+=1}setInt8(e){this._dataView.setInt8(this._offset,e),this._offset+=1}setInt8Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setInt8(this._offset,e[n]),this._offset+=1}setUint16(e){this._dataView.setUint16(this._offset,e,D._LittleEndian),this._offset+=2}setUint16Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setUint16(this._offset,e[n],D._LittleEndian),this._offset+=2}setUint32(e){this._dataView.setUint32(this._offset,e,D._LittleEndian),this._offset+=4}setUint32Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setUint32(this._offset,e[n],D._LittleEndian),this._offset+=4}setInt32(e){this._dataView.setInt32(this._offset,e,D._LittleEndian),this._offset+=4}setInt32Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setInt32(this._offset,e[n],D._LittleEndian),this._offset+=4}setFloat32(e){this._dataView.setFloat32(this._offset,e,D._LittleEndian),this._offset+=4}setFloat32Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setFloat32(this._offset,e[n],D._LittleEndian),this._offset+=4}setString(e){const t=this._dataView,n=this._encoder.encode(e);t.setUint32(this._offset,n.length,D._LittleEndian),this._offset+=4;for(let e=0;e<n.length;++e)t.setUint8(this._offset,n[e]),this._offset+=1}get bytesAvailable(){return this._dataView.byteLength-this._offset}}class P{alphaThreshold;alphaBlendThreshold;useAlphaEvaluation;alphaEvaluationResolution;_loggingEnabled;log;warn;error;constructor(){this.alphaThreshold=195,this.alphaBlendThreshold=100,this.useAlphaEvaluation=!0,this.alphaEvaluationResolution=512,this._loggingEnabled=!0,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled}async convert(e,t,n,r){const o=this.alphaThreshold,s=this.alphaBlendThreshold,a=this.useAlphaEvaluation,l=this.alphaEvaluationResolution;let d;if(void 0===n){const e=await fetch(t).then((e=>e.arrayBuffer()));d=await R.ParseAsync(e,this)}else{const e=n.find((e=>e.webkitRelativePath===t));if(void 0===e)throw new Error(`File ${t} not found`);const r=await e.arrayBuffer();d=await R.ParseAsync(r,this)}const h=d.vertices,c=new Float32Array(3*h.length),u=new Float32Array(3*h.length),f=new Float32Array(2*h.length);let g;g=d.faces instanceof Uint8Array||d.faces instanceof Uint16Array?new Uint16Array(d.faces.length):new Uint32Array(d.faces.length);const p=new Float32Array(4*h.length),x=new Float32Array(4*h.length);let m=!1;const A=new Float32Array(3*d.vertices.length),T=new Float32Array(3*d.vertices.length),_=new Float32Array(3*d.vertices.length);{const e=d.vertices;{const e=d.faces;for(let t=0;t<g.length;t+=3)g[t+0]=e[t+0],g[t+1]=e[t+2],g[t+2]=e[t+1]}for(let t=0;t<e.length;++t){const n=e[t];switch(c[3*t+0]=n.position[0],c[3*t+1]=n.position[1],c[3*t+2]=n.position[2],u[3*t+0]=n.normal[0],u[3*t+1]=n.normal[1],u[3*t+2]=n.normal[2],f[2*t+0]=n.uv[0],f[2*t+1]=1-n.uv[1],n.weightType){case i.Vertex.BoneWeightType.Bdef1:{const e=n.boneWeight;p[4*t+0]=e.boneIndices,p[4*t+1]=0,p[4*t+2]=0,p[4*t+3]=0,x[4*t+0]=1,x[4*t+1]=0,x[4*t+2]=0,x[4*t+3]=0}break;case i.Vertex.BoneWeightType.Bdef2:{const e=n.boneWeight;p[4*t+0]=e.boneIndices[0],p[4*t+1]=e.boneIndices[1],p[4*t+2]=0,p[4*t+3]=0,x[4*t+0]=e.boneWeights,x[4*t+1]=1-e.boneWeights,x[4*t+2]=0,x[4*t+3]=0}break;case i.Vertex.BoneWeightType.Bdef4:case i.Vertex.BoneWeightType.Qdef:{const e=n.boneWeight;p[4*t+0]=e.boneIndices[0],p[4*t+1]=e.boneIndices[1],p[4*t+2]=e.boneIndices[2],p[4*t+3]=e.boneIndices[3],x[4*t+0]=e.boneWeights[0],x[4*t+1]=e.boneWeights[1],x[4*t+2]=e.boneWeights[2],x[4*t+3]=e.boneWeights[3]}break;case i.Vertex.BoneWeightType.Sdef:{const e=n.boneWeight;p[4*t+0]=e.boneIndices[0],p[4*t+1]=e.boneIndices[1],p[4*t+2]=0,p[4*t+3]=0;const r=e.boneWeights,o=r.boneWeight0,i=1-o;x[4*t+0]=o,x[4*t+1]=i,x[4*t+2]=0,x[4*t+3]=0,A[3*t+0]=r.c[0],A[3*t+1]=r.c[1],A[3*t+2]=r.c[2],T[3*t+0]=r.r0[0],T[3*t+1]=r.r0[1],T[3*t+2]=r.r0[2],_[3*t+0]=r.r1[0],_[3*t+1]=r.r1[1],_[3*t+2]=r.r1[2],m=!0}}}}const y=[];{const r=new Array(d.textures.length),o=t.substring(0,t.lastIndexOf("/")+1),i=new M,s=new C(n??[],o,""),a=[],l=d.materials;for(let t=0;t<l.length;++t){const n=l[t],h=d.textures[n.textureIndex];if(void 0!==h){const t=s.resolve(h);void 0!==t?a.push(i.loadTextureFromBufferAsync(0,h,t,e,null).then((e=>{r[n.textureIndex]=e}))):a.push(i.loadTextureAsync(0,o,h,e,null).then((e=>{r[n.textureIndex]=e})))}const c=d.textures[n.sphereTextureIndex];if(void 0!==c){const t=s.resolve(c);void 0!==t?a.push(i.loadTextureFromBufferAsync(0,c,t,e,null).then((e=>{r[n.sphereTextureIndex]=e}))):a.push(i.loadTextureAsync(0,o,c,e,null).then((e=>{r[n.sphereTextureIndex]=e})))}const u=d.textures[n.toonTextureIndex];if(void 0!==u&&!n.isSharedToonTexture){const t=s.resolve(u);void 0!==t?a.push(i.loadTextureFromBufferAsync(0,u,t,e,null).then((e=>{r[n.toonTextureIndex]=e}))):a.push(i.loadTextureAsync(0,o,u,e,null).then((e=>{r[n.toonTextureIndex]=e})))}}i.loadModelTexturesEnd(0),await Promise.all(a);const h=i.onModelTextureLoadedObservable.get(0);void 0!==h&&await new Promise((e=>{h.addOnce((()=>{e()}))}));for(let e=0;e<r.length;++e){const t=r[e];y[e]=t.arrayBuffer,t.texture?.dispose()}}const E=new Array(d.materials.length).fill(-1);if(a){const e=new U(f,g,l),t=d.materials;let n=0;for(let r=0;r<t.length;++r){const i=t[r];if(void 0!==d.textures[i.textureIndex]){const t=y[i.textureIndex];if(null!==t){const a=await e.textureHasAlphaOnGeometry(t,n,i.surfaceCount,o,s);E[r]=a}}n+=i.surfaceCount}e.dispose()}if(void 0!==r){const e=d.materials,t=new Array(e.length);for(let n=0;n<e.length;++n)t[n]=e[n].name;r(t,E)}const I=new TextEncoder;let b=7;{const e=d.header;b+=4+I.encode(e.modelName).length,b+=4+I.encode(e.englishModelName).length,b+=4+I.encode(e.comment).length,b+=4+I.encode(e.englishComment).length,b+=4,b+=3*h.length*4,b+=3*h.length*4,b+=2*h.length*4,b+=1,b+=4,b+=g.byteLength,b+=4*h.length*4,b+=4*h.length*4,b+=1,m&&(b+=3*h.length*4,b+=3*h.length*4,b+=3*h.length*4),b+=4;const t=d.textures;for(let e=0;e<t.length;++e){const n=y[e];null!==n?(b+=4+I.encode(t[e]).length,b+=4,b+=n.byteLength):(b+=4,b+=4)}b+=4;const n=d.materials;for(let e=0;e<n.length;++e){const t=n[e];b+=4+I.encode(t.name).length,b+=4+I.encode(t.englishName).length,b+=16,b+=12,b+=4,b+=12,b+=1,b+=1,b+=16,b+=4,b+=4,b+=4,b+=1,b+=1,b+=4,b+=4+I.encode(t.comment).length,b+=4}b+=4;const r=d.bones;for(let e=0;e<r.length;++e){const t=r[e];if(b+=4+I.encode(t.name).length,b+=4+I.encode(t.englishName).length,b+=12,b+=4,b+=4,b+=2,"number"==typeof t.tailPosition?b+=4:b+=12,void 0!==t.appendTransform&&(b+=4,b+=4),void 0!==t.axisLimit&&(b+=12),void 0!==t.localVector&&(b+=12,b+=12),void 0!==t.externalParentTransform&&(b+=4),void 0!==t.ik){b+=4,b+=4,b+=4,b+=4;const e=t.ik.links;for(let t=0;t<e.length;++t)b+=4,b+=1,void 0!==e[t].limitation&&(b+=12,b+=12)}}b+=4;const o=d.morphs;for(let e=0;e<o.length;++e){const t=o[e];switch(b+=4+I.encode(t.name).length,b+=4+I.encode(t.englishName).length,b+=1,b+=1,b+=4,t.type){case i.Morph.Type.GroupMorph:b+=8*t.indices.length;break;case i.Morph.Type.VertexMorph:b+=16*t.indices.length;break;case i.Morph.Type.BoneMorph:b+=32*t.indices.length;break;case i.Morph.Type.UvMorph:case i.Morph.Type.AdditionalUvMorph1:case i.Morph.Type.AdditionalUvMorph2:case i.Morph.Type.AdditionalUvMorph3:case i.Morph.Type.AdditionalUvMorph4:b+=20*t.indices.length;break;case i.Morph.Type.MaterialMorph:b+=117*t.elements.length}}b+=4;const s=d.displayFrames;for(let e=0;e<s.length;++e){const t=s[e];b+=4+I.encode(t.name).length,b+=4+I.encode(t.englishName).length,b+=1,b+=4,b+=5*t.frames.length}b+=4;const a=d.rigidBodies;for(let e=0;e<a.length;++e){const t=a[e];b+=4+I.encode(t.name).length,b+=4+I.encode(t.englishName).length,b+=4,b+=1,b+=2,b+=1,b+=12,b+=12,b+=12,b+=4,b+=4,b+=4,b+=4,b+=4,b+=1}b+=4;const l=d.joints;for(let e=0;e<l.length;++e){const t=l[e];b+=4+I.encode(t.name).length,b+=4+I.encode(t.englishName).length,b+=1,b+=4,b+=4,b+=12,b+=12,b+=12,b+=12,b+=12,b+=12,b+=12,b+=12}}const w=new ArrayBuffer(b),S=new D(w);S.setUint8Array(I.encode("BPMX")),S.setInt8Array([1,0,0]),S.setString(d.header.modelName),S.setString(d.header.englishModelName),S.setString(d.header.comment),S.setString(d.header.englishComment),S.setUint32(h.length),S.setFloat32Array(c),S.setFloat32Array(u),S.setFloat32Array(f),g instanceof Uint16Array?(S.setUint8(2),S.setUint32(g.length),S.setUint16Array(g)):(S.setUint8(4),S.setUint32(g.length),S.setUint32Array(g)),S.setFloat32Array(p),S.setFloat32Array(x),S.setUint8(m?1:0),m&&(S.setFloat32Array(A),S.setFloat32Array(T),S.setFloat32Array(_)),S.setUint32(d.textures.length);const v=d.textures;for(let e=0;e<y.length;++e){const t=y[e];null!==t?(S.setString(v[e]),S.setUint32(t.byteLength),S.setUint8Array(new Uint8Array(t))):(S.setUint32(0),S.setUint32(0))}S.setUint32(d.materials.length);const F=d.materials;for(let e=0;e<F.length;++e){const t=F[e];S.setString(t.name),S.setString(t.englishName),S.setFloat32Array(t.diffuse),S.setFloat32Array(t.specular),S.setFloat32(t.shininess),S.setFloat32Array(t.ambient),S.setInt8(E[e]),S.setUint8(t.flag),S.setFloat32Array(t.edgeColor),S.setFloat32(t.edgeSize),S.setInt32(t.textureIndex),S.setInt32(t.sphereTextureIndex),S.setUint8(t.sphereTextureMode),S.setUint8(t.isSharedToonTexture?1:0),S.setInt32(t.toonTextureIndex),S.setString(t.comment),S.setUint32(t.surfaceCount)}S.setUint32(d.bones.length);const B=d.bones;for(let e=0;e<B.length;++e){const t=B[e];if(S.setString(t.name),S.setString(t.englishName),S.setFloat32Array(t.position),S.setInt32(t.parentBoneIndex),S.setInt32(t.transformOrder),S.setUint16(t.flag),"number"==typeof t.tailPosition?S.setFloat32(t.tailPosition):S.setFloat32Array(t.tailPosition),void 0!==t.appendTransform&&(S.setInt32(t.appendTransform.parentIndex),S.setFloat32(t.appendTransform.ratio)),void 0!==t.axisLimit&&S.setFloat32Array(t.axisLimit),void 0!==t.localVector&&(S.setFloat32Array(t.localVector.x),S.setFloat32Array(t.localVector.z)),void 0!==t.externalParentTransform&&S.setInt32(t.externalParentTransform),void 0!==t.ik){const e=t.ik;S.setInt32(e.target),S.setInt32(e.iteration),S.setFloat32(e.rotationConstraint);const n=e.links;S.setInt32(n.length);for(let e=0;e<n.length;++e){const t=n[e];S.setInt32(t.target),S.setUint8(void 0!==t.limitation?1:0),void 0!==t.limitation&&(S.setFloat32Array(t.limitation.minimumAngle),S.setFloat32Array(t.limitation.maximumAngle))}}}S.setUint32(d.morphs.length);const P=d.morphs;for(let e=0;e<P.length;++e){const t=P[e];switch(S.setString(t.name),S.setString(t.englishName),S.setUint8(t.category),S.setUint8(t.type),t.type){case i.Morph.Type.GroupMorph:S.setUint32(t.indices.length),S.setInt32Array(t.indices),S.setFloat32Array(t.ratios);break;case i.Morph.Type.VertexMorph:S.setUint32(t.indices.length),S.setInt32Array(t.indices),S.setFloat32Array(t.positions);break;case i.Morph.Type.BoneMorph:S.setUint32(t.indices.length),S.setInt32Array(t.indices),S.setFloat32Array(t.positions),S.setFloat32Array(t.rotations);break;case i.Morph.Type.UvMorph:case i.Morph.Type.AdditionalUvMorph1:case i.Morph.Type.AdditionalUvMorph2:case i.Morph.Type.AdditionalUvMorph3:case i.Morph.Type.AdditionalUvMorph4:S.setUint32(t.indices.length),S.setInt32Array(t.indices),S.setFloat32Array(t.offsets);break;case i.Morph.Type.MaterialMorph:{S.setUint32(t.elements.length);const e=t.elements;for(let t=0;t<e.length;++t){const n=e[t];S.setInt32(n.index),S.setUint8(n.type),S.setFloat32Array(n.diffuse),S.setFloat32Array(n.specular),S.setFloat32(n.shininess),S.setFloat32Array(n.ambient),S.setFloat32Array(n.edgeColor),S.setFloat32(n.edgeSize),S.setFloat32Array(n.textureColor),S.setFloat32Array(n.sphereTextureColor),S.setFloat32Array(n.toonTextureColor)}}break;default:S.setUint32(0)}}S.setUint32(d.displayFrames.length);const O=d.displayFrames;for(let e=0;e<O.length;++e){const t=O[e];S.setString(t.name),S.setString(t.englishName),S.setUint8(t.isSpecialFrame?1:0),S.setUint32(t.frames.length);const n=t.frames;for(let e=0;e<n.length;++e){const t=n[e];S.setUint8(t.type),S.setInt32(t.index)}}S.setUint32(d.rigidBodies.length);const L=d.rigidBodies;for(let e=0;e<L.length;++e){const t=L[e];S.setString(t.name),S.setString(t.englishName),S.setInt32(t.boneIndex),S.setUint8(t.collisionGroup),S.setUint16(t.collisionMask),S.setUint8(t.shapeType),S.setFloat32Array(t.shapeSize),S.setFloat32Array(t.shapePosition),S.setFloat32Array(t.shapeRotation),S.setFloat32(t.mass),S.setFloat32(t.linearDamping),S.setFloat32(t.angularDamping),S.setFloat32(t.repulsion),S.setFloat32(t.friction),S.setUint8(t.physicsMode)}S.setUint32(d.joints.length);const N=d.joints;for(let e=0;e<N.length;++e){const t=N[e];S.setString(t.name),S.setString(t.englishName),S.setUint8(t.type),S.setInt32(t.rigidbodyIndexA),S.setInt32(t.rigidbodyIndexB),S.setFloat32Array(t.position),S.setFloat32Array(t.rotation),S.setFloat32Array(t.positionMin),S.setFloat32Array(t.positionMax),S.setFloat32Array(t.rotationMin),S.setFloat32Array(t.rotationMax),S.setFloat32Array(t.springPosition),S.setFloat32Array(t.springRotation)}return w}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){m.Y.Log(e)}_logDisabled(){}_warnEnabled(e){m.Y.Warn(e)}_warnDisabled(){}_errorEnabled(e){m.Y.Error(e)}_errorDisabled(){}}var O=n(255),L=n(5312),N=n(5017),V=n(2543),k=n(8058),W=n(4106),z=n(2385),X=n(2341),H=n(2175),G=n(8658),K=n(1547),Q=n(7585),q=(n(7390),n(9089),n(2186)),Y=n(8494),j=n(6181),J=n(7050),$=n(708),Z=n(2108),ee=n(4559);class te{static MatricesSdefCKind="matricesSdefC";static MatricesSdefR0Kind="matricesSdefR0";static MatricesSdefR1Kind="matricesSdefR1"}var ne=n(475);const re="\n#ifndef SDEFDECLARATION\n#define SDEFDECLARATION\n\n#if NUM_BONE_INFLUENCERS > 0 && defined(SDEF)\nattribute vec3 matricesSdefC;\nattribute vec3 matricesSdefR0;\nattribute vec3 matricesSdefR1;\n\nvec4 rotationMatrixToQuaternion(mat3 matrix) {\n    float trace = matrix[0][0] + matrix[1][1] + matrix[2][2];\n    float s;\n\n    float sqrtParam;\n    if (trace > 0.0) {\n        sqrtParam = trace + 1.0;\n    } else if (matrix[0][0] > matrix[1][1] && matrix[0][0] > matrix[2][2]) {\n        sqrtParam = 1.0 + matrix[0][0] - matrix[1][1] - matrix[2][2];\n    } else if (matrix[1][1] > matrix[2][2]) {\n        sqrtParam = 1.0 + matrix[1][1] - matrix[0][0] - matrix[2][2];\n    } else {\n        sqrtParam = 1.0 + matrix[2][2] - matrix[0][0] - matrix[1][1];\n    }\n    float sqrtValue = sqrt(sqrtParam);\n\n    if (trace > 0.0) {\n        s = 0.5 / sqrtValue;\n\n        return vec4(\n            (matrix[1][2] - matrix[2][1]) * s,\n            (matrix[2][0] - matrix[0][2]) * s,\n            (matrix[0][1] - matrix[1][0]) * s,\n            0.25 / s\n        );\n    } else if (matrix[0][0] > matrix[1][1] && matrix[0][0] > matrix[2][2]) {\n        s = 2.0 * sqrtValue;\n\n        return vec4(\n            0.25 * s,\n            (matrix[0][1] + matrix[1][0]) / s,\n            (matrix[2][0] + matrix[0][2]) / s,\n            (matrix[1][2] - matrix[2][1]) / s\n        );\n    } else if (matrix[1][1] > matrix[2][2]) {\n        s = 2.0 * sqrtValue;\n        \n        return vec4(\n            (matrix[0][1] + matrix[1][0]) / s,\n            0.25 * s,\n            (matrix[1][2] + matrix[2][1]) / s,\n            (matrix[2][0] - matrix[0][2]) / s\n        );\n    } else {\n        s = 2.0 * sqrtValue;\n\n        return vec4(\n            (matrix[2][0] + matrix[0][2]) / s,\n            (matrix[1][2] + matrix[2][1]) / s,\n            0.25 * s,\n            (matrix[0][1] - matrix[1][0]) / s\n        );\n    }\n}\n\nmat3 quaternionToRotationMatrix(vec4 q) {\n    float xx = q.x * q.x;\n    float yy = q.y * q.y;\n    float zz = q.z * q.z;\n    float xy = q.x * q.y;\n    float zw = q.z * q.w;\n    float zx = q.z * q.x;\n    float yw = q.y * q.w;\n    float yz = q.y * q.z;\n    float xw = q.x * q.w;\n\n    return mat3(\n        1.0 - 2.0 * (yy + zz), 2.0 * (xy + zw), 2.0 * (zx - yw),\n        2.0 * (xy - zw), 1.0 - 2.0 * (zz + xx), 2.0 * (yz + xw),\n        2.0 * (zx + yw), 2.0 * (yz - xw), 1.0 - 2.0 * (yy + xx)\n    );\n}\n\nvec4 slerp(vec4 q0, vec4 q1, float t) {\n    float cosTheta = dot(q0, q1);\n\n    // if (cosTheta < 0.0) {\n    //     q1 = -q1;\n    //     cosTheta = -cosTheta;\n    // }\n    q1 = mix(-q1, q1, step(0.0, cosTheta));\n    cosTheta = abs(cosTheta);\n    \n    if (cosTheta > 0.999999) {\n        return normalize(mix(q0, q1, t));\n    }\n\n    float theta = acos(cosTheta);\n    float sinTheta = sin(theta);\n\n    float w0 = sin((1.0 - t) * theta) / sinTheta;\n    float w1 = sin(t * theta) / sinTheta;\n\n    return q0 * w0 + q1 * w1;\n}\n#endif\n\n#endif\n",oe="\n#ifndef SDEFVERTEX\n#define SDEFVERTEX\n\n#if !defined(BAKED_VERTEX_ANIMATION_TEXTURE) && defined(SDEF)\n\n#if NUM_BONE_INFLUENCERS > 0\n{\n    float weight0 = matricesWeights[0];\n    float weight1 = matricesWeights[1];\n\n    #ifdef BONETEXTURE\n        mat4 transformMatrix0 = readMatrixFromRawSampler(boneSampler, matricesIndices[0]);\n        mat4 transformMatrix1 = readMatrixFromRawSampler(boneSampler, matricesIndices[1]);\n    #else\n        mat4 transformMatrix0 = mBones[int(matricesIndices[0])];\n        mat4 transformMatrix1 = mBones[int(matricesIndices[1])];\n    #endif\n\n    mat3 slerpedRotationMatrix = quaternionToRotationMatrix(slerp(\n        rotationMatrixToQuaternion(mat3(transformMatrix0)), \n        rotationMatrixToQuaternion(mat3(transformMatrix1)),\n        weight1\n    ));\n\n    // -center transform\n    mat4 sdefInflunce = mat4(\n        vec4(1.0, 0.0, 0.0, 0.0),\n        vec4(0.0, 1.0, 0.0, 0.0),\n        vec4(0.0, 0.0, 1.0, 0.0),\n        vec4(-matricesSdefC, 1.0)\n    );\n\n    // rotation\n    mat4 rotationMatrix = mat4(\n        vec4(slerpedRotationMatrix[0], 0.0),\n        vec4(slerpedRotationMatrix[1], 0.0),\n        vec4(slerpedRotationMatrix[2], 0.0),\n        vec4(0.0, 0.0, 0.0, 1.0)\n    );\n    sdefInflunce = rotationMatrix * sdefInflunce;\n\n    // add position offset\n    vec3 positionOffset =\n        vec3(transformMatrix0 * vec4(matricesSdefR0, 1)) * weight0 +\n        vec3(transformMatrix1 * vec4(matricesSdefR1, 1)) * weight1;\n\n    sdefInflunce[3] += vec4(positionOffset, 0.0);\n    \n    float useLinearDeform = step(0.0, -abs(matricesSdefR0.x));\n\n    influence = mat4(\n        mix(sdefInflunce[0], influence[0], useLinearDeform),\n        mix(sdefInflunce[1], influence[1], useLinearDeform),\n        mix(sdefInflunce[2], influence[2], useLinearDeform),\n        mix(sdefInflunce[3], influence[3], useLinearDeform)\n    );\n}\n#endif\n\n#endif\n\n#endif\n";class ie{static OverrideEngineCreateEffect(e){const t=e.createEffect.bind(e);e.createEffect=function(e,n,r,o,i,s,a,l,d,h=ne.x.GLSL){let c;if(c=n.attributes?n:{attributes:n,uniformsNames:r,uniformBuffersNames:[],samplers:o??[],defines:i??"",fallbacks:s??null,onCompiled:a??null,onError:l??null,indexParameters:d??null,shaderLanguage:h},(c.shaderLanguage===ne.x.GLSL||void 0===c.shaderLanguage)&&(c.uniformsNames.includes("mBones")||c.samplers.includes("boneSampler"))&&-1===c.defines.indexOf("#define SDEF")){c.attributes.push(te.MatricesSdefCKind),c.attributes.push(te.MatricesSdefR0Kind),c.attributes.push(te.MatricesSdefR1Kind),c.defines+="\n#define SDEF";const e=c.processCodeAfterIncludes;c.processCodeAfterIncludes=e?function(t,n){return n=e(t,n),ie.ProcessSdefCode(t,n)}:ie.ProcessSdefCode}return t(e,c,this)}}static ProcessSdefCode(e,t){if("vertex"!==e)return t;const n="#define CUSTOM_VERTEX_DEFINITIONS";t=t.replace(n,`${n}\n${re}`);const r=new RegExp("finalWorld=finalWorld\\*influence;","g");return t.replace(r,`${oe}\nfinalWorld=finalWorld*influence;`)}}class se{static _StencilReference=4;name=ee.l.NAME_OUTLINERENDERER;scene;zOffset=-8;zOffsetUnits=4;_engine;_savedDepthWrite;_passIdForDrawWrapper;constructor(e){this.scene=e,this._engine=e.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=[];for(let e=0;e<3;++e)this._passIdForDrawWrapper[e]=this._engine.createRenderPassId(`Mmd Outline Renderer (${e})`);this._savedDepthWrite=!1}register(){this.scene._beforeRenderingMeshStage.registerStep(ee.l.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(ee.l.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){for(let e=0;e<this._passIdForDrawWrapper.length;++e)this._engine.releaseRenderPassId(this._passIdForDrawWrapper[e])}render(e,t,n,r){r=r??this._passIdForDrawWrapper[0];const o=this.scene,i=o.getEngine(),s=i.getCaps().instancedArrays&&(null!==t.visibleInstances[e._id]&&void 0!==t.visibleInstances[e._id]||e.getRenderingMesh().hasThinInstances);if(!this.isReady(e,s,r))return;const a=e.getMesh(),l=a._internalAbstractMeshDataInfo._actAsRegularMesh?a:null,d=e.getRenderingMesh(),h=l||d,c=e.getMaterial();if(!c||!o.activeCamera)return;const u=e._getDrawWrapper(r),f=J.q.GetEffect(u);if(i.enableEffect(u),c.useLogarithmicDepth&&f.setFloat("logarithmicDepthConstant",2/(Math.log(o.activeCamera.maxZ+1)/Math.LN2)),f.setFloat("offset",n??c.outlineWidth),f.setColor4("color",c.outlineColor,c.outlineAlpha),f.setMatrix("viewProjection",o.getTransformMatrix()),f.setMatrix("world",h.getWorldMatrix()),Z.G.BindBonesParameters(h,f),d.morphTargetManager&&d.morphTargetManager.isUsingTextureForTargets&&d.morphTargetManager._bind(f),Z.G.BindMorphTargetParameters(d,f),s||d._bind(e,f,c.fillMode),c&&c.needAlphaTesting()){const e=c.getAlphaTestTexture();e&&(f.setTexture("diffuseSampler",e),f.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,j.an)(f,c,o),i.setZOffset(-this.zOffset),i.setZOffsetUnits(-this.zOffsetUnits),d._processRendering(h,e,f,c.fillMode,t,s,((e,t)=>{f.setMatrix("world",t)})),i.setZOffset(0),i.setZOffsetUnits(0)}isReady(e,t,n){n=n??this._passIdForDrawWrapper[0];const r=[],o=[q.o.PositionKind,q.o.NormalKind],i=e.getMesh(),s=e.getMaterial();if(!s)return!1;const a=i.getScene();s.needAlphaTesting()&&(r.push("#define ALPHATEST"),i.isVerticesDataPresent(q.o.UVKind)&&(o.push(q.o.UVKind),r.push("#define UV1")),i.isVerticesDataPresent(q.o.UV2Kind)&&(o.push(q.o.UV2Kind),r.push("#define UV2"))),s.useLogarithmicDepth&&r.push("#define LOGARITHMICDEPTH"),(0,j.lK)(s,a,r);const l=new $.L;if(i.useBones&&i.computeBonesUsingShaders&&i.skeleton){o.push(q.o.MatricesIndicesKind),o.push(q.o.MatricesWeightsKind),i.numBoneInfluencers>4&&(o.push(q.o.MatricesIndicesExtraKind),o.push(q.o.MatricesWeightsExtraKind)),i.isVerticesDataPresent(te.MatricesSdefCKind)&&(o.push(te.MatricesSdefCKind),o.push(te.MatricesSdefR0Kind),o.push(te.MatricesSdefR1Kind),r.push("#define SDEF"));const e=i.skeleton;r.push("#define NUM_BONE_INFLUENCERS "+i.numBoneInfluencers),i.numBoneInfluencers>0&&l.addCPUSkinningFallback(0,i),e.isUsingTextureForMatrices?r.push("#define BONETEXTURE"):r.push("#define BonesPerMesh "+(e.bones.length+1))}else r.push("#define NUM_BONE_INFLUENCERS 0");const d=i.morphTargetManager;let h=0;d&&d.numInfluencers>0&&(h=d.numInfluencers,r.push("#define MORPHTARGETS"),r.push("#define NUM_MORPH_INFLUENCERS "+h),d.isUsingTextureForTargets&&r.push("#define MORPHTARGETS_TEXTURE"),Z.G.PrepareAttributesForMorphTargetsInfluencers(o,i,h)),t&&(r.push("#define INSTANCES"),Z.G.PushAttributesForInstances(o),e.getRenderingMesh().hasThinInstances&&r.push("#define THIN_INSTANCES"));const c=e._getDrawWrapper(n,!0),u=c.defines,f=r.join("\n");if(u!==f){const e=["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],t=["diffuseSampler","boneSampler","morphTargets"];(0,j.qx)(e),c.setEffect(this.scene.getEngine().createEffect("outline",{attributes:o,uniformsNames:e,samplers:t,defines:f,indexParameters:{maxSimultaneousMorphTargets:h},processCodeAfterIncludes:ie.ProcessSdefCode},this.scene.getEngine()),f)}return c.effect.isReady()}_beforeRenderingMesh(e,t,n){this._savedDepthWrite=this._engine.getDepthWrite();const r=t.getMaterial();if(r&&r.renderOutline){r.needAlphaBlendingForMesh(e)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(Y.g.REPLACE),this._engine.setStencilFunction(Y.g.ALWAYS),this._engine.setStencilMask(se._StencilReference),this._engine.setStencilFunctionReference(se._StencilReference),this._engine.stencilStateComposer.useStencilGlobalOnly=!0,this.render(t,n,0,this._passIdForDrawWrapper[1]),this._engine.setColorWrite(!0),this._engine.setStencilFunction(Y.g.NOTEQUAL)),this._engine.setDepthWrite(!1);const o=this._engine.getAlphaMode(),i=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(Y.g.ALPHA_COMBINE),this.render(t,n,void 0,this._passIdForDrawWrapper[0]),this._engine.setAlphaMode(o),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.alphaBlend=i,r.needAlphaBlendingForMesh(e)&&(this._engine.stencilStateComposer.useStencilGlobalOnly=!1,this._engine.restoreStencilState())}}_afterRenderingMesh(e,t,n){const r=t.getMaterial();null!==r&&r.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(t,n,void 0,this._passIdForDrawWrapper[2]),this._engine.setColorWrite(!0))}static RegisterMmdOutlineRendererIfNeeded(){x.x.prototype.getMmdOutlineRenderer||(x.x.prototype.getMmdOutlineRenderer=function(){return this._mmdOutlineRenderer||(this._mmdOutlineRenderer=new se(this)),this._mmdOutlineRenderer})}}var ae,le=n(4386),de=n(539);class he extends le.H{SPHERE_TEXTURE=!1;SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=!1;SPHERE_TEXTURE_BLEND_MODE_ADD=!1;TOON_TEXTURE=!1;IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=!1;TEXTURE_COLOR=!1;SPHERE_TEXTURE_COLOR=!1;TOON_TEXTURE_COLOR=!1;SDEF=!1}!function(e){e[e.Multiply=1]="Multiply",e[e.Add=2]="Add"}(ae||(ae={}));class ce extends de.n{_sphereTexture=null;_sphereTextureBlendMode=ae.Add;_toonTexture=null;_ignoreDiffuseWhenToonTextureIsNull=!1;textureColor=new f.HE(1,1,1,1);sphereTextureColor=new f.HE(1,1,1,1);toonTextureColor=new f.HE(1,1,1,1);_useTextureColor=!1;_useSphereTextureColor=!1;_useToonTextureColor=!1;_isEnabled=!1;get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this.markAllDefinesAsDirty(),this._enable(e))}get sphereTexture(){return this._sphereTexture}set sphereTexture(e){this._sphereTexture!==e&&(this._sphereTexture=e,this.markAllSubMeshesAsTexturesDirty())}get sphereTextureBlendMode(){return this._sphereTextureBlendMode}set sphereTextureBlendMode(e){this._sphereTextureBlendMode!==e&&(this._sphereTextureBlendMode=e,this.markAllDefinesAsDirty())}get toonTexture(){return this._toonTexture}set toonTexture(e){this._toonTexture!==e&&(this._toonTexture=e,this.markAllSubMeshesAsTexturesDirty())}get ignoreDiffuseWhenToonTextureIsNull(){return this._ignoreDiffuseWhenToonTextureIsNull}set ignoreDiffuseWhenToonTextureIsNull(e){this._ignoreDiffuseWhenToonTextureIsNull!==e&&(this._ignoreDiffuseWhenToonTextureIsNull=e,this.markAllDefinesAsDirty())}get useTextureColor(){return this._useTextureColor}set useTextureColor(e){this._useTextureColor!==e&&(this._useTextureColor=e,this.markAllDefinesAsDirty())}get useSphereTextureColor(){return this._useSphereTextureColor}set useSphereTextureColor(e){this._useSphereTextureColor!==e&&(this._useSphereTextureColor=e,this.markAllDefinesAsDirty())}get useToonTextureColor(){return this._useToonTextureColor}set useToonTextureColor(e){this._useToonTextureColor!==e&&(this._useToonTextureColor=e,this.markAllDefinesAsDirty())}_internalMarkAllSubMeshesAsTexturesDirty;markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"MmdMaterial",100,new he,t),this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[Y.g.MATERIAL_TextureDirtyFlag]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&this._sphereTexture&&!this._sphereTexture.isReadyOrNotBlocking())}bindForSubMesh(e,t,n,r){if(!this._isEnabled)return;const o=r.materialDefines,i=this._material.isFrozen;e.useUbo&&i&&e.isSync||(o.DIFFUSE&&o.TEXTURE_COLOR&&e.updateDirectColor4("textureColor",this.textureColor),o.NORMAL&&o.SPHERE_TEXTURE&&o.SPHERE_TEXTURE_COLOR&&e.updateDirectColor4("sphereTextureColor",this.sphereTextureColor),o.TOON_TEXTURE&&o.TOON_TEXTURE_COLOR&&e.updateDirectColor4("toonTextureColor",this.toonTextureColor),o.SPHERE_TEXTURE&&null!==r.effect&&this._material.bindView(r.effect)),t.texturesEnabled&&(o.NORMAL&&this._sphereTexture&&e.setTexture("sphereSampler",this._sphereTexture),this._toonTexture&&e.setTexture("toonSampler",this._toonTexture))}dispose(e){e&&(this._sphereTexture?.dispose(),this._toonTexture?.dispose())}getCustomCode(e){if("vertex"===e){const e={};return e.CUSTOM_VERTEX_DEFINITIONS=re,e[`!${this._escapeRegExp("finalWorld=finalWorld*influence;")}`]=`\n                ${oe}\n                \n                finalWorld = finalWorld * influence;\n            `,e}if("fragment"===e){const e={CUSTOM_FRAGMENT_DEFINITIONS:"\n                #if defined(SPHERE_TEXTURE) && defined(NORMAL)\n                    uniform sampler2D sphereSampler;\n                #endif\n                #ifdef TOON_TEXTURE\n                    uniform sampler2D toonSampler;\n                #endif\n            ",CUSTOM_FRAGMENT_MAIN_BEGIN:"\n                #ifdef TOON_TEXTURE\n                    vec3 clampedInfoDiffuse;\n                    float infoToonDiffuseR;\n                    float infoToonDiffuseG;\n                    float infoToonDiffuseB;\n\n                    vec3 infoToonDiffuse;\n                #endif\n            "};return e[`!${this._escapeRegExp("#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif")}`]="\n                #if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\n                    uniform mat4 view;\n                #elif defined(NORMAL) && defined(SPHERE_TEXTURE)\n                    uniform mat4 view;\n                #endif\n            ",e[`!${this._escapeRegExp("baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);")}`]="\n                #if defined(DIFFUSE) && defined(TEXTURE_COLOR)\n                    baseColor = texture2D(diffuseSampler, vDiffuseUV + uvOffset) * textureColor;\n                #else\n                    baseColor = texture2D(diffuseSampler, vDiffuseUV + uvOffset);\n                #endif\n            ",e[`!${this._escapeRegExp("diffuseBase+=info.diffuse*shadow;")}`]="\n                #ifdef TOON_TEXTURE\n                    clampedInfoDiffuse = clamp(info.diffuse, 0.0, 1.0);\n\n                    #ifdef TOON_TEXTURE_COLOR\n                        infoToonDiffuseR = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.r)).r * toonTextureColor.r * toonTextureColor.a;\n                        infoToonDiffuseG = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.g)).g * toonTextureColor.g * toonTextureColor.a;\n                        infoToonDiffuseB = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.b)).b * toonTextureColor.b * toonTextureColor.a;\n                    #else\n                        infoToonDiffuseR = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.r)).r;\n                        infoToonDiffuseG = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.g)).g;\n                        infoToonDiffuseB = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.b)).b;\n                    #endif\n                    \n                    infoToonDiffuse = vec3(infoToonDiffuseR, infoToonDiffuseG, infoToonDiffuseB);\n\n                    diffuseBase += infoToonDiffuse * shadow;\n                #elif defined(IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED)\n                    diffuseBase += vec3(1.0, 1.0, 1.0) * shadow;\n                #else\n                    diffuseBase += info.diffuse * shadow;\n                #endif\n            ",e.CUSTOM_FRAGMENT_BEFORE_FOG="\n                #if defined(NORMAL) && defined(SPHERE_TEXTURE)\n                    vec3 viewSpaceNormal = normalize(mat3(view) * vNormalW);\n\n                    vec2 sphereUV = viewSpaceNormal.xy * 0.5 + 0.5;\n\n                    vec4 sphereReflectionColor = texture2D(sphereSampler, sphereUV);\n\n                    #ifdef SPHERE_TEXTURE_COLOR\n                        sphereReflectionColor *= sphereTextureColor;\n                    #endif\n\n                    #ifdef SPHERE_TEXTURE_BLEND_MODE_MULTIPLY\n                        color *= sphereReflectionColor;\n                    #elif defined(SPHERE_TEXTURE_BLEND_MODE_ADD)\n                        color += vec4(sphereReflectionColor.rgb, sphereReflectionColor.a * alpha);\n                    #endif\n                #endif\n            ",e}return null}prepareDefines(e,t,n){if(this._isEnabled){const r=t.texturesEnabled;e.SPHERE_TEXTURE=null!==this._sphereTexture&&r,e.SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=this._sphereTextureBlendMode===ae.Multiply,e.SPHERE_TEXTURE_BLEND_MODE_ADD=this._sphereTextureBlendMode===ae.Add,e.TOON_TEXTURE=null!==this._toonTexture&&r,e.IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=this._ignoreDiffuseWhenToonTextureIsNull,e.TEXTURE_COLOR=this._useTextureColor,e.SPHERE_TEXTURE_COLOR=this._useSphereTextureColor,e.TOON_TEXTURE_COLOR=this._useToonTextureColor,e.SDEF=!!(n.useBones&&n.computeBonesUsingShaders&&n.skeleton)}else e.SPHERE_TEXTURE=!1,e.SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=!1,e.SPHERE_TEXTURE_BLEND_MODE_ADD=!1,e.TOON_TEXTURE=!1,e.IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=!1,e.TEXTURE_COLOR=!1,e.SPHERE_TEXTURE_COLOR=!1,e.TOON_TEXTURE_COLOR=!1,e.SDEF=!1}hasTexture(e){return this._sphereTexture===e||this._toonTexture===e}getActiveTextures(e){this._sphereTexture&&e.push(this._sphereTexture),this._toonTexture&&e.push(this._toonTexture)}getAnimatables(e){this._sphereTexture&&this._sphereTexture.animations&&0<this._sphereTexture.animations.length&&e.push(this._sphereTexture),this._toonTexture&&this._toonTexture.animations&&0<this._toonTexture.animations.length&&e.push(this._toonTexture)}getSamplers(e){e.push("sphereSampler","toonSampler")}getAttributes(e,t,n){this._isEnabled&&n.useBones&&n.computeBonesUsingShaders&&n.skeleton&&n.isVerticesDataPresent(te.MatricesSdefCKind)&&(e.push(te.MatricesSdefCKind),e.push(te.MatricesSdefR0Kind),e.push(te.MatricesSdefR1Kind))}getUniforms(){return{ubo:[{name:"textureColor",size:4,type:"vec4"},{name:"sphereTextureColor",size:4,type:"vec4"},{name:"toonTextureColor",size:4,type:"vec4"}],fragment:"\n                #if defined(DIFFUSE) && defined(TEXTURE_COLOR)\n                    uniform vec4 textureColor;\n                #endif\n                #if defined(SPHERE_TEXTURE) && defined(SPHERE_TEXTURE_COLOR)\n                    uniform vec4 sphereTextureColor;\n                #endif\n                #if defined(TOON_TEXTURE) && defined(TOON_TEXTURE_COLOR)\n                    uniform vec4 toonTextureColor;\n                #endif\n            "}}getClassName(){return"MmdPluginMaterial"}_escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}}var ue=n(1965);class fe extends ue.K{_pluginMaterial;_renderOutline=!1;outlineWidth=.01;outlineColor=new f.Wo(0,0,0);outlineAlpha=1;constructor(e,t){super(e,t),this.specularColor=new f.Wo(0,0,0);const n=this._pluginMaterial=new ce(this);n.isEnabled=!0,n.ignoreDiffuseWhenToonTextureIsNull=!0}get sphereTexture(){return this._pluginMaterial.sphereTexture}set sphereTexture(e){this._pluginMaterial.sphereTexture=e}get sphereTextureBlendMode(){return this._pluginMaterial.sphereTextureBlendMode}set sphereTextureBlendMode(e){this._pluginMaterial.sphereTextureBlendMode=e}get toonTexture(){return this._pluginMaterial.toonTexture}set toonTexture(e){this._pluginMaterial.toonTexture=e}get ignoreDiffuseWhenToonTextureIsNull(){return this._pluginMaterial.ignoreDiffuseWhenToonTextureIsNull}set ignoreDiffuseWhenToonTextureIsNull(e){this._pluginMaterial.ignoreDiffuseWhenToonTextureIsNull=e}get textureColor(){return this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureColor}set textureColor(e){this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureColor=e}get sphereTextureColor(){return this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureColor}set sphereTextureColor(e){this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureColor=e}get toonTextureColor(){return this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureColor}set toonTextureColor(e){this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureColor=e}get renderOutline(){return this._renderOutline}set renderOutline(e){e&&this.getScene().getMmdOutlineRenderer(),this._renderOutline=e}}class ge{static EdgeSizeScaleFactor=.01;alphaThreshold=195;alphaBlendThreshold=100;useAlphaEvaluation=!0;alphaEvaluationResolution=512;_textureLoader=new M;buildMaterials(e,t,n,r,o,i,s,a,l,d,h,c,u){const f=s.blockMaterialDirtyMechanism;s.blockMaterialDirtyMechanism=!0;let g=null;const p=()=>null!==g?g:this.useAlphaEvaluation?g=new U(d,l,this.alphaEvaluationResolution):null,x=new C(i,r,o),m=[],A={lengthComputable:!0,loaded:0,total:3*t.length},T=()=>{A.loaded+=1,c?.(A)};let _=0;for(let i=0;i<t.length;++i){const l=t[i];s._blockEntityCollection=!!a;const d=new fe(l.name,s);d._parentContainer=a,s._blockEntityCollection=!1,a?.materials.push(d);{const t=[],c=this.loadGeneralScalarProperties(d,l);void 0!==c&&t.push(c);const u=this.loadDiffuseTexture(e,d,l,n,s,a,r,o,x,_,p,T);void 0!==u&&t.push(u);const f=this.loadSphereTexture(e,d,l,n,s,a,r,o,x,T);void 0!==f&&t.push(f);const g=this.loadToonTexture(e,d,l,n,s,a,r,o,x,T);void 0!==g&&t.push(g);const A=this.loadOutlineRenderingProperties(d,l);void 0!==A&&t.push(A),m.push(...t),Promise.all(t).then((()=>{this.afterBuildSingleMaterial(d,i,l,h,n,s,r)}))}h.subMaterials.push(d),_+=l.surfaceCount}this._textureLoader.loadModelTexturesEnd(e);const y=this._textureLoader.onModelTextureLoadedObservable.get(e);void 0!==y?y.addOnce((()=>{Promise.all(m).then((()=>{g?.dispose(),s.blockMaterialDirtyMechanism=f,u?.()}))})):Promise.all(m).then((()=>{g?.dispose(),s.blockMaterialDirtyMechanism=f,u?.()}))}loadGeneralScalarProperties=(e,t)=>{const n=t.diffuse;e.diffuseColor=new f.Wo(n[0],n[1],n[2]);const r=t.specular;e.specularColor=new f.Wo(r[0],r[1],r[2]);const o=t.ambient;e.ambientColor=new f.Wo(o[0],o[1],o[2]);const i=t.diffuse[3];e.alpha=i,e.specularPower=t.shininess};loadDiffuseTexture=async(e,t,n,r,o,s,a,l,d,h,c,u)=>{t.backFaceCulling=!(n.flag&i.Material.Flag.IsDoubleSided);const f=r[n.textureIndex];if(void 0!==f){const r=l+f;let i;const g=d.resolve(r);i=void 0!==g?await this._textureLoader.loadTextureFromBufferAsync(e,r,g instanceof File?g:g.data,o,s):await this._textureLoader.loadTextureAsync(e,a,f,o,s);const p=i.texture;if(null!==p){t.diffuseTexture=p;let e=Number.MAX_SAFE_INTEGER;const r=n.evauatedTransparency;if(void 0!==r&&-1!==r)e=r;else{const t=c();null!==t&&(e=await t.textureHasAlphaOnGeometry(i.arrayBuffer,h,n.surfaceCount,this.alphaThreshold,this.alphaBlendThreshold))}if(e!==Number.MAX_SAFE_INTEGER){const n=e!==F.F.MATERIAL_OPAQUE;n&&(p.hasAlpha=!0),t.useAlphaFromDiffuseTexture=n,t.transparencyMode=e,n&&(t.backFaceCulling=!1)}u?.()}else u?.()}else u?.()};loadSphereTexture=async(e,t,n,r,o,s,a,l,d,h)=>{if(n.sphereTextureMode!==i.Material.SphereTextureMode.Off){const i=r[n.sphereTextureIndex];if(void 0!==i){const r=l+i;let c;const u=d.resolve(r);c=void 0!==u?(await this._textureLoader.loadTextureFromBufferAsync(e,r,u instanceof File?u:u.data,o,s)).texture:(await this._textureLoader.loadTextureAsync(e,a,i,o,s)).texture,null!==c&&(t.sphereTexture=c,t.sphereTextureBlendMode=1===n.sphereTextureMode?ae.Multiply:ae.Add),h?.()}else h?.()}else h?.()};loadToonTexture=async(e,t,n,r,o,i,s,a,l,d)=>{let h;if(h=n.isSharedToonTexture?-1===n.toonTextureIndex?void 0:n.toonTextureIndex:r[n.toonTextureIndex],void 0!==h){const n=a+h;let r;const c="string"==typeof h?l.resolve(n):void 0;r=void 0!==c?(await this._textureLoader.loadTextureFromBufferAsync(e,n,c instanceof File?c:c.data,o,i)).texture:(await this._textureLoader.loadTextureAsync(e,s,h,o,i)).texture,null!==r&&(t.toonTexture=r),d?.()}else d?.()};loadOutlineRenderingProperties=(e,t)=>{if(t.flag&i.Material.Flag.EnabledToonEdge){se.RegisterMmdOutlineRendererIfNeeded(),e.renderOutline=!0,e.outlineWidth=t.edgeSize*ge.EdgeSizeScaleFactor;const n=t.edgeColor;e.outlineColor=new f.Wo(n[0],n[1],n[2]),e.outlineAlpha=n[3]}};afterBuildSingleMaterial=()=>{}}class pe{static _IdMap=new WeakMap;static _NextId=0;constructor(){}static GetId(e){let t=this._IdMap.get(e);return void 0===t&&(t=this._NextId,this._NextId+=1,this._IdMap.set(e,t)),t}}class xe extends z.Kj{applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId===this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(q.o.PositionKind))return this;if(!this.isVerticesDataPresent(q.o.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(q.o.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(q.o.NormalKind),n=this._internalMeshDataInfo;if(!n._sourcePositions){const e=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=e}t&&!n._sourceNormals&&this.setNormalsForCPUSkinning();let r=this.getVerticesData(q.o.PositionKind);if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r));let o=this.getVerticesData(q.o.NormalKind);if(t){if(!o)return this;o instanceof Float32Array||(o=new Float32Array(o))}const i=this.isVerticesDataPresent(te.MatricesSdefCKind);let s=null,a=null,l=null;i&&(s=this.getVerticesData(te.MatricesSdefCKind),a=this.getVerticesData(te.MatricesSdefR0Kind),l=this.getVerticesData(te.MatricesSdefR1Kind));const d=this.getVerticesData(q.o.MatricesIndicesKind),h=this.getVerticesData(q.o.MatricesWeightsKind);if(!h||!d)return this;const c=this.numBoneInfluencers>4,u=c?this.getVerticesData(q.o.MatricesIndicesExtraKind):null,f=c?this.getVerticesData(q.o.MatricesWeightsExtraKind):null,p=e.getTransformMatrices(this),x=g.P.Zero(),m=new g.y3,A=new g.y3,T=new g.y3,_=new g.y3,y=new g._f,E=new g._f,I=new g.P,M=n._sourcePositions,b=n._sourceNormals;let w,S=0;for(let e=0;e<r.length;e+=3,S+=4){let n=0;if(i&&(n=a[e]),0===n){let n;for(w=0;w<4;w++)n=h[S+w],n>0&&(g.y3.FromFloat32ArrayToRefScaled(p,Math.floor(16*d[S+w]),n,A),m.addToSelf(A));if(c)for(w=0;w<4;w++)n=f[S+w],n>0&&(g.y3.FromFloat32ArrayToRefScaled(p,Math.floor(16*u[S+w]),n,A),m.addToSelf(A));g.P.TransformCoordinatesFromFloatsToRef(M[e],M[e+1],M[e+2],m,x),x.toArray(r,e),t&&(g.P.TransformNormalFromFloatsToRef(b[e],b[e+1],b[e+2],m,x),x.toArray(o,e)),m.reset()}else{const n=h[S+0],i=h[S+1];g.y3.FromArrayToRef(p,Math.floor(16*d[S+0]),T),g.y3.FromArrayToRef(p,Math.floor(16*d[S+1]),_),g._f.FromRotationMatrixToRef(T,y),g._f.FromRotationMatrixToRef(_,E),g.y3.FromQuaternionToRef(g._f.SlerpToRef(y,E,i,y),A),g.P.TransformCoordinatesFromFloatsToRef(M[e]-s[e],M[e+1]-s[e+1],M[e+2]-s[e+2],A,I),g.P.TransformCoordinatesFromFloatsToRef(a[e],a[e+1],a[e+2],T,x).scaleAndAddToRef(n,I),g.P.TransformCoordinatesFromFloatsToRef(l[e],l[e+1],l[e+2],_,x).scaleAndAddToRef(i,I),I.toArray(r,e),t&&(g.P.TransformNormalFromFloatsToRef(b[e],b[e+1],b[e+2],A,I),I.toArray(o,e))}}return this.updateVerticesData(q.o.PositionKind,r),t&&this.updateVerticesData(q.o.NormalKind,o),this}}class me{name;extensions;materialBuilder;useSdef;buildSkeleton;buildMorph;boundingBoxMargin;referenceFiles;_loggingEnabled;log;warn;error;constructor(){this.name="pmx",this.extensions={".pmx":{isBinary:!0}},this.materialBuilder=new ge,this.useSdef=!0,this.buildSkeleton=!0,this.buildMorph=!0,this.boundingBoxMargin=10,this.referenceFiles=[],this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled}importMeshAsync(e,t,n,r,o,i){return this._loadAsyncInternal(t,null,n,r,o)}loadAsync(e,t,n,r,o){return this._loadAsyncInternal(e,null,t,n,r).then((()=>{}))}loadAssetContainerAsync(e,t,n,r,o){const i=new O.TJ(e);return this._loadAsyncInternal(e,i,t,n,r).then((()=>i))}loadFile(e,t,n,r,o,i,s){const a=this.materialBuilder,l=this.useSdef,d=this.buildSkeleton,h=this.buildMorph,c=this.boundingBoxMargin,u=this.referenceFiles;return e._loadFile(t,((e,n)=>{const o={arrayBuffer:e,pmxFileId:t instanceof File?pe.GetId(t).toString():t,materialBuilder:a,useSdef:l,buildSkeleton:d,buildMorph:h,boundingBoxMargin:c,referenceFiles:u};r(o,n)}),o,!0,i,s)}async _loadAsyncInternal(e,t,n,r,o){const s=await R.ParseAsync(n.arrayBuffer,this).catch((e=>Promise.reject(e))),a=Math.floor(n.arrayBuffer.byteLength/100),l=100*s.materials.length,d=n.buildSkeleton?100*s.bones.length:0;let h=0;if(n.buildMorph){const e=s.morphs;for(let t=0;t<e.length;++t){const n=e[t];n.type!==i.Morph.Type.VertexMorph&&n.type!==i.Morph.Type.UvMorph&&n.type!==i.Morph.Type.AdditionalUvMorph1&&n.type!==i.Morph.Type.AdditionalUvMorph2&&n.type!==i.Morph.Type.AdditionalUvMorph3&&n.type!==i.Morph.Type.AdditionalUvMorph4||(h+=n.indices.length)}}const c=3e4*s.textures.length;let u=!1;const f={lengthComputable:!0,loaded:a,total:a+s.faces.length+s.vertices.length+l+d+h+c};o?.({...f});let p=a;e._blockEntityCollection=!!t;const x=new(n.useSdef?xe:z.Kj)(s.header.modelName,e);x._parentContainer=t,e._blockEntityCollection=!1;const m=new X.x,A=n.useSdef?new Float32Array(3*s.vertices.length):void 0,T=n.useSdef?new Float32Array(3*s.vertices.length):void 0,_=n.useSdef?new Float32Array(3*s.vertices.length):void 0;let y=!1;{const e=s.vertices,t=new Float32Array(3*e.length),r=new Float32Array(3*e.length),a=new Float32Array(2*e.length),l=new Float32Array(4*e.length),d=new Float32Array(4*e.length);let h;h=s.faces instanceof Uint8Array||s.faces instanceof Uint16Array?new Uint16Array(s.faces.length):new Uint32Array(s.faces.length);{let e=performance.now();const t=s.faces;for(let n=0;n<h.length;n+=3)h[n+0]=t[n+0],h[n+1]=t[n+2],h[n+2]=t[n+1],n%1e4==0&&100<performance.now()-e&&(f.loaded=p+n,o?.({...f}),await G.w1.DelayAsync(0),e=performance.now());f.loaded=p+h.length,o?.({...f}),p+=h.length}{let s=performance.now();for(let h=0;h<e.length;++h){const c=e[h];switch(t[3*h+0]=c.position[0],t[3*h+1]=c.position[1],t[3*h+2]=c.position[2],r[3*h+0]=c.normal[0],r[3*h+1]=c.normal[1],r[3*h+2]=c.normal[2],a[2*h+0]=c.uv[0],a[2*h+1]=1-c.uv[1],c.weightType){case i.Vertex.BoneWeightType.Bdef1:{const e=c.boneWeight;l[4*h+0]=e.boneIndices,l[4*h+1]=0,l[4*h+2]=0,l[4*h+3]=0,d[4*h+0]=1,d[4*h+1]=0,d[4*h+2]=0,d[4*h+3]=0}break;case i.Vertex.BoneWeightType.Bdef2:{const e=c.boneWeight;l[4*h+0]=e.boneIndices[0],l[4*h+1]=e.boneIndices[1],l[4*h+2]=0,l[4*h+3]=0,d[4*h+0]=e.boneWeights,d[4*h+1]=1-e.boneWeights,d[4*h+2]=0,d[4*h+3]=0}break;case i.Vertex.BoneWeightType.Bdef4:case i.Vertex.BoneWeightType.Qdef:{const e=c.boneWeight;l[4*h+0]=e.boneIndices[0],l[4*h+1]=e.boneIndices[1],l[4*h+2]=e.boneIndices[2],l[4*h+3]=e.boneIndices[3],d[4*h+0]=e.boneWeights[0],d[4*h+1]=e.boneWeights[1],d[4*h+2]=e.boneWeights[2],d[4*h+3]=e.boneWeights[3]}break;case i.Vertex.BoneWeightType.Sdef:{const e=c.boneWeight;l[4*h+0]=e.boneIndices[0],l[4*h+1]=e.boneIndices[1],l[4*h+2]=0,l[4*h+3]=0;const t=e.boneWeights,r=t.boneWeight0,o=1-r;if(d[4*h+0]=r,d[4*h+1]=o,d[4*h+2]=0,d[4*h+3]=0,n.useSdef){const e=t.c[0],n=t.c[1],i=t.c[2];let s=t.r0[0],a=t.r0[1],l=t.r0[2],d=t.r1[0],c=t.r1[1],u=t.r1[2];const f=s*r+d*o,g=a*r+c*o,p=l*r+u*o;s=e+s-f,a=n+a-g,l=i+l-p,d=e+d-f,c=n+c-g,u=i+u-p;const x=.5*(e+s),m=.5*(n+a),E=.5*(i+l),I=.5*(e+d),M=.5*(n+c),b=.5*(i+u);A[3*h+0]=e,A[3*h+1]=n,A[3*h+2]=i,T[3*h+0]=x,T[3*h+1]=m,T[3*h+2]=E,_[3*h+0]=I,_[3*h+1]=M,_[3*h+2]=b,y=!0}}}h%1e4==0&&100<performance.now()-s&&(f.loaded=p+h,o?.({...f}),await G.w1.DelayAsync(0),s=performance.now())}f.loaded=p+e.length,o?.({...f}),p+=e.length}m.positions=t,m.normals=r,m.uvs=a,m.indices=h,m.matricesIndices=l,m.matricesWeights=d}e._blockEntityCollection=!!t;const E=new W.Z(s.header.modelName,e,m,!1);E._parentContainer=t,e._blockEntityCollection=!1,n.useSdef&&y&&(E.setVerticesData(te.MatricesSdefCKind,A,!1,3),E.setVerticesData(te.MatricesSdefR0Kind,T,!1,3),E.setVerticesData(te.MatricesSdefR1Kind,_,!1,3)),E.applyToMesh(x),e._blockEntityCollection=!!t;const I=new k.G(s.header.modelName+"_multi",e);let M;I._parentContainer=t,e._blockEntityCollection=!1;const b=new Promise((i=>{M=n.materialBuilder.buildMaterials(x.uniqueId,s.materials,s.textures,r,"file:"+n.pmxFileId+"_",n.referenceFiles,e,t,m.indices,m.uvs,I,(e=>{if(!u)return;const t=e.loaded/e.total;f.loaded=p+Math.floor(c*t),o?.({...f})}),(()=>i()))}));void 0!==M&&await M,x.material=I,x.subMeshes.length=0;{const e=s.materials;let t=0;for(let n=0;n<e.length;++n){const r=e[n];new H.P(n,0,s.vertices.length,t,r.surfaceCount,x),t+=r.surfaceCount}}f.loaded=p+l,o?.({...f}),p+=l;const w=[];let S=null;if(n.buildSkeleton){e._blockEntityCollection=!!t,S=new N.O(s.header.modelName,s.header.modelName+"_skeleton",e),S._parentContainer=t,e._blockEntityCollection=!1;{const e=s.bones,t=[],n=[];for(let r=0;r<e.length;++r){const o=e[r];let i=!1;if(0<=o.parentBoneIndex&&o.parentBoneIndex<e.length){let t=o.parentBoneIndex;for(;-1!==t;){if(t===r){i=!0,this.warn(`Bone loop detected. Ignore Parenting. Bone index: ${r}`);break}t=e[t].parentBoneIndex}r<=o.parentBoneIndex&&this.warn(`Parent bone index is greater equal than child bone index. Bone index: ${r} Parent bone index: ${o.parentBoneIndex}`)}else-1!==o.parentBoneIndex&&this.error(`Parent bone index is out of range. Bone index: ${r} Parent bone index: ${o.parentBoneIndex}`);const s=o.position,a=new g.P(s[0],s[1],s[2]);if(0<=o.parentBoneIndex&&o.parentBoneIndex<t.length&&!i){const t=e[o.parentBoneIndex];a.x-=t.position[0],a.y-=t.position[1],a.z-=t.position[2]}const l=g.y3.Identity().setTranslation(a),d=new L.N(o.name,S,void 0,l,void 0,void 0,r);t.push(d),n.push(i);const h={name:o.name,parentBoneIndex:o.parentBoneIndex,transformOrder:o.transformOrder,flag:o.flag,appendTransform:o.appendTransform,transformAfterPhysics:o.transformAfterPhysics,ik:o.ik};w.push(h)}for(let r=0;r<t.length;++r){const o=e[r],i=t[r];0<=o.parentBoneIndex&&o.parentBoneIndex<t.length&&!n[r]&&i.setParent(t[o.parentBoneIndex],!1)}for(let e=0;e<t.length;++e){const n=t[e];null===n.getParent()&&n._updateAbsoluteBindMatrices()}}x.skeleton=S,f.loaded=p+d,o?.({...f}),p+=d}const C=[];let v=null;if(n.buildMorph){e._blockEntityCollection=!!t,v=new Q.O(e),v._parentContainer=t,e._blockEntityCollection=!1;{const t=s.morphs,n=[];for(let r=0;r<t.length;++r){const a=t[r];switch(a.type){case i.Morph.Type.GroupMorph:case i.Morph.Type.BoneMorph:case i.Morph.Type.MaterialMorph:C.push(a);break;case i.Morph.Type.VertexMorph:case i.Morph.Type.UvMorph:case i.Morph.Type.AdditionalUvMorph1:case i.Morph.Type.AdditionalUvMorph2:case i.Morph.Type.AdditionalUvMorph3:case i.Morph.Type.AdditionalUvMorph4:C.push({name:a.name,englishName:a.englishName,category:a.category,type:a.type,index:n.length});break;default:this.warn(`Unsupported morph type: ${a.type}`)}if(a.type!==i.Morph.Type.VertexMorph&&a.type!==i.Morph.Type.UvMorph&&a.type!==i.Morph.Type.AdditionalUvMorph1&&a.type!==i.Morph.Type.AdditionalUvMorph2&&a.type!==i.Morph.Type.AdditionalUvMorph3&&a.type!==i.Morph.Type.AdditionalUvMorph4)continue;const l=new K.Y(a.name,0,e);if(n.push(l),a.type===i.Morph.Type.VertexMorph){const e=new Float32Array(3*s.vertices.length);e.set(m.positions);const t=a.indices,n=a.positions;let r=performance.now();for(let i=0;i<t.length;++i){const s=t[i];e[3*s+0]+=n[3*i+0],e[3*s+1]+=n[3*i+1],e[3*s+2]+=n[3*i+2],i%1e4==0&&100<performance.now()-r&&(f.loaded=p+i,o?.({...f}),await G.w1.DelayAsync(0),r=performance.now())}p+=t.length,l.setPositions(e)}else{const e=new Float32Array(2*s.vertices.length);e.set(m.uvs);const t=a.indices,n=a.offsets;let r=performance.now();for(let i=0;i<t.length;++i){const s=t[i];e[2*s+0]+=n[4*i+0],e[2*s+1]+=n[4*i+1],i%1e4==0&&100<performance.now()-r&&(f.loaded=p+i,o?.({...f}),await G.w1.DelayAsync(0),r=performance.now())}p+=t.length,l.setPositions(m.positions),l.setUVs(e)}}v.areUpdatesFrozen=!0;for(let e=0;e<n.length;++e)v.addTarget(n[e]);v.areUpdatesFrozen=!1}x.morphTargetManager=v}const F=n.boundingBoxMargin;if(0!==F){const e=x.subMeshes;for(let t=0;t<e.length;++t){const n=e[t],r=n.getBoundingInfo();n.setBoundingInfo(new V.j((new g.P).setAll(-F).addInPlace(r.minimum),(new g.P).setAll(F).addInPlace(r.maximum)))}const t=x.getBoundingInfo();x.setBoundingInfo(new V.j((new g.P).setAll(-F).addInPlace(t.minimum),(new g.P).setAll(F).addInPlace(t.maximum))),x._updateBoundingInfo()}return x.metadata={isMmdModel:!0,header:{modelName:s.header.modelName,englishModelName:s.header.englishModelName,comment:s.header.comment,englishComment:s.header.englishComment},bones:w,morphs:C,rigidBodies:s.rigidBodies,joints:s.joints},f.loaded=p,o?.({...f}),u=!0,await b,null!==t&&(t.meshes.push(x),t.geometries.push(E),t.multiMaterials.push(I),null!==S&&t.skeletons.push(S),null!==v&&t.morphTargetManagers.push(v)),{meshes:[x],particleSystems:[],skeletons:null!==S?[S]:[],animationGroups:[],transformNodes:[],geometries:[E],lights:[]}}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){m.Y.Log(e)}_logDisabled(){}_warnEnabled(e){m.Y.Warn(e)}_warnDisabled(){}_errorEnabled(e){m.Y.Error(e)}_errorDisabled(){}}async function Ae(e,t=""){const n=[];for(let r=0;r<e.length;r++){const o=e[r];if(o.isDirectory){const e=o.createReader(),r=await new Promise(((t,n)=>{e.readEntries(t,n)}));n.push(...await Ae(r,t+o.name+"/"))}else n.push(o)}return n}a();const Te=document.getElementById("render-canvas");if(!(Te instanceof HTMLCanvasElement))throw new Error("Invalid canvas element");const _e=new r.D(Te,!1,{preserveDrawingBuffer:!0,stencil:!0,antialias:!0,powerPreference:"high-performance",doNotHandleContextLost:!0},!0);o.Create({canvas:Te,engine:_e,sceneBuilder:new class{async build(e,t){ie.OverrideEngineCreateEffect(t);const n=new me;n.loggingEnabled=!0,n.buildSkeleton=!1,n.buildMorph=!1,u.n.RegisterPlugin(n);const r=new x.x(t),o=new l.Y("camera",0,0,45,new g.P(0,10,0),r);o.maxZ=5e3,o.fov=Math.PI/180*30,o.speed=.5,o.setPosition(new g.P(0,10,-45)),o.attachControl(e,!0);const i=new h.e("hemisphericLight",new g.P(0,1,0),r);i.intensity=.4,i.specular=new f.Wo(0,0,0),i.groundColor=new f.Wo(1,1,1);const s=new d.O("directionalLight",new g.P(.5,-1,1),r);s.intensity=.8,s.autoCalcShadowZBounds=!1,s.autoUpdateExtends=!1,s.shadowMaxZ=60,s.shadowMinZ=-30,s.orthoTop=54,s.orthoBottom=-3,s.orthoLeft=-30,s.orthoRight=30,s.shadowOrthoScale=0;const a=new c.u(1024,s,!0,o);a.usePercentageCloserFiltering=!0,a.forceBackFacesOnly=!0,a.filteringQuality=c.u.QUALITY_MEDIUM,a.frustumEdgeFalloff=.1;const m=p.V.CreateGround("ground1",{width:100,height:100,subdivisions:2,updatable:!1},r);m.receiveShadows=!0,a.addShadowCaster(m);const A=async e=>{if(y)return;null!==_&&(a.removeShadowCaster(_),_.dispose(!1,!0),_=null),y=!0,t.displayLoadingUI();const o=e.webkitRelativePath;C.textContent=e.name;const i=n.materialBuilder;i.useAlphaEvaluation=w.useAlphaEvaluation,i.alphaEvaluationResolution=w.alphaEvaluationResolution,i.alphaThreshold=w.alphaThreshold,i.alphaBlendThreshold=w.alphaBlendThreshold,_=(await u.n.ImportMeshAsync(void 0,o.substring(0,o.lastIndexOf("/")+1),e,r,(n=>t.loadingUIText=`<br/><br/><br/>Loading (${e.name})... ${n.loaded}/${n.total} (${Math.floor(100*n.loaded/n.total)}%)`))).meshes[0],_.receiveShadows=!0,a.addShadowCaster(_),t.hideLoadingUI(),setTimeout((()=>y=!1),1500)};let T=null,_=null,y=!1;const E=e.parentElement;E.style.display="flex",E.style.flexDirection="row-reverse";const I=document.createElement("div");I.style.width="100%",I.style.height="100%",I.style.display="flex",I.appendChild(e),E.appendChild(I);const M=document.createElement("div");M.style.position="relative",M.style.backgroundColor="white",M.style.width="auto",M.style.height="100%",M.style.display="flex",M.style.flexDirection="column",M.style.justifyContent="center",M.style.alignItems="center",M.style.fontFamily="sans-serif",E.appendChild(M);const b=document.createElement("div");b.style.width="auto",b.style.height="100%",b.style.display="flex",b.style.flexDirection="column",b.style.justifyContent="center",b.style.alignItems="start",b.style.padding="20px",b.style.boxSizing="border-box",M.appendChild(b);const w=new P;w.loggingEnabled=!0;let S=[];const R=document.createElement("h1");R.textContent="PMX to BPMX Converter",R.style.width="500px",R.style.textAlign="center",R.style.marginTop="0",b.appendChild(R);const C=document.createElement("div");C.textContent="No PMX file selected",C.style.width="100%",C.style.height="auto",C.style.fontSize="20px",C.style.marginBottom="10px",C.style.border="1px solid black",C.style.boxSizing="border-box",C.style.padding="10px",b.appendChild(C);const v=document.createElement("div");v.style.width="500px",v.style.flexGrow="1",v.style.overflow="auto",v.style.marginBottom="10px",v.style.border="1px solid black",v.style.boxSizing="border-box",b.appendChild(v);const F=document.createElement("ul");F.style.height="auto",F.style.fontSize="16px",v.appendChild(F);const B=()=>{F.innerHTML="";for(const e of S){const t=document.createElement("li");t.style.whiteSpace="nowrap";const n=e.webkitRelativePath;t.textContent=n,e.name.endsWith(".pmx")&&(t.style.color="blue",t.style.cursor="pointer",t.style.textDecoration="underline",t.onclick=()=>{T=e,A(e)}),F.appendChild(t)}},U=document.createElement("input");U.style.width="100%",U.style.minHeight="80px",U.style.display="block",U.style.backgroundColor="black",U.style.color="white",U.style.marginBottom="10px",U.style.fontSize="20px",U.type="file",U.setAttribute("directory",""),U.setAttribute("webkitdirectory",""),U.setAttribute("allowdirs",""),U.ondragover=e=>{e.preventDefault()},U.ondrop=async e=>{e.preventDefault();const t=e.dataTransfer.items;if(!t)return;const r=[];for(let e=0;e<t.length;++e){const n=t[e].webkitGetAsEntry();n&&r.push(n)}const o=await Ae(r);S=await async function(e){const t=[],n=await Ae(e);for(let e=0;e<n.length;e++){const r=n[e],o=await new Promise(((e,t)=>{r.file(e,t)}));""===o.webkitRelativePath&&(Object.defineProperty(o,"webkitRelativePath",{writable:!0}),o.webkitRelativePath=r.fullPath),t.push(o)}return t}(o),B(),n.referenceFiles=S},U.onchange=()=>{null!==U.files&&(S=Array.from(U.files),B(),n.referenceFiles=S)},b.appendChild(U);const D=document.createElement("div");D.style.width="100%",D.style.height="auto",D.style.display="flex",D.style.flexDirection="column",D.style.justifyContent="center",D.style.alignItems="center",D.style.marginBottom="10px",D.style.border="1px solid black",D.style.padding="20px",D.style.boxSizing="border-box",b.appendChild(D);const O=document.createElement("div");O.style.width="100%",O.style.height="50px",O.style.display="flex",O.style.flexDirection="row",O.style.justifyContent="space-between",O.style.alignItems="center",O.style.marginBottom="10px",D.appendChild(O);const L=document.createElement("label");L.textContent="Use Alpha Evaluation",L.style.width="200px",L.style.textAlign="left",L.style.marginRight="10px",L.style.fontSize="20px",L.style.flexGrow="1",O.appendChild(L);const N=document.createElement("input");N.style.width="20px",N.style.height="20px",N.style.fontSize="20px",N.type="checkbox",N.checked=w.useAlphaEvaluation,O.appendChild(N),N.onchange=()=>{w.useAlphaEvaluation=N.checked};const V=document.createElement("div");V.style.width="100%",V.style.height="50px",V.style.display="flex",V.style.flexDirection="row",V.style.justifyContent="space-between",V.style.alignItems="center",V.style.marginBottom="10px",D.appendChild(V);const k=document.createElement("label");k.textContent="Alpha Evaluation Resolution",k.style.width="200px",k.style.textAlign="left",k.style.marginRight="10px",k.style.fontSize="20px",k.style.flexGrow="1",V.appendChild(k);const W=document.createElement("input");W.style.width="100px",W.style.height="40px",W.style.fontSize="20px",W.type="number",W.min="64",W.max="4096",W.value=w.alphaEvaluationResolution.toString(),V.appendChild(W),W.onchange=()=>{w.alphaEvaluationResolution=Number(W.value)};const z=document.createElement("div");z.style.width="100%",z.style.height="50px",z.style.display="flex",z.style.flexDirection="row",z.style.justifyContent="space-between",z.style.alignItems="center",z.style.marginBottom="10px",D.appendChild(z);const X=document.createElement("label");X.textContent="Alpha Threshold",X.style.width="200px",X.style.textAlign="left",X.style.marginRight="10px",X.style.fontSize="20px",X.style.flexGrow="1",z.appendChild(X);const H=document.createElement("input");H.style.width="100px",H.style.height="40px",H.style.fontSize="20px",H.type="number",H.min="0",H.max="255",H.value=w.alphaThreshold.toString(),z.appendChild(H),H.onchange=()=>{w.alphaThreshold=Number(H.value)};const G=document.createElement("div");G.style.width="100%",G.style.height="50px",G.style.display="flex",G.style.flexDirection="row",G.style.justifyContent="space-between",G.style.alignItems="center",D.appendChild(G);const K=document.createElement("label");K.textContent="Alpha Blend Threshold",K.style.width="200px",K.style.textAlign="left",K.style.marginRight="10px",K.style.fontSize="20px",K.style.flexGrow="1",G.appendChild(K);const Q=document.createElement("input");Q.style.width="100px",Q.style.height="40px",Q.style.fontSize="20px",Q.type="number",Q.min="-500",Q.max="500",Q.value=w.alphaBlendThreshold.toString(),G.appendChild(Q),Q.onchange=()=>{w.alphaBlendThreshold=Number(Q.value)};const q=document.createElement("div");q.style.width="100%",q.style.height="auto",q.style.display="flex",q.style.flexDirection="row",q.style.justifyContent="space-between",q.style.alignItems="center",b.appendChild(q);const Y=document.createElement("button");Y.textContent="Reload",Y.style.width="100%",Y.style.height="60px",Y.style.border="none",Y.style.fontSize="20px",Y.style.color="gray",Y.style.marginRight="10px",q.appendChild(Y),Y.onclick=()=>{null!==T&&A(T)};const j=document.createElement("button");return j.textContent="Convert",j.style.width="100%",j.style.height="60px",j.style.border="none",j.style.fontSize="20px",q.appendChild(j),j.onclick=async()=>{if(null===T)return;if(null===_)return;y=!0,t.displayLoadingUI();const e=T.webkitRelativePath;t.loadingUIText=`<br/><br/><br/>Converting (${T.name})...`;const n=await w.convert(r,e,S),o=new Blob([n],{type:"application/octet-stream"}),i=URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download=`${T.name.substring(0,T.name.lastIndexOf("."))}.bpmx`,s.click(),URL.revokeObjectURL(i),s.remove(),t.hideLoadingUI(),setTimeout((()=>y=!1),1500)},t.resize(!0),r}}}).then((e=>e.run()))}},n={};function r(e){var o=n[e];if(void 0!==o)return o.exports;var i=n[e]={exports:{}};return t[e](i,i.exports,r),i.exports}r.m=t,e=[],r.O=(t,n,o,i)=>{if(!n){var s=1/0;for(h=0;h<e.length;h++){for(var[n,o,i]=e[h],a=!0,l=0;l<n.length;l++)(!1&i||s>=i)&&Object.keys(r.O).every((e=>r.O[e](n[l])))?n.splice(l--,1):(a=!1,i<s&&(s=i));if(a){e.splice(h--,1);var d=o();void 0!==d&&(t=d)}}return t}i=i||0;for(var h=e.length;h>0&&e[h-1][2]>i;h--)e[h]=e[h-1];e[h]=[n,o,i]},r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={179:0};r.O.j=t=>0===e[t];var t=(t,n)=>{var o,i,[s,a,l]=n,d=0;if(s.some((t=>0!==e[t]))){for(o in a)r.o(a,o)&&(r.m[o]=a[o]);if(l)var h=l(r)}for(t&&t(n);d<s.length;d++)i=s[d],r.o(e,i)&&e[i]&&e[i][0](),e[i]=0;return r.O(h)},n=self.webpackChunkbabylon_mmd=self.webpackChunkbabylon_mmd||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var o=r.O(void 0,[216],(()=>r(3975)));o=r.O(o)})();