(()=>{var e,t={110:()=>{},85:(e,t,n)=>{"use strict";var o=n(718);class r{_canvas;_engine;_scene;_onTick;constructor(e){this._canvas=e.canvas,this._engine=e.engine,this._scene=null,this._onTick=null}static async Create(e){const t=new r(e);return t._scene=await t._initialize(e.sceneBuilder),t._onTick=t._makeOnTick(),t}run(){const e=this._engine;window.addEventListener("resize",this._onResize),e.runRenderLoop(this._onTick)}dispose(){window.removeEventListener("resize",this._onResize),this._engine.dispose()}_onResize=()=>{this._engine.resize()};async _initialize(e){return await e.build(this._canvas,this._engine)}_makeOnTick(){const e=this._scene;return()=>e.render()}}var i,s,a=n(110),l=n.n(a);class d{static Data=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="]}class h{uniqueId;leftLoadCount;isRequesting;errorTextureDatas;constructor(e){this.uniqueId=e,this.leftLoadCount=0,this.isRequesting=!0,this.errorTextureDatas=[]}}class c{observable;hasLoadError;constructor(){this.observable=new o.y$z,this.hasLoadError=!1}}class u{cacheKey;_scene;_assetContainer;_urlOrTextureName;_onLoad;_onError;_arrayBuffer;_texture;constructor(e,t,n,o,r,i,s){this.cacheKey=e,this._scene=t,this._assetContainer=n,this._urlOrTextureName=o,this._onLoad=i,this._onError=s,this._arrayBuffer=null,this._texture=null,r||t._loadFile(o,(e=>{const r=this._arrayBuffer=e;this._createTexture(t,n,o,r,i,((e,t)=>{this._arrayBuffer=null,s?.(e,t)}))}),void 0,!0,!0,((e,t)=>{s?.(e?e.status+" "+e.statusText:"",t)}))}loadFromArrayBuffer(e){this._arrayBuffer=e,this._createTexture(this._scene,this._assetContainer,this._urlOrTextureName,this._arrayBuffer,this._onLoad,((e,t)=>{this._arrayBuffer=null,this._onError?.(e,t)}))}_createTexture(e,t,n,r,i,s){e._blockEntityCollection=!!t;const a=this._texture=new o.xEZ("data:"+n,e,void 0,void 0,void 0,i,s,r,!0);a._parentContainer=t,e._blockEntityCollection=!1,t?.textures.push(a),a.name=n}get arrayBuffer(){return this._arrayBuffer}get texture(){return this._texture}}class f{onModelTextureLoadedObservable=new Map;textureCache=new Map;_textureLoadInfoMap=new Map;_loadingModels=new Map;_errorTexturesReferenceCount=new Map;static _EmptyResult={texture:null,arrayBuffer:null};_incrementLeftLoadCount(e){let t=this._loadingModels.get(e);void 0===t&&(t=new h(e),this._loadingModels.set(e,t)),t.leftLoadCount+=1;let n=this.onModelTextureLoadedObservable.get(e);return void 0===n&&(n=new o.y$z,this.onModelTextureLoadedObservable.set(e,n)),t}_decrementLeftLoadCount(e){if(e.leftLoadCount-=1,!e.isRequesting&&0===e.leftLoadCount){this._removeErrorTexturesReferenceCount(e.uniqueId),this._loadingModels.delete(e.uniqueId);const t=this.onModelTextureLoadedObservable.get(e.uniqueId);t?.notifyObservers(),t?.clear(),this.onModelTextureLoadedObservable.delete(e.uniqueId)}}loadModelTexturesEnd(e){const t=this._loadingModels.get(e);if(void 0!==t&&(t.isRequesting=!1,0===t.leftLoadCount)){this._removeErrorTexturesReferenceCount(e),this._loadingModels.delete(e);const t=this.onModelTextureLoadedObservable.get(e);t?.notifyObservers(),t?.clear(),this.onModelTextureLoadedObservable.delete(e)}}_addErrorTextureReferenceCount(e,t){this._loadingModels.get(e).errorTextureDatas.push(t),this._errorTexturesReferenceCount.set(t,(this._errorTexturesReferenceCount.get(t)??0)+1)}_removeErrorTexturesReferenceCount(e){const t=this._loadingModels.get(e);for(let e=0;e<t.errorTextureDatas.length;++e){const n=t.errorTextureDatas[e],o=this._errorTexturesReferenceCount.get(n)-1;0===o?null!==n.texture?n.texture.dispose():(this._textureLoadInfoMap.delete(n.cacheKey),this.textureCache.delete(n.cacheKey),this._errorTexturesReferenceCount.delete(n)):this._errorTexturesReferenceCount.set(n,o)}}_handleTextureOnDispose(e){e.texture.onDisposeObservable.addOnce((()=>{this._textureLoadInfoMap.delete(e.cacheKey),this.textureCache.delete(e.cacheKey),this._errorTexturesReferenceCount.delete(e)}))}async _loadTextureAsyncInternal(e,t,n,o,r,i){const s=this._incrementLeftLoadCount(e);let a=this._textureLoadInfoMap.get(t);void 0===a&&(a=new c,this._textureLoadInfoMap.set(t,a));let l=this.textureCache.get(t)?.deref();if(void 0===l&&!a.hasLoadError){const s=null!==o?d.Data[o]:t;l=new u(t,r,i,s,null!==n,(()=>{this._handleTextureOnDispose(l),a.hasLoadError=!1,a.observable.notifyObservers(!1),a.observable.clear()}),((t,n)=>{null!==l.texture&&this._handleTextureOnDispose(l),this._addErrorTextureReferenceCount(e,l),a.hasLoadError=!0,a.observable.notifyObservers(!0),a.observable.clear()})),this.textureCache.set(t,new WeakRef(l));const h=n instanceof Blob?await n.arrayBuffer():n;null!==h&&l.loadFromArrayBuffer(h)}return null!==l.texture&&l.texture.isReady()?(this._decrementLeftLoadCount(s),a.hasLoadError?f._EmptyResult:l):new Promise((e=>{a.observable.addOnce((t=>{this._decrementLeftLoadCount(s),e(t?f._EmptyResult:l)}))}))}async loadTextureAsync(e,t,n,o,r){const i="number"==typeof n,s=i?i?"shared_toon_texture_"+n:n:this.pathNormalize(t+n);return await this._loadTextureAsyncInternal(e,s,null,i?n:null,o,r)}async loadTextureFromBufferAsync(e,t,n,o,r,i=!0){return i&&(t=this.pathNormalize(t)),await this._loadTextureAsyncInternal(e,t,n,null,o,r)}pathNormalize(e){const t=(e=e.replace(/\\/g,"/")).split("/"),n=[];for(let e=0;e<t.length;++e){const o=t[e];"."!==o&&(".."===o?n.pop():n.push(o))}return n.join("/")}}!function(e){let t,n,o,r,i,s,a,l,d;!function(e){let t;!function(e){e[e.Utf16le=0]="Utf16le",e[e.Utf8=1]="Utf8"}(t=e.Encoding||(e.Encoding={}))}(t=e.Header||(e.Header={})),function(e){let t;!function(e){e[e.Bdef1=0]="Bdef1",e[e.Bdef2=1]="Bdef2",e[e.Bdef4=2]="Bdef4",e[e.Sdef=3]="Sdef",e[e.Qdef=4]="Qdef"}(t=e.BoneWeightType||(e.BoneWeightType={}))}(n=e.Vertex||(e.Vertex={})),function(e){let t,n;!function(e){e[e.IsDoubleSided=1]="IsDoubleSided",e[e.EnabledGroundShadow=2]="EnabledGroundShadow",e[e.EnabledDrawShadow=4]="EnabledDrawShadow",e[e.EnabledReceiveShadow=8]="EnabledReceiveShadow",e[e.EnabledToonEdge=16]="EnabledToonEdge",e[e.EnabledVertexColor=32]="EnabledVertexColor",e[e.EnabledPointDraw=64]="EnabledPointDraw",e[e.EnabledLineDraw=128]="EnabledLineDraw"}(t=e.Flag||(e.Flag={})),function(e){e[e.Off=0]="Off",e[e.Multiply=1]="Multiply",e[e.Add=2]="Add",e[e.SubTexture=3]="SubTexture"}(n=e.SphereTextureMode||(e.SphereTextureMode={}))}(o=e.Material||(e.Material={})),function(e){let t;!function(e){e[e.UseBoneIndexAsTailPosition=1]="UseBoneIndexAsTailPosition",e[e.IsRotatable=2]="IsRotatable",e[e.IsMovable=4]="IsMovable",e[e.IsVisible=8]="IsVisible",e[e.IsControllable=16]="IsControllable",e[e.IsIkEnabled=32]="IsIkEnabled",e[e.LocalAppendTransform=128]="LocalAppendTransform",e[e.HasAppendRotate=256]="HasAppendRotate",e[e.HasAppendMove=512]="HasAppendMove",e[e.HasAxisLimit=1024]="HasAxisLimit",e[e.HasLocalVector=2048]="HasLocalVector",e[e.TransformAfterPhysics=4096]="TransformAfterPhysics",e[e.IsExternalParentTransformed=8192]="IsExternalParentTransformed"}(t=e.Flag||(e.Flag={}))}(r=e.Bone||(e.Bone={})),function(e){let t,n,o;!function(e){e[e.System=0]="System",e[e.Eyebrow=1]="Eyebrow",e[e.Eye=2]="Eye",e[e.Lip=3]="Lip",e[e.Other=4]="Other"}(t=e.Category||(e.Category={})),function(e){e[e.GroupMorph=0]="GroupMorph",e[e.VertexMorph=1]="VertexMorph",e[e.BoneMorph=2]="BoneMorph",e[e.UvMorph=3]="UvMorph",e[e.AdditionalUvMorph1=4]="AdditionalUvMorph1",e[e.AdditionalUvMorph2=5]="AdditionalUvMorph2",e[e.AdditionalUvMorph3=6]="AdditionalUvMorph3",e[e.AdditionalUvMorph4=7]="AdditionalUvMorph4",e[e.MaterialMorph=8]="MaterialMorph",e[e.FlipMorph=9]="FlipMorph",e[e.ImpulseMorph=10]="ImpulseMorph"}(n=e.Type||(e.Type={})),function(e){let t;!function(e){e[e.Multiply=0]="Multiply",e[e.Add=1]="Add"}(t=e.Type||(e.Type={}))}(o=e.MaterialMorph||(e.MaterialMorph={}))}(i=e.Morph||(e.Morph={})),function(e){let t;!function(e){let t;!function(e){e[e.Bone=0]="Bone",e[e.Morph=1]="Morph"}(t=e.FrameType||(e.FrameType={}))}(t=e.FrameData||(e.FrameData={}))}(s=e.DisplayFrame||(e.DisplayFrame={})),function(e){let t,n;!function(e){e[e.Sphere=0]="Sphere",e[e.Box=1]="Box",e[e.Capsule=2]="Capsule"}(t=e.ShapeType||(e.ShapeType={})),function(e){e[e.FollowBone=0]="FollowBone",e[e.Physics=1]="Physics",e[e.PhysicsWithBone=2]="PhysicsWithBone"}(n=e.PhysicsMode||(e.PhysicsMode={}))}(a=e.RigidBody||(e.RigidBody={})),function(e){let t;!function(e){e[e.Spring6dof=0]="Spring6dof",e[e.Sixdof=1]="Sixdof",e[e.P2p=2]="P2p",e[e.ConeTwist=3]="ConeTwist",e[e.Slider=4]="Slider",e[e.Hinge=5]="Hinge"}(t=e.Type||(e.Type={}))}(l=e.Joint||(e.Joint={})),function(e){let t,n,o;!function(e){e[e.TriMesh=0]="TriMesh",e[e.Rope=1]="Rope"}(t=e.Type||(e.Type={})),function(e){e[e.Blink=1]="Blink",e[e.ClusterCreation=2]="ClusterCreation",e[e.LinkCrossing=4]="LinkCrossing"}(n=e.Flag||(e.Flag={})),function(e){e[e.VertexPoint=0]="VertexPoint",e[e.VertexTwoSided=1]="VertexTwoSided",e[e.VertexOneSided=2]="VertexOneSided",e[e.FaceTwoSided=3]="FaceTwoSided",e[e.FaceOneSided=4]="FaceOneSided"}(o=e.AeroDynamicModel||(e.AeroDynamicModel={}))}(d=e.SoftBody||(e.SoftBody={}))}(i||(i={}));class g{log(e){console.log(e)}warn(e){console.warn(e)}error(e){console.error(e)}}class p{static _LittleEndian=!0;_dataView;_decoder;_offset;constructor(e){this._dataView=new DataView(e),this._decoder=null,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}getUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}getInt8(){const e=this._dataView.getInt8(this._offset);return this._offset+=1,e}getUint8Array(e,t){for(let n=0;n<t;++n)e[n]=this._dataView.getUint8(this._offset),this._offset+=1}getUint16(){const e=this._dataView.getUint16(this._offset,p._LittleEndian);return this._offset+=2,e}getUint16Array(e,t){for(let n=0;n<t;++n)e[n]=this._dataView.getUint16(this._offset,p._LittleEndian),this._offset+=2}getInt16(){const e=this._dataView.getInt16(this._offset,p._LittleEndian);return this._offset+=2,e}getUint32(){const e=this._dataView.getUint32(this._offset,p._LittleEndian);return this._offset+=4,e}getUint32Array(e,t){for(let n=0;n<t;++n)e[n]=this._dataView.getUint32(this._offset,p._LittleEndian),this._offset+=4}getInt32(){const e=this._dataView.getInt32(this._offset,p._LittleEndian);return this._offset+=4,e}getInt32Array(e,t){for(let n=0;n<t;++n)e[n]=this._dataView.getInt32(this._offset,p._LittleEndian),this._offset+=4}getFloat32(){const e=this._dataView.getFloat32(this._offset,p._LittleEndian);return this._offset+=4,e}getFloat32Array(e,t){for(let n=0;n<t;++n)e[n]=this._dataView.getFloat32(this._offset,p._LittleEndian),this._offset+=4}getFloat32Tuple(e){const t=new Array(e);for(let n=0;n<e;++n)t[n]=this._dataView.getFloat32(this._offset,p._LittleEndian),this._offset+=4;return t}initializeTextDecoder(e){this._decoder=new TextDecoder(e)}getDecoderString(e,t){if(null===this._decoder)throw new Error("TextDecoder is not initialized.");let n=new Uint8Array(this._dataView.buffer,this._offset,e);if(this._offset+=e,t)for(let e=0;e<n.length;++e)if(0===n[e]){n=n.subarray(0,e);break}return this._decoder.decode(n)}getSignatureString(e){const t=new TextDecoder("utf-8"),n=new Uint8Array(this._dataView.buffer,this._offset,e);return this._offset+=e,t.decode(n)}get bytesAvailable(){return this._dataView.byteLength-this._offset}}class m{_vertexIndexSize;_textureIndexSize;_materialIndexSize;_boneIndexSize;_morphIndexSize;_rigidBodyIndexSize;constructor(e,t,n,o,r,i){this._vertexIndexSize=e,this._textureIndexSize=t,this._materialIndexSize=n,this._boneIndexSize=o,this._morphIndexSize=r,this._rigidBodyIndexSize=i}getVertexIndex(e){switch(this._vertexIndexSize){case 1:return e.getUint8();case 2:return e.getUint16();case 4:return e.getInt32();default:throw new Error(`Invalid vertexIndexSize: ${this._vertexIndexSize}`)}}_getNonVertexIndex(e,t){switch(t){case 1:return e.getInt8();case 2:return e.getInt16();case 4:return e.getInt32();default:throw new Error(`Invalid indexSize: ${t}`)}}getTextureIndex(e){return this._getNonVertexIndex(e,this._textureIndexSize)}getMaterialIndex(e){return this._getNonVertexIndex(e,this._materialIndexSize)}getBoneIndex(e){return this._getNonVertexIndex(e,this._boneIndexSize)}getMorphIndex(e){return this._getNonVertexIndex(e,this._morphIndexSize)}getRigidBodyIndex(e){return this._getNonVertexIndex(e,this._rigidBodyIndexSize)}}class x{constructor(){}static async ParseAsync(e,t=new g){const n=new p(e),o=this._ParseHeader(n,t),r=new m(o.vertexIndexSize,o.textureIndexSize,o.materialIndexSize,o.boneIndexSize,o.morphIndexSize,o.rigidBodyIndexSize),i=await this._ParseVerticesAsync(n,r,o),s=this._ParseFaces(n,r,o),a=this._ParseTextures(n),l=this._ParseMaterials(n,r),d=this._ParseBones(n,r),h=this._ParseMorphs(n,r),c=this._ParseDisplayFrames(n,r),u=this._ParseRigidBodies(n,r),f=this._ParseJoints(n,r),x=o.version<=2?[]:this._ParseSoftBodies(n,r,o);return n.bytesAvailable>0&&t.warn(`There are ${n.bytesAvailable} bytes left after parsing`),{header:o,vertices:i,faces:s,textures:a,materials:l,bones:d,morphs:h,displayFrames:c,rigidBodies:u,joints:f,softBodies:x}}static _ParseHeader(e,t){if(e.bytesAvailable<17)throw new RangeError("is not pmx file");const n=e.getSignatureString(4);if("PMX "!==n)throw new RangeError("is not pmx file");const o=e.getFloat32(),r=e.getUint8(),s=e.getUint8();e.initializeTextDecoder(s===i.Header.Encoding.Utf8?"utf-8":"utf-16le");const a=e.getUint8(),l=e.getUint8(),d=e.getUint8(),h=e.getUint8(),c=e.getUint8(),u=e.getUint8(),f=e.getUint8();if(r<8)throw new Error(`Invalid globalsCount: ${r}`);if(8<r){t.warn(`globalsCount is greater than 8: ${r} files may be corrupted or higher version`);for(let t=8;t<r;++t)e.getUint8()}return{signature:n,version:o,encoding:s,additionalVec4Count:a,vertexIndexSize:l,textureIndexSize:d,materialIndexSize:h,boneIndexSize:c,morphIndexSize:u,rigidBodyIndexSize:f,modelName:e.getDecoderString(e.getInt32(),!1),englishModelName:e.getDecoderString(e.getInt32(),!1),comment:e.getDecoderString(e.getInt32(),!1),englishComment:e.getDecoderString(e.getInt32(),!1)}}static async _ParseVerticesAsync(e,t,n){const o=e.getInt32(),r=[];let s=performance.now();for(let a=0;a<o;++a){const o=e.getFloat32Tuple(3),l=e.getFloat32Tuple(3),d=e.getFloat32Tuple(2),h=[];for(let t=0;t<n.additionalVec4Count;t++)h.push(e.getFloat32Tuple(4));const c=e.getUint8();let u;switch(c){case i.Vertex.BoneWeightType.Bdef1:u={boneIndices:t.getBoneIndex(e),boneWeights:null};break;case i.Vertex.BoneWeightType.Bdef2:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:e.getFloat32()};break;case i.Vertex.BoneWeightType.Bdef4:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:[e.getFloat32(),e.getFloat32(),e.getFloat32(),e.getFloat32()]};break;case i.Vertex.BoneWeightType.Sdef:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:{boneWeight0:e.getFloat32(),c:e.getFloat32Tuple(3),r0:e.getFloat32Tuple(3),r1:e.getFloat32Tuple(3)}};break;case i.Vertex.BoneWeightType.Qdef:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:[e.getFloat32(),e.getFloat32(),e.getFloat32(),e.getFloat32()]};break;default:throw new Error(`Invalid weightType: ${c}`)}const f=e.getFloat32();r.push({position:o,normal:l,uv:d,additionalVec4:h,weightType:c,boneWeight:u,edgeRatio:f}),a%1e4==0&&100<performance.now()-s&&(await new Promise((e=>setTimeout(e,0))),s=performance.now())}return r}static _ParseFaces(e,t,n){const o=e.getInt32(),r=new ArrayBuffer(o*n.vertexIndexSize);let i;switch(n.vertexIndexSize){case 1:i=new Uint8Array(r);break;case 2:i=new Uint16Array(r);break;case 4:i=new Int32Array(r);break;default:throw new Error(`Invalid vertexIndexSize: ${n.vertexIndexSize}`)}for(let n=0;n<o;++n)i[n]=t.getVertexIndex(e);return i}static _ParseTextures(e){const t=e.getInt32(),n=[];for(let o=0;o<t;++o){const t=e.getDecoderString(e.getInt32(),!1);n.push(t)}return n}static _ParseMaterials(e,t){const n=e.getInt32(),o=[];for(let r=0;r<n;++r){const n=e.getDecoderString(e.getInt32(),!1),r=e.getDecoderString(e.getInt32(),!1),i=e.getFloat32Tuple(4),s=e.getFloat32Tuple(3),a=e.getFloat32(),l=e.getFloat32Tuple(3),d=e.getUint8(),h=e.getFloat32Tuple(4),c=e.getFloat32(),u=t.getTextureIndex(e),f=t.getTextureIndex(e),g=e.getUint8(),p=1===e.getUint8(),m={name:n,englishName:r,diffuse:i,specular:s,shininess:a,ambient:l,flag:d,edgeColor:h,edgeSize:c,textureIndex:u,sphereTextureIndex:f,sphereTextureMode:g,isSharedToonTexture:p,toonTextureIndex:p?e.getUint8():t.getTextureIndex(e),comment:e.getDecoderString(e.getInt32(),!1),surfaceCount:e.getInt32()};o.push(m)}return o}static _ParseBones(e,t){const n=e.getInt32(),o=[];for(let r=0;r<n;++r){const n=e.getDecoderString(e.getInt32(),!1),r=e.getDecoderString(e.getInt32(),!1),s=e.getFloat32Tuple(3),a=t.getBoneIndex(e),l=e.getInt32(),d=e.getUint16();let h,c,u,f;h=d&i.Bone.Flag.UseBoneIndexAsTailPosition?t.getBoneIndex(e):e.getFloat32Tuple(3),(d&i.Bone.Flag.HasAppendMove||d&i.Bone.Flag.HasAppendRotate)&&(c={isLocal:0!=(d&i.Bone.Flag.LocalAppendTransform),affectRotation:0!=(d&i.Bone.Flag.HasAppendRotate),affectPosition:0!=(d&i.Bone.Flag.HasAppendMove),parentIndex:t.getBoneIndex(e),ratio:e.getFloat32()}),d&i.Bone.Flag.HasAxisLimit&&(u=e.getFloat32Tuple(3)),d&i.Bone.Flag.HasLocalVector&&(f={x:e.getFloat32Tuple(3),z:e.getFloat32Tuple(3)});const g=0!=(d&i.Bone.Flag.TransformAfterPhysics);let p,m;if(d&i.Bone.Flag.IsExternalParentTransformed&&(p=e.getInt32()),d&i.Bone.Flag.IsIkEnabled){const n=t.getBoneIndex(e),o=e.getInt32(),r=e.getFloat32(),i=[],s=e.getInt32();for(let n=0;n<s;++n){const n={target:t.getBoneIndex(e),limitation:1===e.getUint8()?{minimumAngle:e.getFloat32Tuple(3),maximumAngle:e.getFloat32Tuple(3)}:void 0};i.push(n)}m={target:n,iteration:o,rotationConstraint:r,links:i}}const x={name:n,englishName:r,position:s,parentBoneIndex:a,transformOrder:l,flag:d,tailPosition:h,appendTransform:c,axisLimit:u,localVector:f,transformAfterPhysics:g,externalParentTransform:p,ik:m};o.push(x)}return o}static _ParseMorphs(e,t){const n=e.getInt32(),o=[];for(let r=0;r<n;++r){const n=e.getDecoderString(e.getInt32(),!1),r=e.getDecoderString(e.getInt32(),!1),s=e.getInt8(),a=e.getInt8();let l={name:n,englishName:r,category:s,type:a};const d=e.getInt32();switch(a){case i.Morph.Type.GroupMorph:{const n=new Int32Array(d),o=new Float32Array(d);for(let r=0;r<d;++r)n[r]=t.getMorphIndex(e),o[r]=e.getFloat32();l={...l,indices:n,ratios:o}}break;case i.Morph.Type.VertexMorph:{const n=new Int32Array(d),o=new Float32Array(3*d);for(let r=0;r<d;++r)n[r]=t.getVertexIndex(e),o[3*r+0]=e.getFloat32(),o[3*r+1]=e.getFloat32(),o[3*r+2]=e.getFloat32();l={...l,indices:n,positions:o}}break;case i.Morph.Type.BoneMorph:{const n=new Int32Array(d),o=new Float32Array(3*d),r=new Float32Array(4*d);for(let i=0;i<d;++i)n[i]=t.getBoneIndex(e),o[3*i+0]=e.getFloat32(),o[3*i+1]=e.getFloat32(),o[3*i+2]=e.getFloat32(),r[4*i+0]=e.getFloat32(),r[4*i+1]=e.getFloat32(),r[4*i+2]=e.getFloat32(),r[4*i+3]=e.getFloat32();l={...l,indices:n,positions:o,rotations:r}}break;case i.Morph.Type.UvMorph:case i.Morph.Type.AdditionalUvMorph1:case i.Morph.Type.AdditionalUvMorph2:case i.Morph.Type.AdditionalUvMorph3:case i.Morph.Type.AdditionalUvMorph4:{const n=new Int32Array(d),o=new Float32Array(4*d);for(let r=0;r<d;++r)n[r]=t.getVertexIndex(e),o[4*r+0]=e.getFloat32(),o[4*r+1]=e.getFloat32(),o[4*r+2]=e.getFloat32(),o[4*r+3]=e.getFloat32();l={...l,indices:n,offsets:o}}break;case i.Morph.Type.MaterialMorph:{const n=[];for(let o=0;o<d;++o){const o={index:t.getMaterialIndex(e),type:e.getUint8(),diffuse:e.getFloat32Tuple(4),specular:e.getFloat32Tuple(3),shininess:e.getFloat32(),ambient:e.getFloat32Tuple(3),edgeColor:e.getFloat32Tuple(4),edgeSize:e.getFloat32(),textureColor:e.getFloat32Tuple(4),sphereTextureColor:e.getFloat32Tuple(4),toonTextureColor:e.getFloat32Tuple(4)};n.push(o)}l={...l,elements:n}}break;case i.Morph.Type.FlipMorph:{const n=new Int32Array(d),o=new Float32Array(d);for(let r=0;r<d;++r)n[r]=t.getMorphIndex(e),o[r]=e.getFloat32();l={...l,indices:n,ratios:o}}break;case i.Morph.Type.ImpulseMorph:{const n=new Int32Array(d),o=new Array(d),r=new Float32Array(3*d),i=new Float32Array(3*d);for(let s=0;s<d;++s)n[s]=t.getRigidBodyIndex(e),o[s]=1===e.getUint8(),r[3*s+0]=e.getFloat32(),r[3*s+1]=e.getFloat32(),r[3*s+2]=e.getFloat32(),i[3*s+0]=e.getFloat32(),i[3*s+1]=e.getFloat32(),i[3*s+2]=e.getFloat32();l={...l,indices:n,isLocals:o,velocities:r,torques:i}}break;default:throw new Error(`Unknown morph type: ${a}`)}o.push(l)}return o}static _ParseDisplayFrames(e,t){const n=e.getInt32(),o=[];for(let r=0;r<n;++r){const n=e.getDecoderString(e.getInt32(),!1),r=e.getDecoderString(e.getInt32(),!1),s=1===e.getUint8(),a=e.getInt32(),l=[];for(let n=0;n<a;++n){const n=e.getUint8(),o={type:n,index:n===i.DisplayFrame.FrameData.FrameType.Bone?t.getBoneIndex(e):t.getMorphIndex(e)};l.push(o)}const d={name:n,englishName:r,isSpecialFrame:s,frames:l};o.push(d)}return o}static _ParseRigidBodies(e,t){const n=e.getInt32(),o=[];for(let r=0;r<n;++r){const n={name:e.getDecoderString(e.getInt32(),!1),englishName:e.getDecoderString(e.getInt32(),!1),boneIndex:t.getBoneIndex(e),collisionGroup:e.getUint8(),collisionMask:e.getUint16(),shapeType:e.getUint8(),shapeSize:e.getFloat32Tuple(3),shapePosition:e.getFloat32Tuple(3),shapeRotation:e.getFloat32Tuple(3),mass:e.getFloat32(),linearDamping:e.getFloat32(),angularDamping:e.getFloat32(),repulsion:e.getFloat32(),friction:e.getFloat32(),physicsMode:e.getUint8()};o.push(n)}return o}static _ParseJoints(e,t){const n=e.getInt32(),o=[];for(let r=0;r<n;++r){const n={name:e.getDecoderString(e.getInt32(),!1),englishName:e.getDecoderString(e.getInt32(),!1),type:e.getUint8(),rigidbodyIndexA:t.getRigidBodyIndex(e),rigidbodyIndexB:t.getRigidBodyIndex(e),position:e.getFloat32Tuple(3),rotation:e.getFloat32Tuple(3),positionMin:e.getFloat32Tuple(3),positionMax:e.getFloat32Tuple(3),rotationMin:e.getFloat32Tuple(3),rotationMax:e.getFloat32Tuple(3),springPosition:e.getFloat32Tuple(3),springRotation:e.getFloat32Tuple(3)};o.push(n)}return o}static _ParseSoftBodies(e,t,n){const o=e.getInt32(),r=[];for(let i=0;i<o;++i){const o=e.getDecoderString(e.getInt32(),!1),i=e.getDecoderString(e.getInt32(),!1),s=e.getUint8(),a=t.getMaterialIndex(e),l=e.getUint8(),d=e.getUint16(),h=e.getUint8(),c=e.getInt32(),u=e.getInt32(),f=e.getFloat32(),g=e.getFloat32(),p=e.getInt32(),m={vcf:e.getFloat32(),dp:e.getFloat32(),dg:e.getFloat32(),lf:e.getFloat32(),pr:e.getFloat32(),vc:e.getFloat32(),df:e.getFloat32(),mt:e.getFloat32(),chr:e.getFloat32(),khr:e.getFloat32(),shr:e.getFloat32(),ahr:e.getFloat32()},x={srhrCl:e.getFloat32(),skhrCl:e.getFloat32(),sshrCl:e.getFloat32(),srSpltCl:e.getFloat32(),skSpltCl:e.getFloat32(),ssSpltCl:e.getFloat32()},_={vIt:e.getInt32(),pIt:e.getInt32(),dIt:e.getInt32(),cIt:e.getInt32()},T={lst:e.getInt32(),ast:e.getInt32(),vst:e.getInt32()},A=e.getInt32(),y=[];for(let n=0;n<A;++n){const n={rigidbodyIndex:t.getRigidBodyIndex(e),vertexIndex:t.getVertexIndex(e),isNearMode:0!==e.getUint8()};y.push(n)}const E=e.getInt32(),I=new ArrayBuffer(E*n.vertexIndexSize);let M;switch(n.vertexIndexSize){case 1:M=new Uint8Array(I);break;case 2:M=new Uint16Array(I);break;case 4:M=new Int32Array(I);break;default:throw new Error(`Invalid vertexIndexSize: ${n.vertexIndexSize}`)}for(let n=0;n<E;++n)M[n]=t.getVertexIndex(e);const b={name:o,englishName:i,type:s,materialIndex:a,collisionGroup:l,collisionMask:d,flags:h,bLinkDistance:c,clusterCount:u,totalMass:f,collisionMargin:g,aeroModel:p,config:m,cluster:x,interation:_,material:T,anchors:y,vertexPins:M};r.push(b)}return r}}class _{files;_fileMap=new Map;constructor(e,t){if(this.files=e,0!==e.length)if(e[0]instanceof File)for(const t of e){const e=t.webkitRelativePath;this._fileMap.set(this._pathNormalize(e),t)}else for(const n of e){const e=t+n.relativePath;this._fileMap.set(this._pathNormalize(e),n)}}resolve(e){const t=this._pathNormalize(e);return this._fileMap.get(t)}_pathNormalize(e){return e.replace(/\\/g,"/").toUpperCase()}}!function(e){e[e.Opaque=o.F5T.MATERIAL_OPAQUE]="Opaque",e[e.AlphaTest=o.F5T.MATERIAL_ALPHATEST]="AlphaTest",e[e.AlphaBlend=o.F5T.MATERIAL_ALPHABLEND]="AlphaBlend"}(s||(s={}));class T{texture;onLoadObservable;constructor(){this.texture=null,this.onLoadObservable=new o.y$z}awaitLoad(){return new Promise((e=>{null!==this.texture?e(this):this.onLoadObservable.addOnce((()=>e(this)))}))}}class A{_resolution;_textureCache;_context;_vertexShader;_fragmentShader;_program;_uvBuffer;_indexBuffer;_indicesBytePerElement;constructor(e,t,n=512){this._resolution=n,this._textureCache=new Map,this._context=this._createRenderingContext(),this._vertexShader=null,this._fragmentShader=null,this._program=null,this._uvBuffer=null,this._indexBuffer=null,this._indicesBytePerElement=t.BYTES_PER_ELEMENT,!1!==this._prepareContext()&&!1!==this._bindUvAndIndexBuffer(e,t)||this.dispose()}_createRenderingContext(){const e=document.createElement("canvas");return e.width=this._resolution,e.height=this._resolution,e.getContext("webgl2",{alpha:!1,antialias:!1,depth:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1})}_prepareContext(){if(null===this._context)return!1;const e=this._context;e.clearColor(0,0,0,0);const t=this._vertexShader=e.createShader(e.VERTEX_SHADER);if(null===t)return!1;if(e.shaderSource(t,"\n            precision highp float;\n            attribute vec2 uv;\n            varying vec2 vUv;\n\n            void main() {\n                vUv = uv;\n                gl_Position = vec4(uv * 2.0 - 1.0, 0.0, 1.0);\n            }\n        "),e.compileShader(t),!e.getShaderParameter(t,e.COMPILE_STATUS))return console.error(e.getShaderInfoLog(t)),!1;const n=this._fragmentShader=e.createShader(e.FRAGMENT_SHADER);if(null===n)return!1;const o=`\n            precision highp float;\n            uniform sampler2D texture;\n            varying vec2 vUv;\n\n            void main() {\n                vec2 onePixel = vec2(1.0 / ${this._resolution.toFixed(1)});\n\n                float minAlpha = 1.0;\n                for (int i = 0; i < 2; ++i) {\n                    for (int j = 0; j < 2; ++j) {\n                        float alpha = texture2D(texture, vUv + vec2(onePixel.x * float(i), onePixel.y * float(j))).a;\n                        minAlpha = min(minAlpha, alpha);\n                    }\n                }\n                gl_FragColor = vec4(vec3(1.0) - minAlpha, 1.0);\n            }\n        `;if(e.shaderSource(n,o),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))return console.error(e.getShaderInfoLog(n)),!1;const r=this._program=e.createProgram();return null!==r&&(e.attachShader(r,t),e.attachShader(r,n),e.linkProgram(r),e.getProgramParameter(r,e.LINK_STATUS)?(e.useProgram(r),!0):(console.error(e.getProgramInfoLog(r)),!1))}async _getWebGlTexture(e){const t=this._context;if(null===t)return null;const n=this._textureCache.get(e);if(void 0!==n)return await n.awaitLoad(),n.texture;const o=new T;this._textureCache.set(e,o);const r=await new Promise(((t,n)=>{const o=new Image;o.onload=()=>t(o),o.onerror=()=>n(),o.src=URL.createObjectURL(new Blob([e]))})),i=t.createTexture();return null===i?null:(t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,r.width,r.height,0,t.RGBA,t.UNSIGNED_BYTE,r),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,1),URL.revokeObjectURL(r.src),o.texture=i,o.onLoadObservable.notifyObservers(),i)}_bindUvAndIndexBuffer(e,t){const n=this._context;if(null===n)return!1;const o=this._program;if(null===o)return!1;const r=this._uvBuffer=n.createBuffer();if(null===r)return!1;n.bindBuffer(n.ARRAY_BUFFER,r),n.bufferData(n.ARRAY_BUFFER,e,n.STATIC_DRAW);const i=n.getAttribLocation(o,"uv");n.enableVertexAttribArray(i),n.vertexAttribPointer(i,2,n.FLOAT,!1,0,0);const s=this._indexBuffer=n.createBuffer();return null!==s&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,s),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t,n.STATIC_DRAW),!0)}async textureHasAlphaOnGeometry(e,t,n,o,r){const i=this._context;if(null===i)return s.Opaque;const a=this._program;if(null===a)return s.Opaque;const l=await this._getWebGlTexture(e);if(null===l)return s.Opaque;i.clear(i.COLOR_BUFFER_BIT);const d=i.getUniformLocation(a,"texture");i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,l),i.uniform1i(d,0),i.drawElements(i.TRIANGLES,n,2===this._indicesBytePerElement?i.UNSIGNED_SHORT:i.UNSIGNED_INT,t*this._indicesBytePerElement);const h=this._resolution,c=new Uint8Array(h*h*4);i.readPixels(0,0,h,h,i.RGBA,i.UNSIGNED_BYTE,c);let u=0,f=0,g=0;for(let e=0;e<h;e+=2)for(let t=0;t<h;t+=2){const n=c[4*(e*h+t)];u=Math.max(u,n),0<n&&n<255&&(f+=n,g+=1)}return 0!==g&&(f/=g),u<o?s.Opaque:f+r<u?s.AlphaTest:s.AlphaBlend}dispose(){const e=this._context;if(null!==e){e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),e.bindTexture(e.TEXTURE_2D,null),e.useProgram(null),e.deleteBuffer(this._uvBuffer),e.deleteBuffer(this._indexBuffer);for(const t of this._textureCache.values())e.deleteTexture(t.texture);e.deleteProgram(this._program),e.deleteShader(this._vertexShader),e.deleteShader(this._fragmentShader),this._context=null,this._vertexShader=null,this._fragmentShader=null,this._program=null,this._uvBuffer=null,this._indexBuffer=null}}}class y{static _LittleEndian=!0;_dataView;_encoder;_offset;constructor(e){this._dataView=new DataView(e),this._encoder=new TextEncoder,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}setUint8(e){this._dataView.setUint8(this._offset,e),this._offset+=1}setUint8Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setUint8(this._offset,e[n]),this._offset+=1}setInt8(e){this._dataView.setInt8(this._offset,e),this._offset+=1}setInt8Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setInt8(this._offset,e[n]),this._offset+=1}setUint16(e){this._dataView.setUint16(this._offset,e,y._LittleEndian),this._offset+=2}setUint16Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setUint16(this._offset,e[n],y._LittleEndian),this._offset+=2}setUint32(e){this._dataView.setUint32(this._offset,e,y._LittleEndian),this._offset+=4}setUint32Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setUint32(this._offset,e[n],y._LittleEndian),this._offset+=4}setInt32(e){this._dataView.setInt32(this._offset,e,y._LittleEndian),this._offset+=4}setInt32Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setInt32(this._offset,e[n],y._LittleEndian),this._offset+=4}setFloat32(e){this._dataView.setFloat32(this._offset,e,y._LittleEndian),this._offset+=4}setFloat32Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setFloat32(this._offset,e[n],y._LittleEndian),this._offset+=4}setString(e){const t=this._dataView,n=this._encoder.encode(e);t.setUint32(this._offset,n.length,y._LittleEndian),this._offset+=4;for(let e=0;e<n.length;++e)t.setUint8(this._offset,n[e]),this._offset+=1}get bytesAvailable(){return this._dataView.byteLength-this._offset}}class E{alphaThreshold;alphaBlendThreshold;useAlphaEvaluation;alphaEvaluationResolution;_loggingEnabled;log;warn;error;constructor(){this.alphaThreshold=195,this.alphaBlendThreshold=100,this.useAlphaEvaluation=!0,this.alphaEvaluationResolution=512,this._loggingEnabled=!0,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled}async convert(e,t,n){const o=this.alphaThreshold,r=this.alphaBlendThreshold,s=this.useAlphaEvaluation,a=this.alphaEvaluationResolution;let l;if(void 0===n){const e=await fetch(t).then((e=>e.arrayBuffer()));l=await x.ParseAsync(e,this)}else{const e=n.find((e=>e.webkitRelativePath===t));if(void 0===e)throw new Error(`File ${t} not found`);const o=await e.arrayBuffer();l=await x.ParseAsync(o,this)}const d=l.vertices,h=new Float32Array(3*d.length),c=new Float32Array(3*d.length),u=new Float32Array(2*d.length);let g;g=l.faces instanceof Uint8Array||l.faces instanceof Uint16Array?new Uint16Array(l.faces.length):new Uint32Array(l.faces.length);const p=new Float32Array(4*d.length),m=new Float32Array(4*d.length);let T=!1;const E=new Float32Array(3*l.vertices.length),I=new Float32Array(3*l.vertices.length),M=new Float32Array(3*l.vertices.length);{const e=l.vertices;{const e=l.faces;for(let t=0;t<g.length;t+=3)g[t+0]=e[t+0],g[t+1]=e[t+2],g[t+2]=e[t+1]}for(let t=0;t<e.length;++t){const n=e[t];switch(h[3*t+0]=n.position[0],h[3*t+1]=n.position[1],h[3*t+2]=n.position[2],c[3*t+0]=n.normal[0],c[3*t+1]=n.normal[1],c[3*t+2]=n.normal[2],u[2*t+0]=n.uv[0],u[2*t+1]=1-n.uv[1],n.weightType){case i.Vertex.BoneWeightType.Bdef1:{const e=n.boneWeight;p[4*t+0]=e.boneIndices,p[4*t+1]=0,p[4*t+2]=0,p[4*t+3]=0,m[4*t+0]=1,m[4*t+1]=0,m[4*t+2]=0,m[4*t+3]=0}break;case i.Vertex.BoneWeightType.Bdef2:{const e=n.boneWeight;p[4*t+0]=e.boneIndices[0],p[4*t+1]=e.boneIndices[1],p[4*t+2]=0,p[4*t+3]=0,m[4*t+0]=e.boneWeights,m[4*t+1]=1-e.boneWeights,m[4*t+2]=0,m[4*t+3]=0}break;case i.Vertex.BoneWeightType.Bdef4:case i.Vertex.BoneWeightType.Qdef:{const e=n.boneWeight;p[4*t+0]=e.boneIndices[0],p[4*t+1]=e.boneIndices[1],p[4*t+2]=e.boneIndices[2],p[4*t+3]=e.boneIndices[3],m[4*t+0]=e.boneWeights[0],m[4*t+1]=e.boneWeights[1],m[4*t+2]=e.boneWeights[2],m[4*t+3]=e.boneWeights[3]}break;case i.Vertex.BoneWeightType.Sdef:{const e=n.boneWeight;p[4*t+0]=e.boneIndices[0],p[4*t+1]=e.boneIndices[1],p[4*t+2]=0,p[4*t+3]=0;const o=e.boneWeights,r=o.boneWeight0,i=1-r;m[4*t+0]=r,m[4*t+1]=i,m[4*t+2]=0,m[4*t+3]=0;const s=o.c[0],a=o.c[1],l=o.c[2];let d=o.r0[0],h=o.r0[1],c=o.r0[2],u=o.r1[0],f=o.r1[1],g=o.r1[2];const x=d*r+u*i,_=h*r+f*i,A=c*r+g*i;d=s+d-x,h=a+h-_,c=l+c-A,u=s+u-x,f=a+f-_,g=l+g-A;const y=.5*(s+d),b=.5*(a+h),w=.5*(l+c),R=.5*(s+u),S=.5*(a+f),C=.5*(l+g);E[3*t+0]=s,E[3*t+1]=a,E[3*t+2]=l,I[3*t+0]=y,I[3*t+1]=b,I[3*t+2]=w,M[3*t+0]=R,M[3*t+1]=S,M[3*t+2]=C,T=!0}}}}const b=[];{const o=new Array(l.textures.length),r=t.substring(0,t.lastIndexOf("/")+1),i=new f,s=new _(n??[]),a=[],d=l.materials;for(let t=0;t<d.length;++t){const n=d[t],h=l.textures[n.textureIndex];if(void 0!==h){const t=r+h,l=s.resolve(t);void 0!==l?a.push(i.loadTextureFromBufferAsync(0,t,l,e,null).then((e=>{o[n.textureIndex]=e}))):a.push(i.loadTextureAsync(0,r,h,e,null).then((e=>{o[n.textureIndex]=e})))}const c=l.textures[n.sphereTextureIndex];if(void 0!==c){const t=r+c,l=s.resolve(t);void 0!==l?a.push(i.loadTextureFromBufferAsync(0,t,l,e,null).then((e=>{o[n.sphereTextureIndex]=e}))):a.push(i.loadTextureAsync(0,r,c,e,null).then((e=>{o[n.sphereTextureIndex]=e})))}const u=l.textures[n.toonTextureIndex];if(void 0!==u&&!n.isSharedToonTexture){const t=r+u,l=s.resolve(t);void 0!==l?a.push(i.loadTextureFromBufferAsync(0,t,l,e,null).then((e=>{o[n.toonTextureIndex]=e}))):a.push(i.loadTextureAsync(0,r,u,e,null).then((e=>{o[n.toonTextureIndex]=e})))}}i.loadModelTexturesEnd(0),await Promise.all(a);const h=i.onModelTextureLoadedObservable.get(0);void 0!==h&&await new Promise((e=>{h.addOnce((()=>{e()}))}));for(let e=0;e<o.length;++e){const t=o[e];b[e]=t.arrayBuffer,t.texture?.dispose()}}const w=new Array(l.materials.length).fill(-1);if(s){const e=new A(u,g,a),t=l.materials;let n=0;for(let i=0;i<t.length;++i){const s=t[i];if(void 0!==l.textures[s.textureIndex]){const t=b[s.textureIndex];if(null!==t){const a=await e.textureHasAlphaOnGeometry(t,n,s.surfaceCount,o,r);w[i]=a}}n+=s.surfaceCount}e.dispose()}const R=new TextEncoder;let S=7;{const e=l.header;S+=4+R.encode(e.modelName).length,S+=4+R.encode(e.englishModelName).length,S+=4+R.encode(e.comment).length,S+=4+R.encode(e.englishComment).length,S+=4,S+=3*d.length*4,S+=3*d.length*4,S+=2*d.length*4,S+=1,S+=4,S+=g.byteLength,S+=4*d.length*4,S+=4*d.length*4,S+=1,T&&(S+=3*d.length*4,S+=3*d.length*4,S+=3*d.length*4),S+=4;const t=l.textures;for(let e=0;e<t.length;++e){const n=b[e];null!==n?(S+=4+R.encode(t[e]).length,S+=4,S+=n.byteLength):(S+=4,S+=4)}S+=4;const n=l.materials;for(let e=0;e<n.length;++e){const t=n[e];S+=4+R.encode(t.name).length,S+=4+R.encode(t.englishName).length,S+=16,S+=12,S+=4,S+=12,S+=1,S+=1,S+=16,S+=4,S+=4,S+=4,S+=1,S+=1,S+=4,S+=4+R.encode(t.comment).length,S+=4}S+=4;const o=l.bones;for(let e=0;e<o.length;++e){const t=o[e];if(S+=4+R.encode(t.name).length,S+=4+R.encode(t.englishName).length,S+=12,S+=4,S+=4,S+=2,"number"==typeof t.tailPosition?S+=4:S+=12,void 0!==t.appendTransform&&(S+=4,S+=4),void 0!==t.axisLimit&&(S+=12),void 0!==t.localVector&&(S+=12,S+=12),void 0!==t.externalParentTransform&&(S+=4),void 0!==t.ik){S+=4,S+=4,S+=4,S+=4;const e=t.ik.links;for(let t=0;t<e.length;++t)S+=4,S+=1,void 0!==e[t].limitation&&(S+=12,S+=12)}}S+=4;const r=l.morphs;for(let e=0;e<r.length;++e){const t=r[e];switch(S+=4+R.encode(t.name).length,S+=4+R.encode(t.englishName).length,S+=1,S+=1,S+=4,t.type){case i.Morph.Type.GroupMorph:S+=8*t.indices.length;break;case i.Morph.Type.VertexMorph:S+=16*t.indices.length;break;case i.Morph.Type.BoneMorph:S+=32*t.indices.length;break;case i.Morph.Type.UvMorph:case i.Morph.Type.AdditionalUvMorph1:case i.Morph.Type.AdditionalUvMorph2:case i.Morph.Type.AdditionalUvMorph3:case i.Morph.Type.AdditionalUvMorph4:S+=20*t.indices.length;break;case i.Morph.Type.MaterialMorph:S+=117*t.elements.length}}S+=4;const s=l.displayFrames;for(let e=0;e<s.length;++e){const t=s[e];S+=4+R.encode(t.name).length,S+=4+R.encode(t.englishName).length,S+=1,S+=4,S+=5*t.frames.length}S+=4;const a=l.rigidBodies;for(let e=0;e<a.length;++e){const t=a[e];S+=4+R.encode(t.name).length,S+=4+R.encode(t.englishName).length,S+=4,S+=1,S+=2,S+=1,S+=12,S+=12,S+=12,S+=4,S+=4,S+=4,S+=4,S+=4,S+=1}S+=4;const h=l.joints;for(let e=0;e<h.length;++e){const t=h[e];S+=4+R.encode(t.name).length,S+=4+R.encode(t.englishName).length,S+=1,S+=4,S+=4,S+=12,S+=12,S+=12,S+=12,S+=12,S+=12,S+=12,S+=12}}const C=new ArrayBuffer(S),v=new y(C);v.setUint8Array(R.encode("BPMX")),v.setInt8Array([1,0,0]),v.setString(l.header.modelName),v.setString(l.header.englishModelName),v.setString(l.header.comment),v.setString(l.header.englishComment),v.setUint32(d.length),v.setFloat32Array(h),v.setFloat32Array(c),v.setFloat32Array(u),g instanceof Uint16Array?(v.setUint8(2),v.setUint32(g.length),v.setUint16Array(g)):(v.setUint8(4),v.setUint32(g.length),v.setUint32Array(g)),v.setFloat32Array(p),v.setFloat32Array(m),v.setUint8(T?1:0),T&&(v.setFloat32Array(E),v.setFloat32Array(I),v.setFloat32Array(M)),v.setUint32(l.textures.length);const B=l.textures;for(let e=0;e<b.length;++e){const t=b[e];null!==t?(v.setString(B[e]),v.setUint32(t.byteLength),v.setUint8Array(new Uint8Array(t))):(v.setUint32(0),v.setUint32(0))}v.setUint32(l.materials.length);const F=l.materials;for(let e=0;e<F.length;++e){const t=F[e];v.setString(t.name),v.setString(t.englishName),v.setFloat32Array(t.diffuse),v.setFloat32Array(t.specular),v.setFloat32(t.shininess),v.setFloat32Array(t.ambient),v.setInt8(w[e]),v.setUint8(t.flag),v.setFloat32Array(t.edgeColor),v.setFloat32(t.edgeSize),v.setInt32(t.textureIndex),v.setInt32(t.sphereTextureIndex),v.setUint8(t.sphereTextureMode),v.setUint8(t.isSharedToonTexture?1:0),v.setInt32(t.toonTextureIndex),v.setString(t.comment),v.setUint32(t.surfaceCount)}v.setUint32(l.bones.length);const U=l.bones;for(let e=0;e<U.length;++e){const t=U[e];if(v.setString(t.name),v.setString(t.englishName),v.setFloat32Array(t.position),v.setInt32(t.parentBoneIndex),v.setInt32(t.transformOrder),v.setUint16(t.flag),"number"==typeof t.tailPosition?v.setFloat32(t.tailPosition):v.setFloat32Array(t.tailPosition),void 0!==t.appendTransform&&(v.setInt32(t.appendTransform.parentIndex),v.setFloat32(t.appendTransform.ratio)),void 0!==t.axisLimit&&v.setFloat32Array(t.axisLimit),void 0!==t.localVector&&(v.setFloat32Array(t.localVector.x),v.setFloat32Array(t.localVector.z)),void 0!==t.externalParentTransform&&v.setInt32(t.externalParentTransform),void 0!==t.ik){const e=t.ik;v.setInt32(e.target),v.setInt32(e.iteration),v.setFloat32(e.rotationConstraint);const n=e.links;v.setInt32(n.length);for(let e=0;e<n.length;++e){const t=n[e];v.setInt32(t.target),v.setUint8(void 0!==t.limitation?1:0),void 0!==t.limitation&&(v.setFloat32Array(t.limitation.minimumAngle),v.setFloat32Array(t.limitation.maximumAngle))}}}v.setUint32(l.morphs.length);const P=l.morphs;for(let e=0;e<P.length;++e){const t=P[e];switch(v.setString(t.name),v.setString(t.englishName),v.setUint8(t.category),v.setUint8(t.type),t.type){case i.Morph.Type.GroupMorph:v.setUint32(t.indices.length),v.setInt32Array(t.indices),v.setFloat32Array(t.ratios);break;case i.Morph.Type.VertexMorph:v.setUint32(t.indices.length),v.setInt32Array(t.indices),v.setFloat32Array(t.positions);break;case i.Morph.Type.BoneMorph:v.setUint32(t.indices.length),v.setInt32Array(t.indices),v.setFloat32Array(t.positions),v.setFloat32Array(t.rotations);break;case i.Morph.Type.UvMorph:case i.Morph.Type.AdditionalUvMorph1:case i.Morph.Type.AdditionalUvMorph2:case i.Morph.Type.AdditionalUvMorph3:case i.Morph.Type.AdditionalUvMorph4:v.setUint32(t.indices.length),v.setInt32Array(t.indices),v.setFloat32Array(t.offsets);break;case i.Morph.Type.MaterialMorph:{v.setUint32(t.elements.length);const e=t.elements;for(let t=0;t<e.length;++t){const n=e[t];v.setInt32(n.index),v.setUint8(n.type),v.setFloat32Array(n.diffuse),v.setFloat32Array(n.specular),v.setFloat32(n.shininess),v.setFloat32Array(n.ambient),v.setFloat32Array(n.edgeColor),v.setFloat32(n.edgeSize),v.setFloat32Array(n.textureColor),v.setFloat32Array(n.sphereTextureColor),v.setFloat32Array(n.toonTextureColor)}}break;default:v.setUint32(0)}}v.setUint32(l.displayFrames.length);const D=l.displayFrames;for(let e=0;e<D.length;++e){const t=D[e];v.setString(t.name),v.setString(t.englishName),v.setUint8(t.isSpecialFrame?1:0),v.setUint32(t.frames.length);const n=t.frames;for(let e=0;e<n.length;++e){const t=n[e];v.setUint8(t.type),v.setInt32(t.index)}}v.setUint32(l.rigidBodies.length);const O=l.rigidBodies;for(let e=0;e<O.length;++e){const t=O[e];v.setString(t.name),v.setString(t.englishName),v.setInt32(t.boneIndex),v.setUint8(t.collisionGroup),v.setUint16(t.collisionMask),v.setUint8(t.shapeType),v.setFloat32Array(t.shapeSize),v.setFloat32Array(t.shapePosition),v.setFloat32Array(t.shapeRotation),v.setFloat32(t.mass),v.setFloat32(t.linearDamping),v.setFloat32(t.angularDamping),v.setFloat32(t.repulsion),v.setFloat32(t.friction),v.setUint8(t.physicsMode)}v.setUint32(l.joints.length);const L=l.joints;for(let e=0;e<L.length;++e){const t=L[e];v.setString(t.name),v.setString(t.englishName),v.setUint8(t.type),v.setInt32(t.rigidbodyIndexA),v.setInt32(t.rigidbodyIndexB),v.setFloat32Array(t.position),v.setFloat32Array(t.rotation),v.setFloat32Array(t.positionMin),v.setFloat32Array(t.positionMax),v.setFloat32Array(t.rotationMin),v.setFloat32Array(t.rotationMax),v.setFloat32Array(t.springPosition),v.setFloat32Array(t.springRotation)}return C}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){o.YdH.Log(e)}_logDisabled(){}_warnEnabled(e){o.YdH.Warn(e)}_warnDisabled(){}_errorEnabled(e){o.YdH.Error(e)}_errorDisabled(){}}class I{static MatricesSdefCKind="matricesSdefC";static MatricesSdefR0Kind="matricesSdefR0";static MatricesSdefR1Kind="matricesSdefR1"}const M="\n#ifndef SDEFDECLARATION\n#define SDEFDECLARATION\n\n#if NUM_BONE_INFLUENCERS > 0 && defined(SDEF)\nattribute vec3 matricesSdefC;\nattribute vec3 matricesSdefR0;\nattribute vec3 matricesSdefR1;\n\nvec4 rotationMatrixToQuaternion(mat3 matrix) {\n    float trace = matrix[0][0] + matrix[1][1] + matrix[2][2];\n    float s;\n\n    float sqrtParam;\n    if (trace > 0.0) {\n        sqrtParam = trace + 1.0;\n    } else if (matrix[0][0] > matrix[1][1] && matrix[0][0] > matrix[2][2]) {\n        sqrtParam = 1.0 + matrix[0][0] - matrix[1][1] - matrix[2][2];\n    } else if (matrix[1][1] > matrix[2][2]) {\n        sqrtParam = 1.0 + matrix[1][1] - matrix[0][0] - matrix[2][2];\n    } else {\n        sqrtParam = 1.0 + matrix[2][2] - matrix[0][0] - matrix[1][1];\n    }\n    float sqrtValue = sqrt(sqrtParam);\n\n    if (trace > 0.0) {\n        s = 0.5 / sqrtValue;\n\n        return vec4(\n            (matrix[1][2] - matrix[2][1]) * s,\n            (matrix[2][0] - matrix[0][2]) * s,\n            (matrix[0][1] - matrix[1][0]) * s,\n            0.25 / s\n        );\n    } else if (matrix[0][0] > matrix[1][1] && matrix[0][0] > matrix[2][2]) {\n        s = 2.0 * sqrtValue;\n\n        return vec4(\n            0.25 * s,\n            (matrix[0][1] + matrix[1][0]) / s,\n            (matrix[2][0] + matrix[0][2]) / s,\n            (matrix[1][2] - matrix[2][1]) / s\n        );\n    } else if (matrix[1][1] > matrix[2][2]) {\n        s = 2.0 * sqrtValue;\n        \n        return vec4(\n            (matrix[0][1] + matrix[1][0]) / s,\n            0.25 * s,\n            (matrix[1][2] + matrix[2][1]) / s,\n            (matrix[2][0] - matrix[0][2]) / s\n        );\n    } else {\n        s = 2.0 * sqrtValue;\n\n        return vec4(\n            (matrix[2][0] + matrix[0][2]) / s,\n            (matrix[1][2] + matrix[2][1]) / s,\n            0.25 * s,\n            (matrix[0][1] - matrix[1][0]) / s\n        );\n    }\n}\n\nmat3 quaternionToRotationMatrix(vec4 q) {\n    float xx = q.x * q.x;\n    float yy = q.y * q.y;\n    float zz = q.z * q.z;\n    float xy = q.x * q.y;\n    float zw = q.z * q.w;\n    float zx = q.z * q.x;\n    float yw = q.y * q.w;\n    float yz = q.y * q.z;\n    float xw = q.x * q.w;\n\n    return mat3(\n        1.0 - 2.0 * (yy + zz), 2.0 * (xy + zw), 2.0 * (zx - yw),\n        2.0 * (xy - zw), 1.0 - 2.0 * (zz + xx), 2.0 * (yz + xw),\n        2.0 * (zx + yw), 2.0 * (yz - xw), 1.0 - 2.0 * (yy + xx)\n    );\n}\n\nvec4 slerp(vec4 q0, vec4 q1, float t) {\n    float cosTheta = dot(q0, q1);\n\n    // if (cosTheta < 0.0) {\n    //     q1 = -q1;\n    //     cosTheta = -cosTheta;\n    // }\n    q1 = mix(-q1, q1, step(0.0, cosTheta));\n    cosTheta = abs(cosTheta);\n    \n    if (cosTheta > 0.999999) {\n        return normalize(mix(q0, q1, t));\n    }\n\n    float theta = acos(cosTheta);\n    float sinTheta = sin(theta);\n\n    float w0 = sin((1.0 - t) * theta) / sinTheta;\n    float w1 = sin(t * theta) / sinTheta;\n\n    return q0 * w0 + q1 * w1;\n}\n#endif\n\n#endif\n",b="\n#ifndef SDEFVERTEX\n#define SDEFVERTEX\n\n#if !defined(BAKED_VERTEX_ANIMATION_TEXTURE) && defined(SDEF)\n\n#if NUM_BONE_INFLUENCERS > 0\n{\n    float weight0 = matricesWeights[0];\n    float weight1 = matricesWeights[1];\n\n    #ifdef BONETEXTURE\n        mat4 transformMatrix0 = readMatrixFromRawSampler(boneSampler, matricesIndices[0]);\n        mat4 transformMatrix1 = readMatrixFromRawSampler(boneSampler, matricesIndices[1]);\n    #else\n        mat4 transformMatrix0 = mBones[int(matricesIndices[0])];\n        mat4 transformMatrix1 = mBones[int(matricesIndices[1])];\n    #endif\n\n    mat3 slerpedRotationMatrix = quaternionToRotationMatrix(slerp(\n        rotationMatrixToQuaternion(mat3(transformMatrix0)), \n        rotationMatrixToQuaternion(mat3(transformMatrix1)),\n        weight1\n    ));\n\n    // -center transform\n    mat4 sdefInflunce = mat4(\n        vec4(1.0, 0.0, 0.0, 0.0),\n        vec4(0.0, 1.0, 0.0, 0.0),\n        vec4(0.0, 0.0, 1.0, 0.0),\n        vec4(-matricesSdefC, 1.0)\n    );\n\n    // rotation\n    mat4 rotationMatrix = mat4(\n        vec4(slerpedRotationMatrix[0], 0.0),\n        vec4(slerpedRotationMatrix[1], 0.0),\n        vec4(slerpedRotationMatrix[2], 0.0),\n        vec4(0.0, 0.0, 0.0, 1.0)\n    );\n    sdefInflunce = rotationMatrix * sdefInflunce;\n\n    // add position offset\n    vec3 positionOffset =\n        vec3(transformMatrix0 * vec4(matricesSdefR0, 1)) * weight0 +\n        vec3(transformMatrix1 * vec4(matricesSdefR1, 1)) * weight1;\n\n    sdefInflunce[3] += vec4(positionOffset, 0.0);\n    \n    float useLinearDeform = step(0.0, -abs(matricesSdefR0.x));\n\n    influence = mat4(\n        mix(sdefInflunce[0], influence[0], useLinearDeform),\n        mix(sdefInflunce[1], influence[1], useLinearDeform),\n        mix(sdefInflunce[2], influence[2], useLinearDeform),\n        mix(sdefInflunce[3], influence[3], useLinearDeform)\n    );\n}\n#endif\n\n#endif\n\n#endif\n";class w{static OverrideEngineCreateEffect(e){const t=e.createEffect.bind(e);e.createEffect=function(e,n,r,i,s,a,l,d,h,c=o.xeF.GLSL){let u;if(u=n.attributes?n:{attributes:n,uniformsNames:r,uniformBuffersNames:[],samplers:i??[],defines:s??"",fallbacks:a??null,onCompiled:l??null,onError:d??null,indexParameters:h??null,shaderLanguage:c},(u.shaderLanguage===o.xeF.GLSL||void 0===u.shaderLanguage)&&(u.uniformsNames.includes("mBones")||u.samplers.includes("boneSampler"))&&-1===u.defines.indexOf("#define SDEF")){u.attributes.push(I.MatricesSdefCKind),u.attributes.push(I.MatricesSdefR0Kind),u.attributes.push(I.MatricesSdefR1Kind),u.defines+="\n#define SDEF";const e=u.processCodeAfterIncludes;u.processCodeAfterIncludes=e?function(t,n){return n=e(t,n),w.ProcessSdefCode(t,n)}:w.ProcessSdefCode}return t(e,u,this)}}static ProcessSdefCode(e,t){if("vertex"!==e)return t;const n="#define CUSTOM_VERTEX_DEFINITIONS";t=t.replace(n,`${n}\n${M}`);const o=new RegExp("finalWorld=finalWorld\\*influence;","g");return t.replace(o,`${b}\nfinalWorld=finalWorld*influence;`)}}class R{static _StencilReference=4;name=o.lWj.NAME_OUTLINERENDERER;scene;zOffset=-8;zOffsetUnits=4;_engine;_savedDepthWrite;_passIdForDrawWrapper;constructor(e){this.scene=e,this._engine=e.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=[];for(let e=0;e<3;++e)this._passIdForDrawWrapper[e]=this._engine.createRenderPassId(`Mmd Outline Renderer (${e})`);this._savedDepthWrite=!1}register(){this.scene._beforeRenderingMeshStage.registerStep(o.lWj.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(o.lWj.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){for(let e=0;e<this._passIdForDrawWrapper.length;++e)this._engine.releaseRenderPassId(this._passIdForDrawWrapper[e])}render(e,t,n,r){r=r??this._passIdForDrawWrapper[0];const i=this.scene,s=i.getEngine(),a=s.getCaps().instancedArrays&&(null!==t.visibleInstances[e._id]&&void 0!==t.visibleInstances[e._id]||e.getRenderingMesh().hasThinInstances);if(!this.isReady(e,a,r))return;const l=e.getMesh(),d=l._internalAbstractMeshDataInfo._actAsRegularMesh?l:null,h=e.getRenderingMesh(),c=d||h,u=e.getMaterial();if(!u||!i.activeCamera)return;const f=e._getDrawWrapper(r),g=o.qXw.GetEffect(f);if(s.enableEffect(f),u.useLogarithmicDepth&&g.setFloat("logarithmicDepthConstant",2/(Math.log(i.activeCamera.maxZ+1)/Math.LN2)),g.setFloat("offset",n??u.outlineWidth),g.setColor4("color",u.outlineColor,u.outlineAlpha),g.setMatrix("viewProjection",i.getTransformMatrix()),g.setMatrix("world",c.getWorldMatrix()),o.G$p.BindBonesParameters(c,g),h.morphTargetManager&&h.morphTargetManager.isUsingTextureForTargets&&h.morphTargetManager._bind(g),o.G$p.BindMorphTargetParameters(h,g),a||h._bind(e,g,u.fillMode),u&&u.needAlphaTesting()){const e=u.getAlphaTestTexture();e&&(g.setTexture("diffuseSampler",e),g.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,o.anm)(g,u,i),s.setZOffset(-this.zOffset),s.setZOffsetUnits(-this.zOffsetUnits),h._processRendering(c,e,g,u.fillMode,t,a,((e,t)=>{g.setMatrix("world",t)})),s.setZOffset(0),s.setZOffsetUnits(0)}isReady(e,t,n){n=n??this._passIdForDrawWrapper[0];const r=[],i=[o.oZy.PositionKind,o.oZy.NormalKind],s=e.getMesh(),a=e.getMaterial();if(!a)return!1;const l=s.getScene();a.needAlphaTesting()&&(r.push("#define ALPHATEST"),s.isVerticesDataPresent(o.oZy.UVKind)&&(i.push(o.oZy.UVKind),r.push("#define UV1")),s.isVerticesDataPresent(o.oZy.UV2Kind)&&(i.push(o.oZy.UV2Kind),r.push("#define UV2"))),a.useLogarithmicDepth&&r.push("#define LOGARITHMICDEPTH"),(0,o.lKO)(a,l,r);const d=new o.LUf;if(s.useBones&&s.computeBonesUsingShaders&&s.skeleton){i.push(o.oZy.MatricesIndicesKind),i.push(o.oZy.MatricesWeightsKind),s.numBoneInfluencers>4&&(i.push(o.oZy.MatricesIndicesExtraKind),i.push(o.oZy.MatricesWeightsExtraKind)),s.isVerticesDataPresent(I.MatricesSdefCKind)&&(i.push(I.MatricesSdefCKind),i.push(I.MatricesSdefR0Kind),i.push(I.MatricesSdefR1Kind),r.push("#define SDEF"));const e=s.skeleton;r.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),s.numBoneInfluencers>0&&d.addCPUSkinningFallback(0,s),e.isUsingTextureForMatrices?r.push("#define BONETEXTURE"):r.push("#define BonesPerMesh "+(e.bones.length+1))}else r.push("#define NUM_BONE_INFLUENCERS 0");const h=s.morphTargetManager;let c=0;h&&h.numInfluencers>0&&(c=h.numInfluencers,r.push("#define MORPHTARGETS"),r.push("#define NUM_MORPH_INFLUENCERS "+c),h.isUsingTextureForTargets&&r.push("#define MORPHTARGETS_TEXTURE"),o.G$p.PrepareAttributesForMorphTargetsInfluencers(i,s,c)),t&&(r.push("#define INSTANCES"),o.G$p.PushAttributesForInstances(i),e.getRenderingMesh().hasThinInstances&&r.push("#define THIN_INSTANCES"));const u=e._getDrawWrapper(n,!0),f=u.defines,g=r.join("\n");if(f!==g){const e=["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],t=["diffuseSampler","boneSampler","morphTargets"];(0,o.qx3)(e),u.setEffect(this.scene.getEngine().createEffect("outline",{attributes:i,uniformsNames:e,samplers:t,defines:g,indexParameters:{maxSimultaneousMorphTargets:c},processCodeAfterIncludes:w.ProcessSdefCode},this.scene.getEngine()),g)}return u.effect.isReady()}_beforeRenderingMesh(e,t,n){this._savedDepthWrite=this._engine.getDepthWrite();const r=t.getMaterial();if(r&&r.renderOutline){r.needAlphaBlendingForMesh(e)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(o.gTE.REPLACE),this._engine.setStencilFunction(o.gTE.ALWAYS),this._engine.setStencilMask(R._StencilReference),this._engine.setStencilFunctionReference(R._StencilReference),this._engine.stencilStateComposer.useStencilGlobalOnly=!0,this.render(t,n,0,this._passIdForDrawWrapper[1]),this._engine.setColorWrite(!0),this._engine.setStencilFunction(o.gTE.NOTEQUAL)),this._engine.setDepthWrite(!1);const i=this._engine.getAlphaMode(),s=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(o.gTE.ALPHA_COMBINE),this.render(t,n,void 0,this._passIdForDrawWrapper[0]),this._engine.setAlphaMode(i),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.alphaBlend=s,r.needAlphaBlendingForMesh(e)&&(this._engine.stencilStateComposer.useStencilGlobalOnly=!1,this._engine.restoreStencilState())}}_afterRenderingMesh(e,t,n){const o=t.getMaterial();null!==o&&o.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(t,n,void 0,this._passIdForDrawWrapper[2]),this._engine.setColorWrite(!0))}static RegisterMmdOutlineRendererIfNeeded(){o.xsS.prototype.getMmdOutlineRenderer||(o.xsS.prototype.getMmdOutlineRenderer=function(){return this._mmdOutlineRenderer||(this._mmdOutlineRenderer=new R(this)),this._mmdOutlineRenderer})}}class S extends o.Hgv{SPHERE_TEXTURE=!1;SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=!1;SPHERE_TEXTURE_BLEND_MODE_ADD=!1;TOON_TEXTURE=!1;IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=!1;TEXTURE_COLOR=!1;SPHERE_TEXTURE_COLOR=!1;TOON_TEXTURE_COLOR=!1;SDEF=!1}var C;!function(e){e[e.Multiply=1]="Multiply",e[e.Add=2]="Add"}(C||(C={}));class v extends o.neh{_sphereTexture=null;_sphereTextureBlendMode=C.Add;_toonTexture=null;_ignoreDiffuseWhenToonTextureIsNull=!1;textureColor=new o.HEv(1,1,1,1);sphereTextureColor=new o.HEv(1,1,1,1);toonTextureColor=new o.HEv(1,1,1,1);_useTextureColor=!1;_useSphereTextureColor=!1;_useToonTextureColor=!1;_isEnabled=!1;get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this.markAllDefinesAsDirty(),this._enable(e))}get sphereTexture(){return this._sphereTexture}set sphereTexture(e){this._sphereTexture!==e&&(this._sphereTexture=e,this.markAllSubMeshesAsTexturesDirty())}get sphereTextureBlendMode(){return this._sphereTextureBlendMode}set sphereTextureBlendMode(e){this._sphereTextureBlendMode!==e&&(this._sphereTextureBlendMode=e,this.markAllDefinesAsDirty())}get toonTexture(){return this._toonTexture}set toonTexture(e){this._toonTexture!==e&&(this._toonTexture=e,this.markAllSubMeshesAsTexturesDirty())}get ignoreDiffuseWhenToonTextureIsNull(){return this._ignoreDiffuseWhenToonTextureIsNull}set ignoreDiffuseWhenToonTextureIsNull(e){this._ignoreDiffuseWhenToonTextureIsNull!==e&&(this._ignoreDiffuseWhenToonTextureIsNull=e,this.markAllDefinesAsDirty())}get useTextureColor(){return this._useTextureColor}set useTextureColor(e){this._useTextureColor!==e&&(this._useTextureColor=e,this.markAllDefinesAsDirty())}get useSphereTextureColor(){return this._useSphereTextureColor}set useSphereTextureColor(e){this._useSphereTextureColor!==e&&(this._useSphereTextureColor=e,this.markAllDefinesAsDirty())}get useToonTextureColor(){return this._useToonTextureColor}set useToonTextureColor(e){this._useToonTextureColor!==e&&(this._useToonTextureColor=e,this.markAllDefinesAsDirty())}_internalMarkAllSubMeshesAsTexturesDirty;markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"MmdMaterial",100,new S,t),this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[o.gTE.MATERIAL_TextureDirtyFlag]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&this._sphereTexture&&!this._sphereTexture.isReadyOrNotBlocking())}bindForSubMesh(e,t,n,o){if(!this._isEnabled)return;const r=o.materialDefines,i=this._material.isFrozen;e.useUbo&&i&&e.isSync||(r.DIFFUSE&&r.TEXTURE_COLOR&&e.updateDirectColor4("textureColor",this.textureColor),r.NORMAL&&r.SPHERE_TEXTURE&&r.SPHERE_TEXTURE_COLOR&&e.updateDirectColor4("sphereTextureColor",this.sphereTextureColor),r.TOON_TEXTURE&&r.TOON_TEXTURE_COLOR&&e.updateDirectColor4("toonTextureColor",this.toonTextureColor),r.SPHERE_TEXTURE&&null!==o.effect&&this._material.bindView(o.effect)),t.texturesEnabled&&(r.NORMAL&&this._sphereTexture&&e.setTexture("sphereSampler",this._sphereTexture),this._toonTexture&&e.setTexture("toonSampler",this._toonTexture))}dispose(e){e&&(this._sphereTexture?.dispose(),this._toonTexture?.dispose())}getCustomCode(e){if("vertex"===e){const e={};return e.CUSTOM_VERTEX_DEFINITIONS=M,e[`!${this._escapeRegExp("finalWorld=finalWorld*influence;")}`]=`\n                ${b}\n                \n                finalWorld = finalWorld * influence;\n            `,e}if("fragment"===e){const e={CUSTOM_FRAGMENT_DEFINITIONS:"\n                #if defined(SPHERE_TEXTURE) && defined(NORMAL)\n                    uniform sampler2D sphereSampler;\n                #endif\n                #ifdef TOON_TEXTURE\n                    uniform sampler2D toonSampler;\n                #endif\n            ",CUSTOM_FRAGMENT_MAIN_BEGIN:"\n                #ifdef TOON_TEXTURE\n                    vec3 clampedInfoDiffuse;\n                    float infoToonDiffuseR;\n                    float infoToonDiffuseG;\n                    float infoToonDiffuseB;\n\n                    vec3 infoToonDiffuse;\n                #endif\n            "};return e[`!${this._escapeRegExp("#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif")}`]="\n                #if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\n                    uniform mat4 view;\n                #elif defined(NORMAL) && defined(SPHERE_TEXTURE)\n                    uniform mat4 view;\n                #endif\n            ",e[`!${this._escapeRegExp("baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);")}`]="\n                #if defined(DIFFUSE) && defined(TEXTURE_COLOR)\n                    baseColor = texture2D(diffuseSampler, vDiffuseUV + uvOffset) * textureColor;\n                #else\n                    baseColor = texture2D(diffuseSampler, vDiffuseUV + uvOffset);\n                #endif\n            ",e[`!${this._escapeRegExp("diffuseBase+=info.diffuse*shadow;")}`]="\n                #ifdef TOON_TEXTURE\n                    clampedInfoDiffuse = clamp(info.diffuse, 0.0, 1.0);\n\n                    #ifdef TOON_TEXTURE_COLOR\n                        infoToonDiffuseR = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.r)).r * toonTextureColor.r * toonTextureColor.a;\n                        infoToonDiffuseG = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.g)).g * toonTextureColor.g * toonTextureColor.a;\n                        infoToonDiffuseB = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.b)).b * toonTextureColor.b * toonTextureColor.a;\n                    #else\n                        infoToonDiffuseR = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.r)).r;\n                        infoToonDiffuseG = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.g)).g;\n                        infoToonDiffuseB = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.b)).b;\n                    #endif\n                    \n                    infoToonDiffuse = vec3(infoToonDiffuseR, infoToonDiffuseG, infoToonDiffuseB);\n\n                    diffuseBase += infoToonDiffuse * shadow;\n                #elif defined(IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED)\n                    diffuseBase += vec3(1.0, 1.0, 1.0) * shadow;\n                #else\n                    diffuseBase += info.diffuse * shadow;\n                #endif\n            ",e.CUSTOM_FRAGMENT_BEFORE_FOG="\n                #if defined(NORMAL) && defined(SPHERE_TEXTURE)\n                    vec3 viewSpaceNormal = normalize(mat3(view) * vNormalW);\n\n                    vec2 sphereUV = viewSpaceNormal.xy * 0.5 + 0.5;\n\n                    vec4 sphereReflectionColor = texture2D(sphereSampler, sphereUV);\n\n                    #ifdef SPHERE_TEXTURE_COLOR\n                        sphereReflectionColor *= sphereTextureColor;\n                    #endif\n\n                    #ifdef SPHERE_TEXTURE_BLEND_MODE_MULTIPLY\n                        color *= sphereReflectionColor;\n                    #elif defined(SPHERE_TEXTURE_BLEND_MODE_ADD)\n                        color += vec4(sphereReflectionColor.rgb, sphereReflectionColor.a * alpha);\n                    #endif\n                #endif\n            ",e}return null}prepareDefines(e,t,n){if(this._isEnabled){const o=t.texturesEnabled;e.SPHERE_TEXTURE=null!==this._sphereTexture&&o,e.SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=this._sphereTextureBlendMode===C.Multiply,e.SPHERE_TEXTURE_BLEND_MODE_ADD=this._sphereTextureBlendMode===C.Add,e.TOON_TEXTURE=null!==this._toonTexture&&o,e.IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=this._ignoreDiffuseWhenToonTextureIsNull,e.TEXTURE_COLOR=this._useTextureColor,e.SPHERE_TEXTURE_COLOR=this._useSphereTextureColor,e.TOON_TEXTURE_COLOR=this._useToonTextureColor,e.SDEF=!!(n.useBones&&n.computeBonesUsingShaders&&n.skeleton)}else e.SPHERE_TEXTURE=!1,e.SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=!1,e.SPHERE_TEXTURE_BLEND_MODE_ADD=!1,e.TOON_TEXTURE=!1,e.IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=!1,e.TEXTURE_COLOR=!1,e.SPHERE_TEXTURE_COLOR=!1,e.TOON_TEXTURE_COLOR=!1,e.SDEF=!1}hasTexture(e){return this._sphereTexture===e||this._toonTexture===e}getActiveTextures(e){this._sphereTexture&&e.push(this._sphereTexture),this._toonTexture&&e.push(this._toonTexture)}getAnimatables(e){this._sphereTexture&&this._sphereTexture.animations&&0<this._sphereTexture.animations.length&&e.push(this._sphereTexture),this._toonTexture&&this._toonTexture.animations&&0<this._toonTexture.animations.length&&e.push(this._toonTexture)}getSamplers(e){e.push("sphereSampler","toonSampler")}getAttributes(e,t,n){this._isEnabled&&n.useBones&&n.computeBonesUsingShaders&&n.skeleton&&n.isVerticesDataPresent(I.MatricesSdefCKind)&&(e.push(I.MatricesSdefCKind),e.push(I.MatricesSdefR0Kind),e.push(I.MatricesSdefR1Kind))}getUniforms(){return{ubo:[{name:"textureColor",size:4,type:"vec4"},{name:"sphereTextureColor",size:4,type:"vec4"},{name:"toonTextureColor",size:4,type:"vec4"}],fragment:"\n                #if defined(DIFFUSE) && defined(TEXTURE_COLOR)\n                    uniform vec4 textureColor;\n                #endif\n                #if defined(SPHERE_TEXTURE) && defined(SPHERE_TEXTURE_COLOR)\n                    uniform vec4 sphereTextureColor;\n                #endif\n                #if defined(TOON_TEXTURE) && defined(TOON_TEXTURE_COLOR)\n                    uniform vec4 toonTextureColor;\n                #endif\n            "}}getClassName(){return"MmdPluginMaterial"}_escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}}class B extends o.KuD{_pluginMaterial;_renderOutline=!1;outlineWidth=.01;outlineColor=new o.Wot(0,0,0);outlineAlpha=1;constructor(e,t){super(e,t),this.specularColor=new o.Wot(0,0,0);const n=this._pluginMaterial=new v(this);n.isEnabled=!0,n.ignoreDiffuseWhenToonTextureIsNull=!0}get sphereTexture(){return this._pluginMaterial.sphereTexture}set sphereTexture(e){this._pluginMaterial.sphereTexture=e}get sphereTextureBlendMode(){return this._pluginMaterial.sphereTextureBlendMode}set sphereTextureBlendMode(e){this._pluginMaterial.sphereTextureBlendMode=e}get toonTexture(){return this._pluginMaterial.toonTexture}set toonTexture(e){this._pluginMaterial.toonTexture=e}get ignoreDiffuseWhenToonTextureIsNull(){return this._pluginMaterial.ignoreDiffuseWhenToonTextureIsNull}set ignoreDiffuseWhenToonTextureIsNull(e){this._pluginMaterial.ignoreDiffuseWhenToonTextureIsNull=e}get textureColor(){return this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureColor}set textureColor(e){this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureColor=e}get sphereTextureColor(){return this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureColor}set sphereTextureColor(e){this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureColor=e}get toonTextureColor(){return this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureColor}set toonTextureColor(e){this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureColor=e}get renderOutline(){return this._renderOutline}set renderOutline(e){e&&this.getScene().getMmdOutlineRenderer(),this._renderOutline=e}}class F{static EdgeSizeScaleFactor=.01;alphaThreshold=195;alphaBlendThreshold=100;useAlphaEvaluation=!0;alphaEvaluationResolution=512;_textureLoader=new f;buildMaterials(e,t,n,o,r,i,s,a,l,d,h,c){const u=i.blockMaterialDirtyMechanism;i.blockMaterialDirtyMechanism=!0;const f=this.useAlphaEvaluation?new A(l,a,this.alphaEvaluationResolution):null,g=0===r.length||r[0]instanceof File?new _(r):new _(r,o),p=[],m={lengthComputable:!0,loaded:0,total:3*t.length},x=()=>{m.loaded+=1,h?.(m)};let T=0;for(let r=0;r<t.length;++r){const a=t[r];i._blockEntityCollection=!!s;const l=new B(a.name,i);l._parentContainer=s,i._blockEntityCollection=!1,s?.materials.push(l);{const t=[],h=this.loadGeneralScalarProperties(l,a);void 0!==h&&t.push(h);const c=this.loadDiffuseTexture(e,l,a,n,i,s,o,g,T,f,x);void 0!==c&&t.push(c);const u=this.loadSphereTexture(e,l,a,n,i,s,o,g,x);void 0!==u&&t.push(u);const m=this.loadToonTexture(e,l,a,n,i,s,o,g,x);void 0!==m&&t.push(m);const _=this.loadOutlineRenderingProperties(l,a);void 0!==_&&t.push(_),p.push(...t),Promise.all(t).then((()=>{this.afterBuildSingleMaterial(l,r,a,d,n,i,o)}))}d.subMaterials.push(l),T+=a.surfaceCount}this._textureLoader.loadModelTexturesEnd(e);const y=this._textureLoader.onModelTextureLoadedObservable.get(e);void 0!==y?y.addOnce((()=>{Promise.all(p).then((()=>{f?.dispose(),i.blockMaterialDirtyMechanism=u,c?.()}))})):Promise.all(p).then((()=>{f?.dispose(),i.blockMaterialDirtyMechanism=u,c?.()}))}loadGeneralScalarProperties=(e,t)=>{const n=t.diffuse;e.diffuseColor=new o.Wot(n[0],n[1],n[2]);const r=t.specular;e.specularColor=new o.Wot(r[0],r[1],r[2]);const i=t.ambient;e.ambientColor=new o.Wot(i[0],i[1],i[2]);const s=t.diffuse[3];e.alpha=s,e.specularPower=t.shininess};loadDiffuseTexture=async(e,t,n,r,s,a,l,d,h,c,u)=>{t.backFaceCulling=!(n.flag&i.Material.Flag.IsDoubleSided);const f=r[n.textureIndex];if(void 0!==f){const r=l+f;let i;const g=d.resolve(r);i=void 0!==g?await this._textureLoader.loadTextureFromBufferAsync(e,r,g instanceof File?g:g.data,s,a):await this._textureLoader.loadTextureAsync(e,l,f,s,a);const p=i.texture;if(null!==p){t.diffuseTexture=p;let e=Number.MAX_SAFE_INTEGER;const r=n.evauatedTransparency;if(void 0!==r&&-1!==r?e=r:null!==c&&(e=await c.textureHasAlphaOnGeometry(i.arrayBuffer,h,n.surfaceCount,this.alphaThreshold,this.alphaBlendThreshold)),e!==Number.MAX_SAFE_INTEGER){const n=e!==o.F5T.MATERIAL_OPAQUE;n&&(p.hasAlpha=!0),t.useAlphaFromDiffuseTexture=n,t.transparencyMode=e,n&&(t.backFaceCulling=!1)}u?.()}else u?.()}else u?.()};loadSphereTexture=async(e,t,n,o,r,s,a,l,d)=>{if(n.sphereTextureMode!==i.Material.SphereTextureMode.Off){const i=o[n.sphereTextureIndex];if(void 0!==i){const o=a+i;let h;const c=l.resolve(o);h=void 0!==c?(await this._textureLoader.loadTextureFromBufferAsync(e,o,c instanceof File?c:c.data,r,s)).texture:(await this._textureLoader.loadTextureAsync(e,a,i,r,s)).texture,null!==h&&(t.sphereTexture=h,t.sphereTextureBlendMode=1===n.sphereTextureMode?C.Multiply:C.Add),d?.()}else d?.()}else d?.()};loadToonTexture=async(e,t,n,o,r,i,s,a,l)=>{let d;if(d=n.isSharedToonTexture?-1===n.toonTextureIndex?void 0:n.toonTextureIndex:o[n.toonTextureIndex],void 0!==d){const n=s+d;let o;const h="string"==typeof d?a.resolve(n):void 0;o=void 0!==h?(await this._textureLoader.loadTextureFromBufferAsync(e,n,h instanceof File?h:h.data,r,i)).texture:(await this._textureLoader.loadTextureAsync(e,s,d,r,i)).texture,null!==o&&(t.toonTexture=o),l?.()}else l?.()};loadOutlineRenderingProperties=(e,t)=>{if(t.flag&i.Material.Flag.EnabledToonEdge){R.RegisterMmdOutlineRendererIfNeeded(),e.renderOutline=!0,e.outlineWidth=t.edgeSize*F.EdgeSizeScaleFactor;const n=t.edgeColor;e.outlineColor=new o.Wot(n[0],n[1],n[2]),e.outlineAlpha=n[3]}};afterBuildSingleMaterial=()=>{}}class U extends o.Kj0{applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId===this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(o.oZy.PositionKind))return this;if(!this.isVerticesDataPresent(o.oZy.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(o.oZy.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(o.oZy.NormalKind),n=this._internalMeshDataInfo;if(!n._sourcePositions){const e=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=e}t&&!n._sourceNormals&&this.setNormalsForCPUSkinning();let r=this.getVerticesData(o.oZy.PositionKind);if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r));let i=this.getVerticesData(o.oZy.NormalKind);if(t){if(!i)return this;i instanceof Float32Array||(i=new Float32Array(i))}const s=this.isVerticesDataPresent(I.MatricesSdefCKind);let a=null,l=null,d=null;s&&(a=this.getVerticesData(I.MatricesSdefCKind),l=this.getVerticesData(I.MatricesSdefR0Kind),d=this.getVerticesData(I.MatricesSdefR1Kind));const h=this.getVerticesData(o.oZy.MatricesIndicesKind),c=this.getVerticesData(o.oZy.MatricesWeightsKind);if(!c||!h)return this;const u=this.numBoneInfluencers>4,f=u?this.getVerticesData(o.oZy.MatricesIndicesExtraKind):null,g=u?this.getVerticesData(o.oZy.MatricesWeightsExtraKind):null,p=e.getTransformMatrices(this),m=o.Pa4.Zero(),x=new o.y3G,_=new o.y3G,T=new o.y3G,A=new o.y3G,y=new o._fP,E=new o._fP,M=new o.Pa4,b=n._sourcePositions,w=n._sourceNormals;let R,S=0;for(let e=0;e<r.length;e+=3,S+=4){let n=0;if(s&&(n=l[e]),0===n){let n;for(R=0;R<4;R++)n=c[S+R],n>0&&(o.y3G.FromFloat32ArrayToRefScaled(p,Math.floor(16*h[S+R]),n,_),x.addToSelf(_));if(u)for(R=0;R<4;R++)n=g[S+R],n>0&&(o.y3G.FromFloat32ArrayToRefScaled(p,Math.floor(16*f[S+R]),n,_),x.addToSelf(_));o.Pa4.TransformCoordinatesFromFloatsToRef(b[e],b[e+1],b[e+2],x,m),m.toArray(r,e),t&&(o.Pa4.TransformNormalFromFloatsToRef(w[e],w[e+1],w[e+2],x,m),m.toArray(i,e)),x.reset()}else{const n=c[S+0],s=c[S+1];o.y3G.FromArrayToRef(p,Math.floor(16*h[S+0]),T),o.y3G.FromArrayToRef(p,Math.floor(16*h[S+1]),A),o._fP.FromRotationMatrixToRef(T,y),o._fP.FromRotationMatrixToRef(A,E),o.y3G.FromQuaternionToRef(o._fP.SlerpToRef(y,E,s,y),_),o.Pa4.TransformCoordinatesFromFloatsToRef(b[e]-a[e],b[e+1]-a[e+1],b[e+2]-a[e+2],_,M),o.Pa4.TransformCoordinatesFromFloatsToRef(l[e],l[e+1],l[e+2],T,m).scaleAndAddToRef(n,M),o.Pa4.TransformCoordinatesFromFloatsToRef(d[e],d[e+1],d[e+2],A,m).scaleAndAddToRef(s,M),M.toArray(r,e),t&&(o.Pa4.TransformNormalFromFloatsToRef(w[e],w[e+1],w[e+2],_,M),M.toArray(i,e))}}return this.updateVerticesData(o.oZy.PositionKind,r),t&&this.updateVerticesData(o.oZy.NormalKind,i),this}}class P{name;extensions;materialBuilder;useSdef;boundingBoxMargin;referenceFiles;_loggingEnabled;log;warn;error;constructor(){this.name="pmx",this.extensions={".pmx":{isBinary:!0}},this.materialBuilder=new F,this.useSdef=!0,this.boundingBoxMargin=10,this.referenceFiles=[],this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled}importMeshAsync(e,t,n,o,r,i){return this._loadAsyncInternal(t,null,n,o,r)}loadAsync(e,t,n,o,r){return this._loadAsyncInternal(e,null,t,n,o).then((()=>{}))}loadAssetContainerAsync(e,t,n,r,i){const s=new o.TJ4(e);return this._loadAsyncInternal(e,s,t,n,r).then((()=>s))}loadFile(e,t,n,o,r,i,s){return e._loadFile(t,o,r,!0,i,s)}async _loadAsyncInternal(e,t,n,r,s){const a=this.useSdef,l=this.boundingBoxMargin,d=this.referenceFiles,h=await x.ParseAsync(n,this).catch((e=>Promise.reject(e))),c=Math.floor(n.byteLength/100),u=100*h.materials.length,f=100*h.bones.length;let g=0;{const e=h.morphs;for(let t=0;t<e.length;++t){const n=e[t];n.type!==i.Morph.Type.VertexMorph&&n.type!==i.Morph.Type.UvMorph&&n.type!==i.Morph.Type.AdditionalUvMorph1&&n.type!==i.Morph.Type.AdditionalUvMorph2&&n.type!==i.Morph.Type.AdditionalUvMorph3&&n.type!==i.Morph.Type.AdditionalUvMorph4||(g+=n.indices.length)}}const p=3e4*h.textures.length;let m=!1;const _={lengthComputable:!0,loaded:c,total:c+h.faces.length+h.vertices.length+u+f+g+p};s?.({..._});let T=c;e._blockEntityCollection=!!t;const A=new(a?U:o.Kj0)(h.header.modelName,e);A._parentContainer=t,e._blockEntityCollection=!1;const y=new o.xx8,E=a?new Float32Array(3*h.vertices.length):void 0,M=a?new Float32Array(3*h.vertices.length):void 0,b=a?new Float32Array(3*h.vertices.length):void 0;let w=!1;{const e=h.vertices,t=new Float32Array(3*e.length),n=new Float32Array(3*e.length),r=new Float32Array(2*e.length),l=new Float32Array(4*e.length),d=new Float32Array(4*e.length);let c;c=h.faces instanceof Uint8Array||h.faces instanceof Uint16Array?new Uint16Array(h.faces.length):new Uint32Array(h.faces.length);{let e=performance.now();const t=h.faces;for(let n=0;n<c.length;n+=3)c[n+0]=t[n+0],c[n+1]=t[n+2],c[n+2]=t[n+1],n%1e4==0&&100<performance.now()-e&&(_.loaded=T+n,s?.({..._}),await o.w1W.DelayAsync(0),e=performance.now());_.loaded=T+c.length,s?.({..._}),T+=c.length}{let h=performance.now();for(let c=0;c<e.length;++c){const u=e[c];switch(t[3*c+0]=u.position[0],t[3*c+1]=u.position[1],t[3*c+2]=u.position[2],n[3*c+0]=u.normal[0],n[3*c+1]=u.normal[1],n[3*c+2]=u.normal[2],r[2*c+0]=u.uv[0],r[2*c+1]=1-u.uv[1],u.weightType){case i.Vertex.BoneWeightType.Bdef1:{const e=u.boneWeight;l[4*c+0]=e.boneIndices,l[4*c+1]=0,l[4*c+2]=0,l[4*c+3]=0,d[4*c+0]=1,d[4*c+1]=0,d[4*c+2]=0,d[4*c+3]=0}break;case i.Vertex.BoneWeightType.Bdef2:{const e=u.boneWeight;l[4*c+0]=e.boneIndices[0],l[4*c+1]=e.boneIndices[1],l[4*c+2]=0,l[4*c+3]=0,d[4*c+0]=e.boneWeights,d[4*c+1]=1-e.boneWeights,d[4*c+2]=0,d[4*c+3]=0}break;case i.Vertex.BoneWeightType.Bdef4:case i.Vertex.BoneWeightType.Qdef:{const e=u.boneWeight;l[4*c+0]=e.boneIndices[0],l[4*c+1]=e.boneIndices[1],l[4*c+2]=e.boneIndices[2],l[4*c+3]=e.boneIndices[3],d[4*c+0]=e.boneWeights[0],d[4*c+1]=e.boneWeights[1],d[4*c+2]=e.boneWeights[2],d[4*c+3]=e.boneWeights[3]}break;case i.Vertex.BoneWeightType.Sdef:{const e=u.boneWeight;l[4*c+0]=e.boneIndices[0],l[4*c+1]=e.boneIndices[1],l[4*c+2]=0,l[4*c+3]=0;const t=e.boneWeights,n=t.boneWeight0,o=1-n;if(d[4*c+0]=n,d[4*c+1]=o,d[4*c+2]=0,d[4*c+3]=0,a){const e=t.c[0],r=t.c[1],i=t.c[2];let s=t.r0[0],a=t.r0[1],l=t.r0[2],d=t.r1[0],h=t.r1[1],u=t.r1[2];const f=s*n+d*o,g=a*n+h*o,p=l*n+u*o;s=e+s-f,a=r+a-g,l=i+l-p,d=e+d-f,h=r+h-g,u=i+u-p;const m=.5*(e+s),x=.5*(r+a),_=.5*(i+l),T=.5*(e+d),A=.5*(r+h),y=.5*(i+u);E[3*c+0]=e,E[3*c+1]=r,E[3*c+2]=i,M[3*c+0]=m,M[3*c+1]=x,M[3*c+2]=_,b[3*c+0]=T,b[3*c+1]=A,b[3*c+2]=y,w=!0}}}c%1e4==0&&100<performance.now()-h&&(_.loaded=T+c,s?.({..._}),await o.w1W.DelayAsync(0),h=performance.now())}_.loaded=T+e.length,s?.({..._}),T+=e.length}y.positions=t,y.normals=n,y.uvs=r,y.indices=c,y.matricesIndices=l,y.matricesWeights=d}e._blockEntityCollection=!!t;const R=new o.ZXM(h.header.modelName,e,y,!1);R._parentContainer=t,e._blockEntityCollection=!1,a&&w&&(R.setVerticesData(I.MatricesSdefCKind,E,!1,3),R.setVerticesData(I.MatricesSdefR0Kind,M,!1,3),R.setVerticesData(I.MatricesSdefR1Kind,b,!1,3)),R.applyToMesh(A),e._blockEntityCollection=!!t;const S=new o.G2s(h.header.modelName+"_multi",e);let C;S._parentContainer=t,e._blockEntityCollection=!1;const v=new Promise((n=>{C=this.materialBuilder.buildMaterials(A.uniqueId,h.materials,h.textures,r,d,e,t,y.indices,y.uvs,S,(e=>{if(!m)return;const t=e.loaded/e.total;_.loaded=T+Math.floor(p*t),s?.({..._})}),(()=>n()))}));void 0!==C&&await C,A.material=S,A.subMeshes.length=0;{const e=h.materials;let t=0;for(let n=0;n<e.length;++n){const r=e[n];new o.P4Y(n,0,h.vertices.length,t,r.surfaceCount,A),t+=r.surfaceCount}}_.loaded=T+u,s?.({..._}),T+=u,e._blockEntityCollection=!!t;const B=new o.OdW(h.header.modelName,h.header.modelName+"_skeleton",e);B._parentContainer=t,e._blockEntityCollection=!1;const F=[];{const e=h.bones,t=[],n=[];for(let r=0;r<e.length;++r){const i=e[r];let s=!1;if(0<=i.parentBoneIndex&&i.parentBoneIndex<e.length){let t=i.parentBoneIndex;for(;-1!==t;){if(t===r){s=!0,this.warn(`Bone loop detected. Ignore Parenting. Bone index: ${r}`);break}t=e[t].parentBoneIndex}r<=i.parentBoneIndex&&this.warn(`Parent bone index is greater equal than child bone index. Bone index: ${r} Parent bone index: ${i.parentBoneIndex}`)}else-1!==i.parentBoneIndex&&this.error(`Parent bone index is out of range. Bone index: ${r} Parent bone index: ${i.parentBoneIndex}`);const a=i.position,l=new o.Pa4(a[0],a[1],a[2]);if(0<=i.parentBoneIndex&&i.parentBoneIndex<t.length&&!s){const t=e[i.parentBoneIndex];l.x-=t.position[0],l.y-=t.position[1],l.z-=t.position[2]}const d=o.y3G.Identity().setTranslation(l),h=new o.N$j(i.name,B,void 0,d,void 0,void 0,r);t.push(h),n.push(s);const c={name:i.name,parentBoneIndex:i.parentBoneIndex,transformOrder:i.transformOrder,flag:i.flag,appendTransform:i.appendTransform,transformAfterPhysics:i.transformAfterPhysics,ik:i.ik};F.push(c)}for(let o=0;o<t.length;++o){const r=e[o],i=t[o];0<=r.parentBoneIndex&&r.parentBoneIndex<t.length&&!n[o]&&i.setParent(t[r.parentBoneIndex],!1)}for(let e=0;e<t.length;++e){const n=t[e];null===n.getParent()&&n._updateAbsoluteBindMatrices()}}A.skeleton=B,_.loaded=T+f,s?.({..._}),T+=f,e._blockEntityCollection=!!t;const P=new o.Oj5(e);P._parentContainer=t,e._blockEntityCollection=!1;const D=[];{const t=h.morphs,n=[];for(let r=0;r<t.length;++r){const a=t[r];switch(a.type){case i.Morph.Type.GroupMorph:case i.Morph.Type.BoneMorph:case i.Morph.Type.MaterialMorph:D.push(a);break;case i.Morph.Type.VertexMorph:case i.Morph.Type.UvMorph:case i.Morph.Type.AdditionalUvMorph1:case i.Morph.Type.AdditionalUvMorph2:case i.Morph.Type.AdditionalUvMorph3:case i.Morph.Type.AdditionalUvMorph4:D.push({name:a.name,englishName:a.englishName,category:a.category,type:a.type,index:n.length});break;default:this.warn(`Unsupported morph type: ${a.type}`)}if(a.type!==i.Morph.Type.VertexMorph&&a.type!==i.Morph.Type.UvMorph&&a.type!==i.Morph.Type.AdditionalUvMorph1&&a.type!==i.Morph.Type.AdditionalUvMorph2&&a.type!==i.Morph.Type.AdditionalUvMorph3&&a.type!==i.Morph.Type.AdditionalUvMorph4)continue;const l=new o.YX6(a.name,0,e);if(n.push(l),a.type===i.Morph.Type.VertexMorph){const e=new Float32Array(3*h.vertices.length);e.set(y.positions);const t=a.indices,n=a.positions;let r=performance.now();for(let i=0;i<t.length;++i){const a=t[i];e[3*a+0]+=n[3*i+0],e[3*a+1]+=n[3*i+1],e[3*a+2]+=n[3*i+2],i%1e4==0&&100<performance.now()-r&&(_.loaded=T+i,s?.({..._}),await o.w1W.DelayAsync(0),r=performance.now())}T+=t.length,l.setPositions(e)}else{const e=new Float32Array(2*h.vertices.length);e.set(y.uvs);const t=a.indices,n=a.offsets;let r=performance.now();for(let i=0;i<t.length;++i){const a=t[i];e[2*a+0]+=n[4*i+0],e[2*a+1]+=n[4*i+1],i%1e4==0&&100<performance.now()-r&&(_.loaded=T+i,s?.({..._}),await o.w1W.DelayAsync(0),r=performance.now())}T+=t.length,l.setPositions(y.positions),l.setUVs(e)}}P.areUpdatesFrozen=!0;for(let e=0;e<n.length;++e)P.addTarget(n[e]);P.areUpdatesFrozen=!1}if(A.morphTargetManager=P,0!==l){const e=A.subMeshes;for(let t=0;t<e.length;++t){const n=e[t],r=n.getBoundingInfo();n.setBoundingInfo(new o.jF4((new o.Pa4).setAll(-l).addInPlace(r.minimum),(new o.Pa4).setAll(l).addInPlace(r.maximum)))}const t=A.getBoundingInfo();A.setBoundingInfo(new o.jF4((new o.Pa4).setAll(-l).addInPlace(t.minimum),(new o.Pa4).setAll(l).addInPlace(t.maximum))),A._updateBoundingInfo()}return A.metadata={isMmdModel:!0,header:{modelName:h.header.modelName,englishModelName:h.header.englishModelName,comment:h.header.comment,englishComment:h.header.englishComment},bones:F,morphs:D,rigidBodies:h.rigidBodies,joints:h.joints},_.loaded=T,s?.({..._}),m=!0,await v,null!==t&&(t.meshes.push(A),t.geometries.push(R),t.multiMaterials.push(S),t.skeletons.push(B),t.morphTargetManagers.push(P)),{meshes:[A],particleSystems:[],skeletons:[B],animationGroups:[],transformNodes:[],geometries:[R],lights:[]}}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){o.YdH.Log(e)}_logDisabled(){}_warnEnabled(e){o.YdH.Warn(e)}_warnDisabled(){}_errorEnabled(e){o.YdH.Error(e)}_errorDisabled(){}}class D{_upperBoundFrameIndex(e,t){const n=t.frameNumbers;let o=0,r=n.length;for(;o<r;){const t=o+(r-o>>1);e<n[t]?r=t:o=t+1}return o}}class O extends D{animation;_boneBindIndexMap;_moveableBoneBindIndexMap;_morphController;_morphBindIndexMap;_mesh;_ikSolverBindIndexMap;constructor(e,t,n,o,r,i,s){super(),this.animation=e,this._boneBindIndexMap=t,this._moveableBoneBindIndexMap=n,this._morphController=o,this._morphBindIndexMap=r,this._mesh=i,this._ikSolverBindIndexMap=s}static _BonePositionA=new o.Pa4;static _BonePositionB=new o.Pa4;static _BoneOriginalPosition=new o.Pa4;static _BoneRotationA=new o._fP;static _BoneRotationB=new o._fP;static _BoneOriginalRotation=new o._fP;animate(e){const t=this.animation,n=this._upperBoundFrameIndex,r=t.boneTracks;if(0<r.length){const t=this._boneBindIndexMap;for(let i=0;i<r.length;++i){const s=t[i];if(null===s)continue;const a=r[i],l=Math.max(a.startFrame,Math.min(a.endFrame,e)),d=n(l,a),h=d-1,c=a.frameNumbers[d];if(void 0===c){const e=a.rotations;s.getRotationQuaternionToRef(o.TaI.LOCAL,null,O._BoneOriginalRotation),s.setRotationQuaternion(O._BoneOriginalRotation.multiply(O._BoneRotationB.set(e[4*h],e[4*h+1],e[4*h+2],e[4*h+3])),o.TaI.LOCAL)}else{const e=a.frameNumbers[h],t=(l-e)/(c-e),n=a.rotations,r=a.rotationInterpolations,i=O._BoneRotationA.set(n[4*h],n[4*h+1],n[4*h+2],n[4*h+3]),u=O._BoneRotationB.set(n[4*d],n[4*d+1],n[4*d+2],n[4*d+3]),f=N.Interpolate(r[4*d]/127,r[4*d+1]/127,r[4*d+2]/127,r[4*d+3]/127,t);o._fP.SlerpToRef(i,u,f,i),s.getRotationQuaternionToRef(o.TaI.LOCAL,null,O._BoneOriginalRotation),s.setRotationQuaternion(O._BoneOriginalRotation.multiply(i),o.TaI.LOCAL)}}}const i=t.moveableBoneTracks;if(0<i.length){const t=this._moveableBoneBindIndexMap;for(let r=0;r<i.length;++r){const s=t[r];if(null===s)continue;const a=i[r],l=Math.max(a.startFrame,Math.min(a.endFrame,e)),d=n(l,a),h=d-1,c=a.frameNumbers[d];if(void 0===c){const e=a.positions;s.getPositionToRef(o.TaI.LOCAL,null,O._BoneOriginalPosition),s.setPosition(O._BoneOriginalPosition.add(O._BonePositionB.set(e[3*h],e[3*h+1],e[3*h+2])),o.TaI.LOCAL);const t=a.rotations;s.getRotationQuaternionToRef(o.TaI.LOCAL,null,O._BoneOriginalRotation),s.setRotationQuaternion(O._BoneOriginalRotation.multiply(O._BoneRotationB.set(t[4*h],t[4*h+1],t[4*h+2],t[4*h+3])),o.TaI.LOCAL)}else{const e=a.frameNumbers[h],t=(l-e)/(c-e),n=a.positions,r=a.positionInterpolations,i=O._BonePositionA.set(n[3*h],n[3*h+1],n[3*h+2]),u=O._BonePositionB.set(n[3*d],n[3*d+1],n[3*d+2]),f=N.Interpolate(r[12*d]/127,r[12*d+1]/127,r[12*d+2]/127,r[12*d+3]/127,t),g=N.Interpolate(r[12*d+4]/127,r[12*d+5]/127,r[12*d+6]/127,r[12*d+7]/127,t),p=N.Interpolate(r[12*d+8]/127,r[12*d+9]/127,r[12*d+10]/127,r[12*d+11]/127,t);i.x+=(u.x-i.x)*f,i.y+=(u.y-i.y)*g,i.z+=(u.z-i.z)*p,s.getPositionToRef(o.TaI.LOCAL,null,O._BoneOriginalPosition),s.setPosition(O._BoneOriginalPosition.add(i),o.TaI.LOCAL);const m=a.rotations,x=a.rotationInterpolations,_=O._BoneRotationA.set(m[4*h],m[4*h+1],m[4*h+2],m[4*h+3]),T=O._BoneRotationB.set(m[4*d],m[4*d+1],m[4*d+2],m[4*d+3]),A=N.Interpolate(x[4*d]/127,x[4*d+1]/127,x[4*d+2]/127,x[4*d+3]/127,t);o._fP.SlerpToRef(_,T,A,_),s.getRotationQuaternionToRef(o.TaI.LOCAL,null,O._BoneOriginalRotation),s.setRotationQuaternion(O._BoneOriginalRotation.multiply(_),o.TaI.LOCAL)}}}const s=t.morphTracks;if(0<s.length){const t=this._morphController,o=this._morphBindIndexMap;for(let r=0;r<s.length;++r){const i=o[r];if(null===i)continue;const a=s[r],l=Math.max(a.startFrame,Math.min(a.endFrame,e)),d=n(l,a),h=d-1,c=a.frameNumbers[d];if(void 0===c){const e=Math.max(a.weights[h],1e-16);for(let n=0;n<i.length;++n)t.setMorphWeightFromIndex(i[n],e)}else{const e=a.frameNumbers[h],n=(l-e)/(c-e),o=a.weights[h],r=a.weights[d],s=Math.max(o+(r-o)*n,1e-16);for(let e=0;e<i.length;++e)t.setMorphWeightFromIndex(i[e],s)}}}if(0<t.propertyTrack.frameNumbers.length){const o=t.propertyTrack,r=n(Math.max(o.startFrame,Math.min(o.endFrame,e)),o)-1;this._mesh.visibility=o.visibles[r];const i=this._ikSolverBindIndexMap,s=o.ikStates;for(let e=0;e<i.length;++e){const t=i[e];if(null===t)continue;const n=s[e];t.enabled=0!==n[r]}}}_materialRecompileInduced=!1;induceMaterialRecompile(e){this._materialRecompileInduced||(this._materialRecompileInduced=!0,O.InduceMaterialRecompile(this._mesh.material.subMaterials,this._morphController,this._morphBindIndexMap,e))}static Create(e,t,n,o){const r=t.mesh.skeleton.bones,i=new Map;if(void 0===n)for(let e=0;e<r.length;++e)i.set(r[e].name,r[e]);else for(let e=0;e<r.length;++e)i.set(n[r[e].name]??r[e].name,r[e]);const s=[],a=e.boneTracks;for(let e=0;e<a.length;++e){const t=a[e],n=i.get(t.name);void 0===n?(o?.warn(`Binding failed: bone ${t.name} not found`),s.push(null)):s.push(n)}const l=[],d=e.moveableBoneTracks;for(let e=0;e<d.length;++e){const t=d[e],n=i.get(t.name);void 0===n?(o?.warn(`Binding failed: bone ${t.name} not found`),l.push(null)):l.push(n)}const h=t.morph,c=[],u=e.morphTracks;for(let e=0;e<u.length;++e){const t=u[e],r=n?.[t.name]??t.name,i=h.getMorphIndices(r);void 0===i?(o?.warn(`Binding failed: morph ${r} not found`),c.push(null)):c.push(i)}const f=t.sortedRuntimeBones,g=new Map;if(void 0===n)for(let e=0;e<r.length;++e)g.set(f[e].name,e);else for(let e=0;e<r.length;++e)g.set(n[f[e].name]??f[e].name,e);const p=[],m=e.propertyTrack.ikBoneNames;for(let e=0;e<m.length;++e){const t=m[e],n=g.get(t);if(void 0===n)o?.warn(`Binding failed: IK bone ${t} not found`),p.push(null);else{const e=f[n].ikSolver;null===e?(o?.warn(`Binding failed: IK solver for bone ${t} not found`),p.push(null)):p.push(e)}}return new O(e,s,l,h,c,t.mesh,p)}static InduceMaterialRecompile=(e,t,n,o)=>{let r=!1;const s=new Set;for(let o=0;o<n.length;++o){const a=n[o];if(null!==a){for(let n=0;n<a.length;++n){const o=t.morphs[a[n]];if(o.type===i.Morph.Type.MaterialMorph){const t=o.materialElements;for(let n=0;n<t.length;++n){const o=t[n];if(null!==o.textureColor){const t=o.index;if(-1===o.index)for(let t=0;t<e.length;++t)e[t].textureColor;else e[t].textureColor,s.add(t.toString())}if(null!==o.sphereTextureColor){const t=o.index;if(-1===o.index)for(let t=0;t<e.length;++t)e[t].sphereTextureColor;else e[t].sphereTextureColor,s.add(t.toString())}if(null!==o.toonTextureColor){const t=o.index;if(-1===o.index)for(let t=0;t<e.length;++t)e[t].toonTextureColor;else e[t].toonTextureColor,s.add(t.toString())}}}}r}}0<s.size&&o?.log(`Materials ${Array.from(s).join(", ")} could be recompiled for morph animation`)}}class L extends D{animation;_camera;constructor(e,t){super(),this.animation=e.cameraTrack,this._camera=t}static _CameraPositionA=new o.Pa4;static _CameraPositionB=new o.Pa4;static _CameraRotationA=new o.Pa4;static _CameraRotationB=new o.Pa4;static _DegToRad=Math.PI/180;animate(e){const t=this.animation;if(0===t.frameNumbers.length)return;const n=this._camera,o=Math.max(t.startFrame,Math.min(t.endFrame,e)),r=this._upperBoundFrameIndex(o,t),i=r-1,s=t.frameNumbers[i],a=t.frameNumbers[r];if(void 0===a||s+1===a){const e=t.positions;n.position.set(e[3*i],e[3*i+1],e[3*i+2]);const o=t.rotations;n.rotation.set(o[3*i],o[3*i+1],o[3*i+2]),n.distance=t.distances[i],n.fov=t.fovs[i]*L._DegToRad}else{const e=(o-s)/(a-s),l=t.positions,d=t.positionInterpolations,h=L._CameraPositionA.set(l[3*i],l[3*i+1],l[3*i+2]),c=L._CameraPositionB.set(l[3*r],l[3*r+1],l[3*r+2]),u=N.Interpolate(d[12*r]/127,d[12*r+1]/127,d[12*r+2]/127,d[12*r+3]/127,e),f=N.Interpolate(d[12*r+4]/127,d[12*r+5]/127,d[12*r+6]/127,d[12*r+7]/127,e),g=N.Interpolate(d[12*r+8]/127,d[12*r+9]/127,d[12*r+10]/127,d[12*r+11]/127,e);n.position.set(h.x+(c.x-h.x)*u,h.y+(c.y-h.y)*f,h.z+(c.z-h.z)*g);const p=t.rotations,m=t.rotationInterpolations,x=L._CameraRotationA.set(p[3*i],p[3*i+1],p[3*i+2]),_=L._CameraRotationB.set(p[3*r],p[3*r+1],p[3*r+2]),T=N.Interpolate(m[4*r]/127,m[4*r+1]/127,m[4*r+2]/127,m[4*r+3]/127,e),A=1-T;n.rotation.set(x.x*A+_.x*T,x.y*A+_.y*T,x.z*A+_.z*T);const y=t.distances[i],E=t.distances[r],I=N.Interpolate(t.distanceInterpolations[4*r]/127,t.distanceInterpolations[4*r+1]/127,t.distanceInterpolations[4*r+2]/127,t.distanceInterpolations[4*r+3]/127,e);n.distance=y+(E-y)*I;const M=t.fovs[i],b=t.fovs[r],w=N.Interpolate(t.fovInterpolations[4*r]/127,t.fovInterpolations[4*r+1]/127,t.fovInterpolations[4*r+2]/127,t.fovInterpolations[4*r+3]/127,e);n.fov=(M+(b-M)*w)*L._DegToRad}}static Create(e,t){return new L(e,t)}}class N{static Interpolate(e,t,n,o,r){let i=.5,s=i,a=1-s;const l=Math;let d,h,c;for(let n=0;n<15;++n){d=3*a*a*s,h=3*a*s*s,c=s*s*s;const n=d*e+h*t+c-r;if(l.abs(n)<1e-5)break;i/=2,s+=n<0?i:-i,a=1-s}return d*n+h*o+c}}class V extends o.V1s{ignoreParentScaling=!1;rotation=new o.Pa4;distance=-45;_viewMatrix=o.y3G.Zero();_tmpUpVector=o.Pa4.Zero();_tmpTargetVector=o.Pa4.Zero();_animations;_animationIndexMap;_currentAnimation;constructor(e,t=new o.Pa4(0,10,0),n,r=!0){super(e,t,n,r),this.fov=Math.PI/180*30,this._animations=[],this._animationIndexMap=new Map,this._currentAnimation=null}addAnimation(e){const t=L.Create(e,this);this._animationIndexMap.set(e.name,this._animations.length),this._animations.push(t)}removeAnimation(e){const t=this._animations[e];this._currentAnimation===t&&(this._currentAnimation=null),this._animationIndexMap.delete(t.animation.name),this._animations.splice(e,1)}setAnimation(e){if(null===e)return void(this._currentAnimation=null);const t=this._animationIndexMap.get(e);if(void 0===t)throw new Error(`Animation ${e} is not found`);this._currentAnimation=this._animations[t]}get runtimeAnimations(){return this._animations}animate(e){null!==this._currentAnimation&&this._currentAnimation.animate(e)}_storedPosition=null;_storedRotation=null;_storedDistance=0;storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this._storedDistance=this.distance,super.storeState()}_restoreStateValues(){return!!super._restoreStateValues()&&(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.distance=this._storedDistance,!0)}_initCache(){super._initCache(),this._cache.rotation=new o.Pa4(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.distance=Number.MAX_VALUE}_updateCache(e){e||super._updateCache(),this._cache.rotation.copyFrom(this.rotation),this._cache.distance=this.distance}_isSynchronizedViewMatrix(){return!!super._isSynchronizedViewMatrix()&&this._cache.rotation.equals(this.rotation)&&this._cache.distance===this.distance}static _RotationMatrix=new o.y3G;static _CameraEyePosition=new o.Pa4;static _UpVector=new o.Pa4;_getViewMatrix(){const e=this.position,t=o.y3G.RotationYawPitchRollToRef(-this.rotation.y,-this.rotation.x,-this.rotation.z,V._RotationMatrix),n=e.addToRef(o.Pa4.TransformCoordinatesFromFloatsToRef(0,0,this.distance,t,V._CameraEyePosition),V._CameraEyePosition),r=o.Pa4.TransformNormalFromFloatsToRef(0,1,0,t,V._UpVector);if(this.ignoreParentScaling){if(this.parent){const t=this.parent.getWorldMatrix();o.Pa4.TransformCoordinatesToRef(n,t,this._globalPosition),o.Pa4.TransformCoordinatesToRef(e,t,this._tmpTargetVector),o.Pa4.TransformNormalToRef(r,t,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(n),this._tmpTargetVector.copyFrom(e),this._tmpUpVector.copyFrom(r);return this.getScene().useRightHandedSystem?o.y3G.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):o.y3G.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix),this._viewMatrix}if(this.getScene().useRightHandedSystem?o.y3G.LookAtRHToRef(n,e,r,this._viewMatrix):o.y3G.LookAtLHToRef(n,e,r,this._viewMatrix),this.parent){const e=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(e,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(n);return this._viewMatrix}getClassName(){return"MmdCamera"}}async function k(e,t=""){const n=[];for(let o=0;o<e.length;o++){const r=e[o];if(r.isDirectory){const e=r.createReader(),o=await new Promise(((t,n)=>{e.readEntries(t,n)}));n.push(...await k(o,t+r.name+"/"))}else n.push(r)}return n}l();const W=document.getElementById("render-canvas");if(!(W instanceof HTMLCanvasElement))throw new Error("Invalid canvas element");const z=new o.D4V(W,!0,{preserveDrawingBuffer:!0,stencil:!0,antialias:!0,powerPreference:"high-performance",doNotHandleContextLost:!0},!0);r.Create({canvas:W,engine:z,sceneBuilder:new class{async build(e,t){w.OverrideEngineCreateEffect(t);const n=new P;n.loggingEnabled=!0,o.n0n.RegisterPlugin(n);const r=new o.xsS(t),i=new V("mmdCamera",new o.Pa4(0,10,0),r);i.maxZ=5e3;const s=new o.ezm("hemisphericLight",new o.Pa4(0,1,0),r);s.intensity=.4,s.specular=new o.Wot(0,0,0),s.groundColor=new o.Wot(1,1,1);const a=new o.Ox3("directionalLight",new o.Pa4(.5,-1,1),r);a.intensity=.8,a.autoCalcShadowZBounds=!1,a.autoUpdateExtends=!1,a.shadowMaxZ=60,a.shadowMinZ=-30,a.orthoTop=54,a.orthoBottom=-3,a.orthoLeft=-30,a.orthoRight=30,a.shadowOrthoScale=0;const l=new o.uXA(1024,a,!0,i);l.usePercentageCloserFiltering=!0,l.forceBackFacesOnly=!0,l.filteringQuality=o.uXA.QUALITY_MEDIUM,l.frustumEdgeFalloff=.1;const d=o.VO7.CreateGround("ground1",{width:100,height:100,subdivisions:2,updatable:!1},r);d.receiveShadows=!0,l.addShadowCaster(d);const h=async e=>{if(f)return;null!==u&&(l.removeShadowCaster(u),u.skeleton.dispose(),u.dispose(!1,!0),u=null),f=!0,t.displayLoadingUI();const i=e.webkitRelativePath;y.textContent=e.name;const s=n.materialBuilder;s.useAlphaEvaluation=_.useAlphaEvaluation,s.alphaEvaluationResolution=_.alphaEvaluationResolution,s.alphaThreshold=_.alphaThreshold,s.alphaBlendThreshold=_.alphaBlendThreshold,u=(await o.n0n.ImportMeshAsync(void 0,i.substring(0,i.lastIndexOf("/")+1),e,r,(n=>t.loadingUIText=`<br/><br/><br/>Loading (${e.name})... ${n.loaded}/${n.total} (${Math.floor(100*n.loaded/n.total)}%)`))).meshes[0],u.receiveShadows=!0,l.addShadowCaster(u),t.hideLoadingUI(),setTimeout((()=>f=!1),1500)};let c=null,u=null,f=!1;const g=e.parentElement;g.style.display="flex",g.style.flexDirection="row-reverse";const p=document.createElement("div");p.style.width="100%",p.style.height="100%",p.style.display="flex",p.appendChild(e),g.appendChild(p);const m=document.createElement("div");m.style.position="relative",m.style.backgroundColor="white",m.style.width="auto",m.style.height="100%",m.style.display="flex",m.style.flexDirection="column",m.style.justifyContent="center",m.style.alignItems="center",m.style.fontFamily="sans-serif",g.appendChild(m);const x=document.createElement("div");x.style.width="auto",x.style.height="100%",x.style.display="flex",x.style.flexDirection="column",x.style.justifyContent="center",x.style.alignItems="start",x.style.padding="20px",x.style.boxSizing="border-box",m.appendChild(x);const _=new E;_.loggingEnabled=!0;let T=[];const A=document.createElement("h1");A.textContent="PMX to BPMX Converter",A.style.width="500px",A.style.textAlign="center",A.style.marginTop="0",x.appendChild(A);const y=document.createElement("div");y.textContent="No PMX file selected",y.style.width="100%",y.style.height="auto",y.style.fontSize="20px",y.style.marginBottom="10px",y.style.border="1px solid black",y.style.boxSizing="border-box",y.style.padding="10px",x.appendChild(y);const I=document.createElement("div");I.style.width="500px",I.style.flexGrow="1",I.style.overflow="auto",I.style.marginBottom="10px",I.style.border="1px solid black",I.style.boxSizing="border-box",x.appendChild(I);const M=document.createElement("ul");M.style.height="auto",M.style.fontSize="16px",I.appendChild(M);const b=()=>{M.innerHTML="";for(const e of T){const t=document.createElement("li");t.style.whiteSpace="nowrap";const n=e.webkitRelativePath;t.textContent=n,e.name.endsWith(".pmx")&&(t.style.color="blue",t.style.cursor="pointer",t.style.textDecoration="underline",t.onclick=()=>{c=e,h(e)}),M.appendChild(t)}},R=document.createElement("input");R.style.width="100%",R.style.minHeight="80px",R.style.display="block",R.style.backgroundColor="black",R.style.color="white",R.style.marginBottom="10px",R.style.fontSize="20px",R.type="file",R.setAttribute("directory",""),R.setAttribute("webkitdirectory",""),R.setAttribute("allowdirs",""),R.ondragover=e=>{e.preventDefault()},R.ondrop=async e=>{e.preventDefault();const t=e.dataTransfer.items;if(!t)return;const o=[];for(let e=0;e<t.length;++e){const n=t[e].webkitGetAsEntry();n&&o.push(n)}const r=await k(o);T=await async function(e){const t=[],n=await k(e);for(let e=0;e<n.length;e++){const o=n[e],r=await new Promise(((e,t)=>{o.file(e,t)}));""===r.webkitRelativePath&&(Object.defineProperty(r,"webkitRelativePath",{writable:!0}),r.webkitRelativePath=o.fullPath),t.push(r)}return t}(r),b(),n.referenceFiles=T},R.onchange=()=>{null!==R.files&&(T=Array.from(R.files),b(),n.referenceFiles=T)},x.appendChild(R);const S=document.createElement("div");S.style.width="100%",S.style.height="auto",S.style.display="flex",S.style.flexDirection="column",S.style.justifyContent="center",S.style.alignItems="center",S.style.marginBottom="10px",S.style.border="1px solid black",S.style.padding="20px",S.style.boxSizing="border-box",x.appendChild(S);const C=document.createElement("div");C.style.width="100%",C.style.height="50px",C.style.display="flex",C.style.flexDirection="row",C.style.justifyContent="space-between",C.style.alignItems="center",C.style.marginBottom="10px",S.appendChild(C);const v=document.createElement("label");v.textContent="Use Alpha Evaluation",v.style.width="200px",v.style.textAlign="left",v.style.marginRight="10px",v.style.fontSize="20px",v.style.flexGrow="1",C.appendChild(v);const B=document.createElement("input");B.style.width="20px",B.style.height="20px",B.style.fontSize="20px",B.type="checkbox",B.checked=_.useAlphaEvaluation,C.appendChild(B),B.onchange=()=>{_.useAlphaEvaluation=B.checked};const F=document.createElement("div");F.style.width="100%",F.style.height="50px",F.style.display="flex",F.style.flexDirection="row",F.style.justifyContent="space-between",F.style.alignItems="center",F.style.marginBottom="10px",S.appendChild(F);const U=document.createElement("label");U.textContent="Alpha Evaluation Resolution",U.style.width="200px",U.style.textAlign="left",U.style.marginRight="10px",U.style.fontSize="20px",U.style.flexGrow="1",F.appendChild(U);const D=document.createElement("input");D.style.width="100px",D.style.height="40px",D.style.fontSize="20px",D.type="number",D.min="64",D.max="4096",D.value=_.alphaEvaluationResolution.toString(),F.appendChild(D),D.onchange=()=>{_.alphaEvaluationResolution=Number(D.value)};const O=document.createElement("div");O.style.width="100%",O.style.height="50px",O.style.display="flex",O.style.flexDirection="row",O.style.justifyContent="space-between",O.style.alignItems="center",O.style.marginBottom="10px",S.appendChild(O);const L=document.createElement("label");L.textContent="Alpha Threshold",L.style.width="200px",L.style.textAlign="left",L.style.marginRight="10px",L.style.fontSize="20px",L.style.flexGrow="1",O.appendChild(L);const N=document.createElement("input");N.style.width="100px",N.style.height="40px",N.style.fontSize="20px",N.type="number",N.min="0",N.max="255",N.value=_.alphaThreshold.toString(),O.appendChild(N),N.onchange=()=>{_.alphaThreshold=Number(N.value)};const W=document.createElement("div");W.style.width="100%",W.style.height="50px",W.style.display="flex",W.style.flexDirection="row",W.style.justifyContent="space-between",W.style.alignItems="center",S.appendChild(W);const z=document.createElement("label");z.textContent="Alpha Blend Threshold",z.style.width="200px",z.style.textAlign="left",z.style.marginRight="10px",z.style.fontSize="20px",z.style.flexGrow="1",W.appendChild(z);const H=document.createElement("input");H.style.width="100px",H.style.height="40px",H.style.fontSize="20px",H.type="number",H.min="-500",H.max="500",H.value=_.alphaBlendThreshold.toString(),W.appendChild(H),H.onchange=()=>{_.alphaBlendThreshold=Number(H.value)};const X=document.createElement("div");X.style.width="100%",X.style.height="auto",X.style.display="flex",X.style.flexDirection="row",X.style.justifyContent="space-between",X.style.alignItems="center",x.appendChild(X);const G=document.createElement("button");G.textContent="Reload",G.style.width="100%",G.style.height="60px",G.style.border="none",G.style.fontSize="20px",G.style.color="gray",G.style.marginRight="10px",X.appendChild(G),G.onclick=()=>{null!==c&&h(c)};const Q=document.createElement("button");return Q.textContent="Convert",Q.style.width="100%",Q.style.height="60px",Q.style.border="none",Q.style.fontSize="20px",X.appendChild(Q),Q.onclick=async()=>{if(null===c)return;if(null===u)return;f=!0,t.displayLoadingUI();const e=c.webkitRelativePath;t.loadingUIText=`<br/><br/><br/>Converting (${c.name})...`;const n=await _.convert(r,e,T),o=new Blob([n],{type:"application/octet-stream"}),i=URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download=`${c.name.substring(0,c.name.lastIndexOf("."))}.bpmx`,s.click(),URL.revokeObjectURL(i),s.remove(),t.hideLoadingUI(),setTimeout((()=>f=!1),1500)},t.resize(!0),r}}}).then((e=>e.run()))}},n={};function o(e){var r=n[e];if(void 0!==r)return r.exports;var i=n[e]={exports:{}};return t[e](i,i.exports,o),i.exports}o.m=t,e=[],o.O=(t,n,r,i)=>{if(!n){var s=1/0;for(h=0;h<e.length;h++){for(var[n,r,i]=e[h],a=!0,l=0;l<n.length;l++)(!1&i||s>=i)&&Object.keys(o.O).every((e=>o.O[e](n[l])))?n.splice(l--,1):(a=!1,i<s&&(s=i));if(a){e.splice(h--,1);var d=r();void 0!==d&&(t=d)}}return t}i=i||0;for(var h=e.length;h>0&&e[h-1][2]>i;h--)e[h]=e[h-1];e[h]=[n,r,i]},o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={179:0};o.O.j=t=>0===e[t];var t=(t,n)=>{var r,i,[s,a,l]=n,d=0;if(s.some((t=>0!==e[t]))){for(r in a)o.o(a,r)&&(o.m[r]=a[r]);if(l)var h=l(o)}for(t&&t(n);d<s.length;d++)i=s[d],o.o(e,i)&&e[i]&&e[i][0](),e[i]=0;return o.O(h)},n=self.webpackChunkbabylon_mmd=self.webpackChunkbabylon_mmd||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var r=o.O(void 0,[216],(()=>o(85)));r=o.O(r)})();