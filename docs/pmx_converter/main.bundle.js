(()=>{var e,t={110:()=>{},989:(e,t,n)=>{"use strict";var r=n(718);class o{_canvas;_engine;_scene;_onTick;constructor(e){this._canvas=e.canvas,this._engine=e.engine,this._scene=null,this._onTick=null}static async Create(e){const t=new o(e);return t._scene=await t._initialize(e.sceneBuilder),t._onTick=t._makeOnTick(),t}run(){const e=this._engine;window.addEventListener("resize",this._onResize),e.runRenderLoop(this._onTick)}dispose(){window.removeEventListener("resize",this._onResize),this._engine.dispose()}_onResize=()=>{this._engine.resize()};async _initialize(e){return await e.build(this._canvas,this._engine)}_makeOnTick(){const e=this._scene;return()=>e.render()}}var i,s,a=n(110),l=n.n(a);class d{static Data=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="]}class h{uniqueId;leftLoadCount;isRequesting;errorTextureDatas;constructor(e){this.uniqueId=e,this.leftLoadCount=0,this.isRequesting=!0,this.errorTextureDatas=[]}}class c{observable;hasLoadError;constructor(){this.observable=new r.y$z,this.hasLoadError=!1}}class u{cacheKey;_scene;_assetContainer;_onLoad;_onError;_arrayBuffer;_texture;constructor(e,t,n,r,o,i,s){this.cacheKey=e,this._scene=t,this._assetContainer=n,this._onLoad=i,this._onError=s,this._arrayBuffer=null,this._texture=null,o||t._loadFile(r,(r=>{const o=this._arrayBuffer=r;this._createTexture(t,n,e,o,i,((e,t)=>{this._arrayBuffer=null,s?.(e,t)}))}),void 0,!0,!0,((e,t)=>{s?.(e?e.status+" "+e.statusText:"",t)}))}loadFromArrayBuffer(e){this._arrayBuffer=e,this._createTexture(this._scene,this._assetContainer,this.cacheKey,this._arrayBuffer,this._onLoad,((e,t)=>{this._arrayBuffer=null,this._onError?.(e,t)}))}_createTexture(e,t,n,o,i,s){e._blockEntityCollection=!!t;const a=this._texture=new r.xEZ("data:"+n,e,void 0,void 0,void 0,i,s,o,!0);a._parentContainer=t,e._blockEntityCollection=!1,t?.textures.push(a),a.name=n}get arrayBuffer(){return this._arrayBuffer}get texture(){return this._texture}}class f{onModelTextureLoadedObservable=new Map;textureCache=new Map;_textureLoadInfoMap=new Map;_loadingModels=new Map;_errorTexturesReferenceCount=new Map;static _EmptyResult={texture:null,arrayBuffer:null};_incrementLeftLoadCount(e){let t=this._loadingModels.get(e);void 0===t&&(t=new h(e),this._loadingModels.set(e,t)),t.leftLoadCount+=1;let n=this.onModelTextureLoadedObservable.get(e);return void 0===n&&(n=new r.y$z,this.onModelTextureLoadedObservable.set(e,n)),t}_decrementLeftLoadCount(e){if(e.leftLoadCount-=1,!e.isRequesting&&0===e.leftLoadCount){this._removeErrorTexturesReferenceCount(e.uniqueId),this._loadingModels.delete(e.uniqueId);const t=this.onModelTextureLoadedObservable.get(e.uniqueId);t?.notifyObservers(),t?.clear(),this.onModelTextureLoadedObservable.delete(e.uniqueId)}}loadModelTexturesEnd(e){const t=this._loadingModels.get(e);if(void 0!==t&&(t.isRequesting=!1,0===t.leftLoadCount)){this._removeErrorTexturesReferenceCount(e),this._loadingModels.delete(e);const t=this.onModelTextureLoadedObservable.get(e);t?.notifyObservers(),t?.clear(),this.onModelTextureLoadedObservable.delete(e)}}_addErrorTextureReferenceCount(e,t){this._loadingModels.get(e).errorTextureDatas.push(t),this._errorTexturesReferenceCount.set(t,(this._errorTexturesReferenceCount.get(t)??0)+1)}_removeErrorTexturesReferenceCount(e){const t=this._loadingModels.get(e);for(let e=0;e<t.errorTextureDatas.length;++e){const n=t.errorTextureDatas[e],r=this._errorTexturesReferenceCount.get(n)-1;0===r?null!==n.texture?n.texture.dispose():(this._textureLoadInfoMap.delete(n.cacheKey),this.textureCache.delete(n.cacheKey),this._errorTexturesReferenceCount.delete(n)):this._errorTexturesReferenceCount.set(n,r)}}_handleTextureOnDispose(e){e.texture.onDisposeObservable.addOnce((()=>{this._textureLoadInfoMap.delete(e.cacheKey),this.textureCache.delete(e.cacheKey),this._errorTexturesReferenceCount.delete(e)}))}async _loadTextureAsyncInternal(e,t,n,r,o,i){const s=this._incrementLeftLoadCount(e);let a=this._textureLoadInfoMap.get(t);void 0===a&&(a=new c,this._textureLoadInfoMap.set(t,a));let l=this.textureCache.get(t);if(void 0===l&&!a.hasLoadError){const s=null!==r?d.Data[r]:t;l=new u(t,o,i,s,null!==n,(()=>{this._handleTextureOnDispose(l),a.hasLoadError=!1,a.observable.notifyObservers(!1),a.observable.clear()}),((t,n)=>{null!==l.texture&&this._handleTextureOnDispose(l),this._addErrorTextureReferenceCount(e,l),a.hasLoadError=!0,a.observable.notifyObservers(!0),a.observable.clear()})),this.textureCache.set(t,l);const h=n instanceof Blob?await n.arrayBuffer():n;null!==h&&l.loadFromArrayBuffer(h)}return null!==l.texture&&l.texture.isReady()?(this._decrementLeftLoadCount(s),a.hasLoadError?f._EmptyResult:l):new Promise((e=>{a.observable.addOnce((t=>{this._decrementLeftLoadCount(s),e(t?f._EmptyResult:l)}))}))}async loadTextureAsync(e,t,n,r,o){const i="number"==typeof n,s=i?i?"file:shared_toon_texture_"+n:n:this.pathNormalize(t+n);return await this._loadTextureAsyncInternal(e,s,null,i?n:null,r,o)}async loadTextureFromBufferAsync(e,t,n,r,o,i=!0){return i&&(t=this.pathNormalize(t)),await this._loadTextureAsyncInternal(e,t,n,null,r,o)}pathNormalize(e){const t=(e=e.replace(/\\/g,"/")).split("/"),n=[];for(let e=0;e<t.length;++e){const r=t[e];"."!==r&&(".."===r?n.pop():n.push(r))}return n.join("/")}}!function(e){let t,n,r,o,i,s,a,l,d;!function(e){let t;!function(e){e[e.Utf16le=0]="Utf16le",e[e.Utf8=1]="Utf8"}(t=e.Encoding||(e.Encoding={}))}(t=e.Header||(e.Header={})),function(e){let t;!function(e){e[e.Bdef1=0]="Bdef1",e[e.Bdef2=1]="Bdef2",e[e.Bdef4=2]="Bdef4",e[e.Sdef=3]="Sdef",e[e.Qdef=4]="Qdef"}(t=e.BoneWeightType||(e.BoneWeightType={}))}(n=e.Vertex||(e.Vertex={})),function(e){let t,n;!function(e){e[e.IsDoubleSided=1]="IsDoubleSided",e[e.EnabledGroundShadow=2]="EnabledGroundShadow",e[e.EnabledDrawShadow=4]="EnabledDrawShadow",e[e.EnabledReceiveShadow=8]="EnabledReceiveShadow",e[e.EnabledToonEdge=16]="EnabledToonEdge",e[e.EnabledVertexColor=32]="EnabledVertexColor",e[e.EnabledPointDraw=64]="EnabledPointDraw",e[e.EnabledLineDraw=128]="EnabledLineDraw"}(t=e.Flag||(e.Flag={})),function(e){e[e.Off=0]="Off",e[e.Multiply=1]="Multiply",e[e.Add=2]="Add",e[e.SubTexture=3]="SubTexture"}(n=e.SphereTextureMode||(e.SphereTextureMode={}))}(r=e.Material||(e.Material={})),function(e){let t;!function(e){e[e.UseBoneIndexAsTailPosition=1]="UseBoneIndexAsTailPosition",e[e.IsRotatable=2]="IsRotatable",e[e.IsMovable=4]="IsMovable",e[e.IsVisible=8]="IsVisible",e[e.IsControllable=16]="IsControllable",e[e.IsIkEnabled=32]="IsIkEnabled",e[e.LocalAppendTransform=128]="LocalAppendTransform",e[e.HasAppendRotate=256]="HasAppendRotate",e[e.HasAppendMove=512]="HasAppendMove",e[e.HasAxisLimit=1024]="HasAxisLimit",e[e.HasLocalVector=2048]="HasLocalVector",e[e.TransformAfterPhysics=4096]="TransformAfterPhysics",e[e.IsExternalParentTransformed=8192]="IsExternalParentTransformed"}(t=e.Flag||(e.Flag={}))}(o=e.Bone||(e.Bone={})),function(e){let t,n,r;!function(e){e[e.System=0]="System",e[e.Eyebrow=1]="Eyebrow",e[e.Eye=2]="Eye",e[e.Lip=3]="Lip",e[e.Other=4]="Other"}(t=e.Category||(e.Category={})),function(e){e[e.GroupMorph=0]="GroupMorph",e[e.VertexMorph=1]="VertexMorph",e[e.BoneMorph=2]="BoneMorph",e[e.UvMorph=3]="UvMorph",e[e.AdditionalUvMorph1=4]="AdditionalUvMorph1",e[e.AdditionalUvMorph2=5]="AdditionalUvMorph2",e[e.AdditionalUvMorph3=6]="AdditionalUvMorph3",e[e.AdditionalUvMorph4=7]="AdditionalUvMorph4",e[e.MaterialMorph=8]="MaterialMorph",e[e.FlipMorph=9]="FlipMorph",e[e.ImpulseMorph=10]="ImpulseMorph"}(n=e.Type||(e.Type={})),function(e){let t;!function(e){e[e.Multiply=0]="Multiply",e[e.Add=1]="Add"}(t=e.Type||(e.Type={}))}(r=e.MaterialMorph||(e.MaterialMorph={}))}(i=e.Morph||(e.Morph={})),function(e){let t;!function(e){let t;!function(e){e[e.Bone=0]="Bone",e[e.Morph=1]="Morph"}(t=e.FrameType||(e.FrameType={}))}(t=e.FrameData||(e.FrameData={}))}(s=e.DisplayFrame||(e.DisplayFrame={})),function(e){let t,n;!function(e){e[e.Sphere=0]="Sphere",e[e.Box=1]="Box",e[e.Capsule=2]="Capsule"}(t=e.ShapeType||(e.ShapeType={})),function(e){e[e.FollowBone=0]="FollowBone",e[e.Physics=1]="Physics",e[e.PhysicsWithBone=2]="PhysicsWithBone"}(n=e.PhysicsMode||(e.PhysicsMode={}))}(a=e.RigidBody||(e.RigidBody={})),function(e){let t;!function(e){e[e.Spring6dof=0]="Spring6dof",e[e.Sixdof=1]="Sixdof",e[e.P2p=2]="P2p",e[e.ConeTwist=3]="ConeTwist",e[e.Slider=4]="Slider",e[e.Hinge=5]="Hinge"}(t=e.Type||(e.Type={}))}(l=e.Joint||(e.Joint={})),function(e){let t,n,r;!function(e){e[e.TriMesh=0]="TriMesh",e[e.Rope=1]="Rope"}(t=e.Type||(e.Type={})),function(e){e[e.Blink=1]="Blink",e[e.ClusterCreation=2]="ClusterCreation",e[e.LinkCrossing=4]="LinkCrossing"}(n=e.Flag||(e.Flag={})),function(e){e[e.VertexPoint=0]="VertexPoint",e[e.VertexTwoSided=1]="VertexTwoSided",e[e.VertexOneSided=2]="VertexOneSided",e[e.FaceTwoSided=3]="FaceTwoSided",e[e.FaceOneSided=4]="FaceOneSided"}(r=e.AeroDynamicModel||(e.AeroDynamicModel={}))}(d=e.SoftBody||(e.SoftBody={}))}(i||(i={}));class g{log(e){console.log(e)}warn(e){console.warn(e)}error(e){console.error(e)}}class p{static _LittleEndian=!0;_dataView;_decoder;_offset;constructor(e){this._dataView=new DataView(e),this._decoder=null,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}getUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}getInt8(){const e=this._dataView.getInt8(this._offset);return this._offset+=1,e}getUint8Array(e,t){for(let n=0;n<t;++n)e[n]=this._dataView.getUint8(this._offset),this._offset+=1}getUint16(){const e=this._dataView.getUint16(this._offset,p._LittleEndian);return this._offset+=2,e}getUint16Array(e,t){for(let n=0;n<t;++n)e[n]=this._dataView.getUint16(this._offset,p._LittleEndian),this._offset+=2}getInt16(){const e=this._dataView.getInt16(this._offset,p._LittleEndian);return this._offset+=2,e}getUint32(){const e=this._dataView.getUint32(this._offset,p._LittleEndian);return this._offset+=4,e}getUint32Array(e,t){for(let n=0;n<t;++n)e[n]=this._dataView.getUint32(this._offset,p._LittleEndian),this._offset+=4}getInt32(){const e=this._dataView.getInt32(this._offset,p._LittleEndian);return this._offset+=4,e}getInt32Array(e,t){for(let n=0;n<t;++n)e[n]=this._dataView.getInt32(this._offset,p._LittleEndian),this._offset+=4}getFloat32(){const e=this._dataView.getFloat32(this._offset,p._LittleEndian);return this._offset+=4,e}getFloat32Array(e,t){for(let n=0;n<t;++n)e[n]=this._dataView.getFloat32(this._offset,p._LittleEndian),this._offset+=4}getFloat32Tuple(e){const t=new Array(e);for(let n=0;n<e;++n)t[n]=this._dataView.getFloat32(this._offset,p._LittleEndian),this._offset+=4;return t}initializeTextDecoder(e){this._decoder=new TextDecoder(e)}getDecoderString(e,t){if(null===this._decoder)throw new Error("TextDecoder is not initialized.");let n=new Uint8Array(this._dataView.buffer,this._offset,e);if(this._offset+=e,t)for(let e=0;e<n.length;++e)if(0===n[e]){n=n.subarray(0,e);break}return this._decoder.decode(n)}getSignatureString(e){const t=new TextDecoder("utf-8"),n=new Uint8Array(this._dataView.buffer,this._offset,e);return this._offset+=e,t.decode(n)}get bytesAvailable(){return this._dataView.byteLength-this._offset}}class x{_vertexIndexSize;_textureIndexSize;_materialIndexSize;_boneIndexSize;_morphIndexSize;_rigidBodyIndexSize;constructor(e,t,n,r,o,i){this._vertexIndexSize=e,this._textureIndexSize=t,this._materialIndexSize=n,this._boneIndexSize=r,this._morphIndexSize=o,this._rigidBodyIndexSize=i}getVertexIndex(e){switch(this._vertexIndexSize){case 1:return e.getUint8();case 2:return e.getUint16();case 4:return e.getInt32();default:throw new Error(`Invalid vertexIndexSize: ${this._vertexIndexSize}`)}}_getNonVertexIndex(e,t){switch(t){case 1:return e.getInt8();case 2:return e.getInt16();case 4:return e.getInt32();default:throw new Error(`Invalid indexSize: ${t}`)}}getTextureIndex(e){return this._getNonVertexIndex(e,this._textureIndexSize)}getMaterialIndex(e){return this._getNonVertexIndex(e,this._materialIndexSize)}getBoneIndex(e){return this._getNonVertexIndex(e,this._boneIndexSize)}getMorphIndex(e){return this._getNonVertexIndex(e,this._morphIndexSize)}getRigidBodyIndex(e){return this._getNonVertexIndex(e,this._rigidBodyIndexSize)}}class m{constructor(){}static async ParseAsync(e,t=new g){const n=new p(e),r=this._ParseHeader(n,t),o=new x(r.vertexIndexSize,r.textureIndexSize,r.materialIndexSize,r.boneIndexSize,r.morphIndexSize,r.rigidBodyIndexSize),i=await this._ParseVerticesAsync(n,o,r),s=this._ParseFaces(n,o,r),a=this._ParseTextures(n),l=this._ParseMaterials(n,o),d=this._ParseBones(n,o),h=this._ParseMorphs(n,o),c=this._ParseDisplayFrames(n,o),u=this._ParseRigidBodies(n,o),f=this._ParseJoints(n,o),m=r.version<=2?[]:this._ParseSoftBodies(n,o,r);return n.bytesAvailable>0&&t.warn(`There are ${n.bytesAvailable} bytes left after parsing`),{header:r,vertices:i,faces:s,textures:a,materials:l,bones:d,morphs:h,displayFrames:c,rigidBodies:u,joints:f,softBodies:m}}static _ParseHeader(e,t){if(e.bytesAvailable<17)throw new RangeError("is not pmx file");const n=e.getSignatureString(4);if("PMX "!==n)throw new RangeError("is not pmx file");const r=e.getFloat32(),o=e.getUint8(),s=e.getUint8();e.initializeTextDecoder(s===i.Header.Encoding.Utf8?"utf-8":"utf-16le");const a=e.getUint8(),l=e.getUint8(),d=e.getUint8(),h=e.getUint8(),c=e.getUint8(),u=e.getUint8(),f=e.getUint8();if(o<8)throw new Error(`Invalid globalsCount: ${o}`);if(8<o){t.warn(`globalsCount is greater than 8: ${o} files may be corrupted or higher version`);for(let t=8;t<o;++t)e.getUint8()}return{signature:n,version:r,encoding:s,additionalVec4Count:a,vertexIndexSize:l,textureIndexSize:d,materialIndexSize:h,boneIndexSize:c,morphIndexSize:u,rigidBodyIndexSize:f,modelName:e.getDecoderString(e.getInt32(),!1),englishModelName:e.getDecoderString(e.getInt32(),!1),comment:e.getDecoderString(e.getInt32(),!1),englishComment:e.getDecoderString(e.getInt32(),!1)}}static async _ParseVerticesAsync(e,t,n){const r=e.getInt32(),o=[];let s=performance.now();for(let a=0;a<r;++a){const r=e.getFloat32Tuple(3),l=e.getFloat32Tuple(3),d=e.getFloat32Tuple(2),h=[];for(let t=0;t<n.additionalVec4Count;t++)h.push(e.getFloat32Tuple(4));const c=e.getUint8();let u;switch(c){case i.Vertex.BoneWeightType.Bdef1:u={boneIndices:t.getBoneIndex(e),boneWeights:null};break;case i.Vertex.BoneWeightType.Bdef2:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:e.getFloat32()};break;case i.Vertex.BoneWeightType.Bdef4:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:[e.getFloat32(),e.getFloat32(),e.getFloat32(),e.getFloat32()]};break;case i.Vertex.BoneWeightType.Sdef:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:{boneWeight0:e.getFloat32(),c:e.getFloat32Tuple(3),r0:e.getFloat32Tuple(3),r1:e.getFloat32Tuple(3)}};break;case i.Vertex.BoneWeightType.Qdef:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:[e.getFloat32(),e.getFloat32(),e.getFloat32(),e.getFloat32()]};break;default:throw new Error(`Invalid weightType: ${c}`)}const f=e.getFloat32();o.push({position:r,normal:l,uv:d,additionalVec4:h,weightType:c,boneWeight:u,edgeRatio:f}),a%1e4==0&&100<performance.now()-s&&(await new Promise((e=>setTimeout(e,0))),s=performance.now())}return o}static _ParseFaces(e,t,n){const r=e.getInt32(),o=new ArrayBuffer(r*n.vertexIndexSize);let i;switch(n.vertexIndexSize){case 1:i=new Uint8Array(o);break;case 2:i=new Uint16Array(o);break;case 4:i=new Int32Array(o);break;default:throw new Error(`Invalid vertexIndexSize: ${n.vertexIndexSize}`)}for(let n=0;n<r;++n)i[n]=t.getVertexIndex(e);return i}static _ParseTextures(e){const t=e.getInt32(),n=[];for(let r=0;r<t;++r){const t=e.getDecoderString(e.getInt32(),!1);n.push(t)}return n}static _ParseMaterials(e,t){const n=e.getInt32(),r=[];for(let o=0;o<n;++o){const n=e.getDecoderString(e.getInt32(),!1),o=e.getDecoderString(e.getInt32(),!1),i=e.getFloat32Tuple(4),s=e.getFloat32Tuple(3),a=e.getFloat32(),l=e.getFloat32Tuple(3),d=e.getUint8(),h=e.getFloat32Tuple(4),c=e.getFloat32(),u=t.getTextureIndex(e),f=t.getTextureIndex(e),g=e.getUint8(),p=1===e.getUint8(),x={name:n,englishName:o,diffuse:i,specular:s,shininess:a,ambient:l,flag:d,edgeColor:h,edgeSize:c,textureIndex:u,sphereTextureIndex:f,sphereTextureMode:g,isSharedToonTexture:p,toonTextureIndex:p?e.getUint8():t.getTextureIndex(e),comment:e.getDecoderString(e.getInt32(),!1),surfaceCount:e.getInt32()};r.push(x)}return r}static _ParseBones(e,t){const n=e.getInt32(),r=[];for(let o=0;o<n;++o){const n=e.getDecoderString(e.getInt32(),!1),o=e.getDecoderString(e.getInt32(),!1),s=e.getFloat32Tuple(3),a=t.getBoneIndex(e),l=e.getInt32(),d=e.getUint16();let h,c,u,f;h=d&i.Bone.Flag.UseBoneIndexAsTailPosition?t.getBoneIndex(e):e.getFloat32Tuple(3),(d&i.Bone.Flag.HasAppendMove||d&i.Bone.Flag.HasAppendRotate)&&(c={isLocal:0!=(d&i.Bone.Flag.LocalAppendTransform),affectRotation:0!=(d&i.Bone.Flag.HasAppendRotate),affectPosition:0!=(d&i.Bone.Flag.HasAppendMove),parentIndex:t.getBoneIndex(e),ratio:e.getFloat32()}),d&i.Bone.Flag.HasAxisLimit&&(u=e.getFloat32Tuple(3)),d&i.Bone.Flag.HasLocalVector&&(f={x:e.getFloat32Tuple(3),z:e.getFloat32Tuple(3)});const g=0!=(d&i.Bone.Flag.TransformAfterPhysics);let p,x;if(d&i.Bone.Flag.IsExternalParentTransformed&&(p=e.getInt32()),d&i.Bone.Flag.IsIkEnabled){const n=t.getBoneIndex(e),r=e.getInt32(),o=e.getFloat32(),i=[],s=e.getInt32();for(let n=0;n<s;++n){const n={target:t.getBoneIndex(e),limitation:1===e.getUint8()?{minimumAngle:e.getFloat32Tuple(3),maximumAngle:e.getFloat32Tuple(3)}:void 0};i.push(n)}x={target:n,iteration:r,rotationConstraint:o,links:i}}const m={name:n,englishName:o,position:s,parentBoneIndex:a,transformOrder:l,flag:d,tailPosition:h,appendTransform:c,axisLimit:u,localVector:f,transformAfterPhysics:g,externalParentTransform:p,ik:x};r.push(m)}return r}static _ParseMorphs(e,t){const n=e.getInt32(),r=[];for(let o=0;o<n;++o){const n=e.getDecoderString(e.getInt32(),!1),o=e.getDecoderString(e.getInt32(),!1),s=e.getInt8(),a=e.getInt8();let l={name:n,englishName:o,category:s,type:a};const d=e.getInt32();switch(a){case i.Morph.Type.GroupMorph:{const n=new Int32Array(d),r=new Float32Array(d);for(let o=0;o<d;++o)n[o]=t.getMorphIndex(e),r[o]=e.getFloat32();l={...l,indices:n,ratios:r}}break;case i.Morph.Type.VertexMorph:{const n=new Int32Array(d),r=new Float32Array(3*d);for(let o=0;o<d;++o)n[o]=t.getVertexIndex(e),r[3*o+0]=e.getFloat32(),r[3*o+1]=e.getFloat32(),r[3*o+2]=e.getFloat32();l={...l,indices:n,positions:r}}break;case i.Morph.Type.BoneMorph:{const n=new Int32Array(d),r=new Float32Array(3*d),o=new Float32Array(4*d);for(let i=0;i<d;++i)n[i]=t.getBoneIndex(e),r[3*i+0]=e.getFloat32(),r[3*i+1]=e.getFloat32(),r[3*i+2]=e.getFloat32(),o[4*i+0]=e.getFloat32(),o[4*i+1]=e.getFloat32(),o[4*i+2]=e.getFloat32(),o[4*i+3]=e.getFloat32();l={...l,indices:n,positions:r,rotations:o}}break;case i.Morph.Type.UvMorph:case i.Morph.Type.AdditionalUvMorph1:case i.Morph.Type.AdditionalUvMorph2:case i.Morph.Type.AdditionalUvMorph3:case i.Morph.Type.AdditionalUvMorph4:{const n=new Int32Array(d),r=new Float32Array(4*d);for(let o=0;o<d;++o)n[o]=t.getVertexIndex(e),r[4*o+0]=e.getFloat32(),r[4*o+1]=e.getFloat32(),r[4*o+2]=e.getFloat32(),r[4*o+3]=e.getFloat32();l={...l,indices:n,offsets:r}}break;case i.Morph.Type.MaterialMorph:{const n=[];for(let r=0;r<d;++r){const r={index:t.getMaterialIndex(e),type:e.getUint8(),diffuse:e.getFloat32Tuple(4),specular:e.getFloat32Tuple(3),shininess:e.getFloat32(),ambient:e.getFloat32Tuple(3),edgeColor:e.getFloat32Tuple(4),edgeSize:e.getFloat32(),textureColor:e.getFloat32Tuple(4),sphereTextureColor:e.getFloat32Tuple(4),toonTextureColor:e.getFloat32Tuple(4)};n.push(r)}l={...l,elements:n}}break;case i.Morph.Type.FlipMorph:{const n=new Int32Array(d),r=new Float32Array(d);for(let o=0;o<d;++o)n[o]=t.getMorphIndex(e),r[o]=e.getFloat32();l={...l,indices:n,ratios:r}}break;case i.Morph.Type.ImpulseMorph:{const n=new Int32Array(d),r=new Array(d),o=new Float32Array(3*d),i=new Float32Array(3*d);for(let s=0;s<d;++s)n[s]=t.getRigidBodyIndex(e),r[s]=1===e.getUint8(),o[3*s+0]=e.getFloat32(),o[3*s+1]=e.getFloat32(),o[3*s+2]=e.getFloat32(),i[3*s+0]=e.getFloat32(),i[3*s+1]=e.getFloat32(),i[3*s+2]=e.getFloat32();l={...l,indices:n,isLocals:r,velocities:o,torques:i}}break;default:throw new Error(`Unknown morph type: ${a}`)}r.push(l)}return r}static _ParseDisplayFrames(e,t){const n=e.getInt32(),r=[];for(let o=0;o<n;++o){const n=e.getDecoderString(e.getInt32(),!1),o=e.getDecoderString(e.getInt32(),!1),s=1===e.getUint8(),a=e.getInt32(),l=[];for(let n=0;n<a;++n){const n=e.getUint8(),r={type:n,index:n===i.DisplayFrame.FrameData.FrameType.Bone?t.getBoneIndex(e):t.getMorphIndex(e)};l.push(r)}const d={name:n,englishName:o,isSpecialFrame:s,frames:l};r.push(d)}return r}static _ParseRigidBodies(e,t){const n=e.getInt32(),r=[];for(let o=0;o<n;++o){const n={name:e.getDecoderString(e.getInt32(),!1),englishName:e.getDecoderString(e.getInt32(),!1),boneIndex:t.getBoneIndex(e),collisionGroup:e.getUint8(),collisionMask:e.getUint16(),shapeType:e.getUint8(),shapeSize:e.getFloat32Tuple(3),shapePosition:e.getFloat32Tuple(3),shapeRotation:e.getFloat32Tuple(3),mass:e.getFloat32(),linearDamping:e.getFloat32(),angularDamping:e.getFloat32(),repulsion:e.getFloat32(),friction:e.getFloat32(),physicsMode:e.getUint8()};r.push(n)}return r}static _ParseJoints(e,t){const n=e.getInt32(),r=[];for(let o=0;o<n;++o){const n={name:e.getDecoderString(e.getInt32(),!1),englishName:e.getDecoderString(e.getInt32(),!1),type:e.getUint8(),rigidbodyIndexA:t.getRigidBodyIndex(e),rigidbodyIndexB:t.getRigidBodyIndex(e),position:e.getFloat32Tuple(3),rotation:e.getFloat32Tuple(3),positionMin:e.getFloat32Tuple(3),positionMax:e.getFloat32Tuple(3),rotationMin:e.getFloat32Tuple(3),rotationMax:e.getFloat32Tuple(3),springPosition:e.getFloat32Tuple(3),springRotation:e.getFloat32Tuple(3)};r.push(n)}return r}static _ParseSoftBodies(e,t,n){const r=e.getInt32(),o=[];for(let i=0;i<r;++i){const r=e.getDecoderString(e.getInt32(),!1),i=e.getDecoderString(e.getInt32(),!1),s=e.getUint8(),a=t.getMaterialIndex(e),l=e.getUint8(),d=e.getUint16(),h=e.getUint8(),c=e.getInt32(),u=e.getInt32(),f=e.getFloat32(),g=e.getFloat32(),p=e.getInt32(),x={vcf:e.getFloat32(),dp:e.getFloat32(),dg:e.getFloat32(),lf:e.getFloat32(),pr:e.getFloat32(),vc:e.getFloat32(),df:e.getFloat32(),mt:e.getFloat32(),chr:e.getFloat32(),khr:e.getFloat32(),shr:e.getFloat32(),ahr:e.getFloat32()},m={srhrCl:e.getFloat32(),skhrCl:e.getFloat32(),sshrCl:e.getFloat32(),srSpltCl:e.getFloat32(),skSpltCl:e.getFloat32(),ssSpltCl:e.getFloat32()},A={vIt:e.getInt32(),pIt:e.getInt32(),dIt:e.getInt32(),cIt:e.getInt32()},T={lst:e.getInt32(),ast:e.getInt32(),vst:e.getInt32()},_=e.getInt32(),y=[];for(let n=0;n<_;++n){const n={rigidbodyIndex:t.getRigidBodyIndex(e),vertexIndex:t.getVertexIndex(e),isNearMode:0!==e.getUint8()};y.push(n)}const E=e.getInt32(),I=new ArrayBuffer(E*n.vertexIndexSize);let M;switch(n.vertexIndexSize){case 1:M=new Uint8Array(I);break;case 2:M=new Uint16Array(I);break;case 4:M=new Int32Array(I);break;default:throw new Error(`Invalid vertexIndexSize: ${n.vertexIndexSize}`)}for(let n=0;n<E;++n)M[n]=t.getVertexIndex(e);const b={name:r,englishName:i,type:s,materialIndex:a,collisionGroup:l,collisionMask:d,flags:h,bLinkDistance:c,clusterCount:u,totalMass:f,collisionMargin:g,aeroModel:p,config:x,cluster:m,interation:A,material:T,anchors:y,vertexPins:M};o.push(b)}return o}}class A{files;_fileMap=new Map;constructor(e,t,n){if(t=this._pathNormalize(t),this.files=e,0!==e.length)if(e[0]instanceof File)for(const r of e){const e=n+this._pathNormalize(r.webkitRelativePath).slice(t.length);this._fileMap.set(this._pathNormalize(e),r)}else for(const t of e){const e=n+t.relativePath;this._fileMap.set(this._pathNormalize(e),t)}}resolve(e){const t=this._pathNormalize(e);return this._fileMap.get(t)}_pathNormalize(e){return e.replace(/\\/g,"/").toUpperCase()}}!function(e){e[e.Opaque=r.F5T.MATERIAL_OPAQUE]="Opaque",e[e.AlphaTest=r.F5T.MATERIAL_ALPHATEST]="AlphaTest",e[e.AlphaBlend=r.F5T.MATERIAL_ALPHABLEND]="AlphaBlend"}(s||(s={}));class T{texture;onLoadObservable;constructor(){this.texture=null,this.onLoadObservable=new r.y$z}awaitLoad(){return new Promise((e=>{null!==this.texture?e(this):this.onLoadObservable.addOnce((()=>e(this)))}))}}class _{_resolution;_textureCache;_context;_vertexShader;_fragmentShader;_program;_uvBuffer;_indexBuffer;_indicesBytePerElement;constructor(e,t,n=512){this._resolution=n,this._textureCache=new Map,this._context=this._createRenderingContext(),this._vertexShader=null,this._fragmentShader=null,this._program=null,this._uvBuffer=null,this._indexBuffer=null,this._indicesBytePerElement=t.BYTES_PER_ELEMENT,!1!==this._prepareContext()&&!1!==this._bindUvAndIndexBuffer(e,t)||this.dispose()}_createRenderingContext(){const e=document.createElement("canvas");return e.width=this._resolution,e.height=this._resolution,e.getContext("webgl2",{alpha:!1,antialias:!1,depth:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1})}_prepareContext(){if(null===this._context)return!1;const e=this._context;e.clearColor(0,0,0,0);const t=this._vertexShader=e.createShader(e.VERTEX_SHADER);if(null===t)return!1;if(e.shaderSource(t,"\n            precision highp float;\n            attribute vec2 uv;\n            varying vec2 vUv;\n\n            void main() {\n                vUv = uv;\n                gl_Position = vec4(uv * 2.0 - 1.0, 0.0, 1.0);\n            }\n        "),e.compileShader(t),!e.getShaderParameter(t,e.COMPILE_STATUS))return console.error(e.getShaderInfoLog(t)),!1;const n=this._fragmentShader=e.createShader(e.FRAGMENT_SHADER);if(null===n)return!1;const r=`\n            precision highp float;\n            uniform sampler2D texture;\n            varying vec2 vUv;\n\n            void main() {\n                vec2 onePixel = vec2(1.0 / ${this._resolution.toFixed(1)});\n\n                float minAlpha = 1.0;\n                for (int i = 0; i < 2; ++i) {\n                    for (int j = 0; j < 2; ++j) {\n                        float alpha = texture2D(texture, vUv + vec2(onePixel.x * float(i), onePixel.y * float(j))).a;\n                        minAlpha = min(minAlpha, alpha);\n                    }\n                }\n                gl_FragColor = vec4(vec3(1.0) - minAlpha, 1.0);\n            }\n        `;if(e.shaderSource(n,r),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))return console.error(e.getShaderInfoLog(n)),!1;const o=this._program=e.createProgram();return null!==o&&(e.attachShader(o,t),e.attachShader(o,n),e.linkProgram(o),e.getProgramParameter(o,e.LINK_STATUS)?(e.useProgram(o),!0):(console.error(e.getProgramInfoLog(o)),!1))}async _getWebGlTexture(e){const t=this._context;if(null===t)return null;const n=this._textureCache.get(e);if(void 0!==n)return await n.awaitLoad(),n.texture;const r=new T;this._textureCache.set(e,r);const o=await new Promise(((t,n)=>{const r=new Image;r.onload=()=>t(r),r.onerror=()=>n(),r.src=URL.createObjectURL(new Blob([e]))})),i=t.createTexture();return null===i?null:(t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,o.width,o.height,0,t.RGBA,t.UNSIGNED_BYTE,o),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,1),URL.revokeObjectURL(o.src),r.texture=i,r.onLoadObservable.notifyObservers(),i)}_bindUvAndIndexBuffer(e,t){const n=this._context;if(null===n)return!1;const r=this._program;if(null===r)return!1;const o=this._uvBuffer=n.createBuffer();if(null===o)return!1;n.bindBuffer(n.ARRAY_BUFFER,o),n.bufferData(n.ARRAY_BUFFER,e,n.STATIC_DRAW);const i=n.getAttribLocation(r,"uv");n.enableVertexAttribArray(i),n.vertexAttribPointer(i,2,n.FLOAT,!1,0,0);const s=this._indexBuffer=n.createBuffer();return null!==s&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,s),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t,n.STATIC_DRAW),!0)}async textureHasAlphaOnGeometry(e,t,n,r,o){const i=this._context;if(null===i)return s.Opaque;const a=this._program;if(null===a)return s.Opaque;const l=await this._getWebGlTexture(e);if(null===l)return s.Opaque;i.clear(i.COLOR_BUFFER_BIT);const d=i.getUniformLocation(a,"texture");i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,l),i.uniform1i(d,0),i.drawElements(i.TRIANGLES,n,2===this._indicesBytePerElement?i.UNSIGNED_SHORT:i.UNSIGNED_INT,t*this._indicesBytePerElement);const h=this._resolution,c=new Uint8Array(h*h*4);i.readPixels(0,0,h,h,i.RGBA,i.UNSIGNED_BYTE,c);let u=0,f=0,g=0;for(let e=0;e<h;e+=2)for(let t=0;t<h;t+=2){const n=c[4*(e*h+t)];u=Math.max(u,n),0<n&&n<255&&(f+=n,g+=1)}return 0!==g&&(f/=g),u<r?s.Opaque:f+o<u?s.AlphaTest:s.AlphaBlend}dispose(){const e=this._context;if(null!==e){e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),e.bindTexture(e.TEXTURE_2D,null),e.useProgram(null),e.deleteBuffer(this._uvBuffer),e.deleteBuffer(this._indexBuffer);for(const t of this._textureCache.values())e.deleteTexture(t.texture);e.deleteProgram(this._program),e.deleteShader(this._vertexShader),e.deleteShader(this._fragmentShader),this._context=null,this._vertexShader=null,this._fragmentShader=null,this._program=null,this._uvBuffer=null,this._indexBuffer=null}}}class y{static _LittleEndian=!0;_dataView;_encoder;_offset;constructor(e){this._dataView=new DataView(e),this._encoder=new TextEncoder,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}setUint8(e){this._dataView.setUint8(this._offset,e),this._offset+=1}setUint8Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setUint8(this._offset,e[n]),this._offset+=1}setInt8(e){this._dataView.setInt8(this._offset,e),this._offset+=1}setInt8Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setInt8(this._offset,e[n]),this._offset+=1}setUint16(e){this._dataView.setUint16(this._offset,e,y._LittleEndian),this._offset+=2}setUint16Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setUint16(this._offset,e[n],y._LittleEndian),this._offset+=2}setUint32(e){this._dataView.setUint32(this._offset,e,y._LittleEndian),this._offset+=4}setUint32Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setUint32(this._offset,e[n],y._LittleEndian),this._offset+=4}setInt32(e){this._dataView.setInt32(this._offset,e,y._LittleEndian),this._offset+=4}setInt32Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setInt32(this._offset,e[n],y._LittleEndian),this._offset+=4}setFloat32(e){this._dataView.setFloat32(this._offset,e,y._LittleEndian),this._offset+=4}setFloat32Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setFloat32(this._offset,e[n],y._LittleEndian),this._offset+=4}setString(e){const t=this._dataView,n=this._encoder.encode(e);t.setUint32(this._offset,n.length,y._LittleEndian),this._offset+=4;for(let e=0;e<n.length;++e)t.setUint8(this._offset,n[e]),this._offset+=1}get bytesAvailable(){return this._dataView.byteLength-this._offset}}class E{alphaThreshold;alphaBlendThreshold;useAlphaEvaluation;alphaEvaluationResolution;_loggingEnabled;log;warn;error;constructor(){this.alphaThreshold=195,this.alphaBlendThreshold=100,this.useAlphaEvaluation=!0,this.alphaEvaluationResolution=512,this._loggingEnabled=!0,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled}async convert(e,t,n,r){const o=this.alphaThreshold,s=this.alphaBlendThreshold,a=this.useAlphaEvaluation,l=this.alphaEvaluationResolution;let d;if(void 0===n){const e=await fetch(t).then((e=>e.arrayBuffer()));d=await m.ParseAsync(e,this)}else{const e=n.find((e=>e.webkitRelativePath===t));if(void 0===e)throw new Error(`File ${t} not found`);const r=await e.arrayBuffer();d=await m.ParseAsync(r,this)}const h=d.vertices,c=new Float32Array(3*h.length),u=new Float32Array(3*h.length),g=new Float32Array(2*h.length);let p;p=d.faces instanceof Uint8Array||d.faces instanceof Uint16Array?new Uint16Array(d.faces.length):new Uint32Array(d.faces.length);const x=new Float32Array(4*h.length),T=new Float32Array(4*h.length);let E=!1;const I=new Float32Array(3*d.vertices.length),M=new Float32Array(3*d.vertices.length),b=new Float32Array(3*d.vertices.length);{const e=d.vertices;{const e=d.faces;for(let t=0;t<p.length;t+=3)p[t+0]=e[t+0],p[t+1]=e[t+2],p[t+2]=e[t+1]}for(let t=0;t<e.length;++t){const n=e[t];switch(c[3*t+0]=n.position[0],c[3*t+1]=n.position[1],c[3*t+2]=n.position[2],u[3*t+0]=n.normal[0],u[3*t+1]=n.normal[1],u[3*t+2]=n.normal[2],g[2*t+0]=n.uv[0],g[2*t+1]=1-n.uv[1],n.weightType){case i.Vertex.BoneWeightType.Bdef1:{const e=n.boneWeight;x[4*t+0]=e.boneIndices,x[4*t+1]=0,x[4*t+2]=0,x[4*t+3]=0,T[4*t+0]=1,T[4*t+1]=0,T[4*t+2]=0,T[4*t+3]=0}break;case i.Vertex.BoneWeightType.Bdef2:{const e=n.boneWeight;x[4*t+0]=e.boneIndices[0],x[4*t+1]=e.boneIndices[1],x[4*t+2]=0,x[4*t+3]=0,T[4*t+0]=e.boneWeights,T[4*t+1]=1-e.boneWeights,T[4*t+2]=0,T[4*t+3]=0}break;case i.Vertex.BoneWeightType.Bdef4:case i.Vertex.BoneWeightType.Qdef:{const e=n.boneWeight;x[4*t+0]=e.boneIndices[0],x[4*t+1]=e.boneIndices[1],x[4*t+2]=e.boneIndices[2],x[4*t+3]=e.boneIndices[3],T[4*t+0]=e.boneWeights[0],T[4*t+1]=e.boneWeights[1],T[4*t+2]=e.boneWeights[2],T[4*t+3]=e.boneWeights[3]}break;case i.Vertex.BoneWeightType.Sdef:{const e=n.boneWeight;x[4*t+0]=e.boneIndices[0],x[4*t+1]=e.boneIndices[1],x[4*t+2]=0,x[4*t+3]=0;const r=e.boneWeights,o=r.boneWeight0,i=1-o;T[4*t+0]=o,T[4*t+1]=i,T[4*t+2]=0,T[4*t+3]=0,I[3*t+0]=r.c[0],I[3*t+1]=r.c[1],I[3*t+2]=r.c[2],M[3*t+0]=r.r0[0],M[3*t+1]=r.r0[1],M[3*t+2]=r.r0[2],b[3*t+0]=r.r1[0],b[3*t+1]=r.r1[1],b[3*t+2]=r.r1[2],E=!0}}}}const w=[];{const r=new Array(d.textures.length),o=t.substring(0,t.lastIndexOf("/")+1),i=new f,s=new A(n??[],o,""),a=[],l=d.materials;for(let t=0;t<l.length;++t){const n=l[t],h=d.textures[n.textureIndex];if(void 0!==h){const t=s.resolve(h);void 0!==t?a.push(i.loadTextureFromBufferAsync(0,h,t,e,null).then((e=>{r[n.textureIndex]=e}))):a.push(i.loadTextureAsync(0,o,h,e,null).then((e=>{r[n.textureIndex]=e})))}const c=d.textures[n.sphereTextureIndex];if(void 0!==c){const t=s.resolve(c);void 0!==t?a.push(i.loadTextureFromBufferAsync(0,c,t,e,null).then((e=>{r[n.sphereTextureIndex]=e}))):a.push(i.loadTextureAsync(0,o,c,e,null).then((e=>{r[n.sphereTextureIndex]=e})))}const u=d.textures[n.toonTextureIndex];if(void 0!==u&&!n.isSharedToonTexture){const t=s.resolve(u);void 0!==t?a.push(i.loadTextureFromBufferAsync(0,u,t,e,null).then((e=>{r[n.toonTextureIndex]=e}))):a.push(i.loadTextureAsync(0,o,u,e,null).then((e=>{r[n.toonTextureIndex]=e})))}}i.loadModelTexturesEnd(0),await Promise.all(a);const h=i.onModelTextureLoadedObservable.get(0);void 0!==h&&await new Promise((e=>{h.addOnce((()=>{e()}))}));for(let e=0;e<r.length;++e){const t=r[e];w[e]=t.arrayBuffer,t.texture?.dispose()}}const S=new Array(d.materials.length).fill(-1);if(a){const e=new _(g,p,l),t=d.materials;let n=0;for(let r=0;r<t.length;++r){const i=t[r];if(void 0!==d.textures[i.textureIndex]){const t=w[i.textureIndex];if(null!==t){const a=await e.textureHasAlphaOnGeometry(t,n,i.surfaceCount,o,s);S[r]=a}}n+=i.surfaceCount}e.dispose()}if(void 0!==r){const e=d.materials,t=new Array(e.length);for(let n=0;n<e.length;++n)t[n]=e[n].name;r(t,S)}const R=new TextEncoder;let C=7;{const e=d.header;C+=4+R.encode(e.modelName).length,C+=4+R.encode(e.englishModelName).length,C+=4+R.encode(e.comment).length,C+=4+R.encode(e.englishComment).length,C+=4,C+=3*h.length*4,C+=3*h.length*4,C+=2*h.length*4,C+=1,C+=4,C+=p.byteLength,C+=4*h.length*4,C+=4*h.length*4,C+=1,E&&(C+=3*h.length*4,C+=3*h.length*4,C+=3*h.length*4),C+=4;const t=d.textures;for(let e=0;e<t.length;++e){const n=w[e];null!==n?(C+=4+R.encode(t[e]).length,C+=4,C+=n.byteLength):(C+=4,C+=4)}C+=4;const n=d.materials;for(let e=0;e<n.length;++e){const t=n[e];C+=4+R.encode(t.name).length,C+=4+R.encode(t.englishName).length,C+=16,C+=12,C+=4,C+=12,C+=1,C+=1,C+=16,C+=4,C+=4,C+=4,C+=1,C+=1,C+=4,C+=4+R.encode(t.comment).length,C+=4}C+=4;const r=d.bones;for(let e=0;e<r.length;++e){const t=r[e];if(C+=4+R.encode(t.name).length,C+=4+R.encode(t.englishName).length,C+=12,C+=4,C+=4,C+=2,"number"==typeof t.tailPosition?C+=4:C+=12,void 0!==t.appendTransform&&(C+=4,C+=4),void 0!==t.axisLimit&&(C+=12),void 0!==t.localVector&&(C+=12,C+=12),void 0!==t.externalParentTransform&&(C+=4),void 0!==t.ik){C+=4,C+=4,C+=4,C+=4;const e=t.ik.links;for(let t=0;t<e.length;++t)C+=4,C+=1,void 0!==e[t].limitation&&(C+=12,C+=12)}}C+=4;const o=d.morphs;for(let e=0;e<o.length;++e){const t=o[e];switch(C+=4+R.encode(t.name).length,C+=4+R.encode(t.englishName).length,C+=1,C+=1,C+=4,t.type){case i.Morph.Type.GroupMorph:C+=8*t.indices.length;break;case i.Morph.Type.VertexMorph:C+=16*t.indices.length;break;case i.Morph.Type.BoneMorph:C+=32*t.indices.length;break;case i.Morph.Type.UvMorph:case i.Morph.Type.AdditionalUvMorph1:case i.Morph.Type.AdditionalUvMorph2:case i.Morph.Type.AdditionalUvMorph3:case i.Morph.Type.AdditionalUvMorph4:C+=20*t.indices.length;break;case i.Morph.Type.MaterialMorph:C+=117*t.elements.length}}C+=4;const s=d.displayFrames;for(let e=0;e<s.length;++e){const t=s[e];C+=4+R.encode(t.name).length,C+=4+R.encode(t.englishName).length,C+=1,C+=4,C+=5*t.frames.length}C+=4;const a=d.rigidBodies;for(let e=0;e<a.length;++e){const t=a[e];C+=4+R.encode(t.name).length,C+=4+R.encode(t.englishName).length,C+=4,C+=1,C+=2,C+=1,C+=12,C+=12,C+=12,C+=4,C+=4,C+=4,C+=4,C+=4,C+=1}C+=4;const l=d.joints;for(let e=0;e<l.length;++e){const t=l[e];C+=4+R.encode(t.name).length,C+=4+R.encode(t.englishName).length,C+=1,C+=4,C+=4,C+=12,C+=12,C+=12,C+=12,C+=12,C+=12,C+=12,C+=12}}const F=new ArrayBuffer(C),v=new y(F);v.setUint8Array(R.encode("BPMX")),v.setInt8Array([1,0,0]),v.setString(d.header.modelName),v.setString(d.header.englishModelName),v.setString(d.header.comment),v.setString(d.header.englishComment),v.setUint32(h.length),v.setFloat32Array(c),v.setFloat32Array(u),v.setFloat32Array(g),p instanceof Uint16Array?(v.setUint8(2),v.setUint32(p.length),v.setUint16Array(p)):(v.setUint8(4),v.setUint32(p.length),v.setUint32Array(p)),v.setFloat32Array(x),v.setFloat32Array(T),v.setUint8(E?1:0),E&&(v.setFloat32Array(I),v.setFloat32Array(M),v.setFloat32Array(b)),v.setUint32(d.textures.length);const B=d.textures;for(let e=0;e<w.length;++e){const t=w[e];null!==t?(v.setString(B[e]),v.setUint32(t.byteLength),v.setUint8Array(new Uint8Array(t))):(v.setUint32(0),v.setUint32(0))}v.setUint32(d.materials.length);const U=d.materials;for(let e=0;e<U.length;++e){const t=U[e];v.setString(t.name),v.setString(t.englishName),v.setFloat32Array(t.diffuse),v.setFloat32Array(t.specular),v.setFloat32(t.shininess),v.setFloat32Array(t.ambient),v.setInt8(S[e]),v.setUint8(t.flag),v.setFloat32Array(t.edgeColor),v.setFloat32(t.edgeSize),v.setInt32(t.textureIndex),v.setInt32(t.sphereTextureIndex),v.setUint8(t.sphereTextureMode),v.setUint8(t.isSharedToonTexture?1:0),v.setInt32(t.toonTextureIndex),v.setString(t.comment),v.setUint32(t.surfaceCount)}v.setUint32(d.bones.length);const D=d.bones;for(let e=0;e<D.length;++e){const t=D[e];if(v.setString(t.name),v.setString(t.englishName),v.setFloat32Array(t.position),v.setInt32(t.parentBoneIndex),v.setInt32(t.transformOrder),v.setUint16(t.flag),"number"==typeof t.tailPosition?v.setFloat32(t.tailPosition):v.setFloat32Array(t.tailPosition),void 0!==t.appendTransform&&(v.setInt32(t.appendTransform.parentIndex),v.setFloat32(t.appendTransform.ratio)),void 0!==t.axisLimit&&v.setFloat32Array(t.axisLimit),void 0!==t.localVector&&(v.setFloat32Array(t.localVector.x),v.setFloat32Array(t.localVector.z)),void 0!==t.externalParentTransform&&v.setInt32(t.externalParentTransform),void 0!==t.ik){const e=t.ik;v.setInt32(e.target),v.setInt32(e.iteration),v.setFloat32(e.rotationConstraint);const n=e.links;v.setInt32(n.length);for(let e=0;e<n.length;++e){const t=n[e];v.setInt32(t.target),v.setUint8(void 0!==t.limitation?1:0),void 0!==t.limitation&&(v.setFloat32Array(t.limitation.minimumAngle),v.setFloat32Array(t.limitation.maximumAngle))}}}v.setUint32(d.morphs.length);const P=d.morphs;for(let e=0;e<P.length;++e){const t=P[e];switch(v.setString(t.name),v.setString(t.englishName),v.setUint8(t.category),v.setUint8(t.type),t.type){case i.Morph.Type.GroupMorph:v.setUint32(t.indices.length),v.setInt32Array(t.indices),v.setFloat32Array(t.ratios);break;case i.Morph.Type.VertexMorph:v.setUint32(t.indices.length),v.setInt32Array(t.indices),v.setFloat32Array(t.positions);break;case i.Morph.Type.BoneMorph:v.setUint32(t.indices.length),v.setInt32Array(t.indices),v.setFloat32Array(t.positions),v.setFloat32Array(t.rotations);break;case i.Morph.Type.UvMorph:case i.Morph.Type.AdditionalUvMorph1:case i.Morph.Type.AdditionalUvMorph2:case i.Morph.Type.AdditionalUvMorph3:case i.Morph.Type.AdditionalUvMorph4:v.setUint32(t.indices.length),v.setInt32Array(t.indices),v.setFloat32Array(t.offsets);break;case i.Morph.Type.MaterialMorph:{v.setUint32(t.elements.length);const e=t.elements;for(let t=0;t<e.length;++t){const n=e[t];v.setInt32(n.index),v.setUint8(n.type),v.setFloat32Array(n.diffuse),v.setFloat32Array(n.specular),v.setFloat32(n.shininess),v.setFloat32Array(n.ambient),v.setFloat32Array(n.edgeColor),v.setFloat32(n.edgeSize),v.setFloat32Array(n.textureColor),v.setFloat32Array(n.sphereTextureColor),v.setFloat32Array(n.toonTextureColor)}}break;default:v.setUint32(0)}}v.setUint32(d.displayFrames.length);const O=d.displayFrames;for(let e=0;e<O.length;++e){const t=O[e];v.setString(t.name),v.setString(t.englishName),v.setUint8(t.isSpecialFrame?1:0),v.setUint32(t.frames.length);const n=t.frames;for(let e=0;e<n.length;++e){const t=n[e];v.setUint8(t.type),v.setInt32(t.index)}}v.setUint32(d.rigidBodies.length);const L=d.rigidBodies;for(let e=0;e<L.length;++e){const t=L[e];v.setString(t.name),v.setString(t.englishName),v.setInt32(t.boneIndex),v.setUint8(t.collisionGroup),v.setUint16(t.collisionMask),v.setUint8(t.shapeType),v.setFloat32Array(t.shapeSize),v.setFloat32Array(t.shapePosition),v.setFloat32Array(t.shapeRotation),v.setFloat32(t.mass),v.setFloat32(t.linearDamping),v.setFloat32(t.angularDamping),v.setFloat32(t.repulsion),v.setFloat32(t.friction),v.setUint8(t.physicsMode)}v.setUint32(d.joints.length);const N=d.joints;for(let e=0;e<N.length;++e){const t=N[e];v.setString(t.name),v.setString(t.englishName),v.setUint8(t.type),v.setInt32(t.rigidbodyIndexA),v.setInt32(t.rigidbodyIndexB),v.setFloat32Array(t.position),v.setFloat32Array(t.rotation),v.setFloat32Array(t.positionMin),v.setFloat32Array(t.positionMax),v.setFloat32Array(t.rotationMin),v.setFloat32Array(t.rotationMax),v.setFloat32Array(t.springPosition),v.setFloat32Array(t.springRotation)}return F}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){r.YdH.Log(e)}_logDisabled(){}_warnEnabled(e){r.YdH.Warn(e)}_warnDisabled(){}_errorEnabled(e){r.YdH.Error(e)}_errorDisabled(){}}class I{static MatricesSdefCKind="matricesSdefC";static MatricesSdefR0Kind="matricesSdefR0";static MatricesSdefR1Kind="matricesSdefR1"}const M="\n#ifndef SDEFDECLARATION\n#define SDEFDECLARATION\n\n#if NUM_BONE_INFLUENCERS > 0 && defined(SDEF)\nattribute vec3 matricesSdefC;\nattribute vec3 matricesSdefR0;\nattribute vec3 matricesSdefR1;\n\nvec4 rotationMatrixToQuaternion(mat3 matrix) {\n    float trace = matrix[0][0] + matrix[1][1] + matrix[2][2];\n    float s;\n\n    float sqrtParam;\n    if (trace > 0.0) {\n        sqrtParam = trace + 1.0;\n    } else if (matrix[0][0] > matrix[1][1] && matrix[0][0] > matrix[2][2]) {\n        sqrtParam = 1.0 + matrix[0][0] - matrix[1][1] - matrix[2][2];\n    } else if (matrix[1][1] > matrix[2][2]) {\n        sqrtParam = 1.0 + matrix[1][1] - matrix[0][0] - matrix[2][2];\n    } else {\n        sqrtParam = 1.0 + matrix[2][2] - matrix[0][0] - matrix[1][1];\n    }\n    float sqrtValue = sqrt(sqrtParam);\n\n    if (trace > 0.0) {\n        s = 0.5 / sqrtValue;\n\n        return vec4(\n            (matrix[1][2] - matrix[2][1]) * s,\n            (matrix[2][0] - matrix[0][2]) * s,\n            (matrix[0][1] - matrix[1][0]) * s,\n            0.25 / s\n        );\n    } else if (matrix[0][0] > matrix[1][1] && matrix[0][0] > matrix[2][2]) {\n        s = 2.0 * sqrtValue;\n\n        return vec4(\n            0.25 * s,\n            (matrix[0][1] + matrix[1][0]) / s,\n            (matrix[2][0] + matrix[0][2]) / s,\n            (matrix[1][2] - matrix[2][1]) / s\n        );\n    } else if (matrix[1][1] > matrix[2][2]) {\n        s = 2.0 * sqrtValue;\n        \n        return vec4(\n            (matrix[0][1] + matrix[1][0]) / s,\n            0.25 * s,\n            (matrix[1][2] + matrix[2][1]) / s,\n            (matrix[2][0] - matrix[0][2]) / s\n        );\n    } else {\n        s = 2.0 * sqrtValue;\n\n        return vec4(\n            (matrix[2][0] + matrix[0][2]) / s,\n            (matrix[1][2] + matrix[2][1]) / s,\n            0.25 * s,\n            (matrix[0][1] - matrix[1][0]) / s\n        );\n    }\n}\n\nmat3 quaternionToRotationMatrix(vec4 q) {\n    float xx = q.x * q.x;\n    float yy = q.y * q.y;\n    float zz = q.z * q.z;\n    float xy = q.x * q.y;\n    float zw = q.z * q.w;\n    float zx = q.z * q.x;\n    float yw = q.y * q.w;\n    float yz = q.y * q.z;\n    float xw = q.x * q.w;\n\n    return mat3(\n        1.0 - 2.0 * (yy + zz), 2.0 * (xy + zw), 2.0 * (zx - yw),\n        2.0 * (xy - zw), 1.0 - 2.0 * (zz + xx), 2.0 * (yz + xw),\n        2.0 * (zx + yw), 2.0 * (yz - xw), 1.0 - 2.0 * (yy + xx)\n    );\n}\n\nvec4 slerp(vec4 q0, vec4 q1, float t) {\n    float cosTheta = dot(q0, q1);\n\n    // if (cosTheta < 0.0) {\n    //     q1 = -q1;\n    //     cosTheta = -cosTheta;\n    // }\n    q1 = mix(-q1, q1, step(0.0, cosTheta));\n    cosTheta = abs(cosTheta);\n    \n    if (cosTheta > 0.999999) {\n        return normalize(mix(q0, q1, t));\n    }\n\n    float theta = acos(cosTheta);\n    float sinTheta = sin(theta);\n\n    float w0 = sin((1.0 - t) * theta) / sinTheta;\n    float w1 = sin(t * theta) / sinTheta;\n\n    return q0 * w0 + q1 * w1;\n}\n#endif\n\n#endif\n",b="\n#ifndef SDEFVERTEX\n#define SDEFVERTEX\n\n#if !defined(BAKED_VERTEX_ANIMATION_TEXTURE) && defined(SDEF)\n\n#if NUM_BONE_INFLUENCERS > 0\n{\n    float weight0 = matricesWeights[0];\n    float weight1 = matricesWeights[1];\n\n    #ifdef BONETEXTURE\n        mat4 transformMatrix0 = readMatrixFromRawSampler(boneSampler, matricesIndices[0]);\n        mat4 transformMatrix1 = readMatrixFromRawSampler(boneSampler, matricesIndices[1]);\n    #else\n        mat4 transformMatrix0 = mBones[int(matricesIndices[0])];\n        mat4 transformMatrix1 = mBones[int(matricesIndices[1])];\n    #endif\n\n    mat3 slerpedRotationMatrix = quaternionToRotationMatrix(slerp(\n        rotationMatrixToQuaternion(mat3(transformMatrix0)), \n        rotationMatrixToQuaternion(mat3(transformMatrix1)),\n        weight1\n    ));\n\n    // -center transform\n    mat4 sdefInflunce = mat4(\n        vec4(1.0, 0.0, 0.0, 0.0),\n        vec4(0.0, 1.0, 0.0, 0.0),\n        vec4(0.0, 0.0, 1.0, 0.0),\n        vec4(-matricesSdefC, 1.0)\n    );\n\n    // rotation\n    mat4 rotationMatrix = mat4(\n        vec4(slerpedRotationMatrix[0], 0.0),\n        vec4(slerpedRotationMatrix[1], 0.0),\n        vec4(slerpedRotationMatrix[2], 0.0),\n        vec4(0.0, 0.0, 0.0, 1.0)\n    );\n    sdefInflunce = rotationMatrix * sdefInflunce;\n\n    // add position offset\n    vec3 positionOffset =\n        vec3(transformMatrix0 * vec4(matricesSdefR0, 1)) * weight0 +\n        vec3(transformMatrix1 * vec4(matricesSdefR1, 1)) * weight1;\n\n    sdefInflunce[3] += vec4(positionOffset, 0.0);\n    \n    float useLinearDeform = step(0.0, -abs(matricesSdefR0.x));\n\n    influence = mat4(\n        mix(sdefInflunce[0], influence[0], useLinearDeform),\n        mix(sdefInflunce[1], influence[1], useLinearDeform),\n        mix(sdefInflunce[2], influence[2], useLinearDeform),\n        mix(sdefInflunce[3], influence[3], useLinearDeform)\n    );\n}\n#endif\n\n#endif\n\n#endif\n";class w{static OverrideEngineCreateEffect(e){const t=e.createEffect.bind(e);e.createEffect=function(e,n,o,i,s,a,l,d,h,c=r.xeF.GLSL){let u;if(u=n.attributes?n:{attributes:n,uniformsNames:o,uniformBuffersNames:[],samplers:i??[],defines:s??"",fallbacks:a??null,onCompiled:l??null,onError:d??null,indexParameters:h??null,shaderLanguage:c},(u.shaderLanguage===r.xeF.GLSL||void 0===u.shaderLanguage)&&(u.uniformsNames.includes("mBones")||u.samplers.includes("boneSampler"))&&-1===u.defines.indexOf("#define SDEF")){u.attributes.push(I.MatricesSdefCKind),u.attributes.push(I.MatricesSdefR0Kind),u.attributes.push(I.MatricesSdefR1Kind),u.defines+="\n#define SDEF";const e=u.processCodeAfterIncludes;u.processCodeAfterIncludes=e?function(t,n){return n=e(t,n),w.ProcessSdefCode(t,n)}:w.ProcessSdefCode}return t(e,u,this)}}static ProcessSdefCode(e,t){if("vertex"!==e)return t;const n="#define CUSTOM_VERTEX_DEFINITIONS";t=t.replace(n,`${n}\n${M}`);const r=new RegExp("finalWorld=finalWorld\\*influence;","g");return t.replace(r,`${b}\nfinalWorld=finalWorld*influence;`)}}class S{static _StencilReference=4;name=r.lWj.NAME_OUTLINERENDERER;scene;zOffset=-8;zOffsetUnits=4;_engine;_savedDepthWrite;_passIdForDrawWrapper;constructor(e){this.scene=e,this._engine=e.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=[];for(let e=0;e<3;++e)this._passIdForDrawWrapper[e]=this._engine.createRenderPassId(`Mmd Outline Renderer (${e})`);this._savedDepthWrite=!1}register(){this.scene._beforeRenderingMeshStage.registerStep(r.lWj.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(r.lWj.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){for(let e=0;e<this._passIdForDrawWrapper.length;++e)this._engine.releaseRenderPassId(this._passIdForDrawWrapper[e])}render(e,t,n,o){o=o??this._passIdForDrawWrapper[0];const i=this.scene,s=i.getEngine(),a=s.getCaps().instancedArrays&&(null!==t.visibleInstances[e._id]&&void 0!==t.visibleInstances[e._id]||e.getRenderingMesh().hasThinInstances);if(!this.isReady(e,a,o))return;const l=e.getMesh(),d=l._internalAbstractMeshDataInfo._actAsRegularMesh?l:null,h=e.getRenderingMesh(),c=d||h,u=e.getMaterial();if(!u||!i.activeCamera)return;const f=e._getDrawWrapper(o),g=r.qXw.GetEffect(f);if(s.enableEffect(f),u.useLogarithmicDepth&&g.setFloat("logarithmicDepthConstant",2/(Math.log(i.activeCamera.maxZ+1)/Math.LN2)),g.setFloat("offset",n??u.outlineWidth),g.setColor4("color",u.outlineColor,u.outlineAlpha),g.setMatrix("viewProjection",i.getTransformMatrix()),g.setMatrix("world",c.getWorldMatrix()),r.G$p.BindBonesParameters(c,g),h.morphTargetManager&&h.morphTargetManager.isUsingTextureForTargets&&h.morphTargetManager._bind(g),r.G$p.BindMorphTargetParameters(h,g),a||h._bind(e,g,u.fillMode),u&&u.needAlphaTesting()){const e=u.getAlphaTestTexture();e&&(g.setTexture("diffuseSampler",e),g.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,r.anm)(g,u,i),s.setZOffset(-this.zOffset),s.setZOffsetUnits(-this.zOffsetUnits),h._processRendering(c,e,g,u.fillMode,t,a,((e,t)=>{g.setMatrix("world",t)})),s.setZOffset(0),s.setZOffsetUnits(0)}isReady(e,t,n){n=n??this._passIdForDrawWrapper[0];const o=[],i=[r.oZy.PositionKind,r.oZy.NormalKind],s=e.getMesh(),a=e.getMaterial();if(!a)return!1;const l=s.getScene();a.needAlphaTesting()&&(o.push("#define ALPHATEST"),s.isVerticesDataPresent(r.oZy.UVKind)&&(i.push(r.oZy.UVKind),o.push("#define UV1")),s.isVerticesDataPresent(r.oZy.UV2Kind)&&(i.push(r.oZy.UV2Kind),o.push("#define UV2"))),a.useLogarithmicDepth&&o.push("#define LOGARITHMICDEPTH"),(0,r.lKO)(a,l,o);const d=new r.LUf;if(s.useBones&&s.computeBonesUsingShaders&&s.skeleton){i.push(r.oZy.MatricesIndicesKind),i.push(r.oZy.MatricesWeightsKind),s.numBoneInfluencers>4&&(i.push(r.oZy.MatricesIndicesExtraKind),i.push(r.oZy.MatricesWeightsExtraKind)),s.isVerticesDataPresent(I.MatricesSdefCKind)&&(i.push(I.MatricesSdefCKind),i.push(I.MatricesSdefR0Kind),i.push(I.MatricesSdefR1Kind),o.push("#define SDEF"));const e=s.skeleton;o.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),s.numBoneInfluencers>0&&d.addCPUSkinningFallback(0,s),e.isUsingTextureForMatrices?o.push("#define BONETEXTURE"):o.push("#define BonesPerMesh "+(e.bones.length+1))}else o.push("#define NUM_BONE_INFLUENCERS 0");const h=s.morphTargetManager;let c=0;h&&h.numInfluencers>0&&(c=h.numInfluencers,o.push("#define MORPHTARGETS"),o.push("#define NUM_MORPH_INFLUENCERS "+c),h.isUsingTextureForTargets&&o.push("#define MORPHTARGETS_TEXTURE"),r.G$p.PrepareAttributesForMorphTargetsInfluencers(i,s,c)),t&&(o.push("#define INSTANCES"),r.G$p.PushAttributesForInstances(i),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES"));const u=e._getDrawWrapper(n,!0),f=u.defines,g=o.join("\n");if(f!==g){const e=["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],t=["diffuseSampler","boneSampler","morphTargets"];(0,r.qx3)(e),u.setEffect(this.scene.getEngine().createEffect("outline",{attributes:i,uniformsNames:e,samplers:t,defines:g,indexParameters:{maxSimultaneousMorphTargets:c},processCodeAfterIncludes:w.ProcessSdefCode},this.scene.getEngine()),g)}return u.effect.isReady()}_beforeRenderingMesh(e,t,n){this._savedDepthWrite=this._engine.getDepthWrite();const o=t.getMaterial();if(o&&o.renderOutline){o.needAlphaBlendingForMesh(e)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(r.gTE.REPLACE),this._engine.setStencilFunction(r.gTE.ALWAYS),this._engine.setStencilMask(S._StencilReference),this._engine.setStencilFunctionReference(S._StencilReference),this._engine.stencilStateComposer.useStencilGlobalOnly=!0,this.render(t,n,0,this._passIdForDrawWrapper[1]),this._engine.setColorWrite(!0),this._engine.setStencilFunction(r.gTE.NOTEQUAL)),this._engine.setDepthWrite(!1);const i=this._engine.getAlphaMode(),s=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(r.gTE.ALPHA_COMBINE),this.render(t,n,void 0,this._passIdForDrawWrapper[0]),this._engine.setAlphaMode(i),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.alphaBlend=s,o.needAlphaBlendingForMesh(e)&&(this._engine.stencilStateComposer.useStencilGlobalOnly=!1,this._engine.restoreStencilState())}}_afterRenderingMesh(e,t,n){const r=t.getMaterial();null!==r&&r.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(t,n,void 0,this._passIdForDrawWrapper[2]),this._engine.setColorWrite(!0))}static RegisterMmdOutlineRendererIfNeeded(){r.xsS.prototype.getMmdOutlineRenderer||(r.xsS.prototype.getMmdOutlineRenderer=function(){return this._mmdOutlineRenderer||(this._mmdOutlineRenderer=new S(this)),this._mmdOutlineRenderer})}}class R extends r.Hgv{SPHERE_TEXTURE=!1;SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=!1;SPHERE_TEXTURE_BLEND_MODE_ADD=!1;TOON_TEXTURE=!1;IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=!1;TEXTURE_COLOR=!1;SPHERE_TEXTURE_COLOR=!1;TOON_TEXTURE_COLOR=!1;SDEF=!1}var C;!function(e){e[e.Multiply=1]="Multiply",e[e.Add=2]="Add"}(C||(C={}));class F extends r.neh{_sphereTexture=null;_sphereTextureBlendMode=C.Add;_toonTexture=null;_ignoreDiffuseWhenToonTextureIsNull=!1;textureColor=new r.HEv(1,1,1,1);sphereTextureColor=new r.HEv(1,1,1,1);toonTextureColor=new r.HEv(1,1,1,1);_useTextureColor=!1;_useSphereTextureColor=!1;_useToonTextureColor=!1;_isEnabled=!1;get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this.markAllDefinesAsDirty(),this._enable(e))}get sphereTexture(){return this._sphereTexture}set sphereTexture(e){this._sphereTexture!==e&&(this._sphereTexture=e,this.markAllSubMeshesAsTexturesDirty())}get sphereTextureBlendMode(){return this._sphereTextureBlendMode}set sphereTextureBlendMode(e){this._sphereTextureBlendMode!==e&&(this._sphereTextureBlendMode=e,this.markAllDefinesAsDirty())}get toonTexture(){return this._toonTexture}set toonTexture(e){this._toonTexture!==e&&(this._toonTexture=e,this.markAllSubMeshesAsTexturesDirty())}get ignoreDiffuseWhenToonTextureIsNull(){return this._ignoreDiffuseWhenToonTextureIsNull}set ignoreDiffuseWhenToonTextureIsNull(e){this._ignoreDiffuseWhenToonTextureIsNull!==e&&(this._ignoreDiffuseWhenToonTextureIsNull=e,this.markAllDefinesAsDirty())}get useTextureColor(){return this._useTextureColor}set useTextureColor(e){this._useTextureColor!==e&&(this._useTextureColor=e,this.markAllDefinesAsDirty())}get useSphereTextureColor(){return this._useSphereTextureColor}set useSphereTextureColor(e){this._useSphereTextureColor!==e&&(this._useSphereTextureColor=e,this.markAllDefinesAsDirty())}get useToonTextureColor(){return this._useToonTextureColor}set useToonTextureColor(e){this._useToonTextureColor!==e&&(this._useToonTextureColor=e,this.markAllDefinesAsDirty())}_internalMarkAllSubMeshesAsTexturesDirty;markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"MmdMaterial",100,new R,t),this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[r.gTE.MATERIAL_TextureDirtyFlag]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&this._sphereTexture&&!this._sphereTexture.isReadyOrNotBlocking())}bindForSubMesh(e,t,n,r){if(!this._isEnabled)return;const o=r.materialDefines,i=this._material.isFrozen;e.useUbo&&i&&e.isSync||(o.DIFFUSE&&o.TEXTURE_COLOR&&e.updateDirectColor4("textureColor",this.textureColor),o.NORMAL&&o.SPHERE_TEXTURE&&o.SPHERE_TEXTURE_COLOR&&e.updateDirectColor4("sphereTextureColor",this.sphereTextureColor),o.TOON_TEXTURE&&o.TOON_TEXTURE_COLOR&&e.updateDirectColor4("toonTextureColor",this.toonTextureColor),o.SPHERE_TEXTURE&&null!==r.effect&&this._material.bindView(r.effect)),t.texturesEnabled&&(o.NORMAL&&this._sphereTexture&&e.setTexture("sphereSampler",this._sphereTexture),this._toonTexture&&e.setTexture("toonSampler",this._toonTexture))}dispose(e){e&&(this._sphereTexture?.dispose(),this._toonTexture?.dispose())}getCustomCode(e){if("vertex"===e){const e={};return e.CUSTOM_VERTEX_DEFINITIONS=M,e[`!${this._escapeRegExp("finalWorld=finalWorld*influence;")}`]=`\n                ${b}\n                \n                finalWorld = finalWorld * influence;\n            `,e}if("fragment"===e){const e={CUSTOM_FRAGMENT_DEFINITIONS:"\n                #if defined(SPHERE_TEXTURE) && defined(NORMAL)\n                    uniform sampler2D sphereSampler;\n                #endif\n                #ifdef TOON_TEXTURE\n                    uniform sampler2D toonSampler;\n                #endif\n            ",CUSTOM_FRAGMENT_MAIN_BEGIN:"\n                #ifdef TOON_TEXTURE\n                    vec3 clampedInfoDiffuse;\n                    float infoToonDiffuseR;\n                    float infoToonDiffuseG;\n                    float infoToonDiffuseB;\n\n                    vec3 infoToonDiffuse;\n                #endif\n            "};return e[`!${this._escapeRegExp("#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif")}`]="\n                #if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\n                    uniform mat4 view;\n                #elif defined(NORMAL) && defined(SPHERE_TEXTURE)\n                    uniform mat4 view;\n                #endif\n            ",e[`!${this._escapeRegExp("baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);")}`]="\n                #if defined(DIFFUSE) && defined(TEXTURE_COLOR)\n                    baseColor = texture2D(diffuseSampler, vDiffuseUV + uvOffset) * textureColor;\n                #else\n                    baseColor = texture2D(diffuseSampler, vDiffuseUV + uvOffset);\n                #endif\n            ",e[`!${this._escapeRegExp("diffuseBase+=info.diffuse*shadow;")}`]="\n                #ifdef TOON_TEXTURE\n                    clampedInfoDiffuse = clamp(info.diffuse, 0.0, 1.0);\n\n                    #ifdef TOON_TEXTURE_COLOR\n                        infoToonDiffuseR = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.r)).r * toonTextureColor.r * toonTextureColor.a;\n                        infoToonDiffuseG = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.g)).g * toonTextureColor.g * toonTextureColor.a;\n                        infoToonDiffuseB = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.b)).b * toonTextureColor.b * toonTextureColor.a;\n                    #else\n                        infoToonDiffuseR = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.r)).r;\n                        infoToonDiffuseG = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.g)).g;\n                        infoToonDiffuseB = texture2D(toonSampler, vec2(0.5, clampedInfoDiffuse.b)).b;\n                    #endif\n                    \n                    infoToonDiffuse = vec3(infoToonDiffuseR, infoToonDiffuseG, infoToonDiffuseB);\n\n                    diffuseBase += infoToonDiffuse * shadow;\n                #elif defined(IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED)\n                    diffuseBase += vec3(1.0, 1.0, 1.0) * shadow;\n                #else\n                    diffuseBase += info.diffuse * shadow;\n                #endif\n            ",e.CUSTOM_FRAGMENT_BEFORE_FOG="\n                #if defined(NORMAL) && defined(SPHERE_TEXTURE)\n                    vec3 viewSpaceNormal = normalize(mat3(view) * vNormalW);\n\n                    vec2 sphereUV = viewSpaceNormal.xy * 0.5 + 0.5;\n\n                    vec4 sphereReflectionColor = texture2D(sphereSampler, sphereUV);\n\n                    #ifdef SPHERE_TEXTURE_COLOR\n                        sphereReflectionColor *= sphereTextureColor;\n                    #endif\n\n                    #ifdef SPHERE_TEXTURE_BLEND_MODE_MULTIPLY\n                        color *= sphereReflectionColor;\n                    #elif defined(SPHERE_TEXTURE_BLEND_MODE_ADD)\n                        color += vec4(sphereReflectionColor.rgb, sphereReflectionColor.a * alpha);\n                    #endif\n                #endif\n            ",e}return null}prepareDefines(e,t,n){if(this._isEnabled){const r=t.texturesEnabled;e.SPHERE_TEXTURE=null!==this._sphereTexture&&r,e.SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=this._sphereTextureBlendMode===C.Multiply,e.SPHERE_TEXTURE_BLEND_MODE_ADD=this._sphereTextureBlendMode===C.Add,e.TOON_TEXTURE=null!==this._toonTexture&&r,e.IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=this._ignoreDiffuseWhenToonTextureIsNull,e.TEXTURE_COLOR=this._useTextureColor,e.SPHERE_TEXTURE_COLOR=this._useSphereTextureColor,e.TOON_TEXTURE_COLOR=this._useToonTextureColor,e.SDEF=!!(n.useBones&&n.computeBonesUsingShaders&&n.skeleton)}else e.SPHERE_TEXTURE=!1,e.SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=!1,e.SPHERE_TEXTURE_BLEND_MODE_ADD=!1,e.TOON_TEXTURE=!1,e.IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=!1,e.TEXTURE_COLOR=!1,e.SPHERE_TEXTURE_COLOR=!1,e.TOON_TEXTURE_COLOR=!1,e.SDEF=!1}hasTexture(e){return this._sphereTexture===e||this._toonTexture===e}getActiveTextures(e){this._sphereTexture&&e.push(this._sphereTexture),this._toonTexture&&e.push(this._toonTexture)}getAnimatables(e){this._sphereTexture&&this._sphereTexture.animations&&0<this._sphereTexture.animations.length&&e.push(this._sphereTexture),this._toonTexture&&this._toonTexture.animations&&0<this._toonTexture.animations.length&&e.push(this._toonTexture)}getSamplers(e){e.push("sphereSampler","toonSampler")}getAttributes(e,t,n){this._isEnabled&&n.useBones&&n.computeBonesUsingShaders&&n.skeleton&&n.isVerticesDataPresent(I.MatricesSdefCKind)&&(e.push(I.MatricesSdefCKind),e.push(I.MatricesSdefR0Kind),e.push(I.MatricesSdefR1Kind))}getUniforms(){return{ubo:[{name:"textureColor",size:4,type:"vec4"},{name:"sphereTextureColor",size:4,type:"vec4"},{name:"toonTextureColor",size:4,type:"vec4"}],fragment:"\n                #if defined(DIFFUSE) && defined(TEXTURE_COLOR)\n                    uniform vec4 textureColor;\n                #endif\n                #if defined(SPHERE_TEXTURE) && defined(SPHERE_TEXTURE_COLOR)\n                    uniform vec4 sphereTextureColor;\n                #endif\n                #if defined(TOON_TEXTURE) && defined(TOON_TEXTURE_COLOR)\n                    uniform vec4 toonTextureColor;\n                #endif\n            "}}getClassName(){return"MmdPluginMaterial"}_escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}}class v extends r.KuD{_pluginMaterial;_renderOutline=!1;outlineWidth=.01;outlineColor=new r.Wot(0,0,0);outlineAlpha=1;constructor(e,t){super(e,t),this.specularColor=new r.Wot(0,0,0);const n=this._pluginMaterial=new F(this);n.isEnabled=!0,n.ignoreDiffuseWhenToonTextureIsNull=!0}get sphereTexture(){return this._pluginMaterial.sphereTexture}set sphereTexture(e){this._pluginMaterial.sphereTexture=e}get sphereTextureBlendMode(){return this._pluginMaterial.sphereTextureBlendMode}set sphereTextureBlendMode(e){this._pluginMaterial.sphereTextureBlendMode=e}get toonTexture(){return this._pluginMaterial.toonTexture}set toonTexture(e){this._pluginMaterial.toonTexture=e}get ignoreDiffuseWhenToonTextureIsNull(){return this._pluginMaterial.ignoreDiffuseWhenToonTextureIsNull}set ignoreDiffuseWhenToonTextureIsNull(e){this._pluginMaterial.ignoreDiffuseWhenToonTextureIsNull=e}get textureColor(){return this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureColor}set textureColor(e){this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureColor=e}get sphereTextureColor(){return this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureColor}set sphereTextureColor(e){this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureColor=e}get toonTextureColor(){return this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureColor}set toonTextureColor(e){this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureColor=e}get renderOutline(){return this._renderOutline}set renderOutline(e){e&&this.getScene().getMmdOutlineRenderer(),this._renderOutline=e}}class B{static EdgeSizeScaleFactor=.01;alphaThreshold=195;alphaBlendThreshold=100;useAlphaEvaluation=!0;alphaEvaluationResolution=512;_textureLoader=new f;buildMaterials(e,t,n,r,o,i,s,a,l,d,h,c,u){const f=s.blockMaterialDirtyMechanism;s.blockMaterialDirtyMechanism=!0;let g=null;const p=()=>null!==g?g:this.useAlphaEvaluation?g=new _(d,l,this.alphaEvaluationResolution):null,x=new A(i,r,o),m=[],T={lengthComputable:!0,loaded:0,total:3*t.length},y=()=>{T.loaded+=1,c?.(T)};let E=0;for(let i=0;i<t.length;++i){const l=t[i];s._blockEntityCollection=!!a;const d=new v(l.name,s);d._parentContainer=a,s._blockEntityCollection=!1,a?.materials.push(d);{const t=[],c=this.loadGeneralScalarProperties(d,l);void 0!==c&&t.push(c);const u=this.loadDiffuseTexture(e,d,l,n,s,a,r,o,x,E,p,y);void 0!==u&&t.push(u);const f=this.loadSphereTexture(e,d,l,n,s,a,r,o,x,y);void 0!==f&&t.push(f);const g=this.loadToonTexture(e,d,l,n,s,a,r,o,x,y);void 0!==g&&t.push(g);const A=this.loadOutlineRenderingProperties(d,l);void 0!==A&&t.push(A),m.push(...t),Promise.all(t).then((()=>{this.afterBuildSingleMaterial(d,i,l,h,n,s,r)}))}h.subMaterials.push(d),E+=l.surfaceCount}this._textureLoader.loadModelTexturesEnd(e);const I=this._textureLoader.onModelTextureLoadedObservable.get(e);void 0!==I?I.addOnce((()=>{Promise.all(m).then((()=>{g?.dispose(),s.blockMaterialDirtyMechanism=f,u?.()}))})):Promise.all(m).then((()=>{g?.dispose(),s.blockMaterialDirtyMechanism=f,u?.()}))}loadGeneralScalarProperties=(e,t)=>{const n=t.diffuse;e.diffuseColor=new r.Wot(n[0],n[1],n[2]);const o=t.specular;e.specularColor=new r.Wot(o[0],o[1],o[2]);const i=t.ambient;e.ambientColor=new r.Wot(i[0],i[1],i[2]);const s=t.diffuse[3];e.alpha=s,e.specularPower=t.shininess};loadDiffuseTexture=async(e,t,n,o,s,a,l,d,h,c,u,f)=>{t.backFaceCulling=!(n.flag&i.Material.Flag.IsDoubleSided);const g=o[n.textureIndex];if(void 0!==g){const o=d+g;let i;const p=h.resolve(o);i=void 0!==p?await this._textureLoader.loadTextureFromBufferAsync(e,o,p instanceof File?p:p.data,s,a):await this._textureLoader.loadTextureAsync(e,l,g,s,a);const x=i.texture;if(null!==x){t.diffuseTexture=x;let e=Number.MAX_SAFE_INTEGER;const o=n.evauatedTransparency;if(void 0!==o&&-1!==o)e=o;else{const t=u();null!==t&&(e=await t.textureHasAlphaOnGeometry(i.arrayBuffer,c,n.surfaceCount,this.alphaThreshold,this.alphaBlendThreshold))}if(e!==Number.MAX_SAFE_INTEGER){const n=e!==r.F5T.MATERIAL_OPAQUE;n&&(x.hasAlpha=!0),t.useAlphaFromDiffuseTexture=n,t.transparencyMode=e,n&&(t.backFaceCulling=!1)}f?.()}else f?.()}else f?.()};loadSphereTexture=async(e,t,n,r,o,s,a,l,d,h)=>{if(n.sphereTextureMode!==i.Material.SphereTextureMode.Off){const i=r[n.sphereTextureIndex];if(void 0!==i){const r=l+i;let c;const u=d.resolve(r);c=void 0!==u?(await this._textureLoader.loadTextureFromBufferAsync(e,r,u instanceof File?u:u.data,o,s)).texture:(await this._textureLoader.loadTextureAsync(e,a,i,o,s)).texture,null!==c&&(t.sphereTexture=c,t.sphereTextureBlendMode=1===n.sphereTextureMode?C.Multiply:C.Add),h?.()}else h?.()}else h?.()};loadToonTexture=async(e,t,n,r,o,i,s,a,l,d)=>{let h;if(h=n.isSharedToonTexture?-1===n.toonTextureIndex?void 0:n.toonTextureIndex:r[n.toonTextureIndex],void 0!==h){const n=a+h;let r;const c="string"==typeof h?l.resolve(n):void 0;r=void 0!==c?(await this._textureLoader.loadTextureFromBufferAsync(e,n,c instanceof File?c:c.data,o,i)).texture:(await this._textureLoader.loadTextureAsync(e,s,h,o,i)).texture,null!==r&&(t.toonTexture=r),d?.()}else d?.()};loadOutlineRenderingProperties=(e,t)=>{if(t.flag&i.Material.Flag.EnabledToonEdge){S.RegisterMmdOutlineRendererIfNeeded(),e.renderOutline=!0,e.outlineWidth=t.edgeSize*B.EdgeSizeScaleFactor;const n=t.edgeColor;e.outlineColor=new r.Wot(n[0],n[1],n[2]),e.outlineAlpha=n[3]}};afterBuildSingleMaterial=()=>{}}class U{static _IdMap=new WeakMap;static _NextId=0;constructor(){}static GetId(e){let t=this._IdMap.get(e);return void 0===t&&(t=this._NextId,this._NextId+=1,this._IdMap.set(e,t)),t}}class D extends r.Kj0{applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId===this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(r.oZy.PositionKind))return this;if(!this.isVerticesDataPresent(r.oZy.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(r.oZy.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(r.oZy.NormalKind),n=this._internalMeshDataInfo;if(!n._sourcePositions){const e=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=e}t&&!n._sourceNormals&&this.setNormalsForCPUSkinning();let o=this.getVerticesData(r.oZy.PositionKind);if(!o)return this;o instanceof Float32Array||(o=new Float32Array(o));let i=this.getVerticesData(r.oZy.NormalKind);if(t){if(!i)return this;i instanceof Float32Array||(i=new Float32Array(i))}const s=this.isVerticesDataPresent(I.MatricesSdefCKind);let a=null,l=null,d=null;s&&(a=this.getVerticesData(I.MatricesSdefCKind),l=this.getVerticesData(I.MatricesSdefR0Kind),d=this.getVerticesData(I.MatricesSdefR1Kind));const h=this.getVerticesData(r.oZy.MatricesIndicesKind),c=this.getVerticesData(r.oZy.MatricesWeightsKind);if(!c||!h)return this;const u=this.numBoneInfluencers>4,f=u?this.getVerticesData(r.oZy.MatricesIndicesExtraKind):null,g=u?this.getVerticesData(r.oZy.MatricesWeightsExtraKind):null,p=e.getTransformMatrices(this),x=r.Pa4.Zero(),m=new r.y3G,A=new r.y3G,T=new r.y3G,_=new r.y3G,y=new r._fP,E=new r._fP,M=new r.Pa4,b=n._sourcePositions,w=n._sourceNormals;let S,R=0;for(let e=0;e<o.length;e+=3,R+=4){let n=0;if(s&&(n=l[e]),0===n){let n;for(S=0;S<4;S++)n=c[R+S],n>0&&(r.y3G.FromFloat32ArrayToRefScaled(p,Math.floor(16*h[R+S]),n,A),m.addToSelf(A));if(u)for(S=0;S<4;S++)n=g[R+S],n>0&&(r.y3G.FromFloat32ArrayToRefScaled(p,Math.floor(16*f[R+S]),n,A),m.addToSelf(A));r.Pa4.TransformCoordinatesFromFloatsToRef(b[e],b[e+1],b[e+2],m,x),x.toArray(o,e),t&&(r.Pa4.TransformNormalFromFloatsToRef(w[e],w[e+1],w[e+2],m,x),x.toArray(i,e)),m.reset()}else{const n=c[R+0],s=c[R+1];r.y3G.FromArrayToRef(p,Math.floor(16*h[R+0]),T),r.y3G.FromArrayToRef(p,Math.floor(16*h[R+1]),_),r._fP.FromRotationMatrixToRef(T,y),r._fP.FromRotationMatrixToRef(_,E),r.y3G.FromQuaternionToRef(r._fP.SlerpToRef(y,E,s,y),A),r.Pa4.TransformCoordinatesFromFloatsToRef(b[e]-a[e],b[e+1]-a[e+1],b[e+2]-a[e+2],A,M),r.Pa4.TransformCoordinatesFromFloatsToRef(l[e],l[e+1],l[e+2],T,x).scaleAndAddToRef(n,M),r.Pa4.TransformCoordinatesFromFloatsToRef(d[e],d[e+1],d[e+2],_,x).scaleAndAddToRef(s,M),M.toArray(o,e),t&&(r.Pa4.TransformNormalFromFloatsToRef(w[e],w[e+1],w[e+2],A,M),M.toArray(i,e))}}return this.updateVerticesData(r.oZy.PositionKind,o),t&&this.updateVerticesData(r.oZy.NormalKind,i),this}}class P{name;extensions;materialBuilder;useSdef;buildSkeleton;buildMorph;boundingBoxMargin;referenceFiles;_loggingEnabled;log;warn;error;constructor(){this.name="pmx",this.extensions={".pmx":{isBinary:!0}},this.materialBuilder=new B,this.useSdef=!0,this.buildSkeleton=!0,this.buildMorph=!0,this.boundingBoxMargin=10,this.referenceFiles=[],this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled}importMeshAsync(e,t,n,r,o,i){return this._loadAsyncInternal(t,null,n,r,o)}loadAsync(e,t,n,r,o){return this._loadAsyncInternal(e,null,t,n,r).then((()=>{}))}loadAssetContainerAsync(e,t,n,o,i){const s=new r.TJ4(e);return this._loadAsyncInternal(e,s,t,n,o).then((()=>s))}loadFile(e,t,n,r,o,i,s){const a=this.materialBuilder,l=this.useSdef,d=this.buildSkeleton,h=this.buildMorph,c=this.boundingBoxMargin,u=this.referenceFiles;return e._loadFile(t,((e,n)=>{const o={arrayBuffer:e,pmxFileId:t instanceof File?U.GetId(t).toString():t,materialBuilder:a,useSdef:l,buildSkeleton:d,buildMorph:h,boundingBoxMargin:c,referenceFiles:u};r(o,n)}),o,!0,i,s)}async _loadAsyncInternal(e,t,n,o,s){const a=await m.ParseAsync(n.arrayBuffer,this).catch((e=>Promise.reject(e))),l=Math.floor(n.arrayBuffer.byteLength/100),d=100*a.materials.length,h=n.buildSkeleton?100*a.bones.length:0;let c=0;if(n.buildMorph){const e=a.morphs;for(let t=0;t<e.length;++t){const n=e[t];n.type!==i.Morph.Type.VertexMorph&&n.type!==i.Morph.Type.UvMorph&&n.type!==i.Morph.Type.AdditionalUvMorph1&&n.type!==i.Morph.Type.AdditionalUvMorph2&&n.type!==i.Morph.Type.AdditionalUvMorph3&&n.type!==i.Morph.Type.AdditionalUvMorph4||(c+=n.indices.length)}}const u=3e4*a.textures.length;let f=!1;const g={lengthComputable:!0,loaded:l,total:l+a.faces.length+a.vertices.length+d+h+c+u};s?.({...g});let p=l;e._blockEntityCollection=!!t;const x=new(n.useSdef?D:r.Kj0)(a.header.modelName,e);x._parentContainer=t,e._blockEntityCollection=!1;const A=new r.xx8,T=n.useSdef?new Float32Array(3*a.vertices.length):void 0,_=n.useSdef?new Float32Array(3*a.vertices.length):void 0,y=n.useSdef?new Float32Array(3*a.vertices.length):void 0;let E=!1;{const e=a.vertices,t=new Float32Array(3*e.length),o=new Float32Array(3*e.length),l=new Float32Array(2*e.length),d=new Float32Array(4*e.length),h=new Float32Array(4*e.length);let c;c=a.faces instanceof Uint8Array||a.faces instanceof Uint16Array?new Uint16Array(a.faces.length):new Uint32Array(a.faces.length);{let e=performance.now();const t=a.faces;for(let n=0;n<c.length;n+=3)c[n+0]=t[n+0],c[n+1]=t[n+2],c[n+2]=t[n+1],n%1e4==0&&100<performance.now()-e&&(g.loaded=p+n,s?.({...g}),await r.w1W.DelayAsync(0),e=performance.now());g.loaded=p+c.length,s?.({...g}),p+=c.length}{let a=performance.now();for(let c=0;c<e.length;++c){const u=e[c];switch(t[3*c+0]=u.position[0],t[3*c+1]=u.position[1],t[3*c+2]=u.position[2],o[3*c+0]=u.normal[0],o[3*c+1]=u.normal[1],o[3*c+2]=u.normal[2],l[2*c+0]=u.uv[0],l[2*c+1]=1-u.uv[1],u.weightType){case i.Vertex.BoneWeightType.Bdef1:{const e=u.boneWeight;d[4*c+0]=e.boneIndices,d[4*c+1]=0,d[4*c+2]=0,d[4*c+3]=0,h[4*c+0]=1,h[4*c+1]=0,h[4*c+2]=0,h[4*c+3]=0}break;case i.Vertex.BoneWeightType.Bdef2:{const e=u.boneWeight;d[4*c+0]=e.boneIndices[0],d[4*c+1]=e.boneIndices[1],d[4*c+2]=0,d[4*c+3]=0,h[4*c+0]=e.boneWeights,h[4*c+1]=1-e.boneWeights,h[4*c+2]=0,h[4*c+3]=0}break;case i.Vertex.BoneWeightType.Bdef4:case i.Vertex.BoneWeightType.Qdef:{const e=u.boneWeight;d[4*c+0]=e.boneIndices[0],d[4*c+1]=e.boneIndices[1],d[4*c+2]=e.boneIndices[2],d[4*c+3]=e.boneIndices[3],h[4*c+0]=e.boneWeights[0],h[4*c+1]=e.boneWeights[1],h[4*c+2]=e.boneWeights[2],h[4*c+3]=e.boneWeights[3]}break;case i.Vertex.BoneWeightType.Sdef:{const e=u.boneWeight;d[4*c+0]=e.boneIndices[0],d[4*c+1]=e.boneIndices[1],d[4*c+2]=0,d[4*c+3]=0;const t=e.boneWeights,r=t.boneWeight0,o=1-r;if(h[4*c+0]=r,h[4*c+1]=o,h[4*c+2]=0,h[4*c+3]=0,n.useSdef){const e=t.c[0],n=t.c[1],i=t.c[2];let s=t.r0[0],a=t.r0[1],l=t.r0[2],d=t.r1[0],h=t.r1[1],u=t.r1[2];const f=s*r+d*o,g=a*r+h*o,p=l*r+u*o;s=e+s-f,a=n+a-g,l=i+l-p,d=e+d-f,h=n+h-g,u=i+u-p;const x=.5*(e+s),m=.5*(n+a),A=.5*(i+l),I=.5*(e+d),M=.5*(n+h),b=.5*(i+u);T[3*c+0]=e,T[3*c+1]=n,T[3*c+2]=i,_[3*c+0]=x,_[3*c+1]=m,_[3*c+2]=A,y[3*c+0]=I,y[3*c+1]=M,y[3*c+2]=b,E=!0}}}c%1e4==0&&100<performance.now()-a&&(g.loaded=p+c,s?.({...g}),await r.w1W.DelayAsync(0),a=performance.now())}g.loaded=p+e.length,s?.({...g}),p+=e.length}A.positions=t,A.normals=o,A.uvs=l,A.indices=c,A.matricesIndices=d,A.matricesWeights=h}e._blockEntityCollection=!!t;const M=new r.ZXM(a.header.modelName,e,A,!1);M._parentContainer=t,e._blockEntityCollection=!1,n.useSdef&&E&&(M.setVerticesData(I.MatricesSdefCKind,T,!1,3),M.setVerticesData(I.MatricesSdefR0Kind,_,!1,3),M.setVerticesData(I.MatricesSdefR1Kind,y,!1,3)),M.applyToMesh(x),e._blockEntityCollection=!!t;const b=new r.G2s(a.header.modelName+"_multi",e);let w;b._parentContainer=t,e._blockEntityCollection=!1;const S=new Promise((r=>{w=n.materialBuilder.buildMaterials(x.uniqueId,a.materials,a.textures,o,"file:"+n.pmxFileId+"_",n.referenceFiles,e,t,A.indices,A.uvs,b,(e=>{if(!f)return;const t=e.loaded/e.total;g.loaded=p+Math.floor(u*t),s?.({...g})}),(()=>r()))}));void 0!==w&&await w,x.material=b,x.subMeshes.length=0;{const e=a.materials;let t=0;for(let n=0;n<e.length;++n){const o=e[n];new r.P4Y(n,0,a.vertices.length,t,o.surfaceCount,x),t+=o.surfaceCount}}g.loaded=p+d,s?.({...g}),p+=d;const R=[];let C=null;if(n.buildSkeleton){e._blockEntityCollection=!!t,C=new r.OdW(a.header.modelName,a.header.modelName+"_skeleton",e),C._parentContainer=t,e._blockEntityCollection=!1;{const e=a.bones,t=[],n=[];for(let o=0;o<e.length;++o){const i=e[o];let s=!1;if(0<=i.parentBoneIndex&&i.parentBoneIndex<e.length){let t=i.parentBoneIndex;for(;-1!==t;){if(t===o){s=!0,this.warn(`Bone loop detected. Ignore Parenting. Bone index: ${o}`);break}t=e[t].parentBoneIndex}o<=i.parentBoneIndex&&this.warn(`Parent bone index is greater equal than child bone index. Bone index: ${o} Parent bone index: ${i.parentBoneIndex}`)}else-1!==i.parentBoneIndex&&this.error(`Parent bone index is out of range. Bone index: ${o} Parent bone index: ${i.parentBoneIndex}`);const a=i.position,l=new r.Pa4(a[0],a[1],a[2]);if(0<=i.parentBoneIndex&&i.parentBoneIndex<t.length&&!s){const t=e[i.parentBoneIndex];l.x-=t.position[0],l.y-=t.position[1],l.z-=t.position[2]}const d=r.y3G.Identity().setTranslation(l),h=new r.N$j(i.name,C,void 0,d,void 0,void 0,o);t.push(h),n.push(s);const c={name:i.name,parentBoneIndex:i.parentBoneIndex,transformOrder:i.transformOrder,flag:i.flag,appendTransform:i.appendTransform,transformAfterPhysics:i.transformAfterPhysics,ik:i.ik};R.push(c)}for(let r=0;r<t.length;++r){const o=e[r],i=t[r];0<=o.parentBoneIndex&&o.parentBoneIndex<t.length&&!n[r]&&i.setParent(t[o.parentBoneIndex],!1)}for(let e=0;e<t.length;++e){const n=t[e];null===n.getParent()&&n._updateAbsoluteBindMatrices()}}x.skeleton=C,g.loaded=p+h,s?.({...g}),p+=h}const F=[];let v=null;if(n.buildMorph){e._blockEntityCollection=!!t,v=new r.Oj5(e),v._parentContainer=t,e._blockEntityCollection=!1;{const t=a.morphs,n=[];for(let o=0;o<t.length;++o){const l=t[o];switch(l.type){case i.Morph.Type.GroupMorph:case i.Morph.Type.BoneMorph:case i.Morph.Type.MaterialMorph:F.push(l);break;case i.Morph.Type.VertexMorph:case i.Morph.Type.UvMorph:case i.Morph.Type.AdditionalUvMorph1:case i.Morph.Type.AdditionalUvMorph2:case i.Morph.Type.AdditionalUvMorph3:case i.Morph.Type.AdditionalUvMorph4:F.push({name:l.name,englishName:l.englishName,category:l.category,type:l.type,index:n.length});break;default:this.warn(`Unsupported morph type: ${l.type}`)}if(l.type!==i.Morph.Type.VertexMorph&&l.type!==i.Morph.Type.UvMorph&&l.type!==i.Morph.Type.AdditionalUvMorph1&&l.type!==i.Morph.Type.AdditionalUvMorph2&&l.type!==i.Morph.Type.AdditionalUvMorph3&&l.type!==i.Morph.Type.AdditionalUvMorph4)continue;const d=new r.YX6(l.name,0,e);if(n.push(d),l.type===i.Morph.Type.VertexMorph){const e=new Float32Array(3*a.vertices.length);e.set(A.positions);const t=l.indices,n=l.positions;let o=performance.now();for(let i=0;i<t.length;++i){const a=t[i];e[3*a+0]+=n[3*i+0],e[3*a+1]+=n[3*i+1],e[3*a+2]+=n[3*i+2],i%1e4==0&&100<performance.now()-o&&(g.loaded=p+i,s?.({...g}),await r.w1W.DelayAsync(0),o=performance.now())}p+=t.length,d.setPositions(e)}else{const e=new Float32Array(2*a.vertices.length);e.set(A.uvs);const t=l.indices,n=l.offsets;let o=performance.now();for(let i=0;i<t.length;++i){const a=t[i];e[2*a+0]+=n[4*i+0],e[2*a+1]+=n[4*i+1],i%1e4==0&&100<performance.now()-o&&(g.loaded=p+i,s?.({...g}),await r.w1W.DelayAsync(0),o=performance.now())}p+=t.length,d.setPositions(A.positions),d.setUVs(e)}}v.areUpdatesFrozen=!0;for(let e=0;e<n.length;++e)v.addTarget(n[e]);v.areUpdatesFrozen=!1}x.morphTargetManager=v}const B=n.boundingBoxMargin;if(0!==B){const e=x.subMeshes;for(let t=0;t<e.length;++t){const n=e[t],o=n.getBoundingInfo();n.setBoundingInfo(new r.jF4((new r.Pa4).setAll(-B).addInPlace(o.minimum),(new r.Pa4).setAll(B).addInPlace(o.maximum)))}const t=x.getBoundingInfo();x.setBoundingInfo(new r.jF4((new r.Pa4).setAll(-B).addInPlace(t.minimum),(new r.Pa4).setAll(B).addInPlace(t.maximum))),x._updateBoundingInfo()}return x.metadata={isMmdModel:!0,header:{modelName:a.header.modelName,englishModelName:a.header.englishModelName,comment:a.header.comment,englishComment:a.header.englishComment},bones:R,morphs:F,rigidBodies:a.rigidBodies,joints:a.joints},g.loaded=p,s?.({...g}),f=!0,await S,null!==t&&(t.meshes.push(x),t.geometries.push(M),t.multiMaterials.push(b),null!==C&&t.skeletons.push(C),null!==v&&t.morphTargetManagers.push(v)),{meshes:[x],particleSystems:[],skeletons:null!==C?[C]:[],animationGroups:[],transformNodes:[],geometries:[M],lights:[]}}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){r.YdH.Log(e)}_logDisabled(){}_warnEnabled(e){r.YdH.Warn(e)}_warnDisabled(){}_errorEnabled(e){r.YdH.Error(e)}_errorDisabled(){}}async function O(e,t=""){const n=[];for(let r=0;r<e.length;r++){const o=e[r];if(o.isDirectory){const e=o.createReader(),r=await new Promise(((t,n)=>{e.readEntries(t,n)}));n.push(...await O(r,t+o.name+"/"))}else n.push(o)}return n}l();const L=document.getElementById("render-canvas");if(!(L instanceof HTMLCanvasElement))throw new Error("Invalid canvas element");const N=new r.D4V(L,!0,{preserveDrawingBuffer:!0,stencil:!0,antialias:!0,powerPreference:"high-performance",doNotHandleContextLost:!0},!0);o.Create({canvas:L,engine:N,sceneBuilder:new class{async build(e,t){w.OverrideEngineCreateEffect(t);const n=new P;n.loggingEnabled=!0,n.buildSkeleton=!1,n.buildMorph=!1,r.n0n.RegisterPlugin(n);const o=new r.xsS(t),i=new r.YfP("camera",0,0,45,new r.Pa4(0,10,0),o);i.maxZ=5e3,i.fov=Math.PI/180*30,i.speed=.5,i.setPosition(new r.Pa4(0,10,-45)),i.attachControl(e,!0);const s=new r.ezm("hemisphericLight",new r.Pa4(0,1,0),o);s.intensity=.4,s.specular=new r.Wot(0,0,0),s.groundColor=new r.Wot(1,1,1);const a=new r.Ox3("directionalLight",new r.Pa4(.5,-1,1),o);a.intensity=.8,a.autoCalcShadowZBounds=!1,a.autoUpdateExtends=!1,a.shadowMaxZ=60,a.shadowMinZ=-30,a.orthoTop=54,a.orthoBottom=-3,a.orthoLeft=-30,a.orthoRight=30,a.shadowOrthoScale=0;const l=new r.uXA(1024,a,!0,i);l.usePercentageCloserFiltering=!0,l.forceBackFacesOnly=!0,l.filteringQuality=r.uXA.QUALITY_MEDIUM,l.frustumEdgeFalloff=.1;const d=r.VO7.CreateGround("ground1",{width:100,height:100,subdivisions:2,updatable:!1},o);d.receiveShadows=!0,l.addShadowCaster(d);const h=async e=>{if(f)return;null!==u&&(l.removeShadowCaster(u),u.dispose(!1,!0),u=null),f=!0,t.displayLoadingUI();const i=e.webkitRelativePath;y.textContent=e.name;const s=n.materialBuilder;s.useAlphaEvaluation=A.useAlphaEvaluation,s.alphaEvaluationResolution=A.alphaEvaluationResolution,s.alphaThreshold=A.alphaThreshold,s.alphaBlendThreshold=A.alphaBlendThreshold,u=(await r.n0n.ImportMeshAsync(void 0,i.substring(0,i.lastIndexOf("/")+1),e,o,(n=>t.loadingUIText=`<br/><br/><br/>Loading (${e.name})... ${n.loaded}/${n.total} (${Math.floor(100*n.loaded/n.total)}%)`))).meshes[0],u.receiveShadows=!0,l.addShadowCaster(u),t.hideLoadingUI(),setTimeout((()=>f=!1),1500)};let c=null,u=null,f=!1;const g=e.parentElement;g.style.display="flex",g.style.flexDirection="row-reverse";const p=document.createElement("div");p.style.width="100%",p.style.height="100%",p.style.display="flex",p.appendChild(e),g.appendChild(p);const x=document.createElement("div");x.style.position="relative",x.style.backgroundColor="white",x.style.width="auto",x.style.height="100%",x.style.display="flex",x.style.flexDirection="column",x.style.justifyContent="center",x.style.alignItems="center",x.style.fontFamily="sans-serif",g.appendChild(x);const m=document.createElement("div");m.style.width="auto",m.style.height="100%",m.style.display="flex",m.style.flexDirection="column",m.style.justifyContent="center",m.style.alignItems="start",m.style.padding="20px",m.style.boxSizing="border-box",x.appendChild(m);const A=new E;A.loggingEnabled=!0;let T=[];const _=document.createElement("h1");_.textContent="PMX to BPMX Converter",_.style.width="500px",_.style.textAlign="center",_.style.marginTop="0",m.appendChild(_);const y=document.createElement("div");y.textContent="No PMX file selected",y.style.width="100%",y.style.height="auto",y.style.fontSize="20px",y.style.marginBottom="10px",y.style.border="1px solid black",y.style.boxSizing="border-box",y.style.padding="10px",m.appendChild(y);const I=document.createElement("div");I.style.width="500px",I.style.flexGrow="1",I.style.overflow="auto",I.style.marginBottom="10px",I.style.border="1px solid black",I.style.boxSizing="border-box",m.appendChild(I);const M=document.createElement("ul");M.style.height="auto",M.style.fontSize="16px",I.appendChild(M);const b=()=>{M.innerHTML="";for(const e of T){const t=document.createElement("li");t.style.whiteSpace="nowrap";const n=e.webkitRelativePath;t.textContent=n,e.name.endsWith(".pmx")&&(t.style.color="blue",t.style.cursor="pointer",t.style.textDecoration="underline",t.onclick=()=>{c=e,h(e)}),M.appendChild(t)}},S=document.createElement("input");S.style.width="100%",S.style.minHeight="80px",S.style.display="block",S.style.backgroundColor="black",S.style.color="white",S.style.marginBottom="10px",S.style.fontSize="20px",S.type="file",S.setAttribute("directory",""),S.setAttribute("webkitdirectory",""),S.setAttribute("allowdirs",""),S.ondragover=e=>{e.preventDefault()},S.ondrop=async e=>{e.preventDefault();const t=e.dataTransfer.items;if(!t)return;const r=[];for(let e=0;e<t.length;++e){const n=t[e].webkitGetAsEntry();n&&r.push(n)}const o=await O(r);T=await async function(e){const t=[],n=await O(e);for(let e=0;e<n.length;e++){const r=n[e],o=await new Promise(((e,t)=>{r.file(e,t)}));""===o.webkitRelativePath&&(Object.defineProperty(o,"webkitRelativePath",{writable:!0}),o.webkitRelativePath=r.fullPath),t.push(o)}return t}(o),b(),n.referenceFiles=T},S.onchange=()=>{null!==S.files&&(T=Array.from(S.files),b(),n.referenceFiles=T)},m.appendChild(S);const R=document.createElement("div");R.style.width="100%",R.style.height="auto",R.style.display="flex",R.style.flexDirection="column",R.style.justifyContent="center",R.style.alignItems="center",R.style.marginBottom="10px",R.style.border="1px solid black",R.style.padding="20px",R.style.boxSizing="border-box",m.appendChild(R);const C=document.createElement("div");C.style.width="100%",C.style.height="50px",C.style.display="flex",C.style.flexDirection="row",C.style.justifyContent="space-between",C.style.alignItems="center",C.style.marginBottom="10px",R.appendChild(C);const F=document.createElement("label");F.textContent="Use Alpha Evaluation",F.style.width="200px",F.style.textAlign="left",F.style.marginRight="10px",F.style.fontSize="20px",F.style.flexGrow="1",C.appendChild(F);const v=document.createElement("input");v.style.width="20px",v.style.height="20px",v.style.fontSize="20px",v.type="checkbox",v.checked=A.useAlphaEvaluation,C.appendChild(v),v.onchange=()=>{A.useAlphaEvaluation=v.checked};const B=document.createElement("div");B.style.width="100%",B.style.height="50px",B.style.display="flex",B.style.flexDirection="row",B.style.justifyContent="space-between",B.style.alignItems="center",B.style.marginBottom="10px",R.appendChild(B);const U=document.createElement("label");U.textContent="Alpha Evaluation Resolution",U.style.width="200px",U.style.textAlign="left",U.style.marginRight="10px",U.style.fontSize="20px",U.style.flexGrow="1",B.appendChild(U);const D=document.createElement("input");D.style.width="100px",D.style.height="40px",D.style.fontSize="20px",D.type="number",D.min="64",D.max="4096",D.value=A.alphaEvaluationResolution.toString(),B.appendChild(D),D.onchange=()=>{A.alphaEvaluationResolution=Number(D.value)};const L=document.createElement("div");L.style.width="100%",L.style.height="50px",L.style.display="flex",L.style.flexDirection="row",L.style.justifyContent="space-between",L.style.alignItems="center",L.style.marginBottom="10px",R.appendChild(L);const N=document.createElement("label");N.textContent="Alpha Threshold",N.style.width="200px",N.style.textAlign="left",N.style.marginRight="10px",N.style.fontSize="20px",N.style.flexGrow="1",L.appendChild(N);const V=document.createElement("input");V.style.width="100px",V.style.height="40px",V.style.fontSize="20px",V.type="number",V.min="0",V.max="255",V.value=A.alphaThreshold.toString(),L.appendChild(V),V.onchange=()=>{A.alphaThreshold=Number(V.value)};const k=document.createElement("div");k.style.width="100%",k.style.height="50px",k.style.display="flex",k.style.flexDirection="row",k.style.justifyContent="space-between",k.style.alignItems="center",R.appendChild(k);const W=document.createElement("label");W.textContent="Alpha Blend Threshold",W.style.width="200px",W.style.textAlign="left",W.style.marginRight="10px",W.style.fontSize="20px",W.style.flexGrow="1",k.appendChild(W);const z=document.createElement("input");z.style.width="100px",z.style.height="40px",z.style.fontSize="20px",z.type="number",z.min="-500",z.max="500",z.value=A.alphaBlendThreshold.toString(),k.appendChild(z),z.onchange=()=>{A.alphaBlendThreshold=Number(z.value)};const X=document.createElement("div");X.style.width="100%",X.style.height="auto",X.style.display="flex",X.style.flexDirection="row",X.style.justifyContent="space-between",X.style.alignItems="center",m.appendChild(X);const H=document.createElement("button");H.textContent="Reload",H.style.width="100%",H.style.height="60px",H.style.border="none",H.style.fontSize="20px",H.style.color="gray",H.style.marginRight="10px",X.appendChild(H),H.onclick=()=>{null!==c&&h(c)};const G=document.createElement("button");return G.textContent="Convert",G.style.width="100%",G.style.height="60px",G.style.border="none",G.style.fontSize="20px",X.appendChild(G),G.onclick=async()=>{if(null===c)return;if(null===u)return;f=!0,t.displayLoadingUI();const e=c.webkitRelativePath;t.loadingUIText=`<br/><br/><br/>Converting (${c.name})...`;const n=await A.convert(o,e,T),r=new Blob([n],{type:"application/octet-stream"}),i=URL.createObjectURL(r),s=document.createElement("a");s.href=i,s.download=`${c.name.substring(0,c.name.lastIndexOf("."))}.bpmx`,s.click(),URL.revokeObjectURL(i),s.remove(),t.hideLoadingUI(),setTimeout((()=>f=!1),1500)},t.resize(!0),o}}}).then((e=>e.run()))}},n={};function r(e){var o=n[e];if(void 0!==o)return o.exports;var i=n[e]={exports:{}};return t[e](i,i.exports,r),i.exports}r.m=t,e=[],r.O=(t,n,o,i)=>{if(!n){var s=1/0;for(h=0;h<e.length;h++){for(var[n,o,i]=e[h],a=!0,l=0;l<n.length;l++)(!1&i||s>=i)&&Object.keys(r.O).every((e=>r.O[e](n[l])))?n.splice(l--,1):(a=!1,i<s&&(s=i));if(a){e.splice(h--,1);var d=o();void 0!==d&&(t=d)}}return t}i=i||0;for(var h=e.length;h>0&&e[h-1][2]>i;h--)e[h]=e[h-1];e[h]=[n,o,i]},r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={179:0};r.O.j=t=>0===e[t];var t=(t,n)=>{var o,i,[s,a,l]=n,d=0;if(s.some((t=>0!==e[t]))){for(o in a)r.o(a,o)&&(r.m[o]=a[o]);if(l)var h=l(r)}for(t&&t(n);d<s.length;d++)i=s[d],r.o(e,i)&&e[i]&&e[i][0](),e[i]=0;return r.O(h)},n=self.webpackChunkbabylon_mmd=self.webpackChunkbabylon_mmd||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var o=r.O(void 0,[216],(()=>r(989)));o=r.O(o)})();